--The sp_whopro(TM) script is a SQL Server Activity Monitoring and Logging Stored Procedure. If you have used sp_who or sp_who2, you will find 
--sp_whopro very helpful, sp_whopro is versatile and easy to use. For the latest release of sp_whopro please check http://www.sqldownload.com/download
--
--The sp_whopro stored procedure can be created in any database, we recommend that you create it in the master database.
--For usage help: 'exec sp_whopro 'help'', for documentation refer to: http://www.sqldownload.com/documentation.
--If you do not have permission to create stored procedures, try creating it as ##sp_whopro, a global temporary stored procedure.
--
--You acknowledge upon downloading or using the sp_whopro script that you have reviewed and agreed to all of the terms and conditions set forth in the 
--EULA (http://www.sqldownload.com/eula). If you do not agree with all of these terms and conditions, do not download or use sp_whopro. If you have 
--already downloaded the sp_whopro script and do not agree to the terms and conditions, please delete the sp_whopro script and immediately discontinue its usage.
--
use master
if (object_id('sp_whopro') is NULL)
exec ('create proc sp_whopro as select ''For latest release of sp_whopro(TM) please check http://www.sqldownload.com/download''')
go
alter proc sp_whopro (@sessions nvarchar(max) = 'ACTIVE, BLOCKING', @columns nvarchar(max) = 'DEFAULT', @order_by nvarchar(max) = NULL, @save_to_database nvarchar(max) = NULL, @datetime datetime = NULL output, @datetime_to datetime = NULL, @execution_time_report_threshold int = 250) as
begin
	/*
	Copyright: 2013-2015 Ramesh Meyyappan, SQL Consulting GmbH, Munich, Germany, http://www.sqlworkshops.com.
	The sp_whopro(TM) script is registered with US Copyright Office, Registration Number: TXu001920835.

	Please email your comments, feedback and suggestions to Ramesh @ mailto:rmeyyappan@sqlworkshops.com, keep yourself up to date by subscribing to our newsletter at 
	https://newsletter.sqlworkshops.com/sp_whopro and use our support forum at http://www.sqldownload.com/forum/sp_whopro to check for answers and post your questions.
	Connect with me in LinkedIn: http://de.linkedin.com/in/rmeyyappan, on twitter https://twitter.com/SQLWorkshops.
	If you like sp_whopro, tell your friends and colleagues. Feel free to share the links in your blog and social media.

	You acknowledge upon downloading or using the sp_whopro script that you have reviewed and agreed to all of the terms and conditions set forth in the 
	EULA (http://www.sqldownload.com/eula). If You do not agree with all of these terms and conditions, do not download or use sp_whopro. If you have 
	already downloaded the sp_whopro script and do not agree to the terms and conditions, please delete the sp_whopro script and immediately discontinue its usage.
	You can download and use the sp_whopr(TM) script in accordance with the below described license types as long as the Copyright, License, About Us, rest of 
	the header information and the entire script remains intact without any alteration or modification; furthermore, sp_whopro must not be sold, re-licensed, 
	transferred or otherwise re-distributed, neither wholly nor partly, without SQL Consulting GmbH's written permission. 
	The sp_whopro script is provided on an "as is" basis without warranty of any kind, either expressed or implied.
	
	License: The sp_whopro(TM) script has the following license model: "Free Community License", "Enterprise License", "Service Provider License" and 
	"Solution Provider License"; Please read the EULA for additional information @ www.sqldownload.com/eula.
	"Free Community License" can be used for internal purposes (in any number of servers, including production servers), except in the following cases where you need an 
	"Enterprise License": a.) if you would like to download or deploy the sp_whopro script for other users in your company or organization, b.) if you want to engage a 
	third party consultant to analyze the collected data, c.) if you want to use a software, script or computer program from a third party or external consultant to process 
	the collected data or d.) if you wish to obtain email support. 
	"Free Community License" can also be used for automated processing of the data collected by the sp_whopro script, for analysis purposes or in order to set up alerts.
	
	If you are a consultant or a service provider and wish to use the sp_whopro script as part of your services to a third party, you require a "Service Provider License". 
	If you are a software developer or a solution provider and wish to use the sp_whopro script in your products, wholly or partly, you require a "Solution Provider License". 
	The cost of the "Enterprise License" is $45/ year. The "Enterprise License" grants simultaneous access to all computers on one physical site/ geographic location. 
	The "Free Community License" is incompatible with "Enterprise License", "Service Provider License", "Solution Provider License" or with any third party usage. 
	A list of Licensed Service Providers and Solution Providers can be found at http://www.sqlworkshops.com/ListofLicensedServiceSolutionTrainingProviders. 
	Please contact us at mailto:license@sqlworkshops.com to acquire the appropriate license.

	About Us:
	We are a consulting company, SQL Consulting GmbH, based in Munich, Germany. We provide onsite and offsite SQL Server Performance Tuning and Troubleshooting 
	Consulting. We can prepare SQL Server Performance, Load, Stress or Unit Test based on your workload. We conduct SQL Server Health Check and provide a list of 
	recommendations to improve performance for our customers. We provide SQL Server Performance Monitoring and Tuning Hands-on Training for developers and DBAs. 
	Please contact us at mailto:support@sqlworkshops.com or visit http://www.sqlworkshops.com if you are interested in any of our services. You will obtain a 
	complementary 1 Year "Enterprise License" if you engage us for SQL Server Consulting (4 hours or more). For customer feedback from previous engagements: 
	http://www.sqlworkshops.com/feedback, workshop agenda: http://www.sqlworkshops.com/agenda, workshop schedule: http://www.sqlworkshops.com/schedule.
	Our Mission: Empower customers to fully realize the performance potential of Microsoft SQL Server without increasing the total cost of ownership (TCO) and 
	achieve high customer satisfaction in every consulting engagement and workshop delivery.

	Download SQLTest, our SQL Server Performance, Load, Stress and Unit Test Tool from http://www.sqltest.org
	Check out our videos on sp_whopro, SQL Server and SQLTest @ http://www.sqlvideo.com

	For usage help: 'exec sp_whopro 'help'', for documentation refer to: http://www.sqldownload.com/documentation
	The stored procedure creation script is custom generated based on SQL Server Version and Service Pack. First execution of sp_whopro stored procedure may be slow, subsequent executions should be fast due to caching. To reduce execution time and disk space usage with 'SAVE' option, it is not recommended to collect 'ALL' columns. Dynamic SQL statements are only used in the following few cases: to collect DBCC INPUTBUFFER of sessions and requests, to resolve object and index names for locks, wait_resource and resource_description info, to resolve schema name, to create and to alter table and to save sp_whopro data with 'SAVE' option, to select sp_whopro result based on custom column set and custom order by clause. sp_whopro parameters are not directly used in dynamic SQL statements to avoid SQL Injection attacks. Short variable names are used to reduce the size of the stored procedure. With version independent script generator, sp_whopro stored procedure is easy to enhance. If you have additional inputs for making sp_whopro more useful or have special needs, let me know. Thanks for using sp_whopro.

	This release of sp_whopro(TM) is for Microsoft SQL Server 2014 (SP1).
	sp_whopro(TM) version 102, for latest release of sp_whopro please check http://www.sqldownload.com/download. Build id: 22BC0B9B-7E70-0752-03E3-1E18D30057A5 ChangeLog: http://www.sqldownload.com/changelog.
	*/
	set nocount on if ((substring(@@version, 11, 10) <> 'SQL Server' or cast(serverproperty('productversion') as nvarchar(4)) <> '12.0') or (cast(serverproperty ('productlevel') as nvarchar(3)) <> 'SP1')) begin print 'This release of sp_whopro(TM) is for Microsoft SQL Server 2014 (SP1). Download the compatible release from http://www.sqldownload.com/download.' end declare @254 datetime, @a09 int select @254 = getdate() if (ltrim(rtrim(upper(@sessions))) = 'HELP') begin create table #33f (cc6e int identity, ca65 nvarchar(max)) insert into #33f values ('/*	For latest build of sp_whopro, help and documentation, refer to http://www.sqldownload.com') insert into #33f values ('	sp_whopro [@sessions =] ''option[, option]'' | NULL, [@columns =] ''option[, option]'' | ''column[, column]'' | NULL, [@order_by =] ''column[, column]'' | ''help'' | NULL, [@save_to_database =] ''database_name[.schema_name]'' | NULL, [@datetime = OUTPUT] ''ctime'' | NULL, [@datetime_to =] ''ctime'' | NULL, [@execution_time_report_threshold =] milliseconds | NULL') insert into #33f values ('') insert into #33f values ('		[@sessions =] ''option[, option]'' | NULL') insert into #33f values ('		The following options are a comma separated list, can be used to filter sessions as shown below:') insert into #33f values ('			Example ACTIVE, SAVE') insert into #33f values ('			ACTIVE') insert into #33f values ('				Include Active sessions.') insert into #33f values ('			NULL') insert into #33f values ('				Include Active and Blocking sessions.') insert into #33f values ('			WAIT') insert into #33f values ('				Include Waiting sessions.') insert into #33f values ('			BLOCK') insert into #33f values ('				Include Blocked and Blocking sessions.') insert into #33f values ('			BLOCKED') insert into #33f values ('				Include Blocked sessions.') insert into #33f values ('			BLOCKING') insert into #33f values ('				Include Blocking sessions.') insert into #33f values ('			CURSOR') insert into #33f values ('				Sessions that have open cursors.') insert into #33f values ('			SP_WHOPRO') insert into #33f values ('				Include sp_whopro''s own session.') insert into #33f values ('			ALL') insert into #33f values ('				Include All sessions.') insert into #33f values ('			SAVE') insert into #33f values ('				Save output.') insert into #33f values ('			NODDL') insert into #33f values ('				To not to perform DDL statements like create or alter table part of ''SAVE'' option,') insert into #33f values ('					can reduce execution time, missing tables or columns will lead to errors.') insert into #33f values ('			NOOUTPUT') insert into #33f values ('				To not to display results, to be used in combination with ''SAVE'' option when run as a job or') insert into #33f values ('					to get the select statement when @datetime is supplied.') insert into #33f values ('		When ''not in'', ''>'', ''<'', ''='' or ''not like'' is specified include All sessions') insert into #33f values ('		The following ''in'' / ''not in'' options are a comma separated list, can be used to filter sessions as shown below:') insert into #33f values ('			Example session_id IN (57, 58)') insert into #33f values ('			Example database_name IN (''SQLDev'', ''SQLTest''), session_id NOT IN (57, 58)') insert into #33f values ('			session_id [IN | NOT IN] (?, [?])') insert into #33f values ('				List of session ids from sys.dm_exec_sessions.') insert into #33f values ('			is_user_process [IN | NOT IN] (?, [?])') insert into #33f values ('				Is user process from sys.dm_exec_sessions, 0 for system sessions, 1 for user sessions.') insert into #33f values ('			database_id [IN | NOT IN] (?, [?])') insert into #33f values ('				List of database ids from sys.dm_exec_sessions.') insert into #33f values ('			database_name [IN | NOT IN] (''?'', [''?''])') insert into #33f values ('				List of database names from sys.dm_exec_sessions.') insert into #33f values ('			status [IN | NOT IN] (''?'', [''?''])') insert into #33f values ('				List of requests status from sys.dm_exec_requests.') insert into #33f values ('			sql_handle [IN | NOT IN] (?, [?])') insert into #33f values ('				List of SQL handles from sys.dm_exec_requests.') insert into #33f values ('			plan_handle [IN | NOT IN] (?, [?])') insert into #33f values ('				List of Plan handles from sys.dm_exec_requests.') insert into #33f values ('			query_hash [IN | NOT IN] (?, [?])') insert into #33f values ('				List of query hash from sys.dm_exec_requests.') insert into #33f values ('			query_plan_hash [IN | NOT IN] (?, [?])') insert into #33f values ('				List of query plan hash from sys.dm_exec_requests.') insert into #33f values ('			Additional in / not in options: host_process_id (from sys.dm_exec_sessions), context_info (from sys.dm_exec_sessions),') insert into #33f values ('				transaction_isolation_level (from sys.dm_exec_sessions ), group_id (from sys.dm_exec_sessions), node_affinity (from') insert into #33f values ('				sys.dm_exec_connections), connection_id (from sys.dm_exec_connections), most_recent_sql_handle (from sys.dm_exec_connections),') insert into #33f values ('				request_id (from sys.dm_exec_requests), command (from sys.dm_exec_requests), statement_start_offset (from sys.dm_exec_requests),') insert into #33f values ('				statement_end_offset (from sys.dm_exec_requests), blocking_session_id (from sys.dm_exec_requests), transaction_id (from') insert into #33f values ('				sys.dm_exec_requests), scheduler_id (from sys.dm_exec_requests), executing_managed_code (from sys.dm_exec_requests).') insert into #33f values ('		The following ''>'' / ''<'' / ''='' range options can be used to filter sessions as shown below:') insert into #33f values ('			Example wait > 1000, wait_time < 20000') insert into #33f values ('			Example total_elapsed_time > 10000, cpu_time > 1000') insert into #33f values ('			wait_time [> | < | =] ?') insert into #33f values ('				Wait time from sys.dm_exec_requests.') insert into #33f values ('			cpu_time [> | < | =] ?') insert into #33f values ('				CPU time from sys.dm_exec_requests.') insert into #33f values ('			total_elapsed_time [> | < | =] ?') insert into #33f values ('				Total elapsed time (duration) from sys.dm_exec_requests.') insert into #33f values ('			reads [> | < | =] ?') insert into #33f values ('				Reads from sys.dm_exec_requests.') insert into #33f values ('			logical_reads [> | < | =] ?') insert into #33f values ('				Logical Reads from sys.dm_exec_requests.') insert into #33f values ('			Additional range options: login_time (from sys.dm_exec_sessions), open_transaction_count (from sys.dm_exec_sessions),') insert into #33f values ('				num_reads (from sys.dm_exec_connections), num_writes (from sys.dm_exec_connections), writes (from sys.dm_exec_requests),') insert into #33f values ('				row_count (from sys.dm_exec_requests), nest_level (from sys.dm_exec_requests), granted_query_memory (from sys.dm_exec_requests).') insert into #33f values ('		The following ''like'' / ''not like'' options can be used to filter sessions as shown below:') insert into #33f values ('			Example wait_type LIKE ''LCK%''') insert into #33f values ('			Example program_name LIKE ''SQLTest%'', wait_type NOT LIKE ''ASYNC_NETWORK_IO''') insert into #33f values ('			host_name [LIKE | NOT LIKE ] ''?''') insert into #33f values ('				Host Name from sys.dm_exec_sessions.') insert into #33f values ('			program_name [LIKE | NOT LIKE ] ''?''') insert into #33f values ('				Program Name from sys.dm_exec_sessions.') insert into #33f values ('			login_name [LIKE | NOT LIKE ] ''?''') insert into #33f values ('				Login Name from sys.dm_exec_sessions.') insert into #33f values ('			wait_type [LIKE | NOT LIKE ] ''?''') insert into #33f values ('				Wait type from sys.dm_exec_requests.') insert into #33f values ('			wait_resource [LIKE | NOT LIKE ] ''?''') insert into #33f values ('				Wait resource from sys.dm_exec_requests.') insert into #33f values ('			Additional like / not like options: nt_domain (from sys.dm_exec_sessions), nt_user_name (from sys.dm_exec_sessions),') insert into #33f values ('') insert into #33f values ('		[@columns =] ''option[, option]'' | ''column[, column]'' | NULL') insert into #33f values ('			Example login_name, CPU, WAIT, DETAILED') insert into #33f values ('			Example r.cpu_time r.total_elapsed_time, wait_type, wait_time') insert into #33f values ('			The following options are a comma separated list, can be used to choose output columns as shown below:') insert into #33f values ('			LIMITED') insert into #33f values ('				Outputs a small set of columns.') insert into #33f values ('			DEFAULT') insert into #33f values ('				Outputs medium set of columns.') insert into #33f values ('			NULL') insert into #33f values ('				Outputs medium set of columns.') insert into #33f values ('			DETAILED') insert into #33f values ('				Outputs large set of columns when specified alone otherwise outputs large set of column associated to options chosen.') insert into #33f values ('			ALL') insert into #33f values ('				Outputs all columns, it is recommended to avoid ''ALL'' option, to reduce execution time and storage overhead.') insert into #33f values ('			CPU | CPU_DETAILED | PROCESSOR | PROCESSOR_DETAILED') insert into #33f values ('				Outputs CPU related columns.') insert into #33f values ('			IO | IO_DETAILED | DISK | DISK_DETAILED | STORAGE | STORAGE_DETAILED') insert into #33f values ('				Outputs IO related columns.') insert into #33f values ('			MEMORY | MEMORY_DETAILED') insert into #33f values ('				Outputs memory related columns.') insert into #33f values ('			NETWORK | NETWORK_DETAILED') insert into #33f values ('				Outputs network related columns.') insert into #33f values ('			WAIT | WAIT_DETAILED | WAITS | WAITS_DETAILED') insert into #33f values ('				Outputs wait related columns.') insert into #33f values ('			BLOCK | BLOCK_DETAILED | BLOCKED | BLOCKED_DETAILED | BLOCKING | BLOCKING_DETAILED') insert into #33f values ('				Outputs blocking related columns.') insert into #33f values ('			LOCK | LOCK_DETAILED | LOCKS | LOCKS_DETAILED') insert into #33f values ('				Outputs lock related columns for blocked and blocking sessions.') insert into #33f values ('			ALLLOCKS | ALLLOCKS_DETAILED') insert into #33f values ('				Outputs lock related columns for all sessions.') insert into #33f values ('			TRAN | TRAN_DETAILED | TRANS | TRANS_DETAILED | TRANSACTION | TRANSACTION_DETAILED | TRANSACTIONS | TRANSACTIONS_DETAILED') insert into #33f values ('				Outputs transaction related columns.') insert into #33f values ('			SQL | SQL_DETAILED') insert into #33f values ('				Outputs sql text related columns.') insert into #33f values ('			SQLASTEXT') insert into #33f values ('				Outputs selected SQL text columns as text instead of XML. Without this option') insert into #33f values ('					selected SQL text columns are output as XML, non-printable characters are replaced with [nchar(?)]') insert into #33f values ('			PLAN | PLAN_DETAILED | PLANS | PLANS_DETAILED') insert into #33f values ('				Outputs execution plan related columns.') insert into #33f values ('			QUERY_PROFILES | QUERY_PROFILES_DETAILED | QUERY_PROFILE | QUERY_PROFILE_DETAILED') insert into #33f values ('				Outputs query profile related columns.') insert into #33f values ('			STATS | STATS_DETAILED | STATISTICS | STATISTICS_DETAILED') insert into #33f values ('				Outputs query, procedure and trigger statistics related columns.') insert into #33f values ('			TEMPDB | TEMPDB_DETAILED') insert into #33f values ('				Outputs tempdb related columns.') insert into #33f values ('			CURSOR | CURSOR_DETAILED | CURSORS | CURSORS_DETAILED') insert into #33f values ('				Outputs cursor related columns.') insert into #33f values ('			TASK | TASK_DETAILED | TASKS | TASKS_DETAILED') insert into #33f values ('				Outputs task related columns.') insert into #33f values ('			WORKER | WORKER_DETAILED | WORKERS | WORKERS_DETAILED') insert into #33f values ('				Outputs worker related columns.') insert into #33f values ('			THREAD | THREAD_DETAILED | THREADS,THREADS_DETAILED') insert into #33f values ('				Outputs thread related columns.') insert into #33f values ('			SESSION | SESSION_DETAILED | SESSIONS | SESSIONS_DETAILED') insert into #33f values ('				Outputs session related columns.') insert into #33f values ('			CONNECTION | CONNECTION_DETAILED | CONNECTIONS | CONNECTIONS_DETAILED') insert into #33f values ('				Outputs connection related columns.') insert into #33f values ('			REQUEST | REQUEST_DETAILED | REQUESTS | REQUESTS_DETAILED') insert into #33f values ('				Outputs request related columns.') insert into #33f values ('			PLAN_ATTRIBUTE | PLAN_ATTRIBUTE_DETAILED | PLAN_ATTRIBUTES | PLAN_ATTRIBUTES_DETAILED') insert into #33f values ('				Outputs plan attribute related columns.') insert into #33f values ('			INPUTPARAMETER | INPUTPARAMETERS') insert into #33f values ('				Outputs @sessions, @columns and @order_by parameters.') insert into #33f values ('			CUSTOM | CUSTOM_DETAILED') insert into #33f values ('				Outputs custom columns, contact Ramesh Meyyappan at mailto:rmeyyappan@sqlworkshops.com for details.') insert into #33f values ('			input_buffer') insert into #33f values ('				Outputs input buffer for requests from sys.dm_exec_requests based on session_id and request_id,') insert into #33f values ('					for sessions from sys.dm_exec_sessions based on session_id.') insert into #33f values ('			s.input_buffer') insert into #33f values ('				Outputs input buffer for sessions from sys.dm_exec_sessions based on session_id.') insert into #33f values ('			r.input_buffer') insert into #33f values ('				Outputs input buffer for requests from sys.dm_exec_requests based on session_id and request_id.') insert into #33f values ('			text_object_name') insert into #33f values ('				Outputs object name for requests from sys.dm_exec_query_text based on sys.dm_exec_requests''s sql_handle,') insert into #33f values ('					for connections from sys.dm_exec_query_text based on sys.dm_exec_connections''s most_recent_sql_handle.') insert into #33f values ('			text') insert into #33f values ('				Outputs text for requests from sys.dm_exec_query_text based on sys.dm_exec_requests''s sql_handle,') insert into #33f values ('					for connections from sys.dm_exec_query_text based on sys.dm_exec_connections''s most_recent_sql_handle.') insert into #33f values ('			c.text_object_name') insert into #33f values ('				Outputs object name for connections from sys.dm_exec_query_text based on sys.dm_exec_connections''s most_recent_sql_handle.') insert into #33f values ('			c.text') insert into #33f values ('				Outputs text for connections from sys.dm_exec_query_text based on sys.dm_exec_connections''s most_recent_sql_handle.') insert into #33f values ('			r.text_object_name') insert into #33f values ('				Outputs object name for requests from sys.dm_exec_query_text based on sys.dm_exec_requests''s sql_handle.') insert into #33f values ('			r.text') insert into #33f values ('				Outputs text for requests from sys.dm_exec_query_text based on sys.dm_exec_requests''s sql_handle.') insert into #33f values ('			statement_object_name, r.statement_object_name') insert into #33f values ('				Outputs object name from sys.dm_exec_query_text based on sys.dm_exec_requests''s sql_handle.') insert into #33f values ('			statement, r.statement') insert into #33f values ('				Outputs statement, substring of text, for requests from sys.dm_exec_query_text based on sys.dm_exec_requests''s sql_handle,') insert into #33f values ('					statement_start_offset and statement_end_offset.') insert into #33f values ('			query_plan, r.query_plan') insert into #33f values ('				Outputs query plan for requests from sys.dm_exec_query_plan based on sys.dm_exec_requests''s plan_handle.') insert into #33f values ('			query_plan_checksum, r.query_plan_checksum') insert into #33f values ('				Outputs query plan checksum, based on query plan, used while saving to avoid duplicate entries.') insert into #33f values ('			text_query_plan, r.text_query_plan') insert into #33f values ('				Outputs text query plan as xml for requests from sys.dm_exec_text_query_plan based on sys.dm_exec_requests''s plan_handle,') insert into #33f values ('					statement_start_offset and statement_end_offset. ') insert into #33f values ('			text_query_plan_as_text, r.text_query_plan_as_text') insert into #33f values ('				Outputs text query plan as text for requests from sys.dm_exec_text_query_plan based on sys.dm_exec_requests''s plan_handle,') insert into #33f values ('					statement_start_offset and statement_end_offset. To avoid error 6335, XML datatype instance has too many levels of nested nodes. ') insert into #33f values ('					Maximum allowed depth is 128 levels.') insert into #33f values ('			full_text_query_plan, r.full_text_query_plan') insert into #33f values ('				Outputs complete text query plan as xml for requests from sys.dm_exec_text_query_plan based on sys.dm_exec_requests''s plan_handle') insert into #33f values ('					with statement_start_offset as 0 and statement_end_offset -1.') insert into #33f values ('			full_text_query_plan_as_text, r.full_text_query_plan_as_text') insert into #33f values ('				Outputs complete text query plan as text for requests from sys.dm_exec_text_query_plan based on sys.dm_exec_requests''s plan_handle') insert into #33f values ('					with statement_start_offset as 0 and statement_end_offset -1. To avoid error 6335, XML datatype instance has too many levels of nested nodes.') insert into #33f values ('					Maximum allowed depth is 128 levels.') insert into #33f values ('			plan_attributes_info, r.plan_attributes_info') insert into #33f values ('				Outputs plan attributes for requests from sys.dm_exec_query_plan based on sys.dm_exec_requests''s plan_handle.') insert into #33f values ('			ctime, s.ctime, c.ctime, r.ctime') insert into #33f values ('				Outputs collection time, available with ''SAVE'' option or when @datetime is not NULL.') insert into #33f values ('			servername, s.servername, c.servername, r.servername') insert into #33f values ('				Outputs server name where data was collected, available with ''SAVE'' option or when @datetime is not NULL.') insert into #33f values ('			The following columns are a comma separated list, can be used to choose output columns (SSMS might truncate the below output to 256 characters with ''Results to Text'', use ''Results to Grid'' instead):') insert into #33f values ('				session_id, login_time, host_name, program_name, host_process_id, client_version, client_interface_name, security_id, login_name, nt_domain, nt_user_name, status, context_info, cpu_time, memory_usage, total_scheduled_time, total_elapsed_time, endpoint_id, last_request_start_time, last_request_end_time, reads, writes, logical_reads, is_user_process, text_size, language, date_format, date_first, quoted_identifier, arithabort, ansi_null_dflt_on, ansi_defaults, ansi_warnings, ansi_padding, ansi_nulls, concat_null_yields_null, transaction_isolation_level, lock_timeout, deadlock_priority, row_count, prev_error, original_security_id, original_login_name, last_successful_logon, last_unsuccessful_logon, unsuccessful_logons, group_id, database_id, authenticating_database_id, open_transaction_count, session_id, most_recent_session_id, connect_time, net_transport, protocol_type, protocol_version, endpoint_id, encrypt_option, auth_scheme, node_affinity, num_reads, num_writes, last_read, last_write, net_packet_size, client_net_address, client_tcp_port, local_net_address, local_tcp_port, connection_id, parent_connection_id, most_recent_sql_handle, session_id, request_id, start_time, status, command, sql_handle, statement_start_offset, statement_end_offset, plan_handle, database_id, user_id, connection_id, blocking_session_id, wait_type, wait_time, last_wait_type, wait_resource, open_transaction_count, open_resultset_count, transaction_id, context_info, percent_complete, estimated_completion_time, cpu_time, total_elapsed_time, scheduler_id, task_address, reads, writes, logical_reads, text_size, language, date_format, date_first, quoted_identifier, arithabort, ansi_null_dflt_on, ansi_defaults, ansi_warnings, ansi_padding, ansi_nulls, concat_null_yields_null, transaction_isolation_level, lock_timeout, deadlock_priority, row_count, prev_error, nest_level, granted_query_memory, executing_managed_code, group_id, query_hash, query_plan_hash, statement_sql_handle, statement_context_id, session_id, job_info, is_blocker, is_head_blocker, blocked_session_ids, input_buffer_checksum, input_buffer_valid_flag, lock_count, lock_owner_id, locks_info, transaction_begin_time, transaction_log_record_count, transaction_log_bytes_used, transaction_info, session_tempdb_usage_kb, session_max_tempdb_usage_kb, session_tempdb_usage_info, cursor_count, max_cursor_dormant_duration, cursors_info, waiting_tasks_wait_types, waiting_tasks_max_wait_duration_ms, waiting_tasks_blocking_session_ids, waiting_tasks_valid_flag, waiting_tasks_info, service_broker_info, sp_whopro_inputparameters, custom_info, session_id, connection_id, query_stats_info, procedure_stats_info, trigger_stats_info, session_id, request_id, connection_id, is_blocked, is_dead_locked, blocker_session_ids, head_blocker_session_ids, input_buffer_checksum, input_buffer_valid_flag, wait_resource_info, lock_count, lock_owner_id, locks_info, transaction_begin_time, transaction_info, task_tempdb_usage_kb, task_max_tempdb_usage_kb, task_tempdb_usage_info, query_memory_grants_requested_memory_kb, query_memory_grants_granted_memory_kb, query_memory_grants_used_memory_kb, query_memory_grants_max_used_memory_kb, query_memory_grants_wait_time_ms, query_memory_grants_ideal_memory_kb, query_memory_grants_info, query_profiles_cpu_time_ms, query_profiles_logical_read_count, query_profiles_physical_read_count, query_profiles_read_ahead_count, query_profiles_write_page_count, query_profiles_info, query_stats_info, procedure_stats_info, trigger_stats_info, cached_plans_info, tasks_count, tasks_context_switches, tasks_pending_io, tasks_io_size_kb, read_bytes_per_second, tasks_ios_per_second, tasks_info, workers_info, threads_info, query_plan_text_checksum, custom_info') insert into #33f values ('				s.session_id, s.login_time, s.host_name, s.program_name, s.host_process_id, s.client_version, s.client_interface_name, s.security_id, s.login_name, s.nt_domain, s.nt_user_name, s.status, s.context_info, s.cpu_time, s.memory_usage, s.total_scheduled_time, s.total_elapsed_time, s.endpoint_id, s.last_request_start_time, s.last_request_end_time, s.reads, s.writes, s.logical_reads, s.is_user_process, s.text_size, s.language, s.date_format, s.date_first, s.quoted_identifier, s.arithabort, s.ansi_null_dflt_on, s.ansi_defaults, s.ansi_warnings, s.ansi_padding, s.ansi_nulls, s.concat_null_yields_null, s.transaction_isolation_level, s.lock_timeout, s.deadlock_priority, s.row_count, s.prev_error, s.original_security_id, s.original_login_name, s.last_successful_logon, s.last_unsuccessful_logon, s.unsuccessful_logons, s.group_id, s.database_id, s.authenticating_database_id, s.open_transaction_count') insert into #33f values ('				c.session_id, c.most_recent_session_id, c.connect_time, c.net_transport, c.protocol_type, c.protocol_version, c.endpoint_id, c.encrypt_option, c.auth_scheme, c.node_affinity, c.num_reads, c.num_writes, c.last_read, c.last_write, c.net_packet_size, c.client_net_address, c.client_tcp_port, c.local_net_address, c.local_tcp_port, c.connection_id, c.parent_connection_id, c.most_recent_sql_handle') insert into #33f values ('				r.session_id, r.request_id, r.start_time, r.status, r.command, r.sql_handle, r.statement_start_offset, r.statement_end_offset, r.plan_handle, r.database_id, r.user_id, r.connection_id, r.blocking_session_id, r.wait_type, r.wait_time, r.last_wait_type, r.wait_resource, r.open_transaction_count, r.open_resultset_count, r.transaction_id, r.context_info, r.percent_complete, r.estimated_completion_time, r.cpu_time, r.total_elapsed_time, r.scheduler_id, r.task_address, r.reads, r.writes, r.logical_reads, r.text_size, r.language, r.date_format, r.date_first, r.quoted_identifier, r.arithabort, r.ansi_null_dflt_on, r.ansi_defaults, r.ansi_warnings, r.ansi_padding, r.ansi_nulls, r.concat_null_yields_null, r.transaction_isolation_level, r.lock_timeout, r.deadlock_priority, r.row_count, r.prev_error, r.nest_level, r.granted_query_memory, r.executing_managed_code, r.group_id, r.query_hash, r.query_plan_hash, r.statement_sql_handle, r.statement_context_id') insert into #33f values ('				s.job_info, s.is_blocker, s.is_head_blocker, s.blocked_session_ids, s.input_buffer_checksum, s.input_buffer_valid_flag, s.lock_count, s.lock_owner_id, s.locks_info, s.transaction_begin_time, s.transaction_log_record_count, s.transaction_log_bytes_used, s.transaction_info, s.session_tempdb_usage_kb, s.session_max_tempdb_usage_kb, s.session_tempdb_usage_info, s.cursor_count, s.max_cursor_dormant_duration, s.cursors_info, s.waiting_tasks_wait_types, s.waiting_tasks_max_wait_duration_ms, s.waiting_tasks_blocking_session_ids, s.waiting_tasks_valid_flag, s.waiting_tasks_info, s.service_broker_info, s.sp_whopro_inputparameters, s.custom_info') insert into #33f values ('				c.query_stats_info, c.procedure_stats_info, c.trigger_stats_info') insert into #33f values ('				r.is_blocked, r.is_dead_locked, r.blocker_session_ids, r.head_blocker_session_ids, r.input_buffer_checksum, r.input_buffer_valid_flag, r.wait_resource_info, r.lock_count, r.lock_owner_id, r.locks_info, r.transaction_begin_time, r.transaction_info, r.task_tempdb_usage_kb, r.task_max_tempdb_usage_kb, r.task_tempdb_usage_info, r.query_memory_grants_requested_memory_kb, r.query_memory_grants_granted_memory_kb, r.query_memory_grants_used_memory_kb, r.query_memory_grants_max_used_memory_kb, r.query_memory_grants_wait_time_ms, r.query_memory_grants_ideal_memory_kb, r.query_memory_grants_info, r.query_profiles_cpu_time_ms, r.query_profiles_logical_read_count, r.query_profiles_physical_read_count, r.query_profiles_read_ahead_count, r.query_profiles_write_page_count, r.query_profiles_info, r.query_stats_info, r.procedure_stats_info, r.trigger_stats_info, r.cached_plans_info, r.tasks_count, r.tasks_context_switches, r.tasks_pending_io, r.tasks_io_size_kb, r.read_bytes_per_second, r.tasks_ios_per_second, r.tasks_info, r.workers_info, r.threads_info, r.query_plan_text_checksum, r.custom_info') insert into #33f values ('') insert into #33f values ('		[@order_by =] ''column[, column]'' | ''help'' | NULL') insert into #33f values ('			When NULL, if @sessions parameter includes ''SAVE'' option, ordered by s.ctime, s.session_id else ordered by s.session_id.') insert into #33f values ('			When ''help'', outputs source select statement to help choose column aliases for use in order by.') insert into #33f values ('			When not NULL, ordered by column(s) specified') insert into #33f values ('			Comma separated list of column aliases, column[, column].') insert into #33f values ('				Can contain any column aliases that are present in select clause, expressions are not allowed to prevent SQL Injection attacks.') insert into #33f values ('			Example r.cpu_time desc') insert into #33f values ('			Example s.login_name') insert into #33f values ('			Example rs.database_id') insert into #33f values ('			Example rs.database_name, s.login_name') insert into #33f values ('') insert into #33f values ('		[@save_to_database =] ''database_name[.schema_name]'' | NULL') insert into #33f values ('			Can be used to save and retrieve data from a specific database and optionally specific schema:') insert into #33f values ('			When NULL, saved in current database in dbo schema.') insert into #33f values ('			When not NULL, saved or retrieve from specified database and optionally specified schema') insert into #33f values ('			When enclosed with delimiter ''['' and '']'', can contain special characters') insert into #33f values ('			Example @save_to_database = ''sp_whopro_db''') insert into #33f values ('			Example @save_to_database = ''sp_whopro_db.sqlws''') insert into #33f values ('			Example @save_to_database = ''[sp whopro db]''') insert into #33f values ('			Example @save_to_database = ''[sp whopro db].[sql ws]''') insert into #33f values ('') insert into #33f values ('		[@datetime = OUTPUT] ''ctime'' | NULL') insert into #33f values ('			When NULL and @sessions parameter includes ''SAVE'' option, outputs ctime, the collection time.') insert into #33f values ('			When not NULL, returns previously saved data where ctime = @datetime') insert into #33f values ('			Example @datetime = ' + cast(cast(dateadd(day, -1, getdate()) as date) as varchar(10)) + ' 09:00:00.000' + '') insert into #33f values ('				Returns previously saved data where ctime = ' + cast(cast(dateadd(day, -1, getdate()) as date) as varchar(10)) + ' 09:00:00.000' + '.') insert into #33f values ('			Can be combined with @columns parameter to choose columns displayed.') insert into #33f values ('			When @sessions parameter includes ''NOOUTPUT'' option, outputs the select statement instead of the rseults.') insert into #33f values ('') insert into #33f values ('		[@datetime_to =] ''ctime'' | NULL') insert into #33f values ('			When not NULL, returns previously saved data where ctime between @datetime and @datetime_to') insert into #33f values ('			Example @datetime_to = ' + cast(cast(dateadd(day, 1, getdate()) as date) as varchar(10)) + ' 12:00:00.000' + '') insert into #33f values ('				Returns previously saved data where ctime between ' + cast(cast(dateadd(day, -1, getdate()) as date) as varchar(10)) + ' 09:00:00.000' + ' and ' + cast(cast(dateadd(day, 1, getdate()) as date) as varchar(10)) + ' 12:00:00.000' + '.') insert into #33f values ('') insert into #33f values ('		[@execution_time_report_threshold =] milliseconds | NULL') insert into #33f values ('			When not NULL, prints sp_whopro internal statements that exceeds the @execution_time_report_threshold value,') insert into #33f values ('				 this is to trace long executing sp_whopro internal queries') insert into #33f values ('			When NULL, @execution_time_report_threshold is 250 milliseconds') insert into #33f values ('			Example @execution_time_report_threshold = 100') insert into #33f values ('				Prints sp_whopro internal statements that exceeds 100 milliseconds execution time.') insert into #33f values ('Usage Examples:') insert into #33f values ('--Example parameters to monitor waits, blocking and corresponding locks:') insert into #33f values ('exec sp_whopro ''active, blocking'', ''sql, wait, block, locks, limited''') insert into #33f values ('go') insert into #33f values ('') insert into #33f values ('--Example parameters to monitor waits, blocking and corresponding locks and to save the data to current database:') insert into #33f values ('exec sp_whopro ''active, blocking, save'', ''sql, wait, block, locks, limited''') insert into #33f values ('go') insert into #33f values ('') insert into #33f values ('--Example parameters to monitor waits, blocking and corresponding locks and to save the data to ''sp_whopro_db'' database in a SQL Agent job without output:') insert into #33f values ('exec sp_whopro ''active, blocking, save, nooutput'', ''sql, wait, block, locks, limited'', null, ''sp_whopro_db''') insert into #33f values ('go') insert into #33f values ('') insert into #33f values ('--Example parameters to retrieve saved data from ''sp_whopro_db'' database:') insert into #33f values ('exec sp_whopro null, ''sql, wait, block, locks, limited'', null, ''sp_whopro_db'', ''2014-10-16 08:24:13.270'',''2014-10-18 08:24:13.270''') insert into #33f values ('') insert into #33f values ('--Example parameters to output the select statement used to retrieve saved data from ''sp_whopro_db'' database:') insert into #33f values ('exec sp_whopro ''nooutput'', ''sql, wait, block, locks, limited'', null, ''sp_whopro_db'', ''2014-10-16 08:24:13.270'',''2014-10-18 08:24:13.270''') insert into #33f values ('go') insert into #33f values (' ') insert into #33f values ('Deleting old data:') insert into #33f values ('Tables sqlws_dm_exec_requests, sqlws_dm_exec_connections and sqlws_dm_exec_sessions have ctime, the collection time column that can be used for data purging.') insert into #33f values ('Tables sqlws_input_buffer, sqlws_dm_exec_sql_text, sqlws_dm_exec_query_plan, sqlws_dm_exec_text_query_plan, sqlws_dm_exec_query_plan_checksum and sqlws_dm_exec_plan_attributes have ctime, the collection time, in addition they have rtime, the last reference time and rcount, the reference count column that can be used for data purging.') insert into #33f values (' ') insert into #33f values ('*/') select ca65 as 'sp_whopro help' from #33f order by cc6e return 0 end create table #d43f_3ff (cc6e int identity, cad83 smallint, cdd9 bit) declare @d43f_d17 bit declare @d43f_e19 bit set @d43f_d17 = 0 set @d43f_e19 = 0 create table #9e0b_3ff (cc6e int identity, c5783 int, cdd9 bit) declare @9e0b_d17 bit declare @9e0b_e19 bit set @9e0b_d17 = 0 set @9e0b_e19 = 0 create table #083d_3ff (cc6e int identity, c0470 varbinary(128), cdd9 bit) declare @083d_d17 bit declare @083d_e19 bit set @083d_d17 = 0 set @083d_e19 = 0 create table #c886_3ff (cc6e int identity, c312c bit, cdd9 bit) declare @c886_d17 bit declare @c886_e19 bit set @c886_d17 = 0 set @c886_e19 = 0 create table #8572_3ff (cc6e int identity, c55ce smallint, cdd9 bit) declare @8572_d17 bit declare @8572_e19 bit set @8572_d17 = 0 set @8572_e19 = 0 create table #52d2_3ff (cc6e int identity, cd5e2 int, cdd9 bit) declare @52d2_d17 bit declare @52d2_e19 bit set @52d2_d17 = 0 set @52d2_e19 = 0 create table #d24d_3ff (cc6e int identity, ca808 smallint, cdd9 bit) declare @d24d_d17 bit declare @d24d_e19 bit set @d24d_d17 = 0 set @d24d_e19 = 0 create table #5f33_3ff (cc6e int identity, cb693 smallint, cdd9 bit) declare @5f33_d17 bit declare @5f33_e19 bit set @5f33_d17 = 0 set @5f33_e19 = 0 create table #9b90_3ff (cc6e int identity, cd07c uniqueidentifier, cdd9 bit) declare @9b90_d17 bit declare @9b90_e19 bit set @9b90_d17 = 0 set @9b90_e19 = 0 create table #6a56_3ff (cc6e int identity, cb8a8 varbinary(64), cdd9 bit) declare @6a56_d17 bit declare @6a56_e19 bit set @6a56_d17 = 0 set @6a56_e19 = 0 create table #9d74_3ff (cc6e int identity, c4643 int, cdd9 bit) declare @9d74_d17 bit declare @9d74_e19 bit set @9d74_d17 = 0 set @9d74_e19 = 0 create table #2db7_3ff (cc6e int identity, c25cc nvarchar(30), cdd9 bit) declare @2db7_d17 bit declare @2db7_e19 bit set @2db7_d17 = 0 set @2db7_e19 = 0 create table #8ca4_3ff (cc6e int identity, caace nvarchar(32), cdd9 bit) declare @8ca4_d17 bit declare @8ca4_e19 bit set @8ca4_d17 = 0 set @8ca4_e19 = 0 create table #1532_3ff (cc6e int identity, c1276 varbinary(64), cdd9 bit) declare @1532_d17 bit declare @1532_e19 bit set @1532_d17 = 0 set @1532_e19 = 0 create table #2947_3ff (cc6e int identity, c336f int, cdd9 bit) declare @2947_d17 bit declare @2947_e19 bit set @2947_d17 = 0 set @2947_e19 = 0 create table #82a0_3ff (cc6e int identity, c60dd int, cdd9 bit) declare @82a0_d17 bit declare @82a0_e19 bit set @82a0_d17 = 0 set @82a0_e19 = 0 create table #e847_3ff (cc6e int identity, cfcb8 varbinary(64), cdd9 bit) declare @e847_d17 bit declare @e847_e19 bit set @e847_d17 = 0 set @e847_e19 = 0 create table #1144_3ff (cc6e int identity, cb6a4 smallint, cdd9 bit) declare @1144_d17 bit declare @1144_e19 bit set @1144_d17 = 0 set @1144_e19 = 0 create table #c026_3ff (cc6e int identity, c54ac bigint, cdd9 bit) declare @c026_d17 bit declare @c026_e19 bit set @c026_d17 = 0 set @c026_e19 = 0 create table #4617_3ff (cc6e int identity, ca694 int, cdd9 bit) declare @4617_d17 bit declare @4617_e19 bit set @4617_d17 = 0 set @4617_e19 = 0 create table #c3e1_3ff (cc6e int identity, c7e3e bit, cdd9 bit) declare @c3e1_d17 bit declare @c3e1_e19 bit set @c3e1_d17 = 0 set @c3e1_e19 = 0 create table #ad99_3ff (cc6e int identity, cdd5b binary(8), cdd9 bit) declare @ad99_d17 bit declare @ad99_e19 bit set @ad99_d17 = 0 set @ad99_e19 = 0 create table #2cbb_3ff (cc6e int identity, cf1e0 binary(8), cdd9 bit) declare @2cbb_d17 bit declare @2cbb_e19 bit set @2cbb_d17 = 0 set @2cbb_e19 = 0 create table #85bd_3ff (cc6e int identity, cec3c datetime, cfbc char(1)) declare @85bd_d17 bit declare @85bd_37a bit declare @85bd_81b bit declare @85bd_01e bit set @85bd_d17 = 0 set @85bd_37a = 0 set @85bd_81b = 0 set @85bd_01e = 0 create table #01d0_3ff (cc6e int identity, ca604 int, cfbc char(1)) declare @01d0_d17 bit declare @01d0_37a bit declare @01d0_81b bit declare @01d0_01e bit set @01d0_d17 = 0 set @01d0_37a = 0 set @01d0_81b = 0 set @01d0_01e = 0 create table #75d5_3ff (cc6e int identity, cb29d int, cfbc char(1)) declare @75d5_d17 bit declare @75d5_37a bit declare @75d5_81b bit declare @75d5_01e bit set @75d5_d17 = 0 set @75d5_37a = 0 set @75d5_81b = 0 set @75d5_01e = 0 create table #b7fa_3ff (cc6e int identity, cb940 int, cfbc char(1)) declare @b7fa_d17 bit declare @b7fa_37a bit declare @b7fa_81b bit declare @b7fa_01e bit set @b7fa_d17 = 0 set @b7fa_37a = 0 set @b7fa_81b = 0 set @b7fa_01e = 0 create table #d72b_3ff (cc6e int identity, caa9e int, cfbc char(1)) declare @d72b_d17 bit declare @d72b_37a bit declare @d72b_81b bit declare @d72b_01e bit set @d72b_d17 = 0 set @d72b_37a = 0 set @d72b_81b = 0 set @d72b_01e = 0 create table #3898_3ff (cc6e int identity, c0dfe int, cfbc char(1)) declare @3898_d17 bit declare @3898_37a bit declare @3898_81b bit declare @3898_01e bit set @3898_d17 = 0 set @3898_37a = 0 set @3898_81b = 0 set @3898_01e = 0 create table #c5d0_3ff (cc6e int identity, c7334 int, cfbc char(1)) declare @c5d0_d17 bit declare @c5d0_37a bit declare @c5d0_81b bit declare @c5d0_01e bit set @c5d0_d17 = 0 set @c5d0_37a = 0 set @c5d0_81b = 0 set @c5d0_01e = 0 create table #60b2_3ff (cc6e int identity, c93c1 bigint, cfbc char(1)) declare @60b2_d17 bit declare @60b2_37a bit declare @60b2_81b bit declare @60b2_01e bit set @60b2_d17 = 0 set @60b2_37a = 0 set @60b2_81b = 0 set @60b2_01e = 0 create table #a140_3ff (cc6e int identity, cac7f bigint, cfbc char(1)) declare @a140_d17 bit declare @a140_37a bit declare @a140_81b bit declare @a140_01e bit set @a140_d17 = 0 set @a140_37a = 0 set @a140_81b = 0 set @a140_01e = 0 create table #4092_3ff (cc6e int identity, c8946 bigint, cfbc char(1)) declare @4092_d17 bit declare @4092_37a bit declare @4092_81b bit declare @4092_01e bit set @4092_d17 = 0 set @4092_37a = 0 set @4092_81b = 0 set @4092_01e = 0 create table #b1a9_3ff (cc6e int identity, ceb65 bigint, cfbc char(1)) declare @b1a9_d17 bit declare @b1a9_37a bit declare @b1a9_81b bit declare @b1a9_01e bit set @b1a9_d17 = 0 set @b1a9_37a = 0 set @b1a9_81b = 0 set @b1a9_01e = 0 create table #1fa1_3ff (cc6e int identity, c9d64 int, cfbc char(1)) declare @1fa1_d17 bit declare @1fa1_37a bit declare @1fa1_81b bit declare @1fa1_01e bit set @1fa1_d17 = 0 set @1fa1_37a = 0 set @1fa1_81b = 0 set @1fa1_01e = 0 create table #2055_3ff (cc6e int identity, c5c53 int, cfbc char(1)) declare @2055_d17 bit declare @2055_37a bit declare @2055_81b bit declare @2055_01e bit set @2055_d17 = 0 set @2055_37a = 0 set @2055_81b = 0 set @2055_01e = 0 create table #2256_3ff (cc6e int identity, c9e53 nvarchar(128), cdd9 bit) declare @2256_d17 bit declare @2256_e19 bit set @2256_d17 = 0 set @2256_e19 = 0 create table #6637_3ff (cc6e int identity, c7a8a nvarchar(128), cdd9 bit) declare @6637_d17 bit declare @6637_e19 bit set @6637_d17 = 0 set @6637_e19 = 0 create table #3d08_3ff (cc6e int identity, cd68f nvarchar(128), cdd9 bit) declare @3d08_d17 bit declare @3d08_e19 bit set @3d08_d17 = 0 set @3d08_e19 = 0 create table #863e_3ff (cc6e int identity, cb91d nvarchar(128), cdd9 bit) declare @863e_d17 bit declare @863e_e19 bit set @863e_d17 = 0 set @863e_e19 = 0 create table #74cb_3ff (cc6e int identity, ca53e nvarchar(128), cdd9 bit) declare @74cb_d17 bit declare @74cb_e19 bit set @74cb_d17 = 0 set @74cb_e19 = 0 create table #3379_3ff (cc6e int identity, c685a varchar(48), cdd9 bit) declare @3379_d17 bit declare @3379_e19 bit set @3379_d17 = 0 set @3379_e19 = 0 create table #8969_3ff (cc6e int identity, c5226 nvarchar(60), cdd9 bit) declare @8969_d17 bit declare @8969_e19 bit set @8969_d17 = 0 set @8969_e19 = 0 create table #3cf2_3ff (cc6e int identity, c2196 nvarchar(256), cdd9 bit) declare @3cf2_d17 bit declare @3cf2_e19 bit set @3cf2_d17 = 0 set @3cf2_e19 = 0 create table #fa4 (cc6e int identity, c35f nvarchar(max)) create table #ecc (cc6e int identity, cc9a nvarchar(max)) create table #1f7 (cc6e int identity, c1cf nvarchar(max)) declare @2f4 nvarchar(max) declare @895 nvarchar(max) declare @64c bit set @64c = 0 declare @3a7 xml declare @088 int declare @289 char(1) declare @ea1 nvarchar(max) declare @1c7 bit declare @2aa char(1) declare @5d0 bit declare @fa4 nvarchar(max) set @5d0 = 0 declare @09e int set @09e = 0 declare @bcc int set @bcc = 1 declare @5e6 bit set @5e6 = 0 declare @b16 bit set @b16 = 0 declare @20e bit set @20e = 0 declare @697 nvarchar(max) declare @8e3 int set @2f4 = replace(replace(replace(@sessions, char(13), ' '), char(10), ' '), '	', ' ') while (charindex('  ', @2f4) <> 0) set @2f4 = replace(@2f4, '  ', ' ') if (@2f4 = ' ') set @sessions = NULL set @2f4 = replace(replace(replace(@datetime, char(13), ' '), char(10), ' '), '	', ' ') while (charindex('  ', @2f4) <> 0) set @2f4 = replace(@2f4, '  ', ' ') if (@2f4 = ' ') set @datetime = NULL set @2f4 = replace(replace(replace(@datetime_to, char(13), ' '), char(10), ' '), '	', ' ') while (charindex('  ', @2f4) <> 0) set @2f4 = replace(@2f4, '  ', ' ') if (@2f4 = ' ') set @datetime_to = NULL if (@sessions is not NULL) begin set @2f4 = replace(replace(replace(@sessions, char(13), ' '), char(10), ' '), '	', ' ') set @088 = 1 set @289 = ',' while (@088 <= len(@2f4)) begin if (substring(@2f4, @088, 1) = ')') begin if (@289 = ',') begin set @ea1 = 'Invalid format ''' + substring(@2f4, @088, len(@2f4) - @088) + ''' for parameter @sessions specified, missing ''(''.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @289 = ',' end if (substring(@2f4, @088, 1) = '(') begin if (@289 = ';') begin set @ea1 = 'Invalid format ''' + substring(@2f4, @088, len(@2f4) - @088) + ''' for parameter @sessions specified, missing '')''.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @289 = ';' end if (substring(@2f4, @088, 1) = ',' and @289 = ';') set @2f4 = stuff(@2f4, @088, 1, ';') set @088 = @088 + 1 end if (@289 = ';') begin set @ea1 = 'Invalid format ''' + @sessions + ''' for parameter @sessions specified, missing '')''.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @2f4 = replace(replace(@2f4, '<', '{['), '>', ']}') set @3a7 = N'<r>' + replace(@2f4, ',', '</r><r>') + '</r>' set @2f4 = replace(replace(@2f4, '{[', '<'), ']}', '>') insert into #ecc select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #ecc where cc9a is NULL or cc9a = '' update #ecc set cc9a = replace(replace(cc9a, '{[', '<'), ']}', '>') if exists (select cc9a from #ecc) begin declare c7ba cursor for select cc9a from #ecc order by cc6e open c7ba fetch next from c7ba into @2f4 while (@@fetch_status = 0) begin if (upper(@2f4) in ('SAVE')) set @5d0 = 1 else if (upper(@2f4) in ('ALL')) set @5e6 = 1 else if (upper(@2f4) in ('NODDL')) set @b16 = 1 else if (upper(@2f4) in ('NOOUTPUT')) set @20e = 1 else if (upper(@2f4) in ('ACTIVE', 'WAIT', 'BLOCK', 'BLOCKED', 'BLOCKING', 'CURSOR', 'SP_WHOPRO')) insert into #fa4 values (upper(@2f4))
	else if (upper(@2f4) like 'SESSION_ID%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 10 + 1, len(@2f4) - 10)) if (upper(@895) like 'IN%') begin set @d43f_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @d43f_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #d43f_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'HOST_PROCESS_ID%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 15 + 1, len(@2f4) - 15)) if (upper(@895) like 'IN%') begin set @9e0b_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @9e0b_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #9e0b_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'CONTEXT_INFO%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 12 + 1, len(@2f4) - 12)) if (upper(@895) like 'IN%') begin set @083d_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @083d_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #083d_3ff select cast('' as xml).value('xs:hexBinary(sql:column("t.c"))', 'varbinary(max)'), @1c7 from (select substring(c1cf, 3, len(c1cf) - 2) from #1f7) as t(c) if exists (select cdd9 from #083d_3ff where c0470 is NULL) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, incorrect binary format.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end end
	else if (upper(@2f4) like 'IS_USER_PROCESS%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 15 + 1, len(@2f4) - 15)) if (upper(@895) like 'IN%') begin set @c886_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @c886_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #c886_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'TRANSACTION_ISOLATION_LEVEL%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 27 + 1, len(@2f4) - 27)) if (upper(@895) like 'IN%') begin set @8572_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @8572_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #8572_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'GROUP_ID%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 8 + 1, len(@2f4) - 8)) if (upper(@895) like 'IN%') begin set @52d2_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @52d2_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #52d2_3ff select c1cf, @1c7 from #1f7 end
	else if (upper(@2f4) like 'DATABASE_ID%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 11 + 1, len(@2f4) - 11)) if (upper(@895) like 'IN%') begin set @d24d_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @d24d_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #d24d_3ff select c1cf, @1c7 from #1f7 end
	else if (upper(@2f4) like 'DATABASE_NAME%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 13 + 1, len(@2f4) - 13)) if (upper(@895) like 'IN%') begin set @d24d_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @d24d_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if exists (select c1cf from #1f7 where db_id(c1cf) is NULL) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, incorrect database name.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #d24d_3ff select db_id(c1cf), @1c7 from #1f7 end else if (upper(@2f4) like 'NODE_AFFINITY%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 13 + 1, len(@2f4) - 13)) if (upper(@895) like 'IN%') begin set @5f33_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @5f33_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #5f33_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'CONNECTION_ID%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 13 + 1, len(@2f4) - 13)) if (upper(@895) like 'IN%') begin set @9b90_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @9b90_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #9b90_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'MOST_RECENT_SQL_HANDLE%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 22 + 1, len(@2f4) - 22)) if (upper(@895) like 'IN%') begin set @6a56_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @6a56_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #6a56_3ff select cast('' as xml).value('xs:hexBinary(sql:column("t.c"))', 'varbinary(max)'), @1c7 from (select substring(c1cf, 3, len(c1cf) - 2) from #1f7) as t(c) if exists (select cdd9 from #6a56_3ff where cb8a8 is NULL) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, incorrect binary format.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end end else if (upper(@2f4) like 'REQUEST_ID%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 10 + 1, len(@2f4) - 10)) if (upper(@895) like 'IN%') begin set @9d74_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @9d74_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #9d74_3ff select c1cf, @1c7 from #1f7 end
	else if (upper(@2f4) like 'STATUS%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 6 + 1, len(@2f4) - 6)) if (upper(@895) like 'IN%') begin set @2db7_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @2db7_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #2db7_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'COMMAND%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 7 + 1, len(@2f4) - 7)) if (upper(@895) like 'IN%') begin set @8ca4_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @8ca4_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #8ca4_3ff select c1cf, @1c7 from #1f7 end
	else if (upper(@2f4) like 'SQL_HANDLE%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 10 + 1, len(@2f4) - 10)) if (upper(@895) like 'IN%') begin set @1532_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @1532_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #1532_3ff select cast('' as xml).value('xs:hexBinary(sql:column("t.c"))', 'varbinary(max)'), @1c7 from (select substring(c1cf, 3, len(c1cf) - 2) from #1f7) as t(c) if exists (select cdd9 from #1532_3ff where c1276 is NULL) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, incorrect binary format.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end end else if (upper(@2f4) like 'STATEMENT_START_OFFSET%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 22 + 1, len(@2f4) - 22)) if (upper(@895) like 'IN%') begin set @2947_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @2947_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #2947_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'STATEMENT_END_OFFSET%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 20 + 1, len(@2f4) - 20)) if (upper(@895) like 'IN%') begin set @82a0_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @82a0_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #82a0_3ff select c1cf, @1c7 from #1f7 end
	else if (upper(@2f4) like 'PLAN_HANDLE%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 11 + 1, len(@2f4) - 11)) if (upper(@895) like 'IN%') begin set @e847_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @e847_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #e847_3ff select cast('' as xml).value('xs:hexBinary(sql:column("t.c"))', 'varbinary(max)'), @1c7 from (select substring(c1cf, 3, len(c1cf) - 2) from #1f7) as t(c) if exists (select cdd9 from #e847_3ff where cfcb8 is NULL) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, incorrect binary format.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end end else if (upper(@2f4) like 'BLOCKING_SESSION_ID%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 19 + 1, len(@2f4) - 19)) if (upper(@895) like 'IN%') begin set @1144_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @1144_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #1144_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'TRANSACTION_ID%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 14 + 1, len(@2f4) - 14)) if (upper(@895) like 'IN%') begin set @c026_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @c026_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #c026_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'SCHEDULER_ID%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 12 + 1, len(@2f4) - 12)) if (upper(@895) like 'IN%') begin set @4617_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @4617_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #4617_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'EXECUTING_MANAGED_CODE%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 22 + 1, len(@2f4) - 22)) if (upper(@895) like 'IN%') begin set @c3e1_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @c3e1_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #c3e1_3ff select c1cf, @1c7 from #1f7 end else if (upper(@2f4) like 'QUERY_HASH%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 10 + 1, len(@2f4) - 10)) if (upper(@895) like 'IN%') begin set @ad99_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @ad99_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #ad99_3ff select cast('' as xml).value('xs:hexBinary(sql:column("t.c"))', 'varbinary(max)'), @1c7 from (select substring(c1cf, 3, len(c1cf) - 2) from #1f7) as t(c) if exists (select cdd9 from #ad99_3ff where cdd5b is NULL) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, incorrect binary format.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end end else if (upper(@2f4) like 'QUERY_PLAN_HASH%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 15 + 1, len(@2f4) - 15)) if (upper(@895) like 'IN%') begin set @2cbb_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 3, len(@895) - 2))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'IN%') begin set @2cbb_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 3, len(ltrim(substring(@895, 4, len(@895) - 3))) - 2))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '(' and substring(@895, len(@895), 1) = ')') set @895 = substring(@895, 2, len(@895) - 2) else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''( / )''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @895 = replace(@895, ';', ',') set @3a7 = N'<r>' + replace(@895, ',', '</r><r>') + '</r>' delete #1f7 insert into #1f7 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @3a7.nodes('r') as t(c) delete #1f7 where c1cf is NULL or c1cf = '' update #1f7 set c1cf = substring(c1cf, 2, len(c1cf) - 2) where substring(c1cf, 1, 1) = '''' and substring(c1cf, len(c1cf), 1) = '''' if not exists (select c1cf from #1f7) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, is empty.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #2cbb_3ff select cast('' as xml).value('xs:hexBinary(sql:column("t.c"))', 'varbinary(max)'), @1c7 from (select substring(c1cf, 3, len(c1cf) - 2) from #1f7) as t(c) if exists (select cdd9 from #2cbb_3ff where cf1e0 is NULL) begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, incorrect binary format.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end end else if (upper(@2f4) like 'LOGIN_TIME%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 10 + 1, len(@2f4) - 10)) if (@895 like '<%') begin set @2aa = '<' set @85bd_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @85bd_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @85bd_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @85bd_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #85bd_3ff (cec3c, cfbc) values (@895, @2aa) end else if (upper(@2f4) like 'OPEN_TRANSACTION_COUNT%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 22 + 1, len(@2f4) - 22)) if (@895 like '<%') begin set @2aa = '<' set @01d0_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @01d0_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @01d0_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @01d0_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #01d0_3ff (ca604, cfbc) values (@895, @2aa) end else if (upper(@2f4) like 'NUM_READS%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 9 + 1, len(@2f4) - 9)) if (@895 like '<%') begin set @2aa = '<' set @75d5_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @75d5_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @75d5_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @75d5_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #75d5_3ff (cb29d, cfbc) values (@895, @2aa) end else if (upper(@2f4) like 'NUM_WRITES%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 10 + 1, len(@2f4) - 10)) if (@895 like '<%') begin set @2aa = '<' set @b7fa_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @b7fa_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @b7fa_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @b7fa_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #b7fa_3ff (cb940, cfbc) values (@895, @2aa) end
	else if (upper(@2f4) like 'WAIT_TIME%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 9 + 1, len(@2f4) - 9)) if (@895 like '<%') begin set @2aa = '<' set @d72b_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @d72b_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @d72b_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @d72b_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #d72b_3ff (caa9e, cfbc) values (@895, @2aa) end
	else if (upper(@2f4) like 'CPU_TIME%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 8 + 1, len(@2f4) - 8)) if (@895 like '<%') begin set @2aa = '<' set @3898_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @3898_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @3898_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @3898_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #3898_3ff (c0dfe, cfbc) values (@895, @2aa) end
	else if (upper(@2f4) like 'TOTAL_ELAPSED_TIME%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 18 + 1, len(@2f4) - 18)) if (@895 like '<%') begin set @2aa = '<' set @c5d0_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @c5d0_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @c5d0_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @c5d0_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #c5d0_3ff (c7334, cfbc) values (@895, @2aa) end
	else if (upper(@2f4) like 'READS%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 5 + 1, len(@2f4) - 5)) if (@895 like '<%') begin set @2aa = '<' set @60b2_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @60b2_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @60b2_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @60b2_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #60b2_3ff (c93c1, cfbc) values (@895, @2aa) end else if (upper(@2f4) like 'WRITES%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 6 + 1, len(@2f4) - 6)) if (@895 like '<%') begin set @2aa = '<' set @a140_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @a140_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @a140_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @a140_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #a140_3ff (cac7f, cfbc) values (@895, @2aa) end
	else if (upper(@2f4) like 'LOGICAL_READS%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 13 + 1, len(@2f4) - 13)) if (@895 like '<%') begin set @2aa = '<' set @4092_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @4092_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @4092_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @4092_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #4092_3ff (c8946, cfbc) values (@895, @2aa) end else if (upper(@2f4) like 'ROW_COUNT%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 9 + 1, len(@2f4) - 9)) if (@895 like '<%') begin set @2aa = '<' set @b1a9_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @b1a9_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @b1a9_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @b1a9_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #b1a9_3ff (ceb65, cfbc) values (@895, @2aa) end else if (upper(@2f4) like 'NEST_LEVEL%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 10 + 1, len(@2f4) - 10)) if (@895 like '<%') begin set @2aa = '<' set @1fa1_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @1fa1_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @1fa1_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @1fa1_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #1fa1_3ff (c9d64, cfbc) values (@895, @2aa) end else if (upper(@2f4) like 'GRANTED_QUERY_MEMORY%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 20 + 1, len(@2f4) - 20)) if (@895 like '<%') begin set @2aa = '<' set @2055_81b = 1 end else if (@895 like '=%') begin set @2aa = '=' set @2055_37a = 1 end else if (@895 like '>%') begin set @2aa = '>' set @2055_01e = 1 end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''< or = or >''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end set @2055_d17 = 1 set @895 = ltrim(rtrim(substring(@895, 2, len(@895) - 1))) if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #2055_3ff (c5c53, cfbc) values (@895, @2aa) end else if (upper(@2f4) like 'HOST_NAME%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 9 + 1, len(@2f4) - 9)) if (upper(@895) like 'LIKE%') begin set @2256_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 5, len(@895) - 4))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'LIKE%') begin set @2256_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 5, len(ltrim(substring(@895, 4, len(@895) - 3))) - 4))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #2256_3ff (c9e53, cdd9) values (@895, @1c7) end
	else if (upper(@2f4) like 'PROGRAM_NAME%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 12 + 1, len(@2f4) - 12)) if (upper(@895) like 'LIKE%') begin set @6637_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 5, len(@895) - 4))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'LIKE%') begin set @6637_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 5, len(ltrim(substring(@895, 4, len(@895) - 3))) - 4))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #6637_3ff (c7a8a, cdd9) values (@895, @1c7) end
	else if (upper(@2f4) like 'LOGIN_NAME%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 10 + 1, len(@2f4) - 10)) if (upper(@895) like 'LIKE%') begin set @3d08_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 5, len(@895) - 4))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'LIKE%') begin set @3d08_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 5, len(ltrim(substring(@895, 4, len(@895) - 3))) - 4))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #3d08_3ff (cd68f, cdd9) values (@895, @1c7) end else if (upper(@2f4) like 'NT_DOMAIN%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 9 + 1, len(@2f4) - 9)) if (upper(@895) like 'LIKE%') begin set @863e_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 5, len(@895) - 4))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'LIKE%') begin set @863e_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 5, len(ltrim(substring(@895, 4, len(@895) - 3))) - 4))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #863e_3ff (cb91d, cdd9) values (@895, @1c7) end else if (upper(@2f4) like 'NT_USER_NAME%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 12 + 1, len(@2f4) - 12)) if (upper(@895) like 'LIKE%') begin set @74cb_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 5, len(@895) - 4))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'LIKE%') begin set @74cb_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 5, len(ltrim(substring(@895, 4, len(@895) - 3))) - 4))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #74cb_3ff (ca53e, cdd9) values (@895, @1c7) end else if (upper(@2f4) like 'CLIENT_NET_ADDRESS%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 18 + 1, len(@2f4) - 18)) if (upper(@895) like 'LIKE%') begin set @3379_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 5, len(@895) - 4))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'LIKE%') begin set @3379_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 5, len(ltrim(substring(@895, 4, len(@895) - 3))) - 4))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #3379_3ff (c685a, cdd9) values (@895, @1c7) end
	else if (upper(@2f4) like 'WAIT_TYPE%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 9 + 1, len(@2f4) - 9)) if (upper(@895) like 'LIKE%') begin set @8969_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 5, len(@895) - 4))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'LIKE%') begin set @8969_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 5, len(ltrim(substring(@895, 4, len(@895) - 3))) - 4))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #8969_3ff (c5226, cdd9) values (@895, @1c7) end
	else if (upper(@2f4) like 'WAIT_RESOURCE%') begin set @64c = 1 set @895 = ltrim(substring(@2f4, 13 + 1, len(@2f4) - 13)) if (upper(@895) like 'LIKE%') begin set @3cf2_d17 = 1 set @1c7 = 1 set @895 = ltrim(rtrim(substring(@895, 5, len(@895) - 4))) end else if (upper(@895) like 'NOT%' and upper(ltrim(substring(@895, 4, len(@895) - 3))) like 'LIKE%') begin set @3cf2_e19 = 1 set @1c7 = 0 set @895 = ltrim(rtrim(substring(ltrim(substring(@895, 4, len(@895) - 3)), 5, len(ltrim(substring(@895, 4, len(@895) - 3))) - 4))) end else begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, missing ''like / not like''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end if (len(@895) > 1) if (substring(@895, 1, 1) = '''' and substring(@895, len(@895), 1) = '''') set @895 = substring(@895, 2, len(@895) - 2) if (@895 = '') begin set @ea1 = 'Invalid format ''' + @2f4 + ''' for parameter @sessions specified, empty value' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end insert into #3cf2_3ff (c2196, cdd9) values (@895, @1c7) end else if (upper(@2f4) in ('HELP')) begin set @ea1 = 'Invalid option ''HELP'' for parameter @sessions specified, option ''HELP'' cannot be combined with other options.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end else begin set @ea1 = 'Invalid option ''' + @2f4 + ''' for parameter @sessions specified.' raiserror (@ea1, 17, 1) set @datetime = NULL close c7ba deallocate c7ba return 1 end fetch next from c7ba into @2f4 end close c7ba deallocate c7ba end end if (@5d0 = 1 and @datetime is not NULL) begin set @ea1 = '@sessions option ''SAVE'' cannot be is specified when @datetime is not NULL' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @fa4 = ltrim(rtrim(@save_to_database)) if (@fa4 = '') set @fa4 = NULL if (@fa4 is not NULL) begin if ((@5d0 = 1) or (@datetime is not NULL)) begin declare @ed3 nvarchar(256) if (charindex('[', @fa4) > 0) begin if (substring (@fa4, len(@fa4), 1) <> ']') begin set @ea1 = 'Invalid database_name.[schema_name] ''' + case when charindex('].[', @fa4, 0) = 0 then substring (@fa4, 2, len(@fa4) - 2) else substring (@fa4, 2, charindex('].[', @fa4, 0) - 2) end + ''' for parameter @fa4 specified, when using delimiter ''['', should terminate with delimiter '']''.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end if (db_id(case when charindex('].[', @fa4, 0) = 0 then substring (@fa4, 2, len(@fa4) - 2) else substring (@fa4, 2, charindex('].[', @fa4, 0) - 2) end) is NULL) begin set @ea1 = 'Invalid database name ''' + case when charindex('].[', @fa4, 0) = 0 then substring (@fa4, 2, len(@fa4) - 2) else substring (@fa4, 2, charindex('].[', @fa4, 0) - 2) end + ''' for parameter @fa4 specified.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end else begin set @09e = db_id(case when charindex('].[', @fa4, 0) = 0 then substring (@fa4, 2, len(@fa4) - 2) else substring (@fa4, 2, charindex('].[', @fa4, 0) - 2) end) if (charindex('].[', @fa4, 0) > 0) begin set @bcc = 0 set @ed3 = substring (@fa4, charindex('].[', @fa4, 0) + 3, len(@fa4) - charindex('].[', @fa4, 0) - 3) set @697 = 'use [' + db_name(@09e) + '] select @bcc = schema_id from sys.schemas where name = @ed3' exec @8e3 = sp_executesql @697, N'@ed3 nvarchar(256), @bcc int output', @ed3 = @ed3, @bcc = @bcc output if (@8e3 <> 0) begin set @ea1 = '''Failed: sp_executesql N''' + @697 + ''', N''@name nvarchar(256), @bcc int output'', @ed3 = ''' + substring (@fa4, charindex('].[', @fa4, 0) + 3, len(@fa4) - charindex('].[', @fa4, 0) - 3) + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end if (@bcc = 0) begin set @ea1 = 'Invalid schema name ''' + substring (@fa4, charindex('].[', @fa4, 0) + 3, len(@fa4) - charindex('].[', @fa4, 0) - 3) + ''' for parameter @fa4 specified.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end end end else begin if (db_id(ltrim(rtrim(case when charindex('.', @fa4, 0) = 0 then @fa4 else substring (@fa4, 0, charindex('.', @fa4, 0)) end))) is NULL) begin set @ea1 = 'Invalid database name ''' + ltrim(rtrim(case when charindex('.', @fa4, 0) = 0 then @fa4 else substring (@fa4, 0, charindex('.', @fa4, 0)) end)) + ''' for parameter @fa4 specified.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end else begin set @09e = db_id(ltrim(rtrim(case when charindex('.', @fa4, 0) = 0 then @fa4 else substring (@fa4, 0, charindex('.', @fa4, 0)) end))) if (charindex('.', @fa4, 0) > 0) begin set @bcc = 0 set @ed3 = substring (@fa4, charindex('.', @fa4, 0) + 1, len(@fa4) - charindex('.', @fa4, 0)) set @697 = 'use [' + db_name(@09e) + '] select @bcc = schema_id from sys.schemas where name = @ed3' exec @8e3 = sp_executesql @697, N'@ed3 nvarchar(256), @bcc int output', @ed3 = @ed3, @bcc = @bcc output if (@8e3 <> 0) begin set @ea1 = '''Failed: sp_executesql N''' + @697 + ''', N''@name nvarchar(256), @bcc int output'', @ed3 = ''' + substring (@fa4, charindex('.', @fa4, 0) + 1, len(@fa4) - charindex('.', @fa4, 0)) + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end if (@bcc = 0) begin set @ea1 = 'Invalid schema name ''' + substring (@fa4, charindex('.', @fa4, 0) + 1, len(@fa4) - charindex('.', @fa4, 0)) + ''' for parameter @fa4 specified.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end end end end else begin set @ea1 = 'Parameter @save_to_database can be specified only when ''SAVE'' option for parameter @session is specified or when @datetime is specified.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end else begin set @09e = db_id() end if (@b16 = 1 and @5d0 = 0) begin set @ea1 = 'When @sessions option ''NODDL'' is specified, option ''SAVE'' should also be specified' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end if (@20e = 1 and @5d0 = 0 and @datetime is NULL) begin set @ea1 = 'When @sessions option ''NOOUTPUT'' is specified, option ''SAVE'' should also be specified or @datetime should not be NULL' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end if (@datetime is NULL and @datetime_to is not NULL) begin set @ea1 = 'When @datetime is NULL, @datetime_to should be NULL' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end create table #253 (cc6e int identity, cc9a nvarchar(max)) declare @ad7 nvarchar(max) declare @703 xml declare @ce7 bit set @ce7 = 0 set @ad7 = replace(replace(replace(@columns, char(13), ' '), char(10), ' '), '	', ' ') while (charindex('  ', @ad7) <> 0) set @ad7 = replace(@ad7, '  ', ' ') if (@ad7 = ' ') set @columns = NULL if (@columns is not NULL) begin set @columns = replace(replace(replace(@columns, char(13), ' '), char(10), ' '), '	', ' ') set @703 = N'<r>' + replace(@columns, ',', '</r><r>') + '</r>' insert into #253 select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @703.nodes('r') as t(c) delete #253 where cc9a is NULL or cc9a = '' if exists (select cc9a from #253) begin if exists (select cc9a from #253 where lower(cc9a) not in ('s.authenticating_database_id', 'c.connection_id', 'original_security_id', 's.context_info', 'language', 's.input_buffer_checksum', 'start_time', 'unsuccessful_logons', 'logical_reads', 'r.tasks_pending_io', 'r.wait_resource', 'r.head_blocker_session_ids', 's.ansi_padding', 'lock_owner_id', 'c.last_read', 'r.date_format', 'writes', 'ansi_warnings', 'scheduler_id', 's.custom_info', 'client_net_address', 'open_transaction_count', 'text_query_plan_as_text', 'last_read', 's.ctime', 's.waiting_tasks_max_wait_duration_ms', 'encrypt_option', 's.waiting_tasks_blocking_session_ids', 'cpu_time', 'last_write', 'plan_attributes_info', 's.is_head_blocker', 'r.statement_context_id', 'r.ansi_defaults', 'connection_id', 'r.row_count', 'net_transport', 'r.writes', 'r.transaction_info', 's.host_process_id', 's.input_buffer_valid_flag', 'r.executing_managed_code', 'deadlock_priority', 's.cpu_time', 'r.ansi_warnings', 'memory_usage', 'ansi_nulls', 'session_id', 'ansi_null_dflt_on', 's.writes', 'text_size', 'query_memory_grants_requested_memory_kb', 'row_count', 'r.statement_end_offset', 'r.query_memory_grants_ideal_memory_kb', 'r.text_query_plan_as_text', 'sp_whopro_inputparameters', 'r.query_hash', 'tasks_info', 'r.query_profiles_read_ahead_count', 'c.most_recent_sql_handle', 'r.query_plan', 'trigger_stats_info', 'wait_type', 'procedure_stats_info', 'c.session_id', 's.blocked_session_ids', 'connection_id', 'c.protocol_version', 's.arithabort', 's.ansi_defaults', 'r.workers_info', 's.row_count', 'wait_resource', 'parent_connection_id', 's.nt_domain', 'total_elapsed_time', 'session_tempdb_usage_info', 'original_login_name', 's.session_tempdb_usage_kb', 'r.open_resultset_count', 'input_buffer_checksum', 'r.sql_handle', 'r.read_bytes_per_second', 'writes', 'ctime', 'concat_null_yields_null', 'r.query_profiles_physical_read_count', 'query_profiles_info', 'query_plan', 's.max_cursor_dormant_duration', 's.logical_reads', 'ansi_defaults', 'custom_info', 'service_broker_info', 'r.language', 'cursors_info', 'r.command', 'r.nest_level', 'waiting_tasks_valid_flag', 'r.date_first', 'r.query_memory_grants_requested_memory_kb', 'c.net_transport', 'query_memory_grants_wait_time_ms', 'r.statement_sql_handle', 'ansi_padding', 'transaction_id', 'task_max_tempdb_usage_kb', 'tasks_io_size_kb', 'open_transaction_count', 'r.input_buffer', 'session_max_tempdb_usage_kb', 'status', 'r.transaction_isolation_level', 'lock_count', 'blocker_session_ids', 'max_cursor_dormant_duration', 'c.endpoint_id', 's.date_format', 'most_recent_sql_handle', 's.lock_owner_id', 'transaction_log_bytes_used', 'percent_complete', 'waiting_tasks_blocking_session_ids', 'is_blocked', 'lock_timeout', 'read_bytes_per_second', 'wait_resource_info', 'total_elapsed_time', 'reads', 'r.lock_owner_id', 'c.protocol_type', 'full_text_query_plan_as_text', 'cursor_count', 'node_affinity', 'request_id', 'database_id', 'local_net_address', 'task_tempdb_usage_kb', 'client_version', 'ansi_nulls', 's.prev_error', 'nest_level', 'r.task_tempdb_usage_info', 'total_scheduled_time', 's.total_scheduled_time', 'nt_domain', 'r.granted_query_memory', 'date_first', 'c.num_reads', 'text', 'r.task_max_tempdb_usage_kb', 'endpoint_id', 's.text_size', 'session_id', 'tasks_ios_per_second', 'connection_id', 'query_stats_info', 's.waiting_tasks_wait_types', 'r.statement_start_offset', 'connect_time', 'c.most_recent_session_id', 'ansi_defaults', 'r.full_text_query_plan_as_text', 'local_tcp_port', 'r.user_id', 's.login_name', 's.quoted_identifier', 's.last_successful_logon', 'program_name', 's.unsuccessful_logons', 'r.request_id', 'c.parent_connection_id', 'r.query_memory_grants_wait_time_ms', 's.program_name', 'open_resultset_count', 'c.net_packet_size', 'status', 's.original_security_id', 'date_format', 'c.trigger_stats_info', 'r.status', 'r.tasks_io_size_kb', 'transaction_isolation_level', 'date_format', 'r.full_text_query_plan', 'quoted_identifier', 'query_memory_grants_granted_memory_kb', 'r.wait_resource_info', 'r.group_id', 'r.task_address', 'arithabort', 'blocking_session_id', 's.memory_usage', 'r.query_plan_text_checksum', 'cpu_time', 'is_head_blocker', 'r.lock_timeout', 'command', 'text_size', 'c.encrypt_option', 's.cursors_info', 'query_profiles_logical_read_count', 'r.blocker_session_ids', 'c.text_object_name', 'r.deadlock_priority', 'full_text_query_plan', 's.lock_timeout', 'input_buffer', 'r.lock_count', 'client_tcp_port', 's.concat_null_yields_null', 'protocol_type', 'r.blocking_session_id', 'tasks_context_switches', 'lock_owner_id', 'r.estimated_completion_time', 'r.servername', 'c.servername', 'r.text_object_name', 'r.query_plan_checksum', 'quoted_identifier', 's.group_id', 'input_buffer_valid_flag', 'task_tempdb_usage_info', 'r.tasks_info', 'statement_context_id', 'locks_info', 'login_name', 'waiting_tasks_max_wait_duration_ms', 'ansi_null_dflt_on', 'net_packet_size', 'client_interface_name', 'reads', 's.ansi_nulls', 'is_dead_locked', 'custom_info', 'group_id', 'is_blocker', 'trigger_stats_info', 's.transaction_info', 's.ansi_null_dflt_on', 'last_wait_type', 'num_writes', 'transaction_info', 'tasks_count', 'c.node_affinity', 's.date_first', 'c.ctime', 's.session_max_tempdb_usage_kb', 'session_tempdb_usage_kb', 'r.last_wait_type', 'arithabort', 'task_address', 's.last_request_start_time', 'host_name', 's.original_login_name', 'endpoint_id', 'query_hash', 'most_recent_session_id', 'query_profiles_read_ahead_count', 'r.start_time', 'transaction_log_record_count', 'head_blocker_session_ids', 'statement_end_offset', 'c.local_net_address', 'query_memory_grants_info', 'r.context_info', 'procedure_stats_info', 'query_memory_grants_ideal_memory_kb', 'language', 'r.wait_type', 'statement', 'statement_sql_handle', 's.transaction_log_bytes_used', 's.is_user_process', 'query_profiles_physical_read_count', 'statement_object_name', 'r.tasks_context_switches', 'lock_timeout', 's.endpoint_id', 'statement_start_offset', 'r.reads', 's.open_transaction_count', 'last_successful_logon', 'r.query_stats_info', 'c.client_tcp_port', 'granted_query_memory', 's.reads', 'text_query_plan', 'r.procedure_stats_info', 'concat_null_yields_null', 's.waiting_tasks_info', 'r.statement', 's.transaction_begin_time', 's.servername', 'blocked_session_ids', 's.client_version', 'r.tasks_ios_per_second', 'r.is_dead_locked', 'cached_plans_info', 'r.query_memory_grants_used_memory_kb', 'r.query_memory_grants_max_used_memory_kb', 's.client_interface_name', 'r.locks_info', 'input_buffer_checksum', 'last_request_start_time', 'session_id', 'r.scheduler_id', 'c.procedure_stats_info', 'r.trigger_stats_info', 'prev_error', 'deadlock_priority', 's.sp_whopro_inputparameters', 'workers_info', 's.last_unsuccessful_logon', 'job_info', 'nt_user_name', 'threads_info', 's.database_id', 's.service_broker_info', 'query_profiles_cpu_time_ms', 's.is_blocker', 's.waiting_tasks_valid_flag', 'session_id', 'database_id', 'r.cpu_time', 'query_memory_grants_used_memory_kb', 'login_time', 's.transaction_log_record_count', 's.ansi_warnings', 'c.local_tcp_port', 'session_id', 'r.percent_complete', 'query_memory_grants_max_used_memory_kb', 'r.wait_time', 's.host_name', 'r.query_plan_hash', 'query_stats_info', 'servername', 'r.tasks_count', 'session_id', 'r.query_profiles_info', 's.deadlock_priority', 'r.logical_reads', 'r.threads_info', 'c.text', 'r.prev_error', 'r.transaction_begin_time', 'request_id', 'logical_reads', 'r.connection_id', 's.last_request_end_time', 'c.query_stats_info', 'r.text_query_plan', 'auth_scheme', 'r.transaction_id', 'query_plan_hash', 'transaction_isolation_level', 'r.query_profiles_cpu_time_ms', 'plan_handle', 'waiting_tasks_wait_types', 's.security_id', 'r.cached_plans_info', 'r.ansi_nulls', 'row_count', 'r.custom_info', 'context_info', 'r.input_buffer_checksum', 'r.text', 'connection_id', 'r.quoted_identifier', 'r.plan_attributes_info', 'last_unsuccessful_logon', 's.login_time', 'r.open_transaction_count', 's.status', 'prev_error', 'r.query_profiles_logical_read_count', 'c.last_write', 'r.is_blocked', 'r.arithabort', 'r.database_id', 'r.text_size', 'estimated_completion_time', 'r.concat_null_yields_null', 'authenticating_database_id', 'security_id', 'context_info', 'query_profiles_write_page_count', 'input_buffer_valid_flag', 'r.plan_handle', 'r.query_memory_grants_info', 'num_reads', 'r.ctime', 's.job_info', 'is_user_process', 'transaction_begin_time', 's.total_elapsed_time', 'executing_managed_code', 'c.num_writes', 's.nt_user_name', 'c.client_net_address', 'ansi_padding', 'ansi_warnings', 'c.auth_scheme', 'r.query_memory_grants_granted_memory_kb', 'r.task_tempdb_usage_kb', 'sql_handle', 'r.total_elapsed_time', 'r.session_id', 's.locks_info', 'r.query_profiles_write_page_count', 'lock_count', 'query_plan_checksum', 'r.input_buffer_valid_flag', 'text_object_name', 'transaction_begin_time', 'last_request_end_time', 'transaction_info', 'c.connect_time', 's.language', 's.lock_count', 'waiting_tasks_info', 's.session_id', 'r.ansi_null_dflt_on', 's.cursor_count', 's.session_tempdb_usage_info', 'group_id', 'r.ansi_padding', 'locks_info', 'user_id', 'protocol_version', 'date_first', 'wait_time', 's.input_buffer', 'r.statement_object_name', 'host_process_id', 'query_plan_text_checksum', 'tasks_pending_io', 's.transaction_isolation_level') and upper(cc9a) not in ('BLOCKED_DETAILED', 'BLOCK_DETAILED', 'PLAN_DETAILED', 'WAIT_DETAILED', 'WAIT', 'TASKS', 'CUSTOM', 'WORKERS', 'TASKS_DETAILED', 'STORAGE', 'QUERY_PROFILES_DETAILED', 'TEMPDB', 'PROCESSOR_DETAILED', 'THREADS_DETAILED', 'SESSION', 'CURSORS_DETAILED', 'SQLASTEXT', 'ALLLOCKS', 'TRANSACTION', 'TRANSACTION_DETAILED', 'ALLLOCKS_DETAILED', 'NETWORK_DETAILED', 'SESSION_DETAILED', 'TRANS', 'SQL', 'TRANS_DETAILED', 'TRAN_DETAILED', 'TRANSACTIONS_DETAILED', 'PLAN', 'CUSTOM_DETAILED', 'LOCK', 'LOCKS_DETAILED', 'SQL_DETAILED', 'CURSORS', 'STORAGE_DETAILED', 'REQUEST', 'TASK_DETAILED', 'CPU_DETAILED', 'CONNECTIONS', 'CONNECTION', 'PLANS_DETAILED', 'TEMPDB_DETAILED', 'ALLIO', 'WORKER_DETAILED', 'INPUTPARAMETERS', 'LOCK_DETAILED', 'DEFAULT', 'BLOCKING_DETAILED', 'ALL', 'THREADS', 'REQUESTS', 'CURSOR', 'DISK_DETAILED', 'LOCKS', 'QUERY_PROFILE_DETAILED', 'QUERY_PROFILE', 'IO_DETAILED', 'TRANSACTIONS', 'QUERY_PROFILES', 'MEMORY', 'CONNECTION_DETAILED', 'CPU', 'PLAN_ATTRIBUTE_DETAILED', 'PLAN_ATTRIBUTE', 'DISK', 'BLOCK', 'WORKERS_DETAILED', 'THREAD', 'LIMITED', 'WAITS', 'CONNECTIONS_DETAILED', 'PROCESSOR', 'STATS', 'THREAD_DETAILED', 'DETAILED', 'CURSOR_DETAILED', 'MEMORY_DETAILED', 'INPUTPARAMETER', 'REQUEST_DETAILED', 'STATISTICS_DETAILED', 'STATS_DETAILED', 'SESSIONS_DETAILED', 'NETWORK', 'PLAN_ATTRIBUTES', 'STATISTICS', 'IO', 'PLAN_ATTRIBUTES_DETAILED', 'TRAN', 'WAITS_DETAILED', 'WORKER', 'BLOCKED', 'SESSIONS', 'REQUESTS_DETAILED', 'TASK', 'BLOCKING', 'PLANS')) begin set @ea1 = 'Invalid option ''' + (select cc9a + case row_number() over (order by cc6e) when count(*) over () then '''' else ''', ''' end from #253 where lower(cc9a) not in ('r.task_tempdb_usage_kb', 'r.percent_complete', 'last_wait_type', 'query_plan', 's.client_interface_name', 'r.ansi_null_dflt_on', 'lock_owner_id', 'r.query_plan', 'connection_id', 'percent_complete', 'concat_null_yields_null', 's.unsuccessful_logons', 'request_id', 'endpoint_id', 'session_max_tempdb_usage_kb', 'r.is_blocked', 's.original_login_name', 'procedure_stats_info', 's.endpoint_id', 'original_security_id', 'c.client_tcp_port', 'date_format', 'reads', 'reads', 'ansi_warnings', 'r.plan_attributes_info', 'r.prev_error', 'r.executing_managed_code', 'quoted_identifier', 'query_memory_grants_wait_time_ms', 'r.nest_level', 'blocked_session_ids', 'threads_info', 's.session_tempdb_usage_kb', 'r.request_id', 'r.statement_object_name', 'cpu_time', 'language', 's.total_elapsed_time', 'input_buffer_valid_flag', 'c.text_object_name', 'r.blocking_session_id', 'r.command', 'task_max_tempdb_usage_kb', 'job_info', 'workers_info', 'r.concat_null_yields_null', 'is_user_process', 'r.total_elapsed_time', 'trigger_stats_info', 'r.trigger_stats_info', 'transaction_id', 'r.query_profiles_physical_read_count', 'input_buffer_valid_flag', 'c.query_stats_info', 'status', 'c.client_net_address', 'r.workers_info', 'prev_error', 'r.statement_start_offset', 'local_net_address', 'c.procedure_stats_info', 'r.query_memory_grants_wait_time_ms', 'net_packet_size', 'transaction_begin_time', 's.sp_whopro_inputparameters', 'row_count', 'language', 'lock_timeout', 'r.language', 'query_memory_grants_info', 'tasks_info', 's.transaction_info', 'program_name', 'r.task_max_tempdb_usage_kb', 'r.start_time', 'tasks_context_switches', 'request_id', 'r.query_profiles_write_page_count', 's.session_max_tempdb_usage_kb', 'query_hash', 'r.transaction_id', 's.is_user_process', 'date_format', 'r.text_object_name', 'session_tempdb_usage_kb', 's.total_scheduled_time', 'text', 'lock_count', 'r.ctime', 'connection_id', 'r.query_profiles_read_ahead_count', 'is_blocked', 'r.lock_owner_id', 's.deadlock_priority', 'plan_handle', 'cached_plans_info', 's.database_id', 'open_transaction_count', 'parent_connection_id', 'r.deadlock_priority', 'cursor_count', 's.login_time', 'r.full_text_query_plan', 'sp_whopro_inputparameters', 'r.ansi_defaults', 's.last_successful_logon', 'deadlock_priority', 'r.date_format', 'lock_owner_id', 's.context_info', 's.login_name', 'c.num_reads', 'tasks_pending_io', 'locks_info', 'original_login_name', 'blocker_session_ids', 's.quoted_identifier', 'num_reads', 'max_cursor_dormant_duration', 'net_transport', 'r.input_buffer_checksum', 's.status', 's.prev_error', 's.ansi_defaults', 'r.is_dead_locked', 'read_bytes_per_second', 'r.estimated_completion_time', 's.ansi_padding', 'task_tempdb_usage_kb', 'user_id', 'query_plan_checksum', 'plan_attributes_info', 'query_profiles_logical_read_count', 's.max_cursor_dormant_duration', 'nt_user_name', 'waiting_tasks_info', 'r.plan_handle', 'row_count', 'c.local_net_address', 'arithabort', 's.transaction_isolation_level', 's.date_first', 's.concat_null_yields_null', 'waiting_tasks_valid_flag', 'last_write', 'query_profiles_physical_read_count', 'r.wait_time', 'deadlock_priority', 's.reads', 'start_time', 'c.most_recent_sql_handle', 'ansi_padding', 's.last_request_end_time', 'r.open_transaction_count', 's.date_format', 'num_writes', 'estimated_completion_time', 'connect_time', 's.waiting_tasks_blocking_session_ids', 'writes', 'r.cached_plans_info', 'nest_level', 'r.task_tempdb_usage_info', 's.lock_owner_id', 'encrypt_option', 'endpoint_id', 'last_successful_logon', 'r.wait_type', 'r.text_query_plan_as_text', 'ansi_null_dflt_on', 'client_net_address', 'quoted_identifier', 's.last_unsuccessful_logon', 'total_elapsed_time', 's.writes', 'ansi_nulls', 'full_text_query_plan_as_text', 'tasks_count', 'c.connect_time', 'custom_info', 'status', 's.cursor_count', 'protocol_version', 'r.full_text_query_plan_as_text', 'query_profiles_read_ahead_count', 'ansi_padding', 's.input_buffer_checksum', 'transaction_info', 'statement_sql_handle', 'task_tempdb_usage_info', 'connection_id', 's.input_buffer_valid_flag', 'r.input_buffer', 's.open_transaction_count', 'r.query_memory_grants_info', 's.security_id', 'r.tasks_pending_io', 'r.query_plan_hash', 's.text_size', 's.original_security_id', 'statement_object_name', 'locks_info', 'r.statement_context_id', 'last_unsuccessful_logon', 'input_buffer_checksum', 'login_time', 'c.num_writes', 's.authenticating_database_id', 's.is_blocker', 'text_query_plan_as_text', 'custom_info', 's.memory_usage', 'r.connection_id', 'ctime', 'host_process_id', 's.cpu_time', 'c.protocol_type', 's.job_info', 'c.servername', 's.host_name', 'text_object_name', 'r.open_resultset_count', 'transaction_isolation_level', 's.input_buffer', 'r.text', 'r.query_plan_checksum', 'r.logical_reads', 'text_size', 'r.query_memory_grants_max_used_memory_kb', 'r.reads', 'total_elapsed_time', 's.is_head_blocker', 's.service_broker_info', 'c.protocol_version', 'query_memory_grants_max_used_memory_kb', 'cursors_info', 'c.net_packet_size', 'date_first', 'session_id', 'authenticating_database_id', 's.row_count', 'query_memory_grants_ideal_memory_kb', 'service_broker_info', 'full_text_query_plan', 'c.auth_scheme', 'session_id', 's.cursors_info', 'r.query_hash', 'r.sql_handle', 's.ansi_null_dflt_on', 's.session_tempdb_usage_info', 'r.scheduler_id', 'r.quoted_identifier', 'r.custom_info', 's.nt_domain', 'is_dead_locked', 'r.input_buffer_valid_flag', 's.program_name', 'is_head_blocker', 's.lock_count', 'r.lock_timeout', 'session_id', 'session_id', 'c.last_read', 'node_affinity', 'r.locks_info', 'most_recent_session_id', 'r.last_wait_type', 'c.node_affinity', 's.servername', 'r.query_profiles_logical_read_count', 'logical_reads', 'r.query_memory_grants_granted_memory_kb', 's.lock_timeout', 'database_id', 'r.tasks_context_switches', 'r.blocker_session_ids', 'wait_resource_info', 'r.user_id', 'query_plan_hash', 'session_id', 'query_profiles_cpu_time_ms', 'scheduler_id', 'sql_handle', 'last_request_start_time', 's.transaction_log_bytes_used', 'most_recent_sql_handle', 'command', 'waiting_tasks_blocking_session_ids', 's.client_version', 'r.query_memory_grants_used_memory_kb', 'r.procedure_stats_info', 'total_scheduled_time', 'statement_start_offset', 's.session_id', 'ansi_warnings', 'c.last_write', 'client_interface_name', 's.transaction_log_record_count', 'group_id', 's.ansi_nulls', 'ansi_defaults', 'transaction_isolation_level', 'security_id', 'client_version', 'auth_scheme', 'r.query_memory_grants_ideal_memory_kb', 'connection_id', 'executing_managed_code', 'r.ansi_warnings', 'r.ansi_nulls', 'r.head_blocker_session_ids', 'r.writes', 'last_read', 'c.ctime', 'session_id', 'lock_count', 'date_first', 'writes', 'statement_end_offset', 'r.group_id', 'query_memory_grants_requested_memory_kb', 'memory_usage', 'input_buffer_checksum', 'text_query_plan', 'statement', 'head_blocker_session_ids', 'r.tasks_io_size_kb', 'host_name', 'transaction_log_bytes_used', 'r.threads_info', 'r.ansi_padding', 'c.connection_id', 's.ctime', 'transaction_log_record_count', 'input_buffer', 's.nt_user_name', 'wait_resource', 'client_tcp_port', 'ansi_defaults', 'protocol_type', 's.language', 'r.date_first', 's.waiting_tasks_info', 'query_stats_info', 'transaction_info', 'r.transaction_info', 'r.tasks_ios_per_second', 'r.statement', 'blocking_session_id', 's.locks_info', 'login_name', 'r.granted_query_memory', 'r.text_query_plan', 'open_transaction_count', 'r.status', 'c.endpoint_id', 's.arithabort', 's.host_process_id', 'r.wait_resource_info', 'r.statement_end_offset', 'c.most_recent_session_id', 'arithabort', 's.blocked_session_ids', 's.logical_reads', 'text_size', 'r.transaction_isolation_level', 'r.query_memory_grants_requested_memory_kb', 'last_request_end_time', 'nt_domain', 'query_memory_grants_used_memory_kb', 's.custom_info', 'r.database_id', 'c.parent_connection_id', 'query_profiles_info', 'r.tasks_info', 'task_address', 'statement_context_id', 'waiting_tasks_max_wait_duration_ms', 'r.query_plan_text_checksum', 'ansi_nulls', 'unsuccessful_logons', 'query_profiles_write_page_count', 'group_id', 'c.local_tcp_port', 'session_tempdb_usage_info', 's.waiting_tasks_valid_flag', 'transaction_begin_time', 'r.cpu_time', 'wait_time', 'r.servername', 'r.query_profiles_cpu_time_ms', 's.waiting_tasks_max_wait_duration_ms', 'procedure_stats_info', 'granted_query_memory', 'logical_reads', 'is_blocker', 'local_tcp_port', 'r.context_info', 'c.session_id', 'c.net_transport', 'r.query_stats_info', 'r.session_id', 'r.query_profiles_info', 'concat_null_yields_null', 's.last_request_start_time', 's.transaction_begin_time', 'r.transaction_begin_time', 'ansi_null_dflt_on', 'open_resultset_count', 'r.task_address', 'wait_type', 'query_plan_text_checksum', 'tasks_ios_per_second', 'lock_timeout', 'context_info', 's.group_id', 's.ansi_warnings', 'trigger_stats_info', 'context_info', 'r.text_size', 'c.encrypt_option', 'cpu_time', 'r.statement_sql_handle', 'r.read_bytes_per_second', 'c.text', 'tasks_io_size_kb', 's.waiting_tasks_wait_types', 'r.wait_resource', 'r.tasks_count', 'r.row_count', 'query_stats_info', 'waiting_tasks_wait_types', 'c.trigger_stats_info', 'r.lock_count', 'query_memory_grants_granted_memory_kb', 'database_id', 'servername', 'r.arithabort', 'prev_error') and upper(cc9a) not in ('CPU', 'NETWORK', 'THREAD_DETAILED', 'REQUESTS', 'NETWORK_DETAILED', 'IO', 'ALLLOCKS', 'CURSOR_DETAILED', 'PLAN_DETAILED', 'PLANS', 'BLOCK', 'BLOCKED_DETAILED', 'STORAGE', 'PLAN_ATTRIBUTE_DETAILED', 'DEFAULT', 'TRANSACTIONS', 'ALLIO', 'BLOCKED', 'INPUTPARAMETERS', 'CURSORS_DETAILED', 'WORKERS_DETAILED', 'TASKS_DETAILED', 'LOCK_DETAILED', 'WAITS_DETAILED', 'BLOCKING', 'TRANSACTION', 'WAITS', 'STATS_DETAILED', 'LIMITED', 'CUSTOM_DETAILED', 'QUERY_PROFILES', 'WORKERS', 'MEMORY_DETAILED', 'DISK', 'TRAN', 'PLAN_ATTRIBUTES', 'QUERY_PROFILE_DETAILED', 'QUERY_PROFILES_DETAILED', 'CONNECTION', 'TRANSACTION_DETAILED', 'STATS', 'LOCKS_DETAILED', 'ALLLOCKS_DETAILED', 'SQL_DETAILED', 'WORKER', 'PROCESSOR', 'STATISTICS_DETAILED', 'TEMPDB', 'THREAD', 'TASKS', 'CPU_DETAILED', 'TASK', 'REQUESTS_DETAILED', 'INPUTPARAMETER', 'SQLASTEXT', 'CONNECTION_DETAILED', 'THREADS', 'WAIT', 'TRANS_DETAILED', 'SESSIONS', 'TASK_DETAILED', 'STATISTICS', 'REQUEST_DETAILED', 'MEMORY', 'SQL', 'BLOCKING_DETAILED', 'TRANS', 'WAIT_DETAILED', 'THREADS_DETAILED', 'CONNECTIONS_DETAILED', 'DISK_DETAILED', 'IO_DETAILED', 'PLAN_ATTRIBUTES_DETAILED', 'STORAGE_DETAILED', 'QUERY_PROFILE', 'DETAILED', 'CURSORS', 'WORKER_DETAILED', 'ALL', 'TEMPDB_DETAILED', 'TRANSACTIONS_DETAILED', 'LOCK', 'CUSTOM', 'SESSIONS_DETAILED', 'PROCESSOR_DETAILED', 'REQUEST', 'SESSION', 'PLAN', 'LOCKS', 'TRAN_DETAILED', 'PLAN_ATTRIBUTE', 'CURSOR', 'BLOCK_DETAILED', 'SESSION_DETAILED', 'PLANS_DETAILED', 'CONNECTIONS') order by cc6e for xml path ('')) + ' for parameter @columns specified' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end if exists (select cc9a from #253 where lower(cc9a) in ('text_query_plan_as_text', 'full_text_query_plan_as_text', 'r.text_query_plan_as_text', 'r.full_text_query_plan_as_text')) begin set @ce7 = 1 update #253 set cc9a = 'text_query_plan' where lower(cc9a) = 'text_query_plan_as_text' update #253 set cc9a = 'full_text_query_plan' where lower(cc9a) = 'full_text_query_plan_as_text' update #253 set cc9a = 'r.text_query_plan' where lower(cc9a) = 'r.text_query_plan_as_text' update #253 set cc9a = 'r.full_text_query_plan' where lower(cc9a) = 'r.full_text_query_plan_as_text' end end end create table #2ff (cc6e int identity, c35f nvarchar(max), c08c bit default 0) declare @dcd nvarchar(max) declare @373 bit set @373 = 0 declare @736 bit set @736 = 0 declare @485 bit set @485 = 0 if ((exists (select cc9a from #253 where upper(cc9a) = 'DEFAULT') and not exists (select cc9a from #253 where upper(cc9a) <> 'DEFAULT')) or (not exists (select cc9a from #253))) begin insert into #253 values ('SQL') insert into #253 values ('WAITS') insert into #253 values ('BLOCK') insert into #253 values ('STATISTICS') insert into #253 values ('CPU') insert into #253 values ('IO') insert into #253 values ('MEMORY') insert into #253 values ('LIMITED') end if (exists (select cc9a from #253 where upper(cc9a) = 'DETAILED') and not exists (select cc9a from #253 where upper(cc9a) <> 'DETAILED')) begin insert into #253 values ('SQL_DETAILED') insert into #253 values ('WAITS_DETAILED') insert into #253 values ('BLOCK_DETAILED') insert into #253 values ('LOCKS_DETAILED') insert into #253 values ('ALLLOCKS_DETAILED') insert into #253 values ('TRANSACTIONS_DETAILED') insert into #253 values ('PLAN_DETAILED') insert into #253 values ('QUERY_PROFILES_DETAILED') insert into #253 values ('STATISTICS_DETAILED') insert into #253 values ('CPU_DETAILED') insert into #253 values ('IO_DETAILED') insert into #253 values ('ALLIO') insert into #253 values ('TEMPDB_DETAILED') insert into #253 values ('MEMORY_DETAILED') insert into #253 values ('NETWORK_DETAILED') insert into #253 values ('PLAN_ATTRIBUTES_DETAILED') insert into #253 values ('CUSTOM_DETAILED') insert into #253 values ('CURSORS_DETAILED') insert into #253 values ('SESSIONS_DETAILED') insert into #253 values ('CONNECTIONS_DETAILED') insert into #253 values ('REQUESTS_DETAILED') insert into #253 values ('TASKS_DETAILED') insert into #253 values ('DETAILED') insert into #2ff (c35f) values ('c99_sp_whopro_inputparameters') end if (exists (select cc9a from #253 where upper(cc9a) = 'ALL')) begin insert into #253 values ('SQL_DETAILED') insert into #253 values ('WAITS_DETAILED') insert into #253 values ('BLOCK_DETAILED') insert into #253 values ('LOCKS_DETAILED') insert into #253 values ('ALLLOCKS_DETAILED') insert into #253 values ('TRANSACTIONS_DETAILED') insert into #253 values ('PLAN_DETAILED') insert into #253 values ('QUERY_PROFILES_DETAILED') insert into #253 values ('STATISTICS_DETAILED') insert into #253 values ('CPU_DETAILED') insert into #253 values ('IO_DETAILED') insert into #253 values ('ALLIO') insert into #253 values ('TEMPDB_DETAILED') insert into #253 values ('MEMORY_DETAILED') insert into #253 values ('NETWORK_DETAILED') insert into #253 values ('PLAN_ATTRIBUTES_DETAILED') insert into #253 values ('TASKS_DETAILED') insert into #253 values ('WORKERS_DETAILED') insert into #253 values ('THREADS_DETAILED') insert into #253 values ('CUSTOM_DETAILED') insert into #253 values ('CURSORS_DETAILED') insert into #253 values ('SESSIONS_DETAILED') insert into #253 values ('CONNECTIONS_DETAILED') insert into #253 values ('REQUESTS_DETAILED') insert into #253 values ('TASKS_DETAILED') insert into #253 values ('DETAILED') insert into #2ff (c35f) values ('c99_sp_whopro_inputparameters') end if (exists (select cc9a from #253 where upper(cc9a) = 'LIMITED') and not exists (select cc9a from #253 where upper(cc9a) <> 'LIMITED')) begin insert into #2ff (c35f) values ('c7e_login_time') insert into #2ff (c35f) values ('c7e_host_name') insert into #2ff (c35f) values ('c7e_program_name') insert into #2ff (c35f) values ('c99_job_info') insert into #2ff (c35f) values ('c7e_login_name') insert into #2ff (c35f) values ('cec_database_id') insert into #2ff (c35f) values ('c7e_database_id') insert into #2ff (c35f) values ('cec_total_elapsed_time') insert into #2ff (c35f) values ('cec_status') insert into #2ff (c35f) values ('cec_command') insert into #2ff (c35f) values ('cec_wait_type') insert into #2ff (c35f) values ('cec_wait_time') insert into #2ff (c35f) values ('cec_blocking_session_id') insert into #2ff (c35f) values ('cec_sql_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('c2e_most_recent_sql_handle') insert into #2ff (c35f) values ('input_buffer') insert into #2ff (c35f) values ('text_object_name') insert into #2ff (c35f) values ('text') insert into #2ff (c35f) values ('statement') insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_cpu_time') insert into #2ff (c35f) values ('cec_reads') insert into #2ff (c35f) values ('cec_logical_reads') insert into #2ff (c35f) values ('cec_granted_query_memory') insert into #2ff (c35f) values ('cec_open_transaction_count') insert into #2ff (c35f) values ('cec_transaction_isolation_level') end else begin declare @b4b bit select @b4b = case when count(*) > 0 then 1 else 0 end from #253 where upper(cc9a) = 'DETAILED' declare c0aa cursor for select cc9a from #253 order by cc6e open c0aa fetch next from c0aa into @dcd while (@@fetch_status = 0) begin
	if (upper(@dcd) in ('CPU', 'CPU_DETAILED', 'PROCESSOR', 'PROCESSOR_DETAILED')) begin if ((upper(@dcd) not in ('CPU_DETAILED', 'PROCESSOR_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('cec_cpu_time') insert into #2ff (c35f) values ('cec_total_elapsed_time') end else begin insert into #2ff (c35f) values ('cec_cpu_time') insert into #2ff (c35f) values ('cec_total_elapsed_time') insert into #2ff (c35f) values ('c7a_tasks_context_switches') insert into #2ff (c35f) values ('cec_scheduler_id') insert into #2ff (c35f) values ('c2e_node_affinity') insert into #2ff (c35f) values ('c7e_cpu_time') insert into #2ff (c35f) values ('c7e_total_scheduled_time') insert into #2ff (c35f) values ('c7e_total_elapsed_time') end end
	else if (upper(@dcd) in ('IO', 'IO_DETAILED', 'DISK', 'DISK_DETAILED', 'STORAGE', 'STORAGE_DETAILED', 'ALLIO', 'ALLIO_DETAILED')) begin if ((upper(@dcd) not in ('IO_DETAILED', 'DISK_DETAILED', 'STORAGE_DETAILED', 'ALLIO_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('cec_reads') insert into #2ff (c35f) values ('cec_logical_reads') end else begin insert into #2ff (c35f) values ('cec_reads') insert into #2ff (c35f) values ('cec_logical_reads') insert into #2ff (c35f) values ('cec_writes') insert into #2ff (c35f) values ('c7a_tasks_pending_io') insert into #2ff (c35f) values ('c7a_tasks_io_size_kb') insert into #2ff (c35f) values ('c7a_read_bytes_per_second') insert into #2ff (c35f) values ('c7a_tasks_ios_per_second') insert into #2ff (c35f) values ('c7e_reads') insert into #2ff (c35f) values ('c7e_writes') insert into #2ff (c35f) values ('c7e_logical_reads') insert into #2ff (c35f) values ('cec_row_count') insert into #2ff (c35f) values ('c7e_row_count') end if (upper(@dcd) in ('ALLIO', 'ALLIO_DETAILED')) begin set @485 = 1 end end
	else if (upper(@dcd) in ('MEMORY', 'MEMORY_DETAILED')) begin if ((upper(@dcd) not in ('MEMORY_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('cec_granted_query_memory') insert into #2ff (c35f) values ('c7a_query_memory_grants_granted_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_max_used_memory_kb') end else begin insert into #2ff (c35f) values ('cec_granted_query_memory') insert into #2ff (c35f) values ('c7a_query_memory_grants_requested_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_granted_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_used_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_max_used_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_wait_time_ms') insert into #2ff (c35f) values ('c7a_query_memory_grants_ideal_memory_kb')insert into #2ff (c35f) values ('c7a_query_memory_grants_info') end end
	else if (upper(@dcd) in ('NETWORK', 'NETWORK_DETAILED')) begin if ((upper(@dcd) not in ('NETWORK_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('c2e_net_transport') insert into #2ff (c35f) values ('c7e_host_name') insert into #2ff (c35f) values ('c2e_num_reads') insert into #2ff (c35f) values ('c2e_num_writes') end else begin insert into #2ff (c35f) values ('c2e_net_transport') insert into #2ff (c35f) values ('c7e_host_name') insert into #2ff (c35f) values ('c2e_num_reads') insert into #2ff (c35f) values ('c2e_num_writes') insert into #2ff (c35f) values ('c2e_last_read') insert into #2ff (c35f) values ('c2e_last_write') insert into #2ff (c35f) values ('c2e_net_packet_size') insert into #2ff (c35f) values ('c2e_client_net_address') insert into #2ff (c35f) values ('c2e_connect_time') end end
	else if (upper(@dcd) in ('WAIT', 'WAIT_DETAILED', 'WAITS', 'WAITS_DETAILED')) begin if ((upper(@dcd) not in ('WAIT_DETAILED', 'WAITS_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('cec_wait_type') insert into #2ff (c35f) values ('cec_wait_time') insert into #2ff (c35f) values ('cec_wait_resource') insert into #2ff (c35f) values ('c7a_wait_resource_info') insert into #2ff (c35f) values ('c99_waiting_tasks_wait_types') insert into #2ff (c35f) values ('c99_waiting_tasks_max_wait_duration_ms') end else begin insert into #2ff (c35f) values ('cec_wait_type') insert into #2ff (c35f) values ('cec_wait_time') insert into #2ff (c35f) values ('cec_wait_resource') insert into #2ff (c35f) values ('c7a_wait_resource_info') insert into #2ff (c35f) values ('c99_waiting_tasks_wait_types') insert into #2ff (c35f) values ('c99_waiting_tasks_max_wait_duration_ms') insert into #2ff (c35f) values ('c99_waiting_tasks_info') end end
	else if (upper(@dcd) in ('BLOCK', 'BLOCK_DETAILED', 'BLOCKED', 'BLOCKED_DETAILED', 'BLOCKING', 'BLOCKING_DETAILED')) begin if ((upper(@dcd) not in ('BLOCK_DETAILED', 'BLOCKED_DETAILED', 'BLOCKING_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('cec_blocking_session_id') insert into #2ff (c35f) values ('c99_waiting_tasks_blocking_session_ids') end else begin insert into #2ff (c35f) values ('cec_blocking_session_id') insert into #2ff (c35f) values ('c99_waiting_tasks_blocking_session_ids') insert into #2ff (c35f) values ('c99_is_blocker') insert into #2ff (c35f) values ('c99_is_head_blocker') insert into #2ff (c35f) values ('c7a_is_blocked') insert into #2ff (c35f) values ('c7a_is_dead_locked') insert into #2ff (c35f) values ('c99_blocked_session_ids') insert into #2ff (c35f) values ('c7a_blocker_session_ids') insert into #2ff (c35f) values ('c7a_head_blocker_session_ids') insert into #2ff (c35f) values ('c99_waiting_tasks_blocking_session_ids') insert into #2ff (c35f) values ('c99_waiting_tasks_info') end end
	else if (upper(@dcd) in ('LOCK', 'LOCK_DETAILED', 'LOCKS', 'LOCKS_DETAILED', 'ALLLOCKS', 'ALLLOCKS_DETAILED')) begin if ((upper(@dcd) not in ('LOCK_DETAILED', 'LOCKS_DETAILED', 'ALLLOCKS_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('c7a_lock_count') insert into #2ff (c35f) values ('c99_lock_count') insert into #2ff (c35f) values ('c7a_locks_info') insert into #2ff (c35f) values ('c99_locks_info') end else begin insert into #2ff (c35f) values ('c7a_lock_count') insert into #2ff (c35f) values ('c99_lock_count') insert into #2ff (c35f) values ('c7a_locks_info') insert into #2ff (c35f) values ('c99_locks_info') insert into #2ff (c35f) values ('cec_transaction_id') insert into #2ff (c35f) values ('c7a_lock_owner_id') insert into #2ff (c35f) values ('c99_lock_owner_id') end if (upper(@dcd) in ('ALLLOCKS', 'ALLLOCKS_DETAILED')) begin insert into #2ff (c35f) values ('c99_waiting_tasks_blocking_session_ids') set @373 = 1 end end
	else if (upper(@dcd) in ('TRAN', 'TRAN_DETAILED', 'TRANS', 'TRANS_DETAILED', 'TRANSACTION', 'TRANSACTION_DETAILED', 'TRANSACTIONS', 'TRANSACTIONS_DETAILED')) begin if ((upper(@dcd) not in ('TRAN_DETAILED', 'TRANS_DETAILED', 'TRANSACTION_DETAILED', 'TRANSACTIONS_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('c7a_transaction_begin_time') insert into #2ff (c35f) values ('c99_transaction_begin_time') insert into #2ff (c35f) values ('c99_transaction_log_record_count') insert into #2ff (c35f) values ('c99_transaction_log_bytes_used') end else begin insert into #2ff (c35f) values ('c7a_transaction_begin_time') insert into #2ff (c35f) values ('c99_transaction_begin_time') insert into #2ff (c35f) values ('c99_transaction_log_record_count') insert into #2ff (c35f) values ('c99_transaction_log_bytes_used') insert into #2ff (c35f) values ('cec_transaction_isolation_level') insert into #2ff (c35f) values ('c7e_transaction_isolation_level') insert into #2ff (c35f) values ('cec_open_transaction_count') insert into #2ff (c35f) values ('c7e_open_transaction_count') insert into #2ff (c35f) values ('c7a_transaction_info') insert into #2ff (c35f) values ('c99_transaction_info') insert into #2ff (c35f) values ('cec_transaction_id') insert into #2ff (c35f) values ('c7a_lock_owner_id') insert into #2ff (c35f) values ('c99_lock_owner_id') end end
	else if (upper(@dcd) in ('SQL', 'SQL_DETAILED')) begin if ((upper(@dcd) not in ('SQL_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('input_buffer') insert into #2ff (c35f) values ('c7a_input_buffer_checksum') insert into #2ff (c35f) values ('c99_input_buffer_checksum') insert into #2ff (c35f) values ('text_object_name') insert into #2ff (c35f) values ('text') insert into #2ff (c35f) values ('statement') insert into #2ff (c35f) values ('cec_command') end else begin insert into #2ff (c35f) values ('input_buffer') insert into #2ff (c35f) values ('c7a_input_buffer_checksum') insert into #2ff (c35f) values ('c99_input_buffer_checksum') insert into #2ff (c35f) values ('text_object_name') insert into #2ff (c35f) values ('text') insert into #2ff (c35f) values ('statement') insert into #2ff (c35f) values ('cec_command') insert into #2ff (c35f) values ('cec_database_id') insert into #2ff (c35f) values ('c7e_database_id') insert into #2ff (c35f) values ('cec_sql_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('c2e_most_recent_sql_handle') insert into #2ff (c35f) values ('cec_query_hash') insert into #2ff (c35f) values ('c7a_input_buffer_valid_flag') insert into #2ff (c35f) values ('c99_input_buffer_valid_flag') end end else if (upper(@dcd) in ('SQLASTEXT')) begin set @736 = 1 end
	else if (upper(@dcd) in ('PLAN', 'PLAN_DETAILED', 'PLANS', 'PLANS_DETAILED')) begin if ((upper(@dcd) not in ('PLAN_DETAILED', 'PLANS_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('query_plan') insert into #2ff (c35f) values ('text_query_plan') end else begin insert into #2ff (c35f) values ('query_plan') insert into #2ff (c35f) values ('text_query_plan') insert into #2ff (c35f) values ('cec_database_id') insert into #2ff (c35f) values ('c7e_database_id') insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('cec_query_plan_hash') end end
	else if (upper(@dcd) in ('QUERY_PROFILES', 'QUERY_PROFILES_DETAILED', 'QUERY_PROFILE', 'QUERY_PROFILE_DETAILED')) begin if ((upper(@dcd) not in ('QUERY_PROFILES_DETAILED', 'QUERY_PROFILE_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('c7a_query_profiles_cpu_time_ms') insert into #2ff (c35f) values ('c7a_query_profiles_logical_read_count') insert into #2ff (c35f) values ('c7a_query_profiles_physical_read_count') insert into #2ff (c35f) values ('c7a_query_profiles_read_ahead_count') end else begin insert into #2ff (c35f) values ('c7a_query_profiles_cpu_time_ms') insert into #2ff (c35f) values ('c7a_query_profiles_logical_read_count') insert into #2ff (c35f) values ('c7a_query_profiles_physical_read_count') insert into #2ff (c35f) values ('c7a_query_profiles_read_ahead_count') insert into #2ff (c35f) values ('c7a_query_profiles_write_page_count') insert into #2ff (c35f) values ('c7a_query_profiles_info') end end
	else if (upper(@dcd) in ('STATS', 'STATS_DETAILED', 'STATISTICS', 'STATISTICS_DETAILED')) begin if ((upper(@dcd) not in ('STATS_DETAILED', 'STATISTICS_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('c7a_query_stats_info') insert into #2ff (c35f) values ('cb2_query_stats_info') insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('cec_database_id') end else begin insert into #2ff (c35f) values ('c7a_query_stats_info') insert into #2ff (c35f) values ('cb2_query_stats_info') insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('cec_database_id') insert into #2ff (c35f) values ('c7a_procedure_stats_info') insert into #2ff (c35f) values ('cb2_procedure_stats_info') insert into #2ff (c35f) values ('c7a_trigger_stats_info') insert into #2ff (c35f) values ('cb2_trigger_stats_info') insert into #2ff (c35f) values ('c7a_cached_plans_info') end end
	else if (upper(@dcd) in ('TEMPDB', 'TEMPDB_DETAILED')) begin if ((upper(@dcd) not in ('TEMPDB_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('c99_session_tempdb_usage_kb') insert into #2ff (c35f) values ('c7a_task_tempdb_usage_kb') end else begin insert into #2ff (c35f) values ('c99_session_tempdb_usage_kb') insert into #2ff (c35f) values ('c7a_task_tempdb_usage_kb') insert into #2ff (c35f) values ('c99_session_max_tempdb_usage_kb') insert into #2ff (c35f) values ('c99_session_tempdb_usage_info') insert into #2ff (c35f) values ('c7a_task_max_tempdb_usage_kb') insert into #2ff (c35f) values ('c7a_task_tempdb_usage_info') end end else if (upper(@dcd) in ('CURSOR', 'CURSOR_DETAILED', 'CURSORS', 'CURSORS_DETAILED')) begin insert into #2ff (c35f) values ('c99_cursor_count') insert into #2ff (c35f) values ('c99_max_cursor_dormant_duration') insert into #2ff (c35f) values ('c99_cursors_info') end
	else if (upper(@dcd) in ('TASK', 'TASK_DETAILED', 'TASKS', 'TASKS_DETAILED')) begin if ((upper(@dcd) not in ('TASK_DETAILED', 'TASKS_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('c7a_tasks_count') insert into #2ff (c35f) values ('c7a_tasks_context_switches') insert into #2ff (c35f) values ('c7a_tasks_pending_io') insert into #2ff (c35f) values ('c7a_tasks_io_size_kb') insert into #2ff (c35f) values ('c7a_read_bytes_per_second') insert into #2ff (c35f) values ('c7a_tasks_ios_per_second') end else begin insert into #2ff (c35f) values ('c7a_tasks_count') insert into #2ff (c35f) values ('c7a_tasks_context_switches') insert into #2ff (c35f) values ('c7a_tasks_pending_io') insert into #2ff (c35f) values ('c7a_tasks_io_size_kb') insert into #2ff (c35f) values ('c7a_read_bytes_per_second') insert into #2ff (c35f) values ('c7a_tasks_ios_per_second') insert into #2ff (c35f) values ('c7a_tasks_info') insert into #2ff (c35f) values ('c99_waiting_tasks_wait_types') insert into #2ff (c35f) values ('c99_waiting_tasks_max_wait_duration_ms') insert into #2ff (c35f) values ('c99_waiting_tasks_blocking_session_ids') insert into #2ff (c35f) values ('c99_waiting_tasks_valid_flag') insert into #2ff (c35f) values ('c99_waiting_tasks_info') end end else if (upper(@dcd) in ('WORKER', 'WORKER_DETAILED', 'WORKERS', 'WORKERS_DETAILED')) begin insert into #2ff (c35f) values ('c7a_workers_info') end else if (upper(@dcd) in ('THREAD', 'THREAD_DETAILED', 'THREADS', 'THREADS_DETAILED')) begin insert into #2ff (c35f) values ('c7a_threads_info') end else if (upper(@dcd) in ('SESSION', 'SESSION_DETAILED', 'SESSIONS', 'SESSIONS_DETAILED')) begin if ((upper(@dcd) not in ('SESSION_DETAILED', 'SESSIONS_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('c7e_login_time') insert into #2ff (c35f) values ('c7e_host_name') insert into #2ff (c35f) values ('c7e_program_name') insert into #2ff (c35f) values ('c99_job_info') insert into #2ff (c35f) values ('c99_service_broker_info') insert into #2ff (c35f) values ('c7e_login_name') insert into #2ff (c35f) values ('c7e_status') insert into #2ff (c35f) values ('c7e_is_user_process') insert into #2ff (c35f) values ('c7e_transaction_isolation_level') insert into #2ff (c35f) values ('c7e_row_count') insert into #2ff (c35f) values ('c7e_group_id') insert into #2ff (c35f) values ('c7e_database_id') insert into #2ff (c35f) values ('c7e_open_transaction_count') end else begin insert into #2ff (c35f) values ('c7e_login_time') insert into #2ff (c35f) values ('c7e_host_name') insert into #2ff (c35f) values ('c7e_program_name') insert into #2ff (c35f) values ('c99_job_info') insert into #2ff (c35f) values ('c99_service_broker_info') insert into #2ff (c35f) values ('c7e_login_name') insert into #2ff (c35f) values ('c7e_status') insert into #2ff (c35f) values ('c7e_is_user_process') insert into #2ff (c35f) values ('c7e_transaction_isolation_level') insert into #2ff (c35f) values ('c7e_row_count') insert into #2ff (c35f) values ('c7e_group_id') insert into #2ff (c35f) values ('c7e_database_id') insert into #2ff (c35f) values ('c7e_open_transaction_count') insert into #2ff (c35f) values ('c7e_host_process_id') insert into #2ff (c35f) values ('c7e_nt_domain') insert into #2ff (c35f) values ('c7e_nt_user_name') insert into #2ff (c35f) values ('c7e_context_info') insert into #2ff (c35f) values ('c7e_cpu_time') insert into #2ff (c35f) values ('c7e_total_scheduled_time') insert into #2ff (c35f) values ('c7e_total_elapsed_time') insert into #2ff (c35f) values ('c7e_reads') insert into #2ff (c35f) values ('c7e_writes') insert into #2ff (c35f) values ('c7e_logical_reads') end end else if (upper(@dcd) in ('CONNECTION', 'CONNECTION_DETAILED', 'CONNECTIONS', 'CONNECTIONS_DETAILED')) begin if ((upper(@dcd) not in ('CONNECTION_DETAILED', 'CONNECTIONS_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('c2e_connect_time') insert into #2ff (c35f) values ('c2e_net_transport') insert into #2ff (c35f) values ('c2e_node_affinity') insert into #2ff (c35f) values ('c2e_num_reads') insert into #2ff (c35f) values ('c2e_num_writes') insert into #2ff (c35f) values ('c2e_client_net_address') insert into #2ff (c35f) values ('c2e_c2e_most_recent_sql_handle') end else begin insert into #2ff (c35f) values ('c2e_connect_time') insert into #2ff (c35f) values ('c2e_net_transport') insert into #2ff (c35f) values ('c2e_node_affinity') insert into #2ff (c35f) values ('c2e_num_reads') insert into #2ff (c35f) values ('c2e_num_writes') insert into #2ff (c35f) values ('c2e_client_net_address') insert into #2ff (c35f) values ('c2e_c2e_most_recent_sql_handle') insert into #2ff (c35f) values ('c2e_last_read') insert into #2ff (c35f) values ('c2e_last_write') insert into #2ff (c35f) values ('c2e_net_packet_size') end end else if (upper(@dcd) in ('REQUEST', 'REQUEST_DETAILED', 'REQUESTS', 'REQUESTS_DETAILED')) begin if ((upper(@dcd) not in ('REQUEST_DETAILED', 'REQUESTS_DETAILED')) and (@b4b = 0)) begin insert into #2ff (c35f) values ('cec_status') insert into #2ff (c35f) values ('cec_command') insert into #2ff (c35f) values ('cec_sql_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_database_id') insert into #2ff (c35f) values ('cec_blocking_session_id') insert into #2ff (c35f) values ('cec_wait_type') insert into #2ff (c35f) values ('cec_wait_time') insert into #2ff (c35f) values ('cec_last_wait_type') insert into #2ff (c35f) values ('cec_wait_resource') insert into #2ff (c35f) values ('cec_open_transaction_count') insert into #2ff (c35f) values ('cec_transaction_id') insert into #2ff (c35f) values ('cec_percent_complete') insert into #2ff (c35f) values ('cec_estimated_completion_time') insert into #2ff (c35f) values ('cec_cpu_time') insert into #2ff (c35f) values ('cec_total_elapsed_time') insert into #2ff (c35f) values ('cec_scheduler_id') insert into #2ff (c35f) values ('cec_reads') insert into #2ff (c35f) values ('cec_writes') insert into #2ff (c35f) values ('cec_logical_reads') insert into #2ff (c35f) values ('cec_transaction_isolation_level') insert into #2ff (c35f) values ('cec_row_count') insert into #2ff (c35f) values ('cec_granted_query_memory') insert into #2ff (c35f) values ('cec_group_id') insert into #2ff (c35f) values ('cec_query_hash') insert into #2ff (c35f) values ('cec_query_plan_hash') end else begin insert into #2ff (c35f) values ('cec_status') insert into #2ff (c35f) values ('cec_command') insert into #2ff (c35f) values ('cec_sql_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_database_id') insert into #2ff (c35f) values ('cec_blocking_session_id') insert into #2ff (c35f) values ('cec_wait_type') insert into #2ff (c35f) values ('cec_wait_time') insert into #2ff (c35f) values ('cec_last_wait_type') insert into #2ff (c35f) values ('cec_wait_resource') insert into #2ff (c35f) values ('cec_open_transaction_count') insert into #2ff (c35f) values ('cec_transaction_id') insert into #2ff (c35f) values ('cec_percent_complete') insert into #2ff (c35f) values ('cec_estimated_completion_time') insert into #2ff (c35f) values ('cec_cpu_time') insert into #2ff (c35f) values ('cec_total_elapsed_time') insert into #2ff (c35f) values ('cec_scheduler_id') insert into #2ff (c35f) values ('cec_reads') insert into #2ff (c35f) values ('cec_writes') insert into #2ff (c35f) values ('cec_logical_reads') insert into #2ff (c35f) values ('cec_transaction_isolation_level') insert into #2ff (c35f) values ('cec_row_count') insert into #2ff (c35f) values ('cec_granted_query_memory') insert into #2ff (c35f) values ('cec_group_id') insert into #2ff (c35f) values ('cec_query_hash') insert into #2ff (c35f) values ('cec_query_plan_hash') insert into #2ff (c35f) values ('cec_open_resultset_count') insert into #2ff (c35f) values ('cec_context_info') insert into #2ff (c35f) values ('cec_nest_level') insert into #2ff (c35f) values ('cec_executing_managed_code') end end else if (upper(@dcd) in ('PLAN_ATTRIBUTE', 'PLAN_ATTRIBUTE_DETAILED', 'PLAN_ATTRIBUTES', 'PLAN_ATTRIBUTES_DETAILED')) begin insert into #2ff (c35f) values ('plan_attributes_info') end else if (upper(@dcd) in ('INPUTPARAMETER', 'INPUTPARAMETERS')) begin insert into #2ff (c35f) values ('c99_sp_whopro_inputparameters') end else if (upper(@dcd) in ('CUSTOM', 'CUSTOM_DETAILED')) begin insert into #2ff (c35f) values ('c99_custom_info') insert into #2ff (c35f) values ('c7a_custom_info') end else if (upper(@dcd) in ('DEFAULT')) begin insert into #2ff (c35f) values ('c7e_login_time') insert into #2ff (c35f) values ('c7e_host_name') insert into #2ff (c35f) values ('c7e_program_name') insert into #2ff (c35f) values ('c99_job_info') insert into #2ff (c35f) values ('c7e_login_name') insert into #2ff (c35f) values ('cec_database_id') insert into #2ff (c35f) values ('c7e_database_id') insert into #2ff (c35f) values ('cec_total_elapsed_time') insert into #2ff (c35f) values ('cec_status') insert into #2ff (c35f) values ('cec_command') insert into #2ff (c35f) values ('cec_wait_type') insert into #2ff (c35f) values ('cec_wait_time') insert into #2ff (c35f) values ('cec_blocking_session_id') insert into #2ff (c35f) values ('cec_sql_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('c2e_most_recent_sql_handle') insert into #2ff (c35f) values ('input_buffer') insert into #2ff (c35f) values ('text_object_name') insert into #2ff (c35f) values ('text')insert into #2ff (c35f) values ('statement') insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_cpu_time') insert into #2ff (c35f) values ('cec_reads') insert into #2ff (c35f) values ('cec_logical_reads') insert into #2ff (c35f) values ('cec_granted_query_memory') insert into #2ff (c35f) values ('cec_open_transaction_count') insert into #2ff (c35f) values ('cec_transaction_isolation_level') end else if (upper(@dcd) in ('LIMITED')) begin insert into #2ff (c35f) values ('c7e_login_time') insert into #2ff (c35f) values ('c7e_host_name') insert into #2ff (c35f) values ('c7e_program_name') insert into #2ff (c35f) values ('c99_job_info') insert into #2ff (c35f) values ('c7e_login_name') insert into #2ff (c35f) values ('cec_database_id') insert into #2ff (c35f) values ('c7e_database_id') insert into #2ff (c35f) values ('cec_total_elapsed_time') insert into #2ff (c35f) values ('cec_status') insert into #2ff (c35f) values ('cec_command') insert into #2ff (c35f) values ('cec_wait_type') insert into #2ff (c35f) values ('cec_wait_time') insert into #2ff (c35f) values ('cec_blocking_session_id') insert into #2ff (c35f) values ('cec_sql_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('c2e_most_recent_sql_handle') insert into #2ff (c35f) values ('input_buffer') insert into #2ff (c35f) values ('text_object_name') insert into #2ff (c35f) values ('text')insert into #2ff (c35f) values ('statement') insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_cpu_time') insert into #2ff (c35f) values ('cec_reads') insert into #2ff (c35f) values ('cec_logical_reads') insert into #2ff (c35f) values ('cec_granted_query_memory') insert into #2ff (c35f) values ('cec_open_transaction_count') insert into #2ff (c35f) values ('cec_transaction_isolation_level') end else if (lower(@dcd) in ('is_dead_locked', 'auth_scheme', 'statement_start_offset', 'last_request_start_time', 'last_wait_type', 'text_size', 'status', 'workers_info', 'deadlock_priority', 'ansi_defaults', 'session_id', 'full_text_query_plan', 'query_memory_grants_wait_time_ms', 'local_net_address', 'connection_id', 'client_net_address', 'status', 'wait_time', 'connection_id', 'nest_level', 'transaction_log_bytes_used', 'query_plan_checksum', 'max_cursor_dormant_duration', 'locks_info', 'num_writes', 'query_memory_grants_used_memory_kb', 'last_write', 'text_object_name', 'most_recent_session_id', 'language', 'granted_query_memory', 'is_user_process', 'cpu_time', 'original_security_id', 'host_name', 'security_id', 'context_info', 'transaction_info', 'protocol_type', 'transaction_begin_time', 'sp_whopro_inputparameters', 'last_read', 'cursor_count', 'arithabort', 'tasks_pending_io', 'procedure_stats_info', 'total_scheduled_time', 'tasks_context_switches', 'task_max_tempdb_usage_kb', 'login_name', 'lock_timeout', 'ansi_padding', 'cursors_info', 'request_id', 'node_affinity', 'open_resultset_count', 'estimated_completion_time', 'is_blocked', 'unsuccessful_logons', 'ctime', 'query_memory_grants_info', 'row_count', 'open_transaction_count', 'group_id', 'servername', 'waiting_tasks_valid_flag', 'ansi_null_dflt_on', 'query_stats_info', 'session_tempdb_usage_kb', 'nt_domain', 'query_profiles_info', 'last_unsuccessful_logon', 'input_buffer_valid_flag', 'program_name', 'last_request_end_time', 'date_first', 'net_packet_size', 'tasks_ios_per_second', 'session_id', 'ansi_nulls', 'input_buffer', 'head_blocker_session_ids', 'read_bytes_per_second', 'tasks_info', 'concat_null_yields_null', 'plan_attributes_info', 'date_format', 'task_address', 'query_memory_grants_granted_memory_kb', 'wait_resource', 'user_id', 'procedure_stats_info', 'scheduler_id', 'waiting_tasks_max_wait_duration_ms', 'transaction_isolation_level', 'query_memory_grants_max_used_memory_kb', 'quoted_identifier', 'writes', 'most_recent_sql_handle', 'tasks_io_size_kb', 'query_profiles_read_ahead_count', 'endpoint_id', 'database_id', 'is_head_blocker', 'reads', 'query_profiles_physical_read_count', 'custom_info', 'logical_reads', 'ansi_padding', 'prev_error', 'custom_info', 'arithabort', 'writes', 'command', 'trigger_stats_info', 'date_first', 'encrypt_option', 'session_tempdb_usage_info', 'net_transport', 'open_transaction_count', 'executing_managed_code', 'memory_usage', 'lock_count', 'query_plan_hash', 'total_elapsed_time', 'ansi_null_dflt_on', 'statement_sql_handle', 'start_time', 'wait_resource_info', 'tasks_count', 'date_format', 'local_tcp_port', 'group_id', 'query_profiles_logical_read_count', 'original_login_name', 'transaction_log_record_count', 'ansi_warnings', 'plan_handle', 'query_profiles_cpu_time_ms', 'lock_owner_id', 'service_broker_info', 'input_buffer_checksum', 'prev_error', 'blocking_session_id', 'waiting_tasks_blocking_session_ids', 'connection_id', 'num_reads', 'session_max_tempdb_usage_kb', 'host_process_id', 'deadlock_priority', 'session_id', 'last_successful_logon', 'wait_type', 'statement_object_name', 'quoted_identifier', 'reads', 'ansi_defaults', 'statement_end_offset', 'query_plan_text_checksum', 'protocol_version', 'trigger_stats_info', 'query_profiles_write_page_count', 'transaction_info', 'session_id', 'text_size', 'lock_count', 'connection_id', 'client_version', 'sql_handle', 'lock_timeout', 'input_buffer_checksum', 'client_tcp_port', 'row_count', 'is_blocker', 'language', 'login_time', 'endpoint_id', 'task_tempdb_usage_kb', 'cached_plans_info', 'input_buffer_valid_flag', 'session_id', 'text', 'waiting_tasks_info', 'transaction_isolation_level', 'nt_user_name', 'locks_info', 'total_elapsed_time', 'threads_info', 'percent_complete', 'query_memory_grants_ideal_memory_kb', 'transaction_id', 'blocker_session_ids', 'request_id', 'job_info', 'blocked_session_ids', 'query_memory_grants_requested_memory_kb', 'query_plan', 'transaction_begin_time', 'query_hash', 'task_tempdb_usage_info', 'connect_time', 'database_id', 'ansi_warnings', 'concat_null_yields_null', 'client_interface_name', 'text_query_plan', 'cpu_time', 'statement_context_id', 'query_stats_info', 'context_info', 'parent_connection_id', 'logical_reads', 'session_id', 'authenticating_database_id', 'ansi_nulls', 'statement', 'lock_owner_id', 'waiting_tasks_wait_types')) begin if (lower(@dcd) in ('waiting_tasks_blocking_session_ids', 'input_buffer_valid_flag', 'transaction_log_bytes_used', 'session_id', 'waiting_tasks_max_wait_duration_ms', 'sp_whopro_inputparameters', 'job_info', 'cursor_count', 'transaction_log_record_count', 'is_blocker', 'session_tempdb_usage_kb', 'service_broker_info', 'lock_count', 'transaction_info', 'input_buffer_checksum', 'session_max_tempdb_usage_kb', 'locks_info', 'custom_info', 'transaction_begin_time', 'lock_owner_id', 'waiting_tasks_info', 'blocked_session_ids', 'is_head_blocker', 'session_tempdb_usage_info', 'waiting_tasks_valid_flag', 'waiting_tasks_wait_types', 'cursors_info', 'max_cursor_dormant_duration') and lower(@dcd) not in ('session_id')) insert into #2ff (c35f, c08c) values ('c99_' + lower(@dcd), 1) if (lower(@dcd) in ('session_id', 'connection_id', 'query_stats_info', 'procedure_stats_info', 'trigger_stats_info') and lower(@dcd) not in ('session_id', 'connection_id')) insert into #2ff (c35f, c08c) values ('cb2_' + lower(@dcd), 1) if (lower(@dcd) in ('query_profiles_physical_read_count', 'trigger_stats_info', 'query_profiles_info', 'head_blocker_session_ids', 'session_id', 'task_max_tempdb_usage_kb', 'query_plan_text_checksum', 'tasks_info', 'task_tempdb_usage_info', 'query_memory_grants_used_memory_kb', 'lock_owner_id', 'query_memory_grants_wait_time_ms', 'task_tempdb_usage_kb', 'query_memory_grants_requested_memory_kb', 'transaction_info', 'query_profiles_logical_read_count', 'locks_info', 'is_dead_locked', 'blocker_session_ids', 'query_memory_grants_max_used_memory_kb', 'tasks_ios_per_second', 'query_memory_grants_ideal_memory_kb', 'lock_count', 'tasks_context_switches', 'cached_plans_info', 'tasks_io_size_kb', 'query_profiles_read_ahead_count', 'transaction_begin_time', 'query_stats_info', 'query_memory_grants_granted_memory_kb', 'query_memory_grants_info', 'procedure_stats_info', 'workers_info', 'read_bytes_per_second', 'tasks_count', 'input_buffer_checksum', 'is_blocked', 'request_id', 'tasks_pending_io', 'threads_info', 'query_profiles_write_page_count', 'query_profiles_cpu_time_ms', 'input_buffer_valid_flag', 'custom_info', 'connection_id', 'wait_resource_info') and lower(@dcd) not in ('session_id', 'request_id', 'connection_id')) insert into #2ff (c35f, c08c) values ('c7a_' + lower(@dcd), 1) if (lower(@dcd) in ('lock_timeout', 'client_version', 'total_scheduled_time', 'nt_domain', 'text_size', 'memory_usage', 'quoted_identifier', 'transaction_isolation_level', 'ansi_defaults', 'writes', 'logical_reads', 'ansi_warnings', 'concat_null_yields_null', 'authenticating_database_id', 'group_id', 'date_format', 'host_process_id', 'is_user_process', 'unsuccessful_logons', 'security_id', 'deadlock_priority', 'ansi_nulls', 'last_request_start_time', 'login_name', 'open_transaction_count', 'total_elapsed_time', 'ansi_padding', 'status', 'original_login_name', 'last_request_end_time', 'arithabort', 'session_id', 'language', 'nt_user_name', 'date_first', 'prev_error', 'cpu_time', 'original_security_id', 'client_interface_name', 'program_name', 'login_time', 'reads', 'row_count', 'ansi_null_dflt_on', 'endpoint_id', 'last_successful_logon', 'context_info', 'host_name', 'last_unsuccessful_logon', 'database_id')) insert into #2ff (c35f, c08c) values ('c7e_' + lower(@dcd), 1) if (lower(@dcd) in ('connect_time', 'last_write', 'client_tcp_port', 'local_net_address', 'parent_connection_id', 'most_recent_sql_handle', 'client_net_address', 'node_affinity', 'most_recent_session_id', 'net_packet_size', 'net_transport', 'protocol_version', 'num_writes', 'protocol_type', 'local_tcp_port', 'session_id', 'num_reads', 'last_read', 'encrypt_option', 'auth_scheme', 'endpoint_id', 'connection_id') and lower(@dcd) not in ('session_id')) insert into #2ff (c35f, c08c) values ('c2e_' + lower(@dcd), 1) if (lower(@dcd) in ('language', 'status', 'session_id', 'scheduler_id', 'query_plan_hash', 'date_format', 'prev_error', 'statement_end_offset', 'wait_resource', 'transaction_id', 'open_transaction_count', 'cpu_time', 'connection_id', 'sql_handle', 'reads', 'date_first', 'database_id', 'ansi_nulls', 'text_size', 'logical_reads', 'executing_managed_code', 'percent_complete', 'transaction_isolation_level', 'task_address', 'group_id', 'lock_timeout', 'user_id', 'nest_level', 'ansi_padding', 'arithabort', 'statement_start_offset', 'ansi_warnings', 'last_wait_type', 'writes', 'concat_null_yields_null', 'granted_query_memory', 'request_id', 'row_count', 'estimated_completion_time', 'ansi_defaults', 'wait_time', 'deadlock_priority', 'start_time', 'blocking_session_id', 'open_resultset_count', 'statement_sql_handle', 'context_info', 'wait_type', 'command', 'quoted_identifier', 'ansi_null_dflt_on', 'plan_handle', 'statement_context_id', 'query_hash', 'total_elapsed_time') and lower(@dcd) not in ('session_id', 'connection_id')) insert into #2ff (c35f, c08c) values ('cec_' + lower(@dcd), 1) if (lower(@dcd) in ('input_buffer', 'text_object_name', 'text', 'statement_object_name', 'statement', 'query_plan', 'query_plan_checksum', 'text_query_plan', 'full_text_query_plan', 'plan_attributes_info')) insert into #2ff (c35f, c08c) values (lower(@dcd), 1) if (lower(@dcd) in ('ctime')) begin insert into #2ff (c35f, c08c) values ('c7e_ctime', 1) insert into #2ff (c35f, c08c) values ('c2e_ctime', 1) insert into #2ff (c35f, c08c) values ('cec_ctime', 1) end if (lower(@dcd) in ('servername')) begin insert into #2ff (c35f, c08c) values ('c7e_servername', 1) insert into #2ff (c35f, c08c) values ('c2e_servername', 1) insert into #2ff (c35f, c08c) values ('cec_servername', 1) end end else if (lower(@dcd) in ('s.status', 's.date_format', 's.endpoint_id', 's.reads', 's.prev_error', 's.database_id', 's.language', 's.original_login_name', 's.last_unsuccessful_logon', 's.lock_timeout', 's.group_id', 's.total_elapsed_time', 's.text_size', 's.ansi_padding', 's.total_scheduled_time', 's.login_name', 's.date_first', 's.context_info', 's.unsuccessful_logons', 's.row_count', 's.ansi_warnings', 's.host_process_id', 's.input_buffer', 's.last_request_end_time', 's.security_id', 's.writes', 's.login_time', 's.program_name', 's.servername', 's.ansi_null_dflt_on', 's.host_name', 's.quoted_identifier', 's.transaction_isolation_level', 's.last_successful_logon', 's.is_user_process', 's.ansi_nulls', 's.client_interface_name', 's.nt_user_name', 's.cpu_time', 's.authenticating_database_id', 's.memory_usage', 's.deadlock_priority', 's.logical_reads', 's.client_version', 's.original_security_id', 's.ctime', 's.last_request_start_time', 's.concat_null_yields_null', 's.open_transaction_count', 's.nt_domain', 's.ansi_defaults', 's.arithabort', 's.session_id')) begin insert into #2ff (c35f, c08c) values (replace(lower(@dcd), 's.', 'c7e_'), 1) end else if (lower(@dcd) in ('c.last_read', 'c.encrypt_option', 'c.net_transport', 'c.connection_id', 'c.parent_connection_id', 'c.servername', 'c.text_object_name', 'c.last_write', 'c.most_recent_session_id', 'c.protocol_version', 'c.protocol_type', 'c.local_net_address', 'c.num_reads', 'c.endpoint_id', 'c.net_packet_size', 'c.client_net_address', 'c.connect_time', 'c.session_id', 'c.client_tcp_port', 'c.ctime', 'c.text', 'c.most_recent_sql_handle', 'c.local_tcp_port', 'c.num_writes', 'c.node_affinity', 'c.auth_scheme')) begin insert into #2ff (c35f, c08c) values (replace(lower(@dcd), 'c.', 'c2e_'), 1) end else if (lower(@dcd) in ('r.text_object_name', 'r.wait_time', 'r.statement_start_offset', 'r.session_id', 'r.query_hash', 'r.query_plan_hash', 'r.prev_error', 'r.wait_type', 'r.query_plan', 'r.open_resultset_count', 'r.last_wait_type', 'r.statement', 'r.plan_attributes_info', 'r.percent_complete', 'r.plan_handle', 'r.language', 'r.user_id', 'r.statement_end_offset', 'r.arithabort', 'r.sql_handle', 'r.estimated_completion_time', 'r.start_time', 'r.scheduler_id', 'r.ansi_defaults', 'r.cpu_time', 'r.query_plan_checksum', 'r.ansi_warnings', 'r.ansi_padding', 'r.writes', 'r.database_id', 'r.date_format', 'r.full_text_query_plan', 'r.servername', 'r.request_id', 'r.nest_level', 'r.blocking_session_id', 'r.executing_managed_code', 'r.row_count', 'r.concat_null_yields_null', 'r.text_query_plan', 'r.statement_sql_handle', 'r.transaction_isolation_level', 'r.ansi_nulls', 'r.total_elapsed_time', 'r.connection_id', 'r.reads', 'r.ctime', 'r.task_address', 'r.date_first', 'r.statement_object_name', 'r.command', 'r.text_size', 'r.lock_timeout', 'r.transaction_id', 'r.logical_reads', 'r.context_info', 'r.input_buffer', 'r.group_id', 'r.deadlock_priority', 'r.open_transaction_count', 'r.statement_context_id', 'r.wait_resource', 'r.quoted_identifier', 'r.ansi_null_dflt_on', 'r.status', 'r.granted_query_memory', 'r.text')) begin insert into #2ff (c35f, c08c) values (replace(lower(@dcd), 'r.', 'cec_'), 1) end else if (lower(@dcd) in ('s.input_buffer_checksum', 's.waiting_tasks_valid_flag', 's.transaction_begin_time', 's.waiting_tasks_wait_types', 's.transaction_info', 's.lock_count', 's.job_info', 's.waiting_tasks_max_wait_duration_ms', 's.waiting_tasks_blocking_session_ids', 's.lock_owner_id', 's.input_buffer_valid_flag', 's.sp_whopro_inputparameters', 's.locks_info', 's.cursor_count', 's.waiting_tasks_info', 's.is_blocker', 's.session_tempdb_usage_kb', 's.session_max_tempdb_usage_kb', 's.is_head_blocker', 's.cursors_info', 's.session_tempdb_usage_info', 's.max_cursor_dormant_duration', 's.custom_info', 's.service_broker_info', 's.blocked_session_ids', 's.transaction_log_record_count', 's.transaction_log_bytes_used')) begin insert into #2ff (c35f, c08c) values (replace(lower(@dcd), 's.', 'c99_'), 1) end else if (lower(@dcd) in ('c.trigger_stats_info', 'c.query_stats_info', 'c.procedure_stats_info')) begin insert into #2ff (c35f, c08c) values (replace(lower(@dcd), 'c.', 'cb2_'), 1) end else if (lower(@dcd) in ('r.head_blocker_session_ids', 'r.query_stats_info', 'r.tasks_context_switches', 'r.is_dead_locked', 'r.cached_plans_info', 'r.transaction_begin_time', 'r.query_profiles_write_page_count', 'r.lock_count', 'r.query_profiles_physical_read_count', 'r.lock_owner_id', 'r.blocker_session_ids', 'r.is_blocked', 'r.transaction_info', 'r.query_profiles_read_ahead_count', 'r.threads_info', 'r.task_tempdb_usage_kb', 'r.query_memory_grants_granted_memory_kb', 'r.query_memory_grants_max_used_memory_kb', 'r.read_bytes_per_second', 'r.tasks_count', 'r.task_max_tempdb_usage_kb', 'r.workers_info', 'r.query_profiles_cpu_time_ms', 'r.locks_info', 'r.procedure_stats_info', 'r.query_memory_grants_info', 'r.query_profiles_info', 'r.query_memory_grants_requested_memory_kb', 'r.tasks_info', 'r.query_memory_grants_used_memory_kb', 'r.wait_resource_info', 'r.query_plan_text_checksum', 'r.tasks_ios_per_second', 'r.input_buffer_checksum', 'r.tasks_io_size_kb', 'r.query_memory_grants_wait_time_ms', 'r.trigger_stats_info', 'r.tasks_pending_io', 'r.custom_info', 'r.query_memory_grants_ideal_memory_kb', 'r.query_profiles_logical_read_count', 'r.input_buffer_valid_flag', 'r.task_tempdb_usage_info')) begin insert into #2ff (c35f, c08c) values (replace(lower(@dcd), 'r.', 'c7a_'), 1) end else if (upper(@dcd) not in ('DETAILED', 'ALL')) begin set @ea1 = 'Invalid option ''' + @dcd + ''' for parameter @columns specified' raiserror (@ea1, 17, 1) set @datetime = NULL close c0aa deallocate c0aa return 1 end fetch next from c0aa into @dcd end close c0aa deallocate c0aa end if (exists (select c35f from #2ff where c35f in ('c7e_ctime', 'c2e_ctime', 'cec_ctime')) and @5d0 = 0 and @datetime is NULL) begin set @ea1 = 'Invalid option ''ctime'' for parameter @columns specified, invalid without @sessions option ''SAVE'' or @datetime is NULL.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end if (exists (select c35f from #2ff where c35f in ('c7e_servername', 'c2e_servername', 'cec_servername')) and @5d0 = 0 and @datetime is NULL) begin set @ea1 = 'Invalid option ''servername'' for parameter @columns specified, invalid without @sessions option ''SAVE'' or @datetime is NULL.' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end if exists (select cc9a from #253 where upper(cc9a) = 'ALL') begin insert into #2ff (c35f) values ('c99_job_info') insert into #2ff (c35f) values ('c99_is_blocker') insert into #2ff (c35f) values ('c99_is_head_blocker') insert into #2ff (c35f) values ('c99_blocked_session_ids') insert into #2ff (c35f) values ('c99_input_buffer_checksum') insert into #2ff (c35f) values ('c99_input_buffer_valid_flag') insert into #2ff (c35f) values ('c99_lock_count') insert into #2ff (c35f) values ('c99_lock_owner_id') insert into #2ff (c35f) values ('c99_locks_info') insert into #2ff (c35f) values ('c99_transaction_begin_time') insert into #2ff (c35f) values ('c99_transaction_log_record_count') insert into #2ff (c35f) values ('c99_transaction_log_bytes_used') insert into #2ff (c35f) values ('c99_transaction_info') insert into #2ff (c35f) values ('c99_session_tempdb_usage_kb') insert into #2ff (c35f) values ('c99_session_max_tempdb_usage_kb') insert into #2ff (c35f) values ('c99_session_tempdb_usage_info') insert into #2ff (c35f) values ('c99_cursor_count') insert into #2ff (c35f) values ('c99_max_cursor_dormant_duration') insert into #2ff (c35f) values ('c99_cursors_info') insert into #2ff (c35f) values ('c99_waiting_tasks_wait_types') insert into #2ff (c35f) values ('c99_waiting_tasks_max_wait_duration_ms') insert into #2ff (c35f) values ('c99_waiting_tasks_blocking_session_ids') insert into #2ff (c35f) values ('c99_waiting_tasks_valid_flag') insert into #2ff (c35f) values ('c99_waiting_tasks_info') insert into #2ff (c35f) values ('c99_service_broker_info') insert into #2ff (c35f) values ('c99_sp_whopro_inputparameters') insert into #2ff (c35f) values ('c99_custom_info') insert into #2ff (c35f) values ('cb2_query_stats_info') insert into #2ff (c35f) values ('cb2_procedure_stats_info') insert into #2ff (c35f) values ('cb2_trigger_stats_info') insert into #2ff (c35f) values ('c7a_is_blocked') insert into #2ff (c35f) values ('c7a_is_dead_locked') insert into #2ff (c35f) values ('c7a_blocker_session_ids') insert into #2ff (c35f) values ('c7a_head_blocker_session_ids') insert into #2ff (c35f) values ('c7a_input_buffer_checksum') insert into #2ff (c35f) values ('c7a_input_buffer_valid_flag') insert into #2ff (c35f) values ('c7a_wait_resource_info') insert into #2ff (c35f) values ('c7a_lock_count') insert into #2ff (c35f) values ('c7a_lock_owner_id') insert into #2ff (c35f) values ('c7a_locks_info') insert into #2ff (c35f) values ('c7a_transaction_begin_time') insert into #2ff (c35f) values ('c7a_transaction_info') insert into #2ff (c35f) values ('c7a_task_tempdb_usage_kb') insert into #2ff (c35f) values ('c7a_task_max_tempdb_usage_kb') insert into #2ff (c35f) values ('c7a_task_tempdb_usage_info') insert into #2ff (c35f) values ('c7a_query_memory_grants_requested_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_granted_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_used_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_max_used_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_wait_time_ms') insert into #2ff (c35f) values ('c7a_query_memory_grants_ideal_memory_kb') insert into #2ff (c35f) values ('c7a_query_memory_grants_info') insert into #2ff (c35f) values ('c7a_query_profiles_cpu_time_ms') insert into #2ff (c35f) values ('c7a_query_profiles_logical_read_count') insert into #2ff (c35f) values ('c7a_query_profiles_physical_read_count') insert into #2ff (c35f) values ('c7a_query_profiles_read_ahead_count') insert into #2ff (c35f) values ('c7a_query_profiles_write_page_count') insert into #2ff (c35f) values ('c7a_query_profiles_info') insert into #2ff (c35f) values ('c7a_query_stats_info') insert into #2ff (c35f) values ('c7a_procedure_stats_info') insert into #2ff (c35f) values ('c7a_trigger_stats_info') insert into #2ff (c35f) values ('c7a_cached_plans_info') insert into #2ff (c35f) values ('c7a_tasks_count') insert into #2ff (c35f) values ('c7a_tasks_context_switches') insert into #2ff (c35f) values ('c7a_tasks_pending_io') insert into #2ff (c35f) values ('c7a_tasks_io_size_kb') insert into #2ff (c35f) values ('c7a_read_bytes_per_second') insert into #2ff (c35f) values ('c7a_tasks_ios_per_second') insert into #2ff (c35f) values ('c7a_tasks_info') insert into #2ff (c35f) values ('c7a_workers_info') insert into #2ff (c35f) values ('c7a_threads_info') insert into #2ff (c35f) values ('c7a_custom_info') insert into #2ff (c35f) values ('c7e_login_time') insert into #2ff (c35f) values ('c7e_host_name') insert into #2ff (c35f) values ('c7e_program_name') insert into #2ff (c35f) values ('c7e_host_process_id') insert into #2ff (c35f) values ('c7e_client_version') insert into #2ff (c35f) values ('c7e_client_interface_name') insert into #2ff (c35f) values ('c7e_security_id') insert into #2ff (c35f) values ('c7e_login_name') insert into #2ff (c35f) values ('c7e_nt_domain') insert into #2ff (c35f) values ('c7e_nt_user_name') insert into #2ff (c35f) values ('c7e_status') insert into #2ff (c35f) values ('c7e_context_info') insert into #2ff (c35f) values ('c7e_cpu_time') insert into #2ff (c35f) values ('c7e_memory_usage') insert into #2ff (c35f) values ('c7e_total_scheduled_time') insert into #2ff (c35f) values ('c7e_total_elapsed_time') insert into #2ff (c35f) values ('c7e_endpoint_id') insert into #2ff (c35f) values ('c7e_last_request_start_time') insert into #2ff (c35f) values ('c7e_last_request_end_time') insert into #2ff (c35f) values ('c7e_reads') insert into #2ff (c35f) values ('c7e_writes') insert into #2ff (c35f) values ('c7e_logical_reads') insert into #2ff (c35f) values ('c7e_is_user_process') insert into #2ff (c35f) values ('c7e_text_size') insert into #2ff (c35f) values ('c7e_language') insert into #2ff (c35f) values ('c7e_date_format') insert into #2ff (c35f) values ('c7e_date_first') insert into #2ff (c35f) values ('c7e_quoted_identifier') insert into #2ff (c35f) values ('c7e_arithabort') insert into #2ff (c35f) values ('c7e_ansi_null_dflt_on') insert into #2ff (c35f) values ('c7e_ansi_defaults') insert into #2ff (c35f) values ('c7e_ansi_warnings') insert into #2ff (c35f) values ('c7e_ansi_padding') insert into #2ff (c35f) values ('c7e_ansi_nulls') insert into #2ff (c35f) values ('c7e_concat_null_yields_null') insert into #2ff (c35f) values ('c7e_transaction_isolation_level') insert into #2ff (c35f) values ('c7e_lock_timeout') insert into #2ff (c35f) values ('c7e_deadlock_priority') insert into #2ff (c35f) values ('c7e_row_count') insert into #2ff (c35f) values ('c7e_prev_error') insert into #2ff (c35f) values ('c7e_original_security_id') insert into #2ff (c35f) values ('c7e_original_login_name') insert into #2ff (c35f) values ('c7e_last_successful_logon') insert into #2ff (c35f) values ('c7e_last_unsuccessful_logon') insert into #2ff (c35f) values ('c7e_unsuccessful_logons') insert into #2ff (c35f) values ('c7e_group_id') insert into #2ff (c35f) values ('c7e_database_id') insert into #2ff (c35f) values ('c7e_authenticating_database_id') insert into #2ff (c35f) values ('c7e_open_transaction_count') insert into #2ff (c35f) values ('c2e_most_recent_session_id') insert into #2ff (c35f) values ('c2e_connect_time') insert into #2ff (c35f) values ('c2e_net_transport') insert into #2ff (c35f) values ('c2e_protocol_type') insert into #2ff (c35f) values ('c2e_protocol_version') insert into #2ff (c35f) values ('c2e_endpoint_id') insert into #2ff (c35f) values ('c2e_encrypt_option') insert into #2ff (c35f) values ('c2e_auth_scheme') insert into #2ff (c35f) values ('c2e_node_affinity') insert into #2ff (c35f) values ('c2e_num_reads') insert into #2ff (c35f) values ('c2e_num_writes') insert into #2ff (c35f) values ('c2e_last_read') insert into #2ff (c35f) values ('c2e_last_write') insert into #2ff (c35f) values ('c2e_net_packet_size') insert into #2ff (c35f) values ('c2e_client_net_address') insert into #2ff (c35f) values ('c2e_client_tcp_port') insert into #2ff (c35f) values ('c2e_local_net_address') insert into #2ff (c35f) values ('c2e_local_tcp_port') insert into #2ff (c35f) values ('c2e_parent_connection_id') insert into #2ff (c35f) values ('c2e_most_recent_sql_handle') insert into #2ff (c35f) values ('cec_start_time') insert into #2ff (c35f) values ('cec_status') insert into #2ff (c35f) values ('cec_command') insert into #2ff (c35f) values ('cec_sql_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_database_id') insert into #2ff (c35f) values ('cec_user_id') insert into #2ff (c35f) values ('cec_blocking_session_id') insert into #2ff (c35f) values ('cec_wait_type') insert into #2ff (c35f) values ('cec_wait_time') insert into #2ff (c35f) values ('cec_last_wait_type') insert into #2ff (c35f) values ('cec_wait_resource') insert into #2ff (c35f) values ('cec_open_transaction_count') insert into #2ff (c35f) values ('cec_open_resultset_count') insert into #2ff (c35f) values ('cec_transaction_id') insert into #2ff (c35f) values ('cec_context_info') insert into #2ff (c35f) values ('cec_percent_complete') insert into #2ff (c35f) values ('cec_estimated_completion_time') insert into #2ff (c35f) values ('cec_cpu_time') insert into #2ff (c35f) values ('cec_total_elapsed_time') insert into #2ff (c35f) values ('cec_scheduler_id') insert into #2ff (c35f) values ('cec_task_address') insert into #2ff (c35f) values ('cec_reads') insert into #2ff (c35f) values ('cec_writes') insert into #2ff (c35f) values ('cec_logical_reads') insert into #2ff (c35f) values ('cec_text_size') insert into #2ff (c35f) values ('cec_language') insert into #2ff (c35f) values ('cec_date_format') insert into #2ff (c35f) values ('cec_date_first') insert into #2ff (c35f) values ('cec_quoted_identifier') insert into #2ff (c35f) values ('cec_arithabort') insert into #2ff (c35f) values ('cec_ansi_null_dflt_on') insert into #2ff (c35f) values ('cec_ansi_defaults') insert into #2ff (c35f) values ('cec_ansi_warnings') insert into #2ff (c35f) values ('cec_ansi_padding') insert into #2ff (c35f) values ('cec_ansi_nulls') insert into #2ff (c35f) values ('cec_concat_null_yields_null') insert into #2ff (c35f) values ('cec_transaction_isolation_level') insert into #2ff (c35f) values ('cec_lock_timeout') insert into #2ff (c35f) values ('cec_deadlock_priority') insert into #2ff (c35f) values ('cec_row_count') insert into #2ff (c35f) values ('cec_prev_error') insert into #2ff (c35f) values ('cec_nest_level') insert into #2ff (c35f) values ('cec_granted_query_memory') insert into #2ff (c35f) values ('cec_executing_managed_code') insert into #2ff (c35f) values ('cec_group_id') insert into #2ff (c35f) values ('cec_query_hash') insert into #2ff (c35f) values ('cec_query_plan_hash') insert into #2ff (c35f) values ('cec_statement_sql_handle') insert into #2ff (c35f) values ('cec_statement_context_id') end delete from #2ff where (c35f like 'c7e[_]%' and c35f not in ('c7e_session_id', 'c7e_login_time', 'c7e_host_name', 'c7e_program_name', 'c7e_host_process_id', 'c7e_client_version', 'c7e_client_interface_name', 'c7e_security_id', 'c7e_login_name', 'c7e_nt_domain', 'c7e_nt_user_name', 'c7e_status', 'c7e_context_info', 'c7e_cpu_time', 'c7e_memory_usage', 'c7e_total_scheduled_time', 'c7e_total_elapsed_time', 'c7e_endpoint_id', 'c7e_last_request_start_time', 'c7e_last_request_end_time', 'c7e_reads', 'c7e_writes', 'c7e_logical_reads', 'c7e_is_user_process', 'c7e_text_size', 'c7e_language', 'c7e_date_format', 'c7e_date_first', 'c7e_quoted_identifier', 'c7e_arithabort', 'c7e_ansi_null_dflt_on', 'c7e_ansi_defaults', 'c7e_ansi_warnings', 'c7e_ansi_padding', 'c7e_ansi_nulls', 'c7e_concat_null_yields_null', 'c7e_transaction_isolation_level', 'c7e_lock_timeout', 'c7e_deadlock_priority', 'c7e_row_count', 'c7e_prev_error', 'c7e_original_security_id', 'c7e_original_login_name', 'c7e_last_successful_logon', 'c7e_last_unsuccessful_logon', 'c7e_unsuccessful_logons', 'c7e_group_id', 'c7e_database_id', 'c7e_authenticating_database_id', 'c7e_open_transaction_count', 'c7e_ctime', 'c7e_servername', 'c7e_input_buffer')) delete from #2ff where (c35f like 'c2e[_]%' and c35f not in ('c2e_session_id', 'c2e_most_recent_session_id', 'c2e_connect_time', 'c2e_net_transport', 'c2e_protocol_type', 'c2e_protocol_version', 'c2e_endpoint_id', 'c2e_encrypt_option', 'c2e_auth_scheme', 'c2e_node_affinity', 'c2e_num_reads', 'c2e_num_writes', 'c2e_last_read', 'c2e_last_write', 'c2e_net_packet_size', 'c2e_client_net_address', 'c2e_client_tcp_port', 'c2e_local_net_address', 'c2e_local_tcp_port', 'c2e_connection_id', 'c2e_parent_connection_id', 'c2e_most_recent_sql_handle', 'c2e_ctime', 'c2e_servername', 'c2e_text_object_name', 'c2e_text')) delete from #2ff where (c35f like 'cec[_]%' and c35f not in ('cec_session_id', 'cec_request_id', 'cec_start_time', 'cec_status', 'cec_command', 'cec_sql_handle', 'cec_statement_start_offset', 'cec_statement_end_offset', 'cec_plan_handle', 'cec_database_id', 'cec_user_id', 'cec_connection_id', 'cec_blocking_session_id', 'cec_wait_type', 'cec_wait_time', 'cec_last_wait_type', 'cec_wait_resource', 'cec_open_transaction_count', 'cec_open_resultset_count', 'cec_transaction_id', 'cec_context_info', 'cec_percent_complete', 'cec_estimated_completion_time', 'cec_cpu_time', 'cec_total_elapsed_time', 'cec_scheduler_id', 'cec_task_address', 'cec_reads', 'cec_writes', 'cec_logical_reads', 'cec_text_size', 'cec_language', 'cec_date_format', 'cec_date_first', 'cec_quoted_identifier', 'cec_arithabort', 'cec_ansi_null_dflt_on', 'cec_ansi_defaults', 'cec_ansi_warnings', 'cec_ansi_padding', 'cec_ansi_nulls', 'cec_concat_null_yields_null', 'cec_transaction_isolation_level', 'cec_lock_timeout', 'cec_deadlock_priority', 'cec_row_count', 'cec_prev_error', 'cec_nest_level', 'cec_granted_query_memory', 'cec_executing_managed_code', 'cec_group_id', 'cec_query_hash', 'cec_query_plan_hash', 'cec_statement_sql_handle', 'cec_statement_context_id', 'cec_ctime', 'cec_servername', 'cec_input_buffer', 'cec_text_object_name', 'cec_text', 'cec_statement_object_name', 'cec_statement', 'cec_query_plan', 'cec_query_plan_checksum', 'cec_text_query_plan', 'cec_full_text_query_plan', 'cec_plan_attributes_info')) if exists (select c35f from #2ff where c35f in ('input_buffer')) begin if not exists (select c35f from #2ff where c35f in ('c99_input_buffer_checksum')) insert into #2ff (c35f) values ('c99_input_buffer_checksum') if not exists (select c35f from #2ff where c35f in ('c7a_input_buffer_checksum')) insert into #2ff (c35f) values ('c7a_input_buffer_checksum') end if exists (select c35f from #2ff where c35f in ('c7e_input_buffer')) if not exists (select c35f from #2ff where c35f in ('c99_input_buffer_checksum')) insert into #2ff (c35f) values ('c99_input_buffer_checksum') if exists (select c35f from #2ff where c35f in ('cec_input_buffer')) if not exists (select c35f from #2ff where c35f in ('c7a_input_buffer_checksum')) insert into #2ff (c35f) values ('c7a_input_buffer_checksum') if exists (select c35f from #2ff where c35f in ('query_plan_checksum', 'cec_query_plan_checksum')) begin insert into #2ff (c35f) values ('c7a_query_plan_text_checksum') end if @5d0 = 1 begin if exists (select c35f from #2ff where c35f in ('text_object_name', 'text', 'c2e_text_object_name', 'c2e_text', 'cec_text_object_name', 'cec_text')) begin insert into #2ff (c35f) values ('cec_sql_handle') insert into #2ff (c35f) values ('c2e_most_recent_sql_handle') end if exists (select c35f from #2ff where c35f in ('statement_object_name', 'statement', 'cec_statement_object_name', 'cec_statement')) begin insert into #2ff (c35f) values ('cec_sql_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') end if exists (select c35f from #2ff where c35f in ('query_plan', 'cec_query_plan', 'query_plan_checksum', 'cec_query_plan_checksum')) begin insert into #2ff (c35f) values ('cec_plan_handle') end if exists (select c35f from #2ff where c35f in ('text_query_plan', 'cec_text_query_plan', 'full_text_query_plan', 'cec_full_text_query_plan')) begin insert into #2ff (c35f) values ('cec_plan_handle') insert into #2ff (c35f) values ('cec_statement_start_offset') insert into #2ff (c35f) values ('cec_statement_end_offset') end if exists (select c35f from #2ff where c35f in ('plan_attributes_info', 'cec_plan_attributes_info')) insert into #2ff (c35f) values ('cec_plan_handle') end if exists (select c35f from #2ff where c35f in ('c99_blocked_session_ids')) if not exists (select c35f from #2ff where c35f in ('c99_is_blocker')) insert into #2ff (c35f) values ('c99_is_blocker') if exists (select c35f from #2ff where c35f in ('c7a_wait_resource_info')) if not exists (select c35f from #2ff where c35f in ('c7a_wait_resource')) insert into #2ff (c35f) values ('c7a_wait_resource_info') if exists (select c35f from #2ff where c35f in ('c7a_is_dead_locked', 'c7a_blocker_session_ids', 'c7a_head_blocker_session_ids')) if not exists (select c35f from #2ff where c35f in ('c7a_is_blocked')) insert into #2ff (c35f) values ('c7a_is_blocked') if exists (select c35f from #2ff where c35f in ('c99_is_head_blocker')) if not exists (select c35f from #2ff where c35f in ('c7a_is_dead_locked')) insert into #2ff (c35f) values ('c7a_is_dead_locked') if exists (select c35f from #2ff where c35f in ('c7a_head_blocker_session_ids')) if not exists (select c35f from #2ff where c35f in ('c99_is_head_blocker')) insert into #2ff (c35f) values ('c99_is_head_blocker') select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'Parsing parameter took ' + cast(@a09 as nvarchar(256)) + ' ms' declare @355 bit set @355 = 0 if (@datetime is not NULL) begin if (exists (select c35f from #fa4) or @5d0 = 1 or @5e6 = 1) begin set @ea1 = 'When @datetime is passed, @sessions has to be NULL or can only have option ''NOOUTPUT''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @355 = 1 end else begin select @254 = getdate()
	if exists (select c35f from #2ff where c35f in ('query_plan', 'cec_query_plan')) begin create table #f20 (plan_handle varbinary(64), query_plan_info nvarchar(1024), dbid smallint, objectid int, number smallint, encrypted bit, query_plan xml, ctime datetime, rcount smallint, primary key (plan_handle)) if (@5d0 = 1 and @b16 = 0) begin set @697 = 'use [' + db_name(@09e) + '] if not exists (select name from sys.objects where schema_id = ' + cast (@bcc as nvarchar(256)) + ' and name = ''sqlws_dm_exec_query_plan'') create table [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan (servername nvarchar(256), plan_handle varbinary(64), query_plan_info nvarchar(1024), dbid smallint, objectid int, number smallint, encrypted bit, query_plan xml, ctime datetime, rtime datetime, rcount bigint, primary key (servername, plan_handle)) if not exists (select c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_query_plan'' and c.name = ''ctime'') alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan add ctime datetime, rtime datetime, rcount bigint' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] create table [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end end
	if exists (select c35f from #2ff where c35f in ('c7a_task_tempdb_usage_kb', 'c7a_task_max_tempdb_usage_kb', 'c7a_task_tempdb_usage_info')) create table #e70 (cd18 varbinary(8), c157 bit, cd43 smallint, c9d7 int, ca87 int, cd24 int, c52c bigint, cdea bigint, c248 bigint, c84f bigint, cc53 datetime)
	if exists (select c35f from #2ff where c35f in ('c7a_threads_info')) if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) create table #d98 (c50f varbinary(8), cc40 bit, c626 int, c2db int, cef9 varbinary(8), c87f datetime, c64e bigint, cdd1 bigint, c0b2 varbinary(8), c3fe varbinary(8), c272 int, c8fe int, cfa6 bigint, c569 int, c2a7 int, ca98 varbinary(8), ca02 int, c952 int, ca8e varbinary(8), c59c varbinary(8), c369 varbinary(8), cd62 varbinary(8), c7de varbinary(8), cdce varbinary(8), c3ce varbinary(8), c9dd smallint, cc53 datetime)
	if exists (select c35f from #2ff where c35f in ('cb2_procedure_stats_info', 'c7a_procedure_stats_info')) create table #066 (cd24 int, c20d int, c55f char(2), c20b nvarchar(60), c153 varbinary(64), ce84 varbinary(64), c418 datetime, c2f9 datetime, c521 bigint, cb4f bigint, c3a8 bigint, cc50 bigint, caa0 bigint, cfbf bigint, c2f7 bigint, c9ff bigint, c6f9 bigint, cb96 bigint, c5f3 bigint, c5bf bigint, c878 bigint, cf41 bigint, c9cf bigint, ce3c bigint, c55d bigint, cc5d bigint, c750 bigint, cac9 bigint, c8ce bigint)
	if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) create table #f5c (cd18 varbinary(8), c005 nvarchar(60), ce18 int, c580 int, c0d4 bigint, cbdb int, c461 int, cd43 smallint, ca87 int, c9d7 int, c7de varbinary(8), c4b9 varbinary(8), cb5e varbinary(8), cc53 datetime, ctime datetime) create table #a52 (c7e_session_id smallint, c7e_login_time datetime, c7e_host_name nvarchar(128), c7e_program_name nvarchar(128), c7e_host_process_id int, c7e_client_version int, c7e_client_interface_name nvarchar(32), c7e_security_id varbinary(85), c7e_login_name nvarchar(128), c7e_nt_domain nvarchar(128), c7e_nt_user_name nvarchar(128), c7e_status nvarchar(30), c7e_context_info varbinary(128), c7e_cpu_time int, c7e_memory_usage int, c7e_total_scheduled_time int, c7e_total_elapsed_time int, c7e_endpoint_id int, c7e_last_request_start_time datetime, c7e_last_request_end_time datetime, c7e_reads bigint, c7e_writes bigint, c7e_logical_reads bigint, c7e_is_user_process bit, c7e_text_size int, c7e_language nvarchar(128), c7e_date_format nvarchar(3), c7e_date_first smallint, c7e_quoted_identifier bit, c7e_arithabort bit, c7e_ansi_null_dflt_on bit, c7e_ansi_defaults bit, c7e_ansi_warnings bit, c7e_ansi_padding bit, c7e_ansi_nulls bit, c7e_concat_null_yields_null bit, c7e_transaction_isolation_level smallint, c7e_lock_timeout int, c7e_deadlock_priority int, c7e_row_count bigint, c7e_prev_error int, c7e_original_security_id varbinary(85), c7e_original_login_name nvarchar(128), c7e_last_successful_logon datetime, c7e_last_unsuccessful_logon datetime, c7e_unsuccessful_logons bigint, c7e_group_id int, c7e_database_id smallint, c7e_authenticating_database_id int, c7e_open_transaction_count int, c2e_session_id int, c2e_most_recent_session_id int, c2e_connect_time datetime, c2e_net_transport nvarchar(40), c2e_protocol_type nvarchar(40), c2e_protocol_version int, c2e_endpoint_id int, c2e_encrypt_option nvarchar(40), c2e_auth_scheme nvarchar(40), c2e_node_affinity smallint, c2e_num_reads int, c2e_num_writes int, c2e_last_read datetime, c2e_last_write datetime, c2e_net_packet_size int, c2e_client_net_address varchar(48), c2e_client_tcp_port int, c2e_local_net_address varchar(48), c2e_local_tcp_port int, c2e_connection_id uniqueidentifier, c2e_parent_connection_id uniqueidentifier, c2e_most_recent_sql_handle varbinary(64), cec_session_id smallint, cec_request_id int, cec_start_time datetime, cec_status nvarchar(30), cec_command nvarchar(32), cec_sql_handle varbinary(64), cec_statement_start_offset int, cec_statement_end_offset int, cec_plan_handle varbinary(64), cec_database_id smallint, cec_user_id int, cec_connection_id uniqueidentifier, cec_blocking_session_id smallint, cec_wait_type nvarchar(60), cec_wait_time int, cec_last_wait_type nvarchar(60), cec_wait_resource nvarchar(256), cec_open_transaction_count int, cec_open_resultset_count int, cec_transaction_id bigint, cec_context_info varbinary(128), cec_percent_complete real, cec_estimated_completion_time bigint, cec_cpu_time int, cec_total_elapsed_time int, cec_scheduler_id int, cec_task_address varbinary(8), cec_reads bigint, cec_writes bigint, cec_logical_reads bigint, cec_text_size int, cec_language nvarchar(128), cec_date_format nvarchar(3), cec_date_first smallint, cec_quoted_identifier bit, cec_arithabort bit, cec_ansi_null_dflt_on bit, cec_ansi_defaults bit, cec_ansi_warnings bit, cec_ansi_padding bit, cec_ansi_nulls bit, cec_concat_null_yields_null bit, cec_transaction_isolation_level smallint, cec_lock_timeout int, cec_deadlock_priority int, cec_row_count bigint, cec_prev_error int, cec_nest_level int, cec_granted_query_memory int, cec_executing_managed_code bit, cec_group_id int, cec_query_hash binary(8), cec_query_plan_hash binary(8), cec_statement_sql_handle varbinary(64), cec_statement_context_id bigint, ctime datetime)
	if exists (select c35f from #2ff where c35f in ('c99_service_broker_info')) create table #588 (c96f int, cd24 smallint, cd0c int, c891 nvarchar(325), c0b0 int, c4d8 datetime)
	if exists (select c35f from #2ff where c35f in ('text_object_name', 'text', 'c2e_text_object_name', 'c2e_text', 'cec_text_object_name', 'cec_text', 'statement_object_name', 'statement', 'cec_statement_object_name', 'cec_statement', 'c99_cursors_info')) begin create table #fbf (sql_handle varbinary(64), sql_text_info nvarchar(1024), dbid smallint, objectid int, number smallint, encrypted bit, text nvarchar(max), ctime datetime, rcount smallint, primary key (sql_handle)) if (@5d0 = 1 and @b16 = 0) begin set @697 = 'use [' + db_name(@09e) + '] if not exists (select name from sys.objects where schema_id = ' + cast (@bcc as nvarchar(256)) + ' and name = ''sqlws_dm_exec_sql_text'') create table [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text (servername nvarchar(256), sql_handle varbinary(64), sql_text_info nvarchar(1024), dbid smallint, objectid int, number smallint, encrypted bit, text nvarchar(max), ctime datetime, rtime datetime, rcount bigint, primary key (servername, sql_handle)) if not exists (select c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_sql_text'' and c.name = ''ctime'') alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text add ctime datetime, rtime datetime, rcount bigint' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] create table [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end end
	if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_requested_memory_kb', 'c7a_query_memory_grants_granted_memory_kb', 'c7a_query_memory_grants_used_memory_kb', 'c7a_query_memory_grants_max_used_memory_kb', 'c7a_query_memory_grants_wait_time_ms', 'c7a_query_memory_grants_ideal_memory_kb', 'c7a_query_memory_grants_info')) create table #525 (cd43 smallint, c9d7 int, c461 int, c59e smallint, c3d2 datetime, ccb7 datetime, c1e1 bigint, c28c bigint, c4fe bigint, c5be bigint, c54c bigint, cc47 float, c388 int, cdf3 smallint, cd0c smallint, cb7b int, cd36 bit, c4e0 bigint, ce84 varbinary(64), c153 varbinary(64), c52d int, c5e8 int, cb4d bit, c62f bigint, cc53 datetime) create table #dd0 (session_id int, most_recent_session_id int, connect_time datetime, net_transport nvarchar(40), protocol_type nvarchar(40), protocol_version int, endpoint_id int, encrypt_option nvarchar(40), auth_scheme nvarchar(40), node_affinity smallint, num_reads int, num_writes int, last_read datetime, last_write datetime, net_packet_size int, client_net_address varchar(48), client_tcp_port int, local_net_address varchar(48), local_tcp_port int, connection_id uniqueidentifier, parent_connection_id uniqueidentifier, most_recent_sql_handle varbinary(64), ctime datetime, primary key (session_id, connection_id))
	if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_wait_types', 'c99_waiting_tasks_max_wait_duration_ms', 'c99_waiting_tasks_blocking_session_ids', 'c99_waiting_tasks_valid_flag', 'c99_waiting_tasks_info', 'c99_lock_count', 'c7a_lock_count', 'c99_lock_owner_id', 'c7a_lock_owner_id', 'c99_locks_info', 'c7a_locks_info', 'c99_is_blocker', 'c99_is_head_blocker', 'c7a_is_blocked', 'c7a_is_dead_locked', 'c99_blocked_session_ids', 'c7a_blocker_session_ids', 'c7a_head_blocker_session_ids')) create table #476 (cf35 varbinary(8), cd43 smallint, ca87 int, c693 bigint, c896 nvarchar(60), cc60 varbinary(8), cb2c varbinary(8), c114 smallint, cedf int, c1f6 nvarchar(3072), ca43 int, c285 int, c73a bigint, c297 nvarchar(max), c4d8 datetime)
	if exists (select c35f from #2ff where c35f in ('input_buffer', 'c7e_input_buffer', 'cec_input_buffer', 'c99_input_buffer_checksum', 'c7a_input_buffer_checksum', 'c99_input_buffer_valid_flag', 'c7a_input_buffer_valid_flag')) begin create table #384 (checksum int, EventType nvarchar(30), Parameters smallint, EventInfo nvarchar(4000), ctime datetime, rcount smallint, primary key (checksum)) if (@5d0 = 1 and @b16 = 0) begin set @697 = 'use [' + db_name(@09e) + '] if not exists (select name from sys.objects where schema_id = ' + cast (@bcc as nvarchar(256)) + ' and name = ''sqlws_input_buffer'') create table [' + schema_name(@bcc) + '].sqlws_input_buffer (servername nvarchar(256), checksum int, EventType nvarchar(30), Parameters smallint, EventInfo nvarchar(4000), ctime datetime, rtime datetime, rcount bigint, primary key (servername, checksum)) if not exists (select c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_input_buffer'' and c.name = ''ctime'') alter table [' + schema_name(@bcc) + '].sqlws_input_buffer add ctime datetime, rtime datetime, rcount bigint' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] create table [' + schema_name(@bcc) + '].sqlws_input_buffer failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end create table #c4f (cd43 smallint, c9d7 int, cd88 int, cc53 datetime, ca6d datetime) create table #f4d (ccfa nvarchar(30), cc4a smallint, c0e4 nvarchar(4000)) end create table #9de (session_id smallint, login_time datetime, host_name nvarchar(128), program_name nvarchar(128), host_process_id int, client_version int, client_interface_name nvarchar(32), security_id varbinary(85), login_name nvarchar(128), nt_domain nvarchar(128), nt_user_name nvarchar(128), status nvarchar(30), context_info varbinary(128), cpu_time int, memory_usage int, total_scheduled_time int, total_elapsed_time int, endpoint_id int, last_request_start_time datetime, last_request_end_time datetime, reads bigint, writes bigint, logical_reads bigint, is_user_process bit, text_size int, language nvarchar(128), date_format nvarchar(3), date_first smallint, quoted_identifier bit, arithabort bit, ansi_null_dflt_on bit, ansi_defaults bit, ansi_warnings bit, ansi_padding bit, ansi_nulls bit, concat_null_yields_null bit, transaction_isolation_level smallint, lock_timeout int, deadlock_priority int, row_count bigint, prev_error int, original_security_id varbinary(85), original_login_name nvarchar(128), last_successful_logon datetime, last_unsuccessful_logon datetime, unsuccessful_logons bigint, group_id int, database_id smallint, authenticating_database_id int, open_transaction_count int, ctime datetime, primary key (session_id)) create table #b39 (session_id smallint, connection_id uniqueidentifier, query_stats_info xml, procedure_stats_info xml, trigger_stats_info xml, primary key (session_id, connection_id)) create table #0ed (session_id smallint, request_id int, connection_id uniqueidentifier, is_blocked bit, is_dead_locked bit, blocker_session_ids nvarchar(max), head_blocker_session_ids nvarchar(max), input_buffer_checksum int, input_buffer_valid_flag bit, wait_resource_info nvarchar(max), lock_count int, lock_owner_id bigint, locks_info xml, transaction_begin_time datetime, transaction_info xml, task_tempdb_usage_kb int, task_max_tempdb_usage_kb int, task_tempdb_usage_info xml, query_memory_grants_requested_memory_kb bigint, query_memory_grants_granted_memory_kb bigint, query_memory_grants_used_memory_kb bigint, query_memory_grants_max_used_memory_kb bigint, query_memory_grants_wait_time_ms bigint, query_memory_grants_ideal_memory_kb bigint, query_memory_grants_info xml, query_profiles_cpu_time_ms bigint, query_profiles_logical_read_count bigint, query_profiles_physical_read_count bigint, query_profiles_read_ahead_count bigint, query_profiles_write_page_count bigint, query_profiles_info xml, query_stats_info xml, procedure_stats_info xml, trigger_stats_info xml, cached_plans_info xml, tasks_count int, tasks_context_switches int, tasks_pending_io int, tasks_io_size_kb int, read_bytes_per_second int, tasks_ios_per_second int, tasks_info xml, workers_info xml, threads_info xml, query_plan_text_checksum int, custom_info nvarchar(max), primary key (session_id, request_id)) create table #091 (session_id smallint, request_id int, start_time datetime, status nvarchar(30), command nvarchar(32), sql_handle varbinary(64), statement_start_offset int, statement_end_offset int, plan_handle varbinary(64), database_id smallint, user_id int, connection_id uniqueidentifier, blocking_session_id smallint, wait_type nvarchar(60), wait_time int, last_wait_type nvarchar(60), wait_resource nvarchar(256), open_transaction_count int, open_resultset_count int, transaction_id bigint, context_info varbinary(128), percent_complete real, estimated_completion_time bigint, cpu_time int, total_elapsed_time int, scheduler_id int, task_address varbinary(8), reads bigint, writes bigint, logical_reads bigint, text_size int, language nvarchar(128), date_format nvarchar(3), date_first smallint, quoted_identifier bit, arithabort bit, ansi_null_dflt_on bit, ansi_defaults bit, ansi_warnings bit, ansi_padding bit, ansi_nulls bit, concat_null_yields_null bit, transaction_isolation_level smallint, lock_timeout int, deadlock_priority int, row_count bigint, prev_error int, nest_level int, granted_query_memory int, executing_managed_code bit, group_id int, query_hash binary(8), query_plan_hash binary(8), statement_sql_handle varbinary(64), statement_context_id bigint, ctime datetime, primary key (session_id, request_id))
	if exists (select c35f from #2ff where c35f in ('c7a_query_profiles_cpu_time_ms', 'c7a_query_profiles_logical_read_count', 'c7a_query_profiles_physical_read_count', 'c7a_query_profiles_read_ahead_count', 'c7a_query_profiles_write_page_count', 'c7a_query_profiles_info')) create table #aa7 (cd43 smallint, c9d7 int, c153 varbinary(64), ce84 varbinary(64), c3a4 nvarchar(256), ca4e int, c439 int, cd18 varbinary(8), cb1a bigint, cc3b bigint, cf45 bigint, ca0d bigint, c8bf bigint, c58b bigint, c9be bigint, cd00 bigint, c109 bigint, c1cc bigint, c91b bigint, c2c9 bigint, ce90 bigint, cd24 smallint, c20d int, cec5 int, c816 bigint, c031 bigint, c63b bigint, c2e7 bigint, c452 bigint, c8c0 bigint, c7b9 bigint, cbf1 bigint, c906 int, c298 int, cc53 datetime)
	if exists (select c35f from #2ff where c35f in ('c99_lock_count', 'c7a_lock_count', 'c99_lock_owner_id', 'c7a_lock_owner_id', 'c99_locks_info', 'c7a_locks_info')) create table #e8f (cf24 nvarchar(60), c590 nvarchar(60), c769 int, c1a4 bigint, ca4e int, cd24 nvarchar(60), c1e0 nvarchar(60), c7e4 nvarchar(60), ce99 smallint, ced9 int, c3ec int, ce07 int, c335 int, cae4 nvarchar(60), c78a bigint, c2f2 uniqueidentifier, c109 nvarchar(32), cd3e varbinary(8), c6ef int, c4d8 datetime)
	if exists (select c35f from #2ff where c35f in ('c99_cursor_count', 'c99_max_cursor_dormant_duration', 'c99_cursors_info')) create table #4dc (cd43 int, cad9 int, c60f nvarchar(128), cee1 nvarchar(128), c153 varbinary(64), c294 int, c82a int, c99e bigint, c87f datetime, cae1 bit, c34b bit, c246 bit, cceb int, c66b int, cf49 int, c879 int, c1c7 bigint, c60b bigint, ca14 bigint, cee4 bigint, c0c4 varbinary(64), c69a bigint, c4d8 datetime)
	if exists (select c35f from #2ff where c35f in ('c7a_workers_info')) if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) create table #016 (c7de varbinary(8), c2db int, c425 bit, cd5d bit, c9d4 bit, c69f bit, cd1c bit, c340 bit, c1f6 bit, c5ec int, c580 int, c0d4 bigint, cbdb int, c6dd bigint, c384 bigint, c264 bigint, c502 bigint, cb30 int, c1fc int, cdc6 varbinary(8), cfa6 bigint, c7d3 nvarchar(60), c49d bigint, c4e5 bigint, c600 nvarchar(60), ce70 int, c369 bigint, cb0e bigint, cf85 int, ce19 int, c31f varbinary(8), cd18 varbinary(8), ce96 varbinary(8), c50f varbinary(8), c678 varbinary(8), cd62 varbinary(8), c9dd smallint, cc53 datetime)
	if exists (select c35f from #2ff where c35f in ('query_plan_checksum', 'cec_query_plan_checksum', 'c7a_query_plan_text_checksum')) begin create table #eef (checksum int, plan_handle varbinary(64), query_plan_info nvarchar(1024), dbid smallint, objectid int, number smallint, encrypted bit, query_plan xml, ctime datetime, rcount smallint, primary key (checksum)) if (@5d0 = 1 and @b16 = 0) begin set @697 = 'use [' + db_name(@09e) + '] if not exists (select name from sys.objects where schema_id = ' + cast (@bcc as nvarchar(256)) + ' and name = ''sqlws_dm_exec_query_plan_checksum'') create table [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum (servername nvarchar(256), checksum int, plan_handle varbinary(64), query_plan_info nvarchar(1024), dbid smallint, objectid int, number smallint, encrypted bit, query_plan xml, ctime datetime, rtime datetime, rcount bigint, primary key (servername, checksum)) if not exists (select c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_query_plan_checksum'' and c.name = ''ctime'') alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum add ctime datetime, rtime datetime, rcount bigint' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] create table [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end end
	if exists (select c35f from #2ff where c35f in ('plan_attributes_info', 'cec_plan_attributes_info')) begin create table #ca5 (plan_handle varbinary(64), sql_handle varbinary(64), plan_attributes_info xml, plan_attributes_detail nvarchar(1024), ctime datetime, rcount smallint, primary key (plan_handle)) if (@5d0 = 1 and @b16 = 0) begin set @697 = 'use [' + db_name(@09e) + '] if not exists (select name from sys.objects where schema_id = ' + cast (@bcc as nvarchar(256)) + ' and name = ''sqlws_dm_exec_plan_attributes'') create table [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes (servername nvarchar(256), plan_handle varbinary(64), sql_handle varbinary(64), plan_attributes_info xml, plan_attributes_detail nvarchar(1024), ctime datetime, rtime datetime, rcount bigint, primary key (servername, plan_handle)) if not exists (select c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_plan_attributes'' and c.name = ''ctime'') alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes add ctime datetime, rtime datetime, rcount bigint' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] create table [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end end
	if exists (select c35f from #2ff where c35f in ('c99_transaction_begin_time', 'c7a_transaction_begin_time', 'c99_transaction_log_record_count', 'c99_transaction_log_bytes_used', 'c99_transaction_info', 'c7a_transaction_info')) create table #088 (cc02 bigint, c60f nvarchar(32), c6bb datetime, c710 int, c353 uniqueidentifier, c20b int, c873 int, c37f int, ca81 int, c8d4 int, cca1 int, c0fe varbinary(128))
	if exists (select c35f from #2ff where c35f in ('text_query_plan', 'cec_text_query_plan', 'full_text_query_plan', 'cec_full_text_query_plan')) begin create table #164 (plan_handle varbinary(64), statement_start_offset int, statement_end_offset int, text_query_plan_info nvarchar(1024), dbid smallint, objectid int, number smallint, encrypted bit, query_plan nvarchar(max), ctime datetime, rcount smallint, primary key (plan_handle, statement_start_offset, statement_end_offset)) if (@5d0 = 1 and @b16 = 0) begin set @697 = 'use [' + db_name(@09e) + '] if not exists (select name from sys.objects where schema_id = ' + cast (@bcc as nvarchar(256)) + ' and name = ''sqlws_dm_exec_text_query_plan'') create table [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan (servername nvarchar(256), plan_handle varbinary(64), statement_start_offset int, statement_end_offset int, text_query_plan_info nvarchar(1024), dbid smallint, objectid int, number smallint, encrypted bit, query_plan nvarchar(max), ctime datetime, rtime datetime, rcount bigint, primary key (servername, plan_handle, statement_start_offset, statement_end_offset)) if not exists (select c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_text_query_plan'' and c.name = ''ctime'') alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan add ctime datetime, rtime datetime, rcount bigint' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] create table [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end end
	if exists (select c35f from #2ff where c35f in ('c99_session_tempdb_usage_kb', 'c99_session_max_tempdb_usage_kb', 'c99_session_tempdb_usage_info')) create table #406 (cd43 smallint, cd24 int, c52c bigint, cdea bigint, c248 bigint, c84f bigint, ca58 bigint, c4d8 datetime)
	if exists (select c35f from #2ff where c35f in ('cb2_trigger_stats_info', 'c7a_trigger_stats_info')) create table #cd9 (cd24 int, c20d int, c55f char(2), c20b nvarchar(60), c153 varbinary(64), ce84 varbinary(64), c418 datetime, c2f9 datetime, c521 bigint, cb4f bigint, c3a8 bigint, cc50 bigint, caa0 bigint, cfbf bigint, c2f7 bigint, c9ff bigint, c6f9 bigint, cb96 bigint, c5f3 bigint, c5bf bigint, c878 bigint, cf41 bigint, c9cf bigint, ce3c bigint, c55d bigint, cc5d bigint, c750 bigint, cac9 bigint, c8ce bigint)
	if exists (select c35f from #2ff where c35f in ('c99_transaction_log_record_count', 'c99_transaction_log_bytes_used', 'c99_transaction_info', 'c7a_transaction_info')) create table #318 (cc02 bigint, cd24 int, ca79 datetime, c8b6 int, c711 int, ce11 int, c894 int, ce7e bigint, c596 int, c5a7 bigint, c548 bigint, c826 int, c834 int, cbb0 numeric(25, 0), c700 numeric(25, 0), c50b numeric(25, 0), c169 numeric(25, 0), c49f numeric(25, 0), c8e9 numeric(25, 0))
	if exists (select c35f from #2ff where c35f in ('cb2_query_stats_info', 'c7a_query_stats_info')) create table #d1b (c153 varbinary(64), c294 int, c82a int, c99e bigint, ce84 varbinary(64), c87f datetime, c2f9 datetime, c521 bigint, cb4f bigint, c3a8 bigint, cc50 bigint, caa0 bigint, cfbf bigint, c2f7 bigint, c9ff bigint, c6f9 bigint, cb96 bigint, c5f3 bigint, c5bf bigint, c878 bigint, cf41 bigint, c9cf bigint, ce3c bigint, c55d bigint, ccd1 bigint, c922 bigint, cb90 bigint, c22f bigint, cc5d bigint, c750 bigint, cac9 bigint, c8ce bigint, cad9 binary(8), c2cb binary(8), cfc3 bigint, c20a bigint, c5ae bigint, c269 bigint, c0c4 varbinary(64), c69a bigint) create table #c05 (session_id smallint, job_info xml, is_blocker bit, is_head_blocker bit, blocked_session_ids nvarchar(max), input_buffer_checksum int, input_buffer_valid_flag bit, lock_count int, lock_owner_id bigint, locks_info xml, transaction_begin_time datetime, transaction_log_record_count int, transaction_log_bytes_used bigint, transaction_info xml, session_tempdb_usage_kb int, session_max_tempdb_usage_kb int, session_tempdb_usage_info xml, cursor_count int, max_cursor_dormant_duration bigint, cursors_info xml, waiting_tasks_wait_types nvarchar(max), waiting_tasks_max_wait_duration_ms bigint, waiting_tasks_blocking_session_ids nvarchar(max), waiting_tasks_valid_flag bit, waiting_tasks_info xml, service_broker_info xml, sp_whopro_inputparameters nvarchar(max), custom_info nvarchar(max), primary key (session_id))
	if exists (select c35f from #2ff where c35f in ('c7a_cached_plans_info')) create table #2d4 (c128 int, c8ba int, c310 int, c45d int, ce96 varbinary(8), c546 nvarchar(50), cb4b nvarchar(20), ce84 varbinary(64), c5e8 int, ce9e varbinary(64))
	if exists (select c35f from #2ff where c35f in ('c99_transaction_begin_time', 'c7a_transaction_begin_time', 'c99_transaction_log_record_count', 'c99_transaction_log_bytes_used', 'c99_transaction_info', 'c7a_transaction_info')) create table #f3c (cd43 int, cc02 bigint, c118 binary(8), c7a8 int, c0a0 bit, cec4 bit, c09b bit, cc8c bit, c01d int, c4d8 datetime) create unique index c2e_session_connection_id on #a52 (c7e_session_id, cec_request_id) with (ignore_dup_key = on) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'Creating temporary tables took ' + cast(@a09 as nvarchar(256)) + ' ms' declare @9c0 smallint, @324 int, @a35 varbinary(64), @c77 varbinary(64), @e39 int, @b12 int, @deb int create table #295 (cd43 smallint, c9d7 int) create table #d48 (c229 varbinary(64)) create table #b1c (c554 varbinary(64)) create table #570 (c554 varbinary(64), c326 int, caa6 int) select @datetime = getdate() select @254 = getdate() if (@64c = 0)
		insert into #a52 select s.session_id as c7e_session_id, s.login_time as c7e_login_time, s.host_name as c7e_host_name, s.program_name as c7e_program_name, s.host_process_id as c7e_host_process_id, s.client_version as c7e_client_version, s.client_interface_name as c7e_client_interface_name, s.security_id as c7e_security_id, s.login_name as c7e_login_name, s.nt_domain as c7e_nt_domain, s.nt_user_name as c7e_nt_user_name, s.status as c7e_status, s.context_info as c7e_context_info, s.cpu_time as c7e_cpu_time, s.memory_usage as c7e_memory_usage, s.total_scheduled_time as c7e_total_scheduled_time, s.total_elapsed_time as c7e_total_elapsed_time, s.endpoint_id as c7e_endpoint_id, s.last_request_start_time as c7e_last_request_start_time, s.last_request_end_time as c7e_last_request_end_time, s.reads as c7e_reads, s.writes as c7e_writes, s.logical_reads as c7e_logical_reads, s.is_user_process as c7e_is_user_process, s.text_size as c7e_text_size, s.language as c7e_language, s.date_format as c7e_date_format, s.date_first as c7e_date_first, s.quoted_identifier as c7e_quoted_identifier, s.arithabort as c7e_arithabort, s.ansi_null_dflt_on as c7e_ansi_null_dflt_on, s.ansi_defaults as c7e_ansi_defaults, s.ansi_warnings as c7e_ansi_warnings, s.ansi_padding as c7e_ansi_padding, s.ansi_nulls as c7e_ansi_nulls, s.concat_null_yields_null as c7e_concat_null_yields_null, s.transaction_isolation_level as c7e_transaction_isolation_level, s.lock_timeout as c7e_lock_timeout, s.deadlock_priority as c7e_deadlock_priority, s.row_count as c7e_row_count, s.prev_error as c7e_prev_error, s.original_security_id as c7e_original_security_id, s.original_login_name as c7e_original_login_name, s.last_successful_logon as c7e_last_successful_logon, s.last_unsuccessful_logon as c7e_last_unsuccessful_logon, s.unsuccessful_logons as c7e_unsuccessful_logons, s.group_id as c7e_group_id, s.database_id as c7e_database_id, s.authenticating_database_id as c7e_authenticating_database_id, s.open_transaction_count as c7e_open_transaction_count, c.session_id as c2e_session_id, c.most_recent_session_id as c2e_most_recent_session_id, c.connect_time as c2e_connect_time, c.net_transport as c2e_net_transport, c.protocol_type as c2e_protocol_type, c.protocol_version as c2e_protocol_version, c.endpoint_id as c2e_endpoint_id, c.encrypt_option as c2e_encrypt_option, c.auth_scheme as c2e_auth_scheme, c.node_affinity as c2e_node_affinity, c.num_reads as c2e_num_reads, c.num_writes as c2e_num_writes, c.last_read as c2e_last_read, c.last_write as c2e_last_write, c.net_packet_size as c2e_net_packet_size, c.client_net_address as c2e_client_net_address, c.client_tcp_port as c2e_client_tcp_port, c.local_net_address as c2e_local_net_address, c.local_tcp_port as c2e_local_tcp_port, c.connection_id as c2e_connection_id, c.parent_connection_id as c2e_parent_connection_id, c.most_recent_sql_handle as c2e_most_recent_sql_handle, r.session_id as cec_session_id, r.request_id as cec_request_id, r.start_time as cec_start_time, r.status as cec_status, r.command as cec_command, r.sql_handle as cec_sql_handle, r.statement_start_offset as cec_statement_start_offset, r.statement_end_offset as cec_statement_end_offset, r.plan_handle as cec_plan_handle, r.database_id as cec_database_id, r.user_id as cec_user_id, r.connection_id as cec_connection_id, r.blocking_session_id as cec_blocking_session_id, r.wait_type as cec_wait_type, r.wait_time as cec_wait_time, r.last_wait_type as cec_last_wait_type, r.wait_resource as cec_wait_resource, r.open_transaction_count as cec_open_transaction_count, r.open_resultset_count as cec_open_resultset_count, r.transaction_id as cec_transaction_id, r.context_info as cec_context_info, r.percent_complete as cec_percent_complete, r.estimated_completion_time as cec_estimated_completion_time, r.cpu_time as cec_cpu_time, r.total_elapsed_time as cec_total_elapsed_time, r.scheduler_id as cec_scheduler_id, r.task_address as cec_task_address, r.reads as cec_reads, r.writes as cec_writes, r.logical_reads as cec_logical_reads, r.text_size as cec_text_size, r.language as cec_language, r.date_format as cec_date_format, r.date_first as cec_date_first, r.quoted_identifier as cec_quoted_identifier, r.arithabort as cec_arithabort, r.ansi_null_dflt_on as cec_ansi_null_dflt_on, r.ansi_defaults as cec_ansi_defaults, r.ansi_warnings as cec_ansi_warnings, r.ansi_padding as cec_ansi_padding, r.ansi_nulls as cec_ansi_nulls, r.concat_null_yields_null as cec_concat_null_yields_null, r.transaction_isolation_level as cec_transaction_isolation_level, r.lock_timeout as cec_lock_timeout, r.deadlock_priority as cec_deadlock_priority, r.row_count as cec_row_count, r.prev_error as cec_prev_error, r.nest_level as cec_nest_level, r.granted_query_memory as cec_granted_query_memory, r.executing_managed_code as cec_executing_managed_code, r.group_id as cec_group_id, r.query_hash as cec_query_hash, r.query_plan_hash as cec_query_plan_hash, r.statement_sql_handle as cec_statement_sql_handle, r.statement_context_id as cec_statement_context_id, getdate()
		from sys.dm_exec_sessions s left join sys.dm_exec_connections c on (s.session_id = c.session_id) left join sys.dm_exec_requests r on ((c.session_id = r.session_id and c.connection_id = r.connection_id) or (s.session_id = r.session_id and c.session_id is NULL))
		where (@5e6 = 1 or (s.is_user_process = 1 and s.session_id = r.session_id and (exists (select c35f from #fa4 where upper(c35f) in ('ACTIVE')))) or
			(s.is_user_process = 1 and (s.session_id = r.session_id or s.session_id in (select r.blocking_session_id from sys.dm_exec_requests r union select wt.blocking_session_id from sys.dm_os_waiting_tasks wt)) and ((not exists (select c35f from #fa4 where c35f not in ('SAVE', 'NODDL', 'NOOUTPUT'))))) or
			(s.is_user_process = 1 and r.wait_type is not NULL and exists (select c35f from #fa4 where upper(c35f) in ('WAIT'))) or
			(s.session_id = r.session_id and (r.blocking_session_id <> 0) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKED'))) or
			(s.session_id in (select r.blocking_session_id from sys.dm_exec_requests r) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKING'))) or
			(s.session_id in (select wt.session_id from sys.dm_os_waiting_tasks wt where wt.blocking_session_id <> 0) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKED'))) or
			(s.session_id in (select wt.blocking_session_id from sys.dm_os_waiting_tasks wt) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKING'))) or
			(s.session_id in (select @@spid where exists (select c35f from #fa4 where upper(c35f) in ('SP_WHOPRO')))) or
			(s.session_id in (select c.session_id from sys.dm_exec_cursors(NULL) c where exists (select c35f from #fa4 where upper(c35f) in ('CURSOR'))))) and (s.session_id not in (select @@spid where not exists (select c35f from #fa4 where upper(c35f) in ('SP_WHOPRO')))) else if (((@8ca4_d17 = 0) and (@01d0_d17 = 0) and (@1fa1_d17 = 0) and (@c026_d17 = 0) and (@863e_d17 = 0) and (@82a0_d17 = 0) and (@5f33_d17 = 0) and (@b7fa_d17 = 0) and (@2055_d17 = 0) and (@083d_d17 = 0) and (@85bd_d17 = 0) and (@8572_d17 = 0) and (@75d5_d17 = 0) and (@9d74_d17 = 0) and (@2947_d17 = 0) and (@52d2_d17 = 0) and (@9e0b_d17 = 0) and (@3379_d17 = 0) and (@4617_d17 = 0) and (@b1a9_d17 = 0) and (@6a56_d17 = 0) and (@9b90_d17 = 0) and (@c3e1_d17 = 0) and (@1144_d17 = 0) and (@74cb_d17 = 0) and 1=1) and ((@8572_e19 = 0) and (@5f33_e19 = 0) and (@3379_e19 = 0) and (@6a56_e19 = 0) and (@9b90_e19 = 0) and (@083d_e19 = 0) and (@9d74_e19 = 0) and (@c3e1_e19 = 0) and (@82a0_e19 = 0) and (@4617_e19 = 0) and (@9e0b_e19 = 0) and (@52d2_e19 = 0) and (@74cb_e19 = 0) and (@c026_e19 = 0) and (@1144_e19 = 0) and (@8ca4_e19 = 0) and (@863e_e19 = 0) and (@2947_e19 = 0) and 1=1)) insert into #a52 select s.session_id as c7e_session_id, s.login_time as c7e_login_time, s.host_name as c7e_host_name, s.program_name as c7e_program_name, s.host_process_id as c7e_host_process_id, s.client_version as c7e_client_version, s.client_interface_name as c7e_client_interface_name, s.security_id as c7e_security_id, s.login_name as c7e_login_name, s.nt_domain as c7e_nt_domain, s.nt_user_name as c7e_nt_user_name, s.status as c7e_status, s.context_info as c7e_context_info, s.cpu_time as c7e_cpu_time, s.memory_usage as c7e_memory_usage, s.total_scheduled_time as c7e_total_scheduled_time, s.total_elapsed_time as c7e_total_elapsed_time, s.endpoint_id as c7e_endpoint_id, s.last_request_start_time as c7e_last_request_start_time, s.last_request_end_time as c7e_last_request_end_time, s.reads as c7e_reads, s.writes as c7e_writes, s.logical_reads as c7e_logical_reads, s.is_user_process as c7e_is_user_process, s.text_size as c7e_text_size, s.language as c7e_language, s.date_format as c7e_date_format, s.date_first as c7e_date_first, s.quoted_identifier as c7e_quoted_identifier, s.arithabort as c7e_arithabort, s.ansi_null_dflt_on as c7e_ansi_null_dflt_on, s.ansi_defaults as c7e_ansi_defaults, s.ansi_warnings as c7e_ansi_warnings, s.ansi_padding as c7e_ansi_padding, s.ansi_nulls as c7e_ansi_nulls, s.concat_null_yields_null as c7e_concat_null_yields_null, s.transaction_isolation_level as c7e_transaction_isolation_level, s.lock_timeout as c7e_lock_timeout, s.deadlock_priority as c7e_deadlock_priority, s.row_count as c7e_row_count, s.prev_error as c7e_prev_error, s.original_security_id as c7e_original_security_id, s.original_login_name as c7e_original_login_name, s.last_successful_logon as c7e_last_successful_logon, s.last_unsuccessful_logon as c7e_last_unsuccessful_logon, s.unsuccessful_logons as c7e_unsuccessful_logons, s.group_id as c7e_group_id, s.database_id as c7e_database_id, s.authenticating_database_id as c7e_authenticating_database_id, s.open_transaction_count as c7e_open_transaction_count, c.session_id as c2e_session_id, c.most_recent_session_id as c2e_most_recent_session_id, c.connect_time as c2e_connect_time, c.net_transport as c2e_net_transport, c.protocol_type as c2e_protocol_type, c.protocol_version as c2e_protocol_version, c.endpoint_id as c2e_endpoint_id, c.encrypt_option as c2e_encrypt_option, c.auth_scheme as c2e_auth_scheme, c.node_affinity as c2e_node_affinity, c.num_reads as c2e_num_reads, c.num_writes as c2e_num_writes, c.last_read as c2e_last_read, c.last_write as c2e_last_write, c.net_packet_size as c2e_net_packet_size, c.client_net_address as c2e_client_net_address, c.client_tcp_port as c2e_client_tcp_port, c.local_net_address as c2e_local_net_address, c.local_tcp_port as c2e_local_tcp_port, c.connection_id as c2e_connection_id, c.parent_connection_id as c2e_parent_connection_id, c.most_recent_sql_handle as c2e_most_recent_sql_handle, r.session_id as cec_session_id, r.request_id as cec_request_id, r.start_time as cec_start_time, r.status as cec_status, r.command as cec_command, r.sql_handle as cec_sql_handle, r.statement_start_offset as cec_statement_start_offset, r.statement_end_offset as cec_statement_end_offset, r.plan_handle as cec_plan_handle, r.database_id as cec_database_id, r.user_id as cec_user_id, r.connection_id as cec_connection_id, r.blocking_session_id as cec_blocking_session_id, r.wait_type as cec_wait_type, r.wait_time as cec_wait_time, r.last_wait_type as cec_last_wait_type, r.wait_resource as cec_wait_resource, r.open_transaction_count as cec_open_transaction_count, r.open_resultset_count as cec_open_resultset_count, r.transaction_id as cec_transaction_id, r.context_info as cec_context_info, r.percent_complete as cec_percent_complete, r.estimated_completion_time as cec_estimated_completion_time, r.cpu_time as cec_cpu_time, r.total_elapsed_time as cec_total_elapsed_time, r.scheduler_id as cec_scheduler_id, r.task_address as cec_task_address, r.reads as cec_reads, r.writes as cec_writes, r.logical_reads as cec_logical_reads, r.text_size as cec_text_size, r.language as cec_language, r.date_format as cec_date_format, r.date_first as cec_date_first, r.quoted_identifier as cec_quoted_identifier, r.arithabort as cec_arithabort, r.ansi_null_dflt_on as cec_ansi_null_dflt_on, r.ansi_defaults as cec_ansi_defaults, r.ansi_warnings as cec_ansi_warnings, r.ansi_padding as cec_ansi_padding, r.ansi_nulls as cec_ansi_nulls, r.concat_null_yields_null as cec_concat_null_yields_null, r.transaction_isolation_level as cec_transaction_isolation_level, r.lock_timeout as cec_lock_timeout, r.deadlock_priority as cec_deadlock_priority, r.row_count as cec_row_count, r.prev_error as cec_prev_error, r.nest_level as cec_nest_level, r.granted_query_memory as cec_granted_query_memory, r.executing_managed_code as cec_executing_managed_code, r.group_id as cec_group_id, r.query_hash as cec_query_hash, r.query_plan_hash as cec_query_plan_hash, r.statement_sql_handle as cec_statement_sql_handle, r.statement_context_id as cec_statement_context_id, getdate() from sys.dm_exec_sessions s left join sys.dm_exec_connections c on (s.session_id = c.session_id) left join sys.dm_exec_requests r on ((c.session_id = r.session_id and c.connection_id = r.connection_id) or (s.session_id = r.session_id and c.session_id is NULL)) where (@5e6 = 1 or (s.is_user_process = 1 and s.session_id = r.session_id and (exists (select c35f from #fa4 where upper(c35f) in ('ACTIVE')))) or (not exists (select c35f from #fa4 where c35f not in ('SAVE', 'NODDL', 'NOOUTPUT'))) or (s.is_user_process = 1 and r.wait_type is not NULL and exists (select c35f from #fa4 where upper(c35f) in ('WAIT'))) or (s.session_id = r.session_id and (blocking_session_id <> 0) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKED'))) or (s.session_id in (select r.blocking_session_id from sys.dm_exec_requests r) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKING'))) or (s.session_id in (select wt.session_id from sys.dm_os_waiting_tasks wt where wt.blocking_session_id <> 0) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKED'))) or (s.session_id in (select wt.blocking_session_id from sys.dm_os_waiting_tasks wt) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKING'))) or (s.session_id in (select @@spid where exists (select c35f from #fa4 where upper(c35f) in ('SP_WHOPRO')))) or (s.session_id in (select c.session_id from sys.dm_exec_cursors(NULL) c where exists (select c35f from #fa4 where upper(c35f) in ('CURSOR'))))) and (not exists (select c1276 from #1532_3ff where cdd9 = 1) or exists (select c1276 from #1532_3ff where cdd9 = 1 and r.sql_handle = c1276 and @1532_d17 = 1)) and (not exists (select ca808 from #d24d_3ff where cdd9 = 1) or exists (select ca808 from #d24d_3ff where cdd9 = 1 and s.database_id = ca808 and @d24d_d17 = 1)) and (not exists (select cad83 from #d43f_3ff where cdd9 = 1) or exists (select cad83 from #d43f_3ff where cdd9 = 1 and s.session_id = cad83 and @d43f_d17 = 1)) and (not exists (select c25cc from #2db7_3ff where cdd9 = 1) or exists (select c25cc from #2db7_3ff where cdd9 = 1 and r.status = c25cc and @2db7_d17 = 1)) and (not exists (select cfcb8 from #e847_3ff where cdd9 = 1) or exists (select cfcb8 from #e847_3ff where cdd9 = 1 and r.plan_handle = cfcb8 and @e847_d17 = 1)) and (not exists (select c312c from #c886_3ff where cdd9 = 1) or exists (select c312c from #c886_3ff where cdd9 = 1 and s.is_user_process = c312c and @c886_d17 = 1)) and (not exists (select cf1e0 from #2cbb_3ff where cdd9 = 1) or exists (select cf1e0 from #2cbb_3ff where cdd9 = 1 and r.query_plan_hash = cf1e0 and @2cbb_d17 = 1)) and (not exists (select cdd5b from #ad99_3ff where cdd9 = 1) or exists (select cdd5b from #ad99_3ff where cdd9 = 1 and r.query_hash = cdd5b and @ad99_d17 = 1)) and (not exists (select caa9e from #d72b_3ff where cfbc = '=') or exists (select caa9e from #d72b_3ff where cfbc = '=' and r.wait_time = caa9e and @d72b_37a = 1)) and (not exists (select caa9e from #d72b_3ff where cfbc = '<') or exists (select caa9e from #d72b_3ff where cfbc = '<' and r.wait_time < caa9e and @d72b_81b = 1)) and (not exists (select caa9e from #d72b_3ff where cfbc = '>') or exists (select caa9e from #d72b_3ff where cfbc = '>' and r.wait_time > caa9e and @d72b_01e = 1)) and (not exists (select cac7f from #a140_3ff where cfbc = '=') or exists (select cac7f from #a140_3ff where cfbc = '=' and r.writes = cac7f and @a140_37a = 1)) and (not exists (select cac7f from #a140_3ff where cfbc = '<') or exists (select cac7f from #a140_3ff where cfbc = '<' and r.writes < cac7f and @a140_81b = 1)) and (not exists (select cac7f from #a140_3ff where cfbc = '>') or exists (select cac7f from #a140_3ff where cfbc = '>' and r.writes > cac7f and @a140_01e = 1)) and (not exists (select c93c1 from #60b2_3ff where cfbc = '=') or exists (select c93c1 from #60b2_3ff where cfbc = '=' and r.reads = c93c1 and @60b2_37a = 1)) and (not exists (select c93c1 from #60b2_3ff where cfbc = '<') or exists (select c93c1 from #60b2_3ff where cfbc = '<' and r.reads < c93c1 and @60b2_81b = 1)) and (not exists (select c93c1 from #60b2_3ff where cfbc = '>') or exists (select c93c1 from #60b2_3ff where cfbc = '>' and r.reads > c93c1 and @60b2_01e = 1)) and (not exists (select c8946 from #4092_3ff where cfbc = '=') or exists (select c8946 from #4092_3ff where cfbc = '=' and r.logical_reads = c8946 and @4092_37a = 1)) and (not exists (select c8946 from #4092_3ff where cfbc = '<') or exists (select c8946 from #4092_3ff where cfbc = '<' and r.logical_reads < c8946 and @4092_81b = 1)) and (not exists (select c8946 from #4092_3ff where cfbc = '>') or exists (select c8946 from #4092_3ff where cfbc = '>' and r.logical_reads > c8946 and @4092_01e = 1)) and (not exists (select c7334 from #c5d0_3ff where cfbc = '=') or exists (select c7334 from #c5d0_3ff where cfbc = '=' and r.total_elapsed_time = c7334 and @c5d0_37a = 1)) and (not exists (select c7334 from #c5d0_3ff where cfbc = '<') or exists (select c7334 from #c5d0_3ff where cfbc = '<' and r.total_elapsed_time < c7334 and @c5d0_81b = 1)) and (not exists (select c7334 from #c5d0_3ff where cfbc = '>') or exists (select c7334 from #c5d0_3ff where cfbc = '>' and r.total_elapsed_time > c7334 and @c5d0_01e = 1)) and (not exists (select c0dfe from #3898_3ff where cfbc = '=') or exists (select c0dfe from #3898_3ff where cfbc = '=' and r.cpu_time = c0dfe and @3898_37a = 1)) and (not exists (select c0dfe from #3898_3ff where cfbc = '<') or exists (select c0dfe from #3898_3ff where cfbc = '<' and r.cpu_time < c0dfe and @3898_81b = 1)) and (not exists (select c0dfe from #3898_3ff where cfbc = '>') or exists (select c0dfe from #3898_3ff where cfbc = '>' and r.cpu_time > c0dfe and @3898_01e = 1)) and (not exists (select c2196 from #3cf2_3ff where cdd9 = 1) or exists (select c2196 from #3cf2_3ff where r.wait_resource like c2196 and cdd9 = 1 and @3cf2_d17 = 1)) and (not exists (select c5226 from #8969_3ff where cdd9 = 1) or exists (select c5226 from #8969_3ff where r.wait_type like c5226 and cdd9 = 1 and @8969_d17 = 1)) and (not exists (select cd68f from #3d08_3ff where cdd9 = 1) or exists (select cd68f from #3d08_3ff where s.login_name like cd68f and cdd9 = 1 and @3d08_d17 = 1)) and (not exists (select c9e53 from #2256_3ff where cdd9 = 1) or exists (select c9e53 from #2256_3ff where s.host_name like c9e53 and cdd9 = 1 and @2256_d17 = 1)) and (not exists (select c7a8a from #6637_3ff where cdd9 = 1) or exists (select c7a8a from #6637_3ff where s.program_name like c7a8a and cdd9 = 1 and @6637_d17 = 1)) and (not exists (select c1276 from #1532_3ff where cdd9 = 0 and r.sql_handle = c1276 and @1532_e19 = 1)) and (not exists (select c312c from #c886_3ff where cdd9 = 0 and s.is_user_process = c312c and @c886_e19 = 1)) and (not exists (select cad83 from #d43f_3ff where cdd9 = 0 and s.session_id = cad83 and @d43f_e19 = 1)) and (not exists (select ca808 from #d24d_3ff where cdd9 = 0 and s.database_id = ca808 and @d24d_e19 = 1)) and (not exists (select c25cc from #2db7_3ff where cdd9 = 0 and r.status = c25cc and @2db7_e19 = 1)) and (not exists (select cf1e0 from #2cbb_3ff where cdd9 = 0 and r.query_plan_hash = cf1e0 and @2cbb_e19 = 1)) and (not exists (select cdd5b from #ad99_3ff where cdd9 = 0 and r.query_hash = cdd5b and @ad99_e19 = 1)) and (not exists (select cfcb8 from #e847_3ff where cdd9 = 0 and r.plan_handle = cfcb8 and @e847_e19 = 1)) and (not exists (select cd68f from #3d08_3ff where s.login_name like cd68f and cdd9 = 0 and @3d08_e19 = 1)) and (not exists (select c9e53 from #2256_3ff where s.host_name like c9e53 and cdd9 = 0 and @2256_e19 = 1)) and (not exists (select c5226 from #8969_3ff where r.wait_type like c5226 and cdd9 = 0 and @8969_e19 = 1)) and (not exists (select c2196 from #3cf2_3ff where r.wait_resource like c2196 and cdd9 = 0 and @3cf2_e19 = 1)) and (not exists (select c7a8a from #6637_3ff where s.program_name like c7a8a and cdd9 = 0 and @6637_e19 = 1)) and (s.session_id not in (select @@spid where not exists (select c35f from #fa4 where upper(c35f) in ('SP_WHOPRO')))) else insert into #a52 select s.session_id as c7e_session_id, s.login_time as c7e_login_time, s.host_name as c7e_host_name, s.program_name as c7e_program_name, s.host_process_id as c7e_host_process_id, s.client_version as c7e_client_version, s.client_interface_name as c7e_client_interface_name, s.security_id as c7e_security_id, s.login_name as c7e_login_name, s.nt_domain as c7e_nt_domain, s.nt_user_name as c7e_nt_user_name, s.status as c7e_status, s.context_info as c7e_context_info, s.cpu_time as c7e_cpu_time, s.memory_usage as c7e_memory_usage, s.total_scheduled_time as c7e_total_scheduled_time, s.total_elapsed_time as c7e_total_elapsed_time, s.endpoint_id as c7e_endpoint_id, s.last_request_start_time as c7e_last_request_start_time, s.last_request_end_time as c7e_last_request_end_time, s.reads as c7e_reads, s.writes as c7e_writes, s.logical_reads as c7e_logical_reads, s.is_user_process as c7e_is_user_process, s.text_size as c7e_text_size, s.language as c7e_language, s.date_format as c7e_date_format, s.date_first as c7e_date_first, s.quoted_identifier as c7e_quoted_identifier, s.arithabort as c7e_arithabort, s.ansi_null_dflt_on as c7e_ansi_null_dflt_on, s.ansi_defaults as c7e_ansi_defaults, s.ansi_warnings as c7e_ansi_warnings, s.ansi_padding as c7e_ansi_padding, s.ansi_nulls as c7e_ansi_nulls, s.concat_null_yields_null as c7e_concat_null_yields_null, s.transaction_isolation_level as c7e_transaction_isolation_level, s.lock_timeout as c7e_lock_timeout, s.deadlock_priority as c7e_deadlock_priority, s.row_count as c7e_row_count, s.prev_error as c7e_prev_error, s.original_security_id as c7e_original_security_id, s.original_login_name as c7e_original_login_name, s.last_successful_logon as c7e_last_successful_logon, s.last_unsuccessful_logon as c7e_last_unsuccessful_logon, s.unsuccessful_logons as c7e_unsuccessful_logons, s.group_id as c7e_group_id, s.database_id as c7e_database_id, s.authenticating_database_id as c7e_authenticating_database_id, s.open_transaction_count as c7e_open_transaction_count, c.session_id as c2e_session_id, c.most_recent_session_id as c2e_most_recent_session_id, c.connect_time as c2e_connect_time, c.net_transport as c2e_net_transport, c.protocol_type as c2e_protocol_type, c.protocol_version as c2e_protocol_version, c.endpoint_id as c2e_endpoint_id, c.encrypt_option as c2e_encrypt_option, c.auth_scheme as c2e_auth_scheme, c.node_affinity as c2e_node_affinity, c.num_reads as c2e_num_reads, c.num_writes as c2e_num_writes, c.last_read as c2e_last_read, c.last_write as c2e_last_write, c.net_packet_size as c2e_net_packet_size, c.client_net_address as c2e_client_net_address, c.client_tcp_port as c2e_client_tcp_port, c.local_net_address as c2e_local_net_address, c.local_tcp_port as c2e_local_tcp_port, c.connection_id as c2e_connection_id, c.parent_connection_id as c2e_parent_connection_id, c.most_recent_sql_handle as c2e_most_recent_sql_handle, r.session_id as cec_session_id, r.request_id as cec_request_id, r.start_time as cec_start_time, r.status as cec_status, r.command as cec_command, r.sql_handle as cec_sql_handle, r.statement_start_offset as cec_statement_start_offset, r.statement_end_offset as cec_statement_end_offset, r.plan_handle as cec_plan_handle, r.database_id as cec_database_id, r.user_id as cec_user_id, r.connection_id as cec_connection_id, r.blocking_session_id as cec_blocking_session_id, r.wait_type as cec_wait_type, r.wait_time as cec_wait_time, r.last_wait_type as cec_last_wait_type, r.wait_resource as cec_wait_resource, r.open_transaction_count as cec_open_transaction_count, r.open_resultset_count as cec_open_resultset_count, r.transaction_id as cec_transaction_id, r.context_info as cec_context_info, r.percent_complete as cec_percent_complete, r.estimated_completion_time as cec_estimated_completion_time, r.cpu_time as cec_cpu_time, r.total_elapsed_time as cec_total_elapsed_time, r.scheduler_id as cec_scheduler_id, r.task_address as cec_task_address, r.reads as cec_reads, r.writes as cec_writes, r.logical_reads as cec_logical_reads, r.text_size as cec_text_size, r.language as cec_language, r.date_format as cec_date_format, r.date_first as cec_date_first, r.quoted_identifier as cec_quoted_identifier, r.arithabort as cec_arithabort, r.ansi_null_dflt_on as cec_ansi_null_dflt_on, r.ansi_defaults as cec_ansi_defaults, r.ansi_warnings as cec_ansi_warnings, r.ansi_padding as cec_ansi_padding, r.ansi_nulls as cec_ansi_nulls, r.concat_null_yields_null as cec_concat_null_yields_null, r.transaction_isolation_level as cec_transaction_isolation_level, r.lock_timeout as cec_lock_timeout, r.deadlock_priority as cec_deadlock_priority, r.row_count as cec_row_count, r.prev_error as cec_prev_error, r.nest_level as cec_nest_level, r.granted_query_memory as cec_granted_query_memory, r.executing_managed_code as cec_executing_managed_code, r.group_id as cec_group_id, r.query_hash as cec_query_hash, r.query_plan_hash as cec_query_plan_hash, r.statement_sql_handle as cec_statement_sql_handle, r.statement_context_id as cec_statement_context_id, getdate() from sys.dm_exec_sessions s left join sys.dm_exec_connections c on (s.session_id = c.session_id) left join sys.dm_exec_requests r on ((c.session_id = r.session_id and c.connection_id = r.connection_id) or (s.session_id = r.session_id and c.session_id is NULL)) where (@5e6 = 1 or (s.is_user_process = 1 and s.session_id = r.session_id and (exists (select c35f from #fa4 where upper(c35f) in ('ACTIVE')))) or (not exists (select c35f from #fa4 where c35f not in ('SAVE', 'NODDL', 'NOOUTPUT'))) or (s.is_user_process = 1 and r.wait_type is not NULL and exists (select c35f from #fa4 where upper(c35f) in ('WAIT'))) or (s.session_id = r.session_id and (blocking_session_id <> 0) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKED'))) or (s.session_id in (select r.blocking_session_id from sys.dm_exec_requests r) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKING'))) or (s.session_id in (select wt.session_id from sys.dm_os_waiting_tasks wt where wt.blocking_session_id <> 0) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKED'))) or (s.session_id in (select wt.blocking_session_id from sys.dm_os_waiting_tasks wt) and exists (select c35f from #fa4 where upper(c35f) in ('BLOCK', 'BLOCKING'))) or (s.session_id in (select @@spid where exists (select c35f from #fa4 where upper(c35f) in ('SP_WHOPRO')))) or (s.session_id in (select c.session_id from sys.dm_exec_cursors(NULL) c where exists (select c35f from #fa4 where upper(c35f) in ('CURSOR'))))) and (not exists (select cad83 from #d43f_3ff where cdd9 = 1) or exists (select cad83 from #d43f_3ff where cdd9 = 1 and s.session_id = cad83 and @d43f_d17 = 1)) and (not exists (select cd5e2 from #52d2_3ff where cdd9 = 1) or exists (select cd5e2 from #52d2_3ff where cdd9 = 1 and s.group_id = cd5e2 and @52d2_d17 = 1)) and (not exists (select cb6a4 from #1144_3ff where cdd9 = 1) or exists (select cb6a4 from #1144_3ff where cdd9 = 1 and r.blocking_session_id = cb6a4 and @1144_d17 = 1)) and (not exists (select ca694 from #4617_3ff where cdd9 = 1) or exists (select ca694 from #4617_3ff where cdd9 = 1 and r.scheduler_id = ca694 and @4617_d17 = 1)) and (not exists (select cb8a8 from #6a56_3ff where cdd9 = 1) or exists (select cb8a8 from #6a56_3ff where cdd9 = 1 and c.most_recent_sql_handle = cb8a8 and @6a56_d17 = 1)) and (not exists (select c7e3e from #c3e1_3ff where cdd9 = 1) or exists (select c7e3e from #c3e1_3ff where cdd9 = 1 and r.executing_managed_code = c7e3e and @c3e1_d17 = 1)) and (not exists (select c54ac from #c026_3ff where cdd9 = 1) or exists (select c54ac from #c026_3ff where cdd9 = 1 and r.transaction_id = c54ac and @c026_d17 = 1)) and (not exists (select c5783 from #9e0b_3ff where cdd9 = 1) or exists (select c5783 from #9e0b_3ff where cdd9 = 1 and s.host_process_id = c5783 and @9e0b_d17 = 1)) and (not exists (select ca808 from #d24d_3ff where cdd9 = 1) or exists (select ca808 from #d24d_3ff where cdd9 = 1 and s.database_id = ca808 and @d24d_d17 = 1)) and (not exists (select c25cc from #2db7_3ff where cdd9 = 1) or exists (select c25cc from #2db7_3ff where cdd9 = 1 and r.status = c25cc and @2db7_d17 = 1)) and (not exists (select cb693 from #5f33_3ff where cdd9 = 1) or exists (select cb693 from #5f33_3ff where cdd9 = 1 and c.node_affinity = cb693 and @5f33_d17 = 1)) and (not exists (select c4643 from #9d74_3ff where cdd9 = 1) or exists (select c4643 from #9d74_3ff where cdd9 = 1 and r.request_id = c4643 and @9d74_d17 = 1)) and (not exists (select c312c from #c886_3ff where cdd9 = 1) or exists (select c312c from #c886_3ff where cdd9 = 1 and s.is_user_process = c312c and @c886_d17 = 1)) and (not exists (select cfcb8 from #e847_3ff where cdd9 = 1) or exists (select cfcb8 from #e847_3ff where cdd9 = 1 and r.plan_handle = cfcb8 and @e847_d17 = 1)) and (not exists (select c1276 from #1532_3ff where cdd9 = 1) or exists (select c1276 from #1532_3ff where cdd9 = 1 and r.sql_handle = c1276 and @1532_d17 = 1)) and (not exists (select c0470 from #083d_3ff where cdd9 = 1) or exists (select c0470 from #083d_3ff where cdd9 = 1 and s.context_info = c0470 and @083d_d17 = 1)) and (not exists (select c55ce from #8572_3ff where cdd9 = 1) or exists (select c55ce from #8572_3ff where cdd9 = 1 and s.transaction_isolation_level = c55ce and @8572_d17 = 1)) and (not exists (select cf1e0 from #2cbb_3ff where cdd9 = 1) or exists (select cf1e0 from #2cbb_3ff where cdd9 = 1 and r.query_plan_hash = cf1e0 and @2cbb_d17 = 1)) and (not exists (select c336f from #2947_3ff where cdd9 = 1) or exists (select c336f from #2947_3ff where cdd9 = 1 and r.statement_start_offset = c336f and @2947_d17 = 1)) and (not exists (select caace from #8ca4_3ff where cdd9 = 1) or exists (select caace from #8ca4_3ff where cdd9 = 1 and r.command = caace and @8ca4_d17 = 1)) and (not exists (select c60dd from #82a0_3ff where cdd9 = 1) or exists (select c60dd from #82a0_3ff where cdd9 = 1 and r.statement_end_offset = c60dd and @82a0_d17 = 1)) and (not exists (select cdd5b from #ad99_3ff where cdd9 = 1) or exists (select cdd5b from #ad99_3ff where cdd9 = 1 and r.query_hash = cdd5b and @ad99_d17 = 1)) and (not exists (select cd07c from #9b90_3ff where cdd9 = 1) or exists (select cd07c from #9b90_3ff where cdd9 = 1 and c.connection_id = cd07c and @9b90_d17 = 1)) and (not exists (select cb940 from #b7fa_3ff where cfbc = '=') or exists (select cb940 from #b7fa_3ff where cfbc = '=' and c.num_writes = cb940 and @b7fa_37a = 1)) and (not exists (select cb940 from #b7fa_3ff where cfbc = '<') or exists (select cb940 from #b7fa_3ff where cfbc = '<' and c.num_writes < cb940 and @b7fa_81b = 1)) and (not exists (select cb940 from #b7fa_3ff where cfbc = '>') or exists (select cb940 from #b7fa_3ff where cfbc = '>' and c.num_writes > cb940 and @b7fa_01e = 1)) and (not exists (select c7334 from #c5d0_3ff where cfbc = '=') or exists (select c7334 from #c5d0_3ff where cfbc = '=' and r.total_elapsed_time = c7334 and @c5d0_37a = 1)) and (not exists (select c7334 from #c5d0_3ff where cfbc = '<') or exists (select c7334 from #c5d0_3ff where cfbc = '<' and r.total_elapsed_time < c7334 and @c5d0_81b = 1)) and (not exists (select c7334 from #c5d0_3ff where cfbc = '>') or exists (select c7334 from #c5d0_3ff where cfbc = '>' and r.total_elapsed_time > c7334 and @c5d0_01e = 1)) and (not exists (select cac7f from #a140_3ff where cfbc = '=') or exists (select cac7f from #a140_3ff where cfbc = '=' and r.writes = cac7f and @a140_37a = 1)) and (not exists (select cac7f from #a140_3ff where cfbc = '<') or exists (select cac7f from #a140_3ff where cfbc = '<' and r.writes < cac7f and @a140_81b = 1)) and (not exists (select cac7f from #a140_3ff where cfbc = '>') or exists (select cac7f from #a140_3ff where cfbc = '>' and r.writes > cac7f and @a140_01e = 1)) and (not exists (select caa9e from #d72b_3ff where cfbc = '=') or exists (select caa9e from #d72b_3ff where cfbc = '=' and r.wait_time = caa9e and @d72b_37a = 1)) and (not exists (select caa9e from #d72b_3ff where cfbc = '<') or exists (select caa9e from #d72b_3ff where cfbc = '<' and r.wait_time < caa9e and @d72b_81b = 1)) and (not exists (select caa9e from #d72b_3ff where cfbc = '>') or exists (select caa9e from #d72b_3ff where cfbc = '>' and r.wait_time > caa9e and @d72b_01e = 1)) and (not exists (select c9d64 from #1fa1_3ff where cfbc = '=') or exists (select c9d64 from #1fa1_3ff where cfbc = '=' and r.nest_level = c9d64 and @1fa1_37a = 1)) and (not exists (select c9d64 from #1fa1_3ff where cfbc = '<') or exists (select c9d64 from #1fa1_3ff where cfbc = '<' and r.nest_level < c9d64 and @1fa1_81b = 1)) and (not exists (select c9d64 from #1fa1_3ff where cfbc = '>') or exists (select c9d64 from #1fa1_3ff where cfbc = '>' and r.nest_level > c9d64 and @1fa1_01e = 1)) and (not exists (select cb29d from #75d5_3ff where cfbc = '=') or exists (select cb29d from #75d5_3ff where cfbc = '=' and c.num_reads = cb29d and @75d5_37a = 1)) and (not exists (select cb29d from #75d5_3ff where cfbc = '<') or exists (select cb29d from #75d5_3ff where cfbc = '<' and c.num_reads < cb29d and @75d5_81b = 1)) and (not exists (select cb29d from #75d5_3ff where cfbc = '>') or exists (select cb29d from #75d5_3ff where cfbc = '>' and c.num_reads > cb29d and @75d5_01e = 1)) and (not exists (select cec3c from #85bd_3ff where cfbc = '=') or exists (select cec3c from #85bd_3ff where cfbc = '=' and s.login_time = cec3c and @85bd_37a = 1)) and (not exists (select cec3c from #85bd_3ff where cfbc = '<') or exists (select cec3c from #85bd_3ff where cfbc = '<' and s.login_time < cec3c and @85bd_81b = 1)) and (not exists (select cec3c from #85bd_3ff where cfbc = '>') or exists (select cec3c from #85bd_3ff where cfbc = '>' and s.login_time > cec3c and @85bd_01e = 1)) and (not exists (select c8946 from #4092_3ff where cfbc = '=') or exists (select c8946 from #4092_3ff where cfbc = '=' and r.logical_reads = c8946 and @4092_37a = 1)) and (not exists (select c8946 from #4092_3ff where cfbc = '<') or exists (select c8946 from #4092_3ff where cfbc = '<' and r.logical_reads < c8946 and @4092_81b = 1)) and (not exists (select c8946 from #4092_3ff where cfbc = '>') or exists (select c8946 from #4092_3ff where cfbc = '>' and r.logical_reads > c8946 and @4092_01e = 1)) and (not exists (select ca604 from #01d0_3ff where cfbc = '=') or exists (select ca604 from #01d0_3ff where cfbc = '=' and s.open_transaction_count = ca604 and @01d0_37a = 1)) and (not exists (select ca604 from #01d0_3ff where cfbc = '<') or exists (select ca604 from #01d0_3ff where cfbc = '<' and s.open_transaction_count < ca604 and @01d0_81b = 1)) and (not exists (select ca604 from #01d0_3ff where cfbc = '>') or exists (select ca604 from #01d0_3ff where cfbc = '>' and s.open_transaction_count > ca604 and @01d0_01e = 1)) and (not exists (select c5c53 from #2055_3ff where cfbc = '=') or exists (select c5c53 from #2055_3ff where cfbc = '=' and r.granted_query_memory = c5c53 and @2055_37a = 1)) and (not exists (select c5c53 from #2055_3ff where cfbc = '<') or exists (select c5c53 from #2055_3ff where cfbc = '<' and r.granted_query_memory < c5c53 and @2055_81b = 1)) and (not exists (select c5c53 from #2055_3ff where cfbc = '>') or exists (select c5c53 from #2055_3ff where cfbc = '>' and r.granted_query_memory > c5c53 and @2055_01e = 1)) and (not exists (select c0dfe from #3898_3ff where cfbc = '=') or exists (select c0dfe from #3898_3ff where cfbc = '=' and r.cpu_time = c0dfe and @3898_37a = 1)) and (not exists (select c0dfe from #3898_3ff where cfbc = '<') or exists (select c0dfe from #3898_3ff where cfbc = '<' and r.cpu_time < c0dfe and @3898_81b = 1)) and (not exists (select c0dfe from #3898_3ff where cfbc = '>') or exists (select c0dfe from #3898_3ff where cfbc = '>' and r.cpu_time > c0dfe and @3898_01e = 1)) and (not exists (select c93c1 from #60b2_3ff where cfbc = '=') or exists (select c93c1 from #60b2_3ff where cfbc = '=' and r.reads = c93c1 and @60b2_37a = 1)) and (not exists (select c93c1 from #60b2_3ff where cfbc = '<') or exists (select c93c1 from #60b2_3ff where cfbc = '<' and r.reads < c93c1 and @60b2_81b = 1)) and (not exists (select c93c1 from #60b2_3ff where cfbc = '>') or exists (select c93c1 from #60b2_3ff where cfbc = '>' and r.reads > c93c1 and @60b2_01e = 1)) and (not exists (select ceb65 from #b1a9_3ff where cfbc = '=') or exists (select ceb65 from #b1a9_3ff where cfbc = '=' and r.row_count = ceb65 and @b1a9_37a = 1)) and (not exists (select ceb65 from #b1a9_3ff where cfbc = '<') or exists (select ceb65 from #b1a9_3ff where cfbc = '<' and r.row_count < ceb65 and @b1a9_81b = 1)) and (not exists (select ceb65 from #b1a9_3ff where cfbc = '>') or exists (select ceb65 from #b1a9_3ff where cfbc = '>' and r.row_count > ceb65 and @b1a9_01e = 1)) and (not exists (select c9e53 from #2256_3ff where cdd9 = 1) or exists (select c9e53 from #2256_3ff where s.host_name like c9e53 and cdd9 = 1 and @2256_d17 = 1)) and (not exists (select c7a8a from #6637_3ff where cdd9 = 1) or exists (select c7a8a from #6637_3ff where s.program_name like c7a8a and cdd9 = 1 and @6637_d17 = 1)) and (not exists (select c685a from #3379_3ff where cdd9 = 1) or exists (select c685a from #3379_3ff where c.client_net_address like c685a and cdd9 = 1 and @3379_d17 = 1)) and (not exists (select c5226 from #8969_3ff where cdd9 = 1) or exists (select c5226 from #8969_3ff where r.wait_type like c5226 and cdd9 = 1 and @8969_d17 = 1)) and (not exists (select cb91d from #863e_3ff where cdd9 = 1) or exists (select cb91d from #863e_3ff where s.nt_domain like cb91d and cdd9 = 1 and @863e_d17 = 1)) and (not exists (select c2196 from #3cf2_3ff where cdd9 = 1) or exists (select c2196 from #3cf2_3ff where r.wait_resource like c2196 and cdd9 = 1 and @3cf2_d17 = 1)) and (not exists (select cd68f from #3d08_3ff where cdd9 = 1) or exists (select cd68f from #3d08_3ff where s.login_name like cd68f and cdd9 = 1 and @3d08_d17 = 1)) and (not exists (select ca53e from #74cb_3ff where cdd9 = 1) or exists (select ca53e from #74cb_3ff where s.nt_user_name like ca53e and cdd9 = 1 and @74cb_d17 = 1)) and (not exists (select cb8a8 from #6a56_3ff where cdd9 = 0 and c.most_recent_sql_handle = cb8a8 and @6a56_e19 = 1)) and (not exists (select c336f from #2947_3ff where cdd9 = 0 and r.statement_start_offset = c336f and @2947_e19 = 1)) and (not exists (select cd07c from #9b90_3ff where cdd9 = 0 and c.connection_id = cd07c and @9b90_e19 = 1)) and (not exists (select cfcb8 from #e847_3ff where cdd9 = 0 and r.plan_handle = cfcb8 and @e847_e19 = 1)) and (not exists (select c25cc from #2db7_3ff where cdd9 = 0 and r.status = c25cc and @2db7_e19 = 1)) and (not exists (select cdd5b from #ad99_3ff where cdd9 = 0 and r.query_hash = cdd5b and @ad99_e19 = 1)) and (not exists (select ca694 from #4617_3ff where cdd9 = 0 and r.scheduler_id = ca694 and @4617_e19 = 1)) and (not exists (select c1276 from #1532_3ff where cdd9 = 0 and r.sql_handle = c1276 and @1532_e19 = 1)) and (not exists (select ca808 from #d24d_3ff where cdd9 = 0 and s.database_id = ca808 and @d24d_e19 = 1)) and (not exists (select c4643 from #9d74_3ff where cdd9 = 0 and r.request_id = c4643 and @9d74_e19 = 1)) and (not exists (select c312c from #c886_3ff where cdd9 = 0 and s.is_user_process = c312c and @c886_e19 = 1)) and (not exists (select c55ce from #8572_3ff where cdd9 = 0 and s.transaction_isolation_level = c55ce and @8572_e19 = 1)) and (not exists (select c60dd from #82a0_3ff where cdd9 = 0 and r.statement_end_offset = c60dd and @82a0_e19 = 1)) and (not exists (select c0470 from #083d_3ff where cdd9 = 0 and s.context_info = c0470 and @083d_e19 = 1)) and (not exists (select c7e3e from #c3e1_3ff where cdd9 = 0 and r.executing_managed_code = c7e3e and @c3e1_e19 = 1)) and (not exists (select cd5e2 from #52d2_3ff where cdd9 = 0 and s.group_id = cd5e2 and @52d2_e19 = 1)) and (not exists (select cb6a4 from #1144_3ff where cdd9 = 0 and r.blocking_session_id = cb6a4 and @1144_e19 = 1)) and (not exists (select cb693 from #5f33_3ff where cdd9 = 0 and c.node_affinity = cb693 and @5f33_e19 = 1)) and (not exists (select c54ac from #c026_3ff where cdd9 = 0 and r.transaction_id = c54ac and @c026_e19 = 1)) and (not exists (select cad83 from #d43f_3ff where cdd9 = 0 and s.session_id = cad83 and @d43f_e19 = 1)) and (not exists (select c5783 from #9e0b_3ff where cdd9 = 0 and s.host_process_id = c5783 and @9e0b_e19 = 1)) and (not exists (select caace from #8ca4_3ff where cdd9 = 0 and r.command = caace and @8ca4_e19 = 1)) and (not exists (select cf1e0 from #2cbb_3ff where cdd9 = 0 and r.query_plan_hash = cf1e0 and @2cbb_e19 = 1)) and (not exists (select cd68f from #3d08_3ff where s.login_name like cd68f and cdd9 = 0 and @3d08_e19 = 1)) and (not exists (select ca53e from #74cb_3ff where s.nt_user_name like ca53e and cdd9 = 0 and @74cb_e19 = 1)) and (not exists (select c2196 from #3cf2_3ff where r.wait_resource like c2196 and cdd9 = 0 and @3cf2_e19 = 1)) and (not exists (select c7a8a from #6637_3ff where s.program_name like c7a8a and cdd9 = 0 and @6637_e19 = 1)) and (not exists (select cb91d from #863e_3ff where s.nt_domain like cb91d and cdd9 = 0 and @863e_e19 = 1)) and (not exists (select c685a from #3379_3ff where c.client_net_address like c685a and cdd9 = 0 and @3379_e19 = 1)) and (not exists (select c9e53 from #2256_3ff where s.host_name like c9e53 and cdd9 = 0 and @2256_e19 = 1)) and (not exists (select c5226 from #8969_3ff where r.wait_type like c5226 and cdd9 = 0 and @8969_e19 = 1)) and (s.session_id not in (select @@spid where not exists (select c35f from #fa4 where upper(c35f) in ('SP_WHOPRO')))) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_sessions left join sys.dm_exec_connections left join sys.dm_exec_requests ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() insert into #c05 (session_id) select distinct c7e_session_id as session_id from #a52 insert into #9de select distinct c7e_session_id as session_id, c7e_login_time as login_time, c7e_host_name as host_name, c7e_program_name as program_name, c7e_host_process_id as host_process_id, c7e_client_version as client_version, c7e_client_interface_name as client_interface_name, c7e_security_id as security_id, c7e_login_name as login_name, c7e_nt_domain as nt_domain, c7e_nt_user_name as nt_user_name, c7e_status as status, c7e_context_info as context_info, c7e_cpu_time as cpu_time, c7e_memory_usage as memory_usage, c7e_total_scheduled_time as total_scheduled_time, c7e_total_elapsed_time as total_elapsed_time, c7e_endpoint_id as endpoint_id, c7e_last_request_start_time as last_request_start_time, c7e_last_request_end_time as last_request_end_time, c7e_reads as reads, c7e_writes as writes, c7e_logical_reads as logical_reads, c7e_is_user_process as is_user_process, c7e_text_size as text_size, c7e_language as language, c7e_date_format as date_format, c7e_date_first as date_first, c7e_quoted_identifier as quoted_identifier, c7e_arithabort as arithabort, c7e_ansi_null_dflt_on as ansi_null_dflt_on, c7e_ansi_defaults as ansi_defaults, c7e_ansi_warnings as ansi_warnings, c7e_ansi_padding as ansi_padding, c7e_ansi_nulls as ansi_nulls, c7e_concat_null_yields_null as concat_null_yields_null, c7e_transaction_isolation_level as transaction_isolation_level, c7e_lock_timeout as lock_timeout, c7e_deadlock_priority as deadlock_priority, c7e_row_count as row_count, c7e_prev_error as prev_error, c7e_original_security_id as original_security_id, c7e_original_login_name as original_login_name, c7e_last_successful_logon as last_successful_logon, c7e_last_unsuccessful_logon as last_unsuccessful_logon, c7e_unsuccessful_logons as unsuccessful_logons, c7e_group_id as group_id, c7e_database_id as database_id, c7e_authenticating_database_id as authenticating_database_id, c7e_open_transaction_count as open_transaction_count, ctime from #a52 select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_sessions ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() insert into #b39 (session_id, connection_id) select distinct c2e_session_id as session_id, c2e_connection_id as connection_id from #a52 where c2e_session_id is not NULL insert into #dd0 select distinct c2e_session_id as session_id, c2e_most_recent_session_id as most_recent_session_id, c2e_connect_time as connect_time, c2e_net_transport as net_transport, c2e_protocol_type as protocol_type, c2e_protocol_version as protocol_version, c2e_endpoint_id as endpoint_id, c2e_encrypt_option as encrypt_option, c2e_auth_scheme as auth_scheme, c2e_node_affinity as node_affinity, c2e_num_reads as num_reads, c2e_num_writes as num_writes, c2e_last_read as last_read, c2e_last_write as last_write, c2e_net_packet_size as net_packet_size, c2e_client_net_address as client_net_address, c2e_client_tcp_port as client_tcp_port, c2e_local_net_address as local_net_address, c2e_local_tcp_port as local_tcp_port, c2e_connection_id as connection_id, c2e_parent_connection_id as parent_connection_id, c2e_most_recent_sql_handle as most_recent_sql_handle, ctime from #a52 where c2e_session_id is not NULL select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_connections ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() insert into #0ed (session_id, request_id, connection_id) select distinct cec_session_id as session_id, cec_request_id as request_id, cec_connection_id as connection_id from #a52 where cec_session_id is not NULL insert into #091 select distinct cec_session_id as session_id, cec_request_id as request_id, cec_start_time as start_time, cec_status as status, cec_command as command, cec_sql_handle as sql_handle, cec_statement_start_offset as statement_start_offset, cec_statement_end_offset as statement_end_offset, cec_plan_handle as plan_handle, cec_database_id as database_id, cec_user_id as user_id, cec_connection_id as connection_id, cec_blocking_session_id as blocking_session_id, cec_wait_type as wait_type, cec_wait_time as wait_time, cec_last_wait_type as last_wait_type, cec_wait_resource as wait_resource, cec_open_transaction_count as open_transaction_count, cec_open_resultset_count as open_resultset_count, cec_transaction_id as transaction_id, cec_context_info as context_info, cec_percent_complete as percent_complete, cec_estimated_completion_time as estimated_completion_time, cec_cpu_time as cpu_time, cec_total_elapsed_time as total_elapsed_time, cec_scheduler_id as scheduler_id, cec_task_address as task_address, cec_reads as reads, cec_writes as writes, cec_logical_reads as logical_reads, cec_text_size as text_size, cec_language as language, cec_date_format as date_format, cec_date_first as date_first, cec_quoted_identifier as quoted_identifier, cec_arithabort as arithabort, cec_ansi_null_dflt_on as ansi_null_dflt_on, cec_ansi_defaults as ansi_defaults, cec_ansi_warnings as ansi_warnings, cec_ansi_padding as ansi_padding, cec_ansi_nulls as ansi_nulls, cec_concat_null_yields_null as concat_null_yields_null, cec_transaction_isolation_level as transaction_isolation_level, cec_lock_timeout as lock_timeout, cec_deadlock_priority as deadlock_priority, cec_row_count as row_count, cec_prev_error as prev_error, cec_nest_level as nest_level, cec_granted_query_memory as granted_query_memory, cec_executing_managed_code as executing_managed_code, cec_group_id as group_id, cec_query_hash as query_hash, cec_query_plan_hash as query_plan_hash, cec_statement_sql_handle as statement_sql_handle, cec_statement_context_id as statement_context_id, ctime from #a52 where cec_session_id is not NULL select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_requests ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) insert into #f5c select t.task_address as cd18, t.task_state as c005, t.context_switches_count as ce18, t.pending_io_count as c580, t.pending_io_byte_count as c0d4, t.pending_io_byte_average as cbdb, t.scheduler_id as c461, t.session_id as cd43, t.exec_context_id as ca87, t.request_id as c9d7, t.worker_address as c7de, t.host_address as c4b9, t.parent_task_address as cb5e, (select start_time from sys.dm_exec_requests where session_id = r.session_id and request_id = r.request_id) as cc53, getdate() as ctime from sys.dm_os_tasks t inner join #091 r on (t.session_id = r.session_id and t.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_os_tasks ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_wait_types', 'c99_waiting_tasks_max_wait_duration_ms', 'c99_waiting_tasks_blocking_session_ids', 'c99_waiting_tasks_valid_flag', 'c99_waiting_tasks_info', 'c99_lock_count', 'c7a_lock_count', 'c99_lock_owner_id', 'c7a_lock_owner_id', 'c99_locks_info', 'c7a_locks_info', 'c99_is_blocker', 'c99_is_head_blocker', 'c7a_is_blocked', 'c7a_is_dead_locked', 'c99_blocked_session_ids', 'c7a_blocker_session_ids', 'c7a_head_blocker_session_ids')) begin if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) insert into #476 (cf35, cd43, ca87, c693, c896, cc60, cb2c, c114, cedf, c1f6, c4d8) select wt.waiting_task_address as cf35, wt.session_id as cd43, wt.exec_context_id as ca87, wt.wait_duration_ms as c693, wt.wait_type as c896, wt.resource_address as cc60, wt.blocking_task_address as cb2c, wt.blocking_session_id as c114, wt.blocking_exec_context_id as cedf, wt.resource_description as c1f6, (select login_time from sys.dm_exec_sessions where session_id = r.session_id) as c4d8 from sys.dm_os_waiting_tasks wt inner join #f5c t on (wt.waiting_task_address = t.cd18) inner join #091 r on (t.cd43 = r.session_id and t.c9d7 = r.request_id) else insert into #476 (cf35, cd43, ca87, c693, c896, cc60, cb2c, c114, cedf, c1f6, c4d8) select wt.waiting_task_address as cf35, wt.session_id as cd43, wt.exec_context_id as ca87, wt.wait_duration_ms as c693, wt.wait_type as c896, wt.resource_address as cc60, wt.blocking_task_address as cb2c, wt.blocking_session_id as c114, wt.blocking_exec_context_id as cedf, wt.resource_description as c1f6, (select login_time from sys.dm_exec_sessions where session_id = s.session_id) as c4d8 from sys.dm_os_waiting_tasks wt inner join #9de s on (wt.session_id = s.session_id) end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_os_waiting_tasks ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_requested_memory_kb', 'c7a_query_memory_grants_granted_memory_kb', 'c7a_query_memory_grants_used_memory_kb', 'c7a_query_memory_grants_max_used_memory_kb', 'c7a_query_memory_grants_wait_time_ms', 'c7a_query_memory_grants_ideal_memory_kb', 'c7a_query_memory_grants_info')) insert into #525 select qmg.session_id as cd43, qmg.request_id as c9d7, qmg.scheduler_id as c461, qmg.dop as c59e, qmg.request_time as c3d2, qmg.grant_time as ccb7, qmg.requested_memory_kb as c1e1, qmg.granted_memory_kb as c28c, qmg.required_memory_kb as c4fe, qmg.used_memory_kb as c5be, qmg.max_used_memory_kb as c54c, qmg.query_cost as cc47, qmg.timeout_sec as c388, qmg.resource_semaphore_id as cdf3, qmg.queue_id as cd0c, qmg.wait_order as cb7b, qmg.is_next_candidate as cd36, qmg.wait_time_ms as c4e0, qmg.plan_handle as ce84, qmg.sql_handle as c153, qmg.group_id as c52d, qmg.pool_id as c5e8, qmg.is_small as cb4d, qmg.ideal_memory_kb as c62f, (select start_time from sys.dm_exec_requests where session_id = r.session_id and request_id = r.request_id) as cc53 from sys.dm_exec_query_memory_grants qmg inner join #091 r on (qmg.session_id = r.session_id and qmg.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_query_memory_grants ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_profiles_cpu_time_ms', 'c7a_query_profiles_logical_read_count', 'c7a_query_profiles_physical_read_count', 'c7a_query_profiles_read_ahead_count', 'c7a_query_profiles_write_page_count', 'c7a_query_profiles_info')) insert into #aa7 select qp.session_id as cd43, qp.request_id as c9d7, qp.sql_handle as c153, qp.plan_handle as ce84, qp.physical_operator_name as c3a4, qp.node_id as ca4e, qp.thread_id as c439, qp.task_address as cd18, qp.row_count as cb1a, qp.rewind_count as cc3b, qp.rebind_count as cf45, qp.end_of_scan_count as ca0d, qp.estimate_row_count as c8bf, qp.first_active_time as c58b, qp.last_active_time as c9be, qp.open_time as cd00, qp.first_row_time as c109, qp.last_row_time as c1cc, qp.close_time as c91b, qp.elapsed_time_ms as c2c9, qp.cpu_time_ms as ce90, qp.database_id as cd24, qp.object_id as c20d, qp.index_id as cec5, qp.scan_count as c816, qp.logical_read_count as c031, qp.physical_read_count as c63b, qp.read_ahead_count as c2e7, qp.write_page_count as c452, qp.lob_logical_read_count as c8c0, qp.lob_physical_read_count as c7b9, qp.lob_read_ahead_count as cbf1, qp.segment_read_count as c906, qp.segment_skip_count as c298, (select start_time from sys.dm_exec_requests where session_id = r.session_id and request_id = r.request_id) as cc53 from sys.dm_exec_query_profiles qp inner join #091 r on (qp.session_id = r.session_id and qp.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_query_profiles ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_transaction_begin_time', 'c7a_transaction_begin_time', 'c99_transaction_log_record_count', 'c99_transaction_log_bytes_used', 'c99_transaction_info', 'c7a_transaction_info')) insert into #f3c select tst.session_id as cd43, tst.transaction_id as cc02, tst.transaction_descriptor as c118, tst.enlist_count as c7a8, tst.is_user_transaction as c0a0, tst.is_local as cec4, tst.is_enlisted as c09b, tst.is_bound as cc8c, tst.open_transaction_count as c01d, (select login_time from sys.dm_exec_sessions where session_id = s.session_id) as c4d8 from sys.dm_tran_session_transactions tst inner join #9de s on (tst.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_tran_session_transactions ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_transaction_begin_time', 'c7a_transaction_begin_time', 'c99_transaction_log_record_count', 'c99_transaction_log_bytes_used', 'c99_transaction_info', 'c7a_transaction_info')) insert into #088 select tat.transaction_id as cc02, tat.name as c60f, tat.transaction_begin_time as c6bb, tat.transaction_type as c710, tat.transaction_uow as c353, tat.transaction_state as c20b, tat.transaction_status as c873, tat.transaction_status2 as c37f, tat.dtc_state as ca81, tat.dtc_status as c8d4, tat.dtc_isolation_level as cca1, tat.filestream_transaction_id as c0fe from sys.dm_tran_active_transactions tat select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_tran_active_transactions ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_transaction_log_record_count', 'c99_transaction_log_bytes_used', 'c99_transaction_info', 'c7a_transaction_info')) insert into #318 select tdt.transaction_id as cc02, tdt.database_id as cd24, tdt.database_transaction_begin_time as ca79, tdt.database_transaction_type as c8b6, tdt.database_transaction_state as c711, tdt.database_transaction_status as ce11, tdt.database_transaction_status2 as c894, tdt.database_transaction_log_record_count as ce7e, tdt.database_transaction_replicate_record_count as c596, tdt.database_transaction_log_bytes_used as c5a7, tdt.database_transaction_log_bytes_reserved as c548, tdt.database_transaction_log_bytes_used_system as c826, tdt.database_transaction_log_bytes_reserved_system as c834, tdt.database_transaction_begin_lsn as cbb0, tdt.database_transaction_last_lsn as c700, tdt.database_transaction_most_recent_savepoint_lsn as c50b, tdt.database_transaction_commit_lsn as c169, tdt.database_transaction_last_rollback_lsn as c49f, tdt.database_transaction_next_undo_lsn as c8e9 from sys.dm_tran_database_transactions tdt select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_tran_database_transactions ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	if exists (select c35f from #2ff where c35f in ('input_buffer', 'c7e_input_buffer', 'cec_input_buffer', 'c99_input_buffer_checksum', 'c7a_input_buffer_checksum', 'c99_input_buffer_valid_flag', 'c7a_input_buffer_valid_flag')) begin select @254 = getdate() insert into #295 select distinct r.session_id, r.request_id from #9de s inner join #091 r on (s.session_id = r.session_id) where s.is_user_process = 1 insert into #295 select distinct s.session_id, NULL from #9de s where s.is_user_process = 1 and s.session_id not in (select cd43 from #295) declare cef8 cursor for select cd43, c9d7 from #295 open cef8 fetch next from cef8 into @9c0, @324 while (@@fetch_status = 0) begin delete #f4d begin try if (@324 is not NULL and exists (select c35f from #2ff where c35f in ('input_buffer', 'cec_input_buffer', 'c7a_input_buffer_checksum', 'c7a_input_buffer_valid_flag'))) begin insert into #f4d exec sp_executesql N'DBCC INPUTBUFFER (@9c0, @324) WITH NO_INFOMSGS', N'@9c0 smallint, @324 int', @9c0, @324 end else if exists (select c35f from #2ff where c35f in ('input_buffer', 'c7e_input_buffer', 'c99_input_buffer_checksum', 'c99_input_buffer_valid_flag')) begin insert into #f4d exec sp_executesql N'DBCC INPUTBUFFER (@9c0) WITH NO_INFOMSGS', N'@9c0 smallint', @9c0 end if exists (select c0e4 from #f4d where checksum(c0e4) is not NULL and checksum(c0e4) <> 2147483647) begin update #384 set rcount = rcount + 1 from #f4d where EventInfo = c0e4 and checksum(c0e4) in (select checksum from #384) insert into #384 select checksum(c0e4), ccfa, cc4a, c0e4, @datetime, 1 from #f4d where checksum(c0e4) not in (select checksum from #384) if (@324 is not NULL) begin insert into #c4f (cd43, c9d7, cd88, cc53) select @9c0, @324, checksum(c0e4), (select start_time from sys.dm_exec_requests where session_id = @9c0 and request_id = @324) from #f4d end else begin insert into #c4f (cd43, c9d7, cd88, ca6d) select @9c0, @324, checksum(c0e4), (select last_request_start_time from sys.dm_exec_sessions where session_id = @9c0) from #f4d end end end try begin catch if (@324 is not NULL and exists (select c35f from #2ff where c35f in ('c7a_input_buffer_checksum', 'c7a_input_buffer_valid_flag'))) print 'DBCC INPUTBUFFER(' + cast(@9c0 as varchar(5)) + ', ' + cast(@324 as varchar(5)) + ') returned error' else if exists (select c35f from #2ff where c35f in ('c99_input_buffer_checksum', 'c99_input_buffer_valid_flag')) print 'DBCC INPUTBUFFER(' + cast(@9c0 as varchar(5)) + ') returned error' print'ERROR_NUMBER = ' + cast(ERROR_NUMBER() as nvarchar(256)) + ', ERROR_SEVERITY = ' + cast(ERROR_SEVERITY() as nvarchar(256)) + ', ERROR_STATE = ' + cast(ERROR_STATE() as nvarchar(256)) + ', ERROR_PROCEDURE = ' + isnull(ERROR_PROCEDURE(), '') + ', ERROR_LINE = ' + cast(ERROR_LINE() as nvarchar(256)) + ', ERROR_MESSAGE = ' + ERROR_MESSAGE() end catch fetch next from cef8 into @9c0, @324 end close cef8 deallocate cef8 if (@5d0 = 1) begin set @697 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_input_buffer set rtime = ib.ctime, rcount = sqlwsib.rcount + ib.rcount from [' + schema_name(@bcc) + '].sqlws_input_buffer sqlwsib inner join #384 ib on (sqlwsib.servername = @@servername and sqlwsib.checksum = ib.checksum)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_input_buffer failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_input_buffer select @@servername, checksum, EventType, Parameters, EventInfo, ctime, ctime, rcount from #384 where checksum not in (select checksum from [' + schema_name(@bcc) + '].sqlws_input_buffer where servername = @@servername)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_input_buffer failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'DBCC INPUTBUFFER ... took ' + cast(@a09 as nvarchar(256)) + ' ms' end
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_lock_count', 'c7a_lock_count', 'c99_lock_owner_id', 'c7a_lock_owner_id', 'c99_locks_info', 'c7a_locks_info')) begin if (@373 = 1) insert into #e8f select tl.resource_type as cf24, tl.resource_subtype as c590, tl.resource_database_id as c769, tl.resource_associated_entity_id as c1a4, tl.resource_lock_partition as ca4e, tl.request_mode as cd24, tl.request_type as c1e0, tl.request_status as c7e4, tl.request_reference_count as ce99, tl.request_lifetime as ced9, tl.request_session_id as c3ec, tl.request_exec_context_id as ce07, tl.request_request_id as c335, tl.request_owner_type as cae4, tl.request_owner_id as c78a, tl.request_owner_guid as c2f2, tl.request_owner_lockspace_id as c109, tl.lock_owner_address as cd3e, count(*), (select login_time from sys.dm_exec_sessions where session_id = tl.request_session_id) as c4d8 from sys.dm_tran_locks tl inner join #9de s on (tl.request_session_id = s.session_id) where @373 = 1 group by resource_type, resource_subtype, resource_database_id, resource_associated_entity_id, resource_lock_partition, request_mode, request_type, request_status, request_reference_count, request_lifetime, request_session_id, request_exec_context_id, request_request_id, request_owner_type, request_owner_id, request_owner_guid, request_owner_lockspace_id, lock_owner_address else insert into #e8f select tl.resource_type as cf24, tl.resource_subtype as c590, tl.resource_database_id as c769, tl.resource_associated_entity_id as c1a4, tl.resource_lock_partition as ca4e, tl.request_mode as cd24, tl.request_type as c1e0, tl.request_status as c7e4, tl.request_reference_count as ce99, tl.request_lifetime as ced9, tl.request_session_id as c3ec, tl.request_exec_context_id as ce07, tl.request_request_id as c335, tl.request_owner_type as cae4, tl.request_owner_id as c78a, tl.request_owner_guid as c2f2, tl.request_owner_lockspace_id as c109, tl.lock_owner_address as cd3e, count(*), (select login_time from sys.dm_exec_sessions where session_id = tl.request_session_id) as c4d8 from sys.dm_tran_locks tl inner join #9de s on (tl.request_session_id = s.session_id) where s.session_id in (select distinct cd43 from #476 wt where c896 like 'LCK%' union select distinct c114 from #476 wt where c896 like 'LCK%') group by resource_type, resource_subtype, resource_database_id, resource_associated_entity_id, resource_lock_partition, request_mode, request_type, request_status, request_reference_count, request_lifetime, request_session_id, request_exec_context_id, request_request_id, request_owner_type, request_owner_id, request_owner_guid, request_owner_lockspace_id, lock_owner_address end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_tran_locks ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	if exists (select c35f from #2ff where c35f in ('text_object_name', 'text', 'c2e_text_object_name', 'c2e_text', 'cec_text_object_name', 'cec_text', 'statement_object_name', 'statement', 'cec_statement_object_name', 'cec_statement', 'c99_cursors_info')) begin select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) begin if exists (select c35f from #2ff where c35f in ('c99_cursors_info')) insert into #d48 (c229) select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct qmg.c153 from #525 qmg union select distinct c.c153 from #4dc c else insert into #d48 (c229) select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct qmg.c153 from #525 qmg end else if exists (select c35f from #2ff where c35f in ('c99_cursors_info')) begin if not exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) insert into #d48 (c229) select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct c.c153 from #4dc c end else insert into #d48 (c229) select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c declare c751 cursor for select c229 from #d48 where c229 is not NULL and c229 <> 0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 open c751 fetch next from c751 into @a35 while (@@fetch_status = 0) begin begin try insert into #fbf select @a35 as sql_handle, case when st.dbid is NULL then 'database_id = NULL' else 'database_id = ' + cast(st.dbid as nvarchar(256)) + case when db_name(st.dbid) is not NULL then '(' + db_name(st.dbid) + ')' else '' end end + case when st.objectid is NULL then ', object_id = NULL' else ', object_id = ' + cast(st.objectid as nvarchar(256)) + case when object_name(st.objectid, st.dbid) is not NULL then '(' + object_name(st.objectid, st.dbid) + ')' else '' end end as sql_text_info, st.dbid, st.objectid, st.number, st.encrypted, st.text, @datetime, (select count(*) from #dd0 c left outer join #091 r on (c.session_id = r.session_id and c.connection_id = r.connection_id) where c.most_recent_sql_handle = @a35 or r.sql_handle = @a35) from sys.dm_exec_sql_text(@a35) st where st.text is not NULL end try begin catch print 'select ... from sys.dm_exec_sql_text(' + sys.fn_varbintohexstr(cast(@a35 as varbinary(64))) + ') returned error' print'ERROR_NUMBER = ' + cast(ERROR_NUMBER() as nvarchar(256)) + ', ERROR_SEVERITY = ' + cast(ERROR_SEVERITY() as nvarchar(256)) + ', ERROR_STATE = ' + cast(ERROR_STATE() as nvarchar(256)) + ', ERROR_PROCEDURE = ' + isnull(ERROR_PROCEDURE(), '') + ', ERROR_LINE = ' + cast(ERROR_LINE() as nvarchar(256)) + ', ERROR_MESSAGE = ' + ERROR_MESSAGE() end catch fetch next from c751 into @a35 end close c751 deallocate c751 if (@5d0 = 1) begin set @697 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text set rtime = st.ctime, rcount = sqlwsst.rcount + st.rcount from [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text sqlwsst inner join #fbf st on (sqlwsst.servername = @@servername and sqlwsst.sql_handle = st.sql_handle)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text select @@servername, sql_handle, sql_text_info, st.dbid, st.objectid, st.number, st.encrypted, st.text, ctime, ctime, rcount from #fbf st where st.sql_handle not in (select sql_handle from [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text where servername = @@servername)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_sql_text ... took ' + cast(@a09 as nvarchar(256)) + ' ms' end if exists (select c35f from #2ff where c35f in ('query_plan', 'cec_query_plan')) begin select @254 = getdate() set lock_timeout 0 delete #b1c if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) insert into #b1c select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg else insert into #b1c select distinct r.plan_handle from #091 r declare cd0a cursor for select c554 from #b1c where c554 is not NULL open cd0a fetch next from cd0a into @c77 while (@@fetch_status = 0) begin begin try if not exists (select plan_handle from #f20 where plan_handle = @c77) insert into #f20 select @c77 as plan_handle, case when qp.dbid is NULL then 'database_id = NULL' else 'database_id = ' + cast(qp.dbid as nvarchar(256)) + case when db_name(qp.dbid) is not NULL then '(' + db_name(qp.dbid) + ')' else '' end end + case when qp.objectid is NULL then ', object_id = NULL' else ', object_id = ' + cast(qp.objectid as nvarchar(256)) + case when object_name(qp.objectid, qp.dbid) is not NULL then '(' + object_name(qp.objectid, qp.dbid) + ')' else '' end end as query_plan_info, qp.dbid, qp.objectid, qp.number, qp.encrypted, qp.query_plan, @datetime, (select count(*) from #091 where plan_handle = @c77) from sys.dm_exec_query_plan(@c77) qp where qp.query_plan is not NULL end try begin catch print 'select ... from sys.dm_exec_exec_query_plan(' + sys.fn_varbintohexstr(cast(@c77 as varbinary(64))) + ') returned error' print'ERROR_NUMBER = ' + cast(ERROR_NUMBER() as nvarchar(256)) + ', ERROR_SEVERITY = ' + cast(ERROR_SEVERITY() as nvarchar(256)) + ', ERROR_STATE = ' + cast(ERROR_STATE() as nvarchar(256)) + ', ERROR_PROCEDURE = ' + isnull(ERROR_PROCEDURE(), '') + ', ERROR_LINE = ' + cast(ERROR_LINE() as nvarchar(256)) + ', ERROR_MESSAGE = ' + ERROR_MESSAGE() end catch fetch next from cd0a into @c77 end close cd0a deallocate cd0a set lock_timeout -1 if (@5d0 = 1) begin set @697 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan set rtime = qp.ctime, rcount = sqlwsqp.rcount + qp.rcount from [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan sqlwsqp inner join #f20 qp on (sqlwsqp.servername = @@servername and sqlwsqp.plan_handle = qp.plan_handle)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan select @@servername, plan_handle, query_plan_info, qp.dbid, qp.objectid, qp.number, qp.encrypted, qp.query_plan, ctime, ctime, rcount from #f20 qp where qp.plan_handle not in (select plan_handle from [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan where servername = @@servername)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_query_plan ... took ' + cast(@a09 as nvarchar(256)) + ' ms' end if exists (select c35f from #2ff where c35f in ('query_plan_checksum', 'cec_query_plan_checksum', 'c7a_query_plan_text_checksum')) begin select @254 = getdate() set lock_timeout 0 delete #b1c if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) insert into #b1c select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg else insert into #b1c select distinct r.plan_handle from #091 r declare cd0a cursor for select c554 from #b1c where c554 is not NULL open cd0a fetch next from cd0a into @c77 while (@@fetch_status = 0) begin begin try insert into #eef select checksum(cast(qp.query_plan as nvarchar(max))) as checksum, @c77 as plan_handle, case when qp.dbid is NULL then 'database_id = NULL' else 'database_id = ' + cast(qp.dbid as nvarchar(256)) + case when db_name(qp.dbid) is not NULL then '(' + db_name(qp.dbid) + ')' else '' end end + case when qp.objectid is NULL then ', object_id = NULL' else ', object_id = ' + cast(qp.objectid as nvarchar(256)) + case when object_name(qp.objectid, qp.dbid) is not NULL then '(' + object_name(qp.objectid, qp.dbid) + ')' else '' end end as query_plan_info, qp.dbid, qp.objectid, qp.number, qp.encrypted, qp.query_plan, @datetime, (select count(*) from #091 where plan_handle = @c77) from sys.dm_exec_query_plan(@c77) qp where checksum(cast(qp.query_plan as nvarchar(max))) <> 2147483647 and checksum(cast(qp.query_plan as nvarchar(max))) not in (select checksum from #eef) end try begin catch print 'select ... from sys.dm_exec_exec_query_plan(' + sys.fn_varbintohexstr(cast(@c77 as varbinary(64))) + ') returned error' print'ERROR_NUMBER = ' + cast(ERROR_NUMBER() as nvarchar(256)) + ', ERROR_SEVERITY = ' + cast(ERROR_SEVERITY() as nvarchar(256)) + ', ERROR_STATE = ' + cast(ERROR_STATE() as nvarchar(256)) + ', ERROR_PROCEDURE = ' + isnull(ERROR_PROCEDURE(), '') + ', ERROR_LINE = ' + cast(ERROR_LINE() as nvarchar(256)) + ', ERROR_MESSAGE = ' + ERROR_MESSAGE() end catch fetch next from cd0a into @c77 end close cd0a deallocate cd0a set lock_timeout -1 if (@5d0 = 1) begin set @697 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum set rtime = qp.ctime, rcount = sqlwsqp.rcount + qp.rcount from [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum sqlwsqp inner join #eef qp on (sqlwsqp.servername = @@servername and sqlwsqp.checksum = qp.checksum)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum select @@servername, qp.checksum, qp.plan_handle, qp.query_plan_info, qp.dbid, qp.objectid, qp.number, qp.encrypted, qp.query_plan, ctime, ctime, rcount from #eef qp where qp.checksum not in (select checksum from [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum where servername = @@servername)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_query_plan ... took ' + cast(@a09 as nvarchar(256)) + ' ms' end if exists (select c35f from #2ff where c35f in ('plan_attributes_info', 'cec_plan_attributes_info')) begin select @254 = getdate() set lock_timeout 0 delete #b1c if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) insert into #b1c select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg else insert into #b1c select distinct r.plan_handle from #091 r declare cd0a cursor for select c554 from #b1c where c554 is not NULL open cd0a fetch next from cd0a into @c77 while (@@fetch_status = 0) begin begin try insert into #ca5 select @c77 as plan_handle, (select cast(plan_attributes.value as varbinary(64)) from sys.dm_exec_plan_attributes(@c77) plan_attributes where plan_attributes.attribute = 'sql_handle') as sql_handle, (select plan_attributes_info.plan_attributes_info, plan_attributes.attribute, case plan_attributes.attribute when 'sql_handle' then sys.fn_varbintohexstr(cast(plan_attributes.value as varbinary(64))) else cast(plan_attributes.value as nvarchar(max)) end as value, plan_attributes.is_cache_key from (select null as plan_attributes_info) as plan_attributes_info cross join sys.dm_exec_plan_attributes(@c77) plan_attributes for xml auto) as plan_attributes_info, (select case when cast(plan_attributes1.value as int) is NULL then 'database_id = NULL' else 'database_id = ' + cast(cast(plan_attributes1.value as int) as nvarchar(256)) + case when db_name(cast(plan_attributes1.value as int)) is not NULL then '(' + db_name(cast(plan_attributes1.value as int)) + ')' else '' end end + case when cast(plan_attributes.value as int) is NULL then ', object_id = NULL' else ', object_id = ' + cast(cast(plan_attributes.value as int) as nvarchar(256)) + case when object_name(cast(plan_attributes.value as int), cast(plan_attributes1.value as int)) is not NULL then '(' + object_name(cast(plan_attributes.value as int), cast(plan_attributes1.value as int)) + ')' else '' end end from sys.dm_exec_plan_attributes(@c77) plan_attributes1 cross join sys.dm_exec_plan_attributes(@c77) plan_attributes where plan_attributes1.attribute = 'dbid' and plan_attributes.attribute = 'objectid') as plan_attributes_detail, @datetime as ctime, (select count(*) from #091 where plan_handle = @c77) as rcount end try begin catch print 'select ... from sys.dm_exec_plan_attributes(' + sys.fn_varbintohexstr(cast(@c77 as varbinary(64))) + ') returned error' print'ERROR_NUMBER = ' + cast(ERROR_NUMBER() as nvarchar(256)) + ', ERROR_SEVERITY = ' + cast(ERROR_SEVERITY() as nvarchar(256)) + ', ERROR_STATE = ' + cast(ERROR_STATE() as nvarchar(256)) + ', ERROR_PROCEDURE = ' + isnull(ERROR_PROCEDURE(), '') + ', ERROR_LINE = ' + cast(ERROR_LINE() as nvarchar(256)) + ', ERROR_MESSAGE = ' + ERROR_MESSAGE() end catch fetch next from cd0a into @c77 end close cd0a deallocate cd0a set lock_timeout -1 if (@5d0 = 1) begin set @697 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes set rtime = pa.ctime, rcount = sqlwspa.rcount + pa.rcount from [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes sqlwspa inner join #ca5 pa on (sqlwspa.servername = @@servername and sqlwspa.plan_handle = pa.plan_handle)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes select @@servername, plan_handle, sql_handle, plan_attributes_info, plan_attributes_detail, ctime, ctime, rcount from #ca5 pa where pa.plan_handle not in (select plan_handle from [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes where servername = @@servername)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_plan_attributes ... took ' + cast(@a09 as nvarchar(256)) + ' ms' end if exists (select c35f from #2ff where c35f in ('text_query_plan', 'cec_text_query_plan', 'full_text_query_plan', 'cec_full_text_query_plan')) begin select @254 = getdate() set lock_timeout 0 insert into #570 select distinct plan_handle, statement_start_offset, statement_end_offset from #091 declare cdda cursor for select c554, c326, caa6 from #570 where c554 is not NULL open cdda fetch next from cdda into @c77, @e39, @b12 while (@@fetch_status = 0) begin begin try if exists (select c35f from #2ff where c35f in ('text_query_plan', 'cec_text_query_plan')) insert into #164 select @c77 as plan_handle, @e39 as statement_start_offset, @b12 as statement_end_offset, case when tqp.dbid is NULL then 'database_id = NULL' else 'database_id = ' + cast(tqp.dbid as nvarchar(256)) + case when db_name(tqp.dbid) is not NULL then '(' + db_name(tqp.dbid) + ')' else '' end end + case when tqp.objectid is NULL then ', object_id = NULL' else ', object_id = ' + cast(tqp.objectid as nvarchar(256)) + case when object_name(tqp.objectid, tqp.dbid) is not NULL then '(' + object_name(tqp.objectid, tqp.dbid) + ')' else '' end end as text_query_plan_info, tqp.dbid, tqp.objectid, tqp.number, tqp.encrypted, tqp.query_plan, @datetime, (select count(*) from #091 where plan_handle = @c77 and statement_start_offset = @e39 and statement_end_offset = @b12) from sys.dm_exec_text_query_plan(@c77, @e39, @b12) tqp where tqp.query_plan is not NULL end try begin catch print 'select ... from sys.dm_exec_text_query_plan(' + sys.fn_varbintohexstr(cast(@c77 as varbinary(64))) + ', ' + cast(@e39 as sysname) + ', ' + cast(@e39 as sysname) + ') returned error' print'ERROR_NUMBER = ' + cast(ERROR_NUMBER() as nvarchar(256)) + ', ERROR_SEVERITY = ' + cast(ERROR_SEVERITY() as nvarchar(256)) + ', ERROR_STATE = ' + cast(ERROR_STATE() as nvarchar(256)) + ', ERROR_PROCEDURE = ' + isnull(ERROR_PROCEDURE(), '') + ', ERROR_LINE = ' + cast(ERROR_LINE() as nvarchar(256)) + ', ERROR_MESSAGE = ' + ERROR_MESSAGE() end catch begin try if exists (select c35f from #2ff where c35f in ('full_text_query_plan', 'cec_full_text_query_plan')) if not exists (select plan_handle from #164 where plan_handle = @c77 and statement_start_offset = 0 and statement_end_offset = -1) insert into #164 select @c77 as plan_handle, 0 as statement_start_offset, -1 as statement_end_offset, case when tqp.dbid is NULL then 'database_id = NULL' else 'database_id = ' + cast(tqp.dbid as nvarchar(256)) + case when db_name(tqp.dbid) is not NULL then '(' + db_name(tqp.dbid) + ')' else '' end end + case when tqp.objectid is NULL then ', object_id = NULL' else ', object_id = ' + cast(tqp.objectid as nvarchar(256)) + case when object_name(tqp.objectid, tqp.dbid) is not NULL then '(' + object_name(tqp.objectid, tqp.dbid) + ')' else '' end end as text_query_plan_info, tqp.dbid, tqp.objectid, tqp.number, tqp.encrypted, tqp.query_plan, @datetime, (select count(*) from #091 where plan_handle = @c77) from sys.dm_exec_text_query_plan(@c77, 0, -1) tqp where tqp.query_plan is not NULL end try begin catch print 'select ... from sys.dm_exec_text_query_plan(' + sys.fn_varbintohexstr(cast(@c77 as varbinary(64))) + ', 0, -1) returned error' print'ERROR_NUMBER = ' + cast(ERROR_NUMBER() as nvarchar(256)) + ', ERROR_SEVERITY = ' + cast(ERROR_SEVERITY() as nvarchar(256)) + ', ERROR_STATE = ' + cast(ERROR_STATE() as nvarchar(256)) + ', ERROR_PROCEDURE = ' + isnull(ERROR_PROCEDURE(), '') + ', ERROR_LINE = ' + cast(ERROR_LINE() as nvarchar(256)) + ', ERROR_MESSAGE = ' + ERROR_MESSAGE() end catch fetch next from cdda into @c77, @e39, @b12 end close cdda deallocate cdda set lock_timeout -1 if (@5d0 = 1) begin set @697 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan set rtime = tqp.ctime, rcount = sqlwstqp.rcount + tqp.rcount from [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan sqlwstqp inner join #164 tqp on (sqlwstqp.servername = @@servername and sqlwstqp.plan_handle = tqp.plan_handle and sqlwstqp.statement_start_offset = tqp.statement_start_offset and sqlwstqp.statement_end_offset = tqp.statement_end_offset)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] update [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan select @@servername, plan_handle, statement_start_offset, statement_end_offset, text_query_plan_info, tqp.dbid, tqp.objectid, tqp.number, tqp.encrypted, tqp.query_plan, ctime, ctime, rcount from #164 tqp where not exists (select plan_handle from [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan where servername = @@servername and plan_handle = tqp.plan_handle and statement_start_offset = tqp.statement_start_offset and statement_end_offset = tqp.statement_end_offset)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_text_query_plan ... took ' + cast(@a09 as nvarchar(256)) + ' ms' end
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('cb2_query_stats_info', 'c7a_query_stats_info')) begin if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) begin if exists (select c35f from #2ff where c35f in ('c99_cursors_info')) insert into #d1b select qs.sql_handle as c153, qs.statement_start_offset as c294, qs.statement_end_offset as c82a, qs.plan_generation_num as c99e, qs.plan_handle as ce84, qs.creation_time as c87f, qs.last_execution_time as c2f9, qs.execution_count as c521, qs.total_worker_time as cb4f, qs.last_worker_time as c3a8, qs.min_worker_time as cc50, qs.max_worker_time as caa0, qs.total_physical_reads as cfbf, qs.last_physical_reads as c2f7, qs.min_physical_reads as c9ff, qs.max_physical_reads as c6f9, qs.total_logical_writes as cb96, qs.last_logical_writes as c5f3, qs.min_logical_writes as c5bf, qs.max_logical_writes as c878, qs.total_logical_reads as cf41, qs.last_logical_reads as c9cf, qs.min_logical_reads as ce3c, qs.max_logical_reads as c55d, qs.total_clr_time as ccd1, qs.last_clr_time as c922, qs.min_clr_time as cb90, qs.max_clr_time as c22f, qs.total_elapsed_time as cc5d, qs.last_elapsed_time as c750, qs.min_elapsed_time as cac9, qs.max_elapsed_time as c8ce, qs.query_hash as cad9, qs.query_plan_hash as c2cb, qs.total_rows as cfc3, qs.last_rows as c20a, qs.min_rows as c5ae, qs.max_rows as c269, qs.statement_sql_handle as c0c4, qs.statement_context_id as c69a from sys.dm_exec_query_stats qs where qs.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct qmg.c153 from #525 qmg union select distinct c.c153 from #4dc c) or qs.plan_handle in (select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg) else insert into #d1b select qs.sql_handle as c153, qs.statement_start_offset as c294, qs.statement_end_offset as c82a, qs.plan_generation_num as c99e, qs.plan_handle as ce84, qs.creation_time as c87f, qs.last_execution_time as c2f9, qs.execution_count as c521, qs.total_worker_time as cb4f, qs.last_worker_time as c3a8, qs.min_worker_time as cc50, qs.max_worker_time as caa0, qs.total_physical_reads as cfbf, qs.last_physical_reads as c2f7, qs.min_physical_reads as c9ff, qs.max_physical_reads as c6f9, qs.total_logical_writes as cb96, qs.last_logical_writes as c5f3, qs.min_logical_writes as c5bf, qs.max_logical_writes as c878, qs.total_logical_reads as cf41, qs.last_logical_reads as c9cf, qs.min_logical_reads as ce3c, qs.max_logical_reads as c55d, qs.total_clr_time as ccd1, qs.last_clr_time as c922, qs.min_clr_time as cb90, qs.max_clr_time as c22f, qs.total_elapsed_time as cc5d, qs.last_elapsed_time as c750, qs.min_elapsed_time as cac9, qs.max_elapsed_time as c8ce, qs.query_hash as cad9, qs.query_plan_hash as c2cb, qs.total_rows as cfc3, qs.last_rows as c20a, qs.min_rows as c5ae, qs.max_rows as c269, qs.statement_sql_handle as c0c4, qs.statement_context_id as c69a from sys.dm_exec_query_stats qs where qs.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct qmg.c153 from #525 qmg) or qs.plan_handle in (select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg) end else if exists (select c35f from #2ff where c35f in ('c99_cursors_info')) begin if not exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) insert into #d1b select qs.sql_handle as c153, qs.statement_start_offset as c294, qs.statement_end_offset as c82a, qs.plan_generation_num as c99e, qs.plan_handle as ce84, qs.creation_time as c87f, qs.last_execution_time as c2f9, qs.execution_count as c521, qs.total_worker_time as cb4f, qs.last_worker_time as c3a8, qs.min_worker_time as cc50, qs.max_worker_time as caa0, qs.total_physical_reads as cfbf, qs.last_physical_reads as c2f7, qs.min_physical_reads as c9ff, qs.max_physical_reads as c6f9, qs.total_logical_writes as cb96, qs.last_logical_writes as c5f3, qs.min_logical_writes as c5bf, qs.max_logical_writes as c878, qs.total_logical_reads as cf41, qs.last_logical_reads as c9cf, qs.min_logical_reads as ce3c, qs.max_logical_reads as c55d, qs.total_clr_time as ccd1, qs.last_clr_time as c922, qs.min_clr_time as cb90, qs.max_clr_time as c22f, qs.total_elapsed_time as cc5d, qs.last_elapsed_time as c750, qs.min_elapsed_time as cac9, qs.max_elapsed_time as c8ce, qs.query_hash as cad9, qs.query_plan_hash as c2cb, qs.total_rows as cfc3, qs.last_rows as c20a, qs.min_rows as c5ae, qs.max_rows as c269, qs.statement_sql_handle as c0c4, qs.statement_context_id as c69a from sys.dm_exec_query_stats qs where qs.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct c.c153 from #4dc c) or qs.plan_handle in (select distinct r.plan_handle from #091 r) end else insert into #d1b select qs.sql_handle as c153, qs.statement_start_offset as c294, qs.statement_end_offset as c82a, qs.plan_generation_num as c99e, qs.plan_handle as ce84, qs.creation_time as c87f, qs.last_execution_time as c2f9, qs.execution_count as c521, qs.total_worker_time as cb4f, qs.last_worker_time as c3a8, qs.min_worker_time as cc50, qs.max_worker_time as caa0, qs.total_physical_reads as cfbf, qs.last_physical_reads as c2f7, qs.min_physical_reads as c9ff, qs.max_physical_reads as c6f9, qs.total_logical_writes as cb96, qs.last_logical_writes as c5f3, qs.min_logical_writes as c5bf, qs.max_logical_writes as c878, qs.total_logical_reads as cf41, qs.last_logical_reads as c9cf, qs.min_logical_reads as ce3c, qs.max_logical_reads as c55d, qs.total_clr_time as ccd1, qs.last_clr_time as c922, qs.min_clr_time as cb90, qs.max_clr_time as c22f, qs.total_elapsed_time as cc5d, qs.last_elapsed_time as c750, qs.min_elapsed_time as cac9, qs.max_elapsed_time as c8ce, qs.query_hash as cad9, qs.query_plan_hash as c2cb, qs.total_rows as cfc3, qs.last_rows as c20a, qs.min_rows as c5ae, qs.max_rows as c269, qs.statement_sql_handle as c0c4, qs.statement_context_id as c69a from sys.dm_exec_query_stats qs where qs.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c) or qs.plan_handle in (select distinct r.plan_handle from #091 r) end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_query_stats ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('cb2_procedure_stats_info', 'c7a_procedure_stats_info')) begin if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) begin if exists (select c35f from #2ff where c35f in ('c99_cursors_info')) insert into #066 select ps.database_id as cd24, ps.object_id as c20d, ps.type as c55f, ps.type_desc as c20b, ps.sql_handle as c153, ps.plan_handle as ce84, ps.cached_time as c418, ps.last_execution_time as c2f9, ps.execution_count as c521, ps.total_worker_time as cb4f, ps.last_worker_time as c3a8, ps.min_worker_time as cc50, ps.max_worker_time as caa0, ps.total_physical_reads as cfbf, ps.last_physical_reads as c2f7, ps.min_physical_reads as c9ff, ps.max_physical_reads as c6f9, ps.total_logical_writes as cb96, ps.last_logical_writes as c5f3, ps.min_logical_writes as c5bf, ps.max_logical_writes as c878, ps.total_logical_reads as cf41, ps.last_logical_reads as c9cf, ps.min_logical_reads as ce3c, ps.max_logical_reads as c55d, ps.total_elapsed_time as cc5d, ps.last_elapsed_time as c750, ps.min_elapsed_time as cac9, ps.max_elapsed_time as c8ce from sys.dm_exec_procedure_stats ps where ps.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct qmg.c153 from #525 qmg union select distinct c.c153 from #4dc c) or ps.plan_handle in (select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg) else insert into #066 select ps.database_id as cd24, ps.object_id as c20d, ps.type as c55f, ps.type_desc as c20b, ps.sql_handle as c153, ps.plan_handle as ce84, ps.cached_time as c418, ps.last_execution_time as c2f9, ps.execution_count as c521, ps.total_worker_time as cb4f, ps.last_worker_time as c3a8, ps.min_worker_time as cc50, ps.max_worker_time as caa0, ps.total_physical_reads as cfbf, ps.last_physical_reads as c2f7, ps.min_physical_reads as c9ff, ps.max_physical_reads as c6f9, ps.total_logical_writes as cb96, ps.last_logical_writes as c5f3, ps.min_logical_writes as c5bf, ps.max_logical_writes as c878, ps.total_logical_reads as cf41, ps.last_logical_reads as c9cf, ps.min_logical_reads as ce3c, ps.max_logical_reads as c55d, ps.total_elapsed_time as cc5d, ps.last_elapsed_time as c750, ps.min_elapsed_time as cac9, ps.max_elapsed_time as c8ce from sys.dm_exec_procedure_stats ps where ps.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct qmg.c153 from #525 qmg) or ps.plan_handle in (select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg) end else if exists (select c35f from #2ff where c35f in ('c99_cursors_info')) begin if not exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) insert into #066 select ps.database_id as cd24, ps.object_id as c20d, ps.type as c55f, ps.type_desc as c20b, ps.sql_handle as c153, ps.plan_handle as ce84, ps.cached_time as c418, ps.last_execution_time as c2f9, ps.execution_count as c521, ps.total_worker_time as cb4f, ps.last_worker_time as c3a8, ps.min_worker_time as cc50, ps.max_worker_time as caa0, ps.total_physical_reads as cfbf, ps.last_physical_reads as c2f7, ps.min_physical_reads as c9ff, ps.max_physical_reads as c6f9, ps.total_logical_writes as cb96, ps.last_logical_writes as c5f3, ps.min_logical_writes as c5bf, ps.max_logical_writes as c878, ps.total_logical_reads as cf41, ps.last_logical_reads as c9cf, ps.min_logical_reads as ce3c, ps.max_logical_reads as c55d, ps.total_elapsed_time as cc5d, ps.last_elapsed_time as c750, ps.min_elapsed_time as cac9, ps.max_elapsed_time as c8ce from sys.dm_exec_procedure_stats ps where ps.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct c.c153 from #4dc c) or ps.plan_handle in (select distinct r.plan_handle from #091 r) end else insert into #066 select ps.database_id as cd24, ps.object_id as c20d, ps.type as c55f, ps.type_desc as c20b, ps.sql_handle as c153, ps.plan_handle as ce84, ps.cached_time as c418, ps.last_execution_time as c2f9, ps.execution_count as c521, ps.total_worker_time as cb4f, ps.last_worker_time as c3a8, ps.min_worker_time as cc50, ps.max_worker_time as caa0, ps.total_physical_reads as cfbf, ps.last_physical_reads as c2f7, ps.min_physical_reads as c9ff, ps.max_physical_reads as c6f9, ps.total_logical_writes as cb96, ps.last_logical_writes as c5f3, ps.min_logical_writes as c5bf, ps.max_logical_writes as c878, ps.total_logical_reads as cf41, ps.last_logical_reads as c9cf, ps.min_logical_reads as ce3c, ps.max_logical_reads as c55d, ps.total_elapsed_time as cc5d, ps.last_elapsed_time as c750, ps.min_elapsed_time as cac9, ps.max_elapsed_time as c8ce from sys.dm_exec_procedure_stats ps where ps.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c) or ps.plan_handle in (select distinct r.plan_handle from #091 r) end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_procedure_stats ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('cb2_trigger_stats_info', 'c7a_trigger_stats_info')) begin if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) begin if exists (select c35f from #2ff where c35f in ('c99_cursors_info')) insert into #cd9 select ts.database_id as cd24, ts.object_id as c20d, ts.type as c55f, ts.type_desc as c20b, ts.sql_handle as c153, ts.plan_handle as ce84, ts.cached_time as c418, ts.last_execution_time as c2f9, ts.execution_count as c521, ts.total_worker_time as cb4f, ts.last_worker_time as c3a8, ts.min_worker_time as cc50, ts.max_worker_time as caa0, ts.total_physical_reads as cfbf, ts.last_physical_reads as c2f7, ts.min_physical_reads as c9ff, ts.max_physical_reads as c6f9, ts.total_logical_writes as cb96, ts.last_logical_writes as c5f3, ts.min_logical_writes as c5bf, ts.max_logical_writes as c878, ts.total_logical_reads as cf41, ts.last_logical_reads as c9cf, ts.min_logical_reads as ce3c, ts.max_logical_reads as c55d, ts.total_elapsed_time as cc5d, ts.last_elapsed_time as c750, ts.min_elapsed_time as cac9, ts.max_elapsed_time as c8ce from sys.dm_exec_trigger_stats ts where ts.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct qmg.c153 from #525 qmg union select distinct c.c153 from #4dc c) or ts.plan_handle in (select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg) else insert into #cd9 select ts.database_id as cd24, ts.object_id as c20d, ts.type as c55f, ts.type_desc as c20b, ts.sql_handle as c153, ts.plan_handle as ce84, ts.cached_time as c418, ts.last_execution_time as c2f9, ts.execution_count as c521, ts.total_worker_time as cb4f, ts.last_worker_time as c3a8, ts.min_worker_time as cc50, ts.max_worker_time as caa0, ts.total_physical_reads as cfbf, ts.last_physical_reads as c2f7, ts.min_physical_reads as c9ff, ts.max_physical_reads as c6f9, ts.total_logical_writes as cb96, ts.last_logical_writes as c5f3, ts.min_logical_writes as c5bf, ts.max_logical_writes as c878, ts.total_logical_reads as cf41, ts.last_logical_reads as c9cf, ts.min_logical_reads as ce3c, ts.max_logical_reads as c55d, ts.total_elapsed_time as cc5d, ts.last_elapsed_time as c750, ts.min_elapsed_time as cac9, ts.max_elapsed_time as c8ce from sys.dm_exec_trigger_stats ts where ts.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct qmg.c153 from #525 qmg) or ts.plan_handle in (select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg) end else if exists (select c35f from #2ff where c35f in ('c99_cursors_info')) begin if not exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) insert into #cd9 select ts.database_id as cd24, ts.object_id as c20d, ts.type as c55f, ts.type_desc as c20b, ts.sql_handle as c153, ts.plan_handle as ce84, ts.cached_time as c418, ts.last_execution_time as c2f9, ts.execution_count as c521, ts.total_worker_time as cb4f, ts.last_worker_time as c3a8, ts.min_worker_time as cc50, ts.max_worker_time as caa0, ts.total_physical_reads as cfbf, ts.last_physical_reads as c2f7, ts.min_physical_reads as c9ff, ts.max_physical_reads as c6f9, ts.total_logical_writes as cb96, ts.last_logical_writes as c5f3, ts.min_logical_writes as c5bf, ts.max_logical_writes as c878, ts.total_logical_reads as cf41, ts.last_logical_reads as c9cf, ts.min_logical_reads as ce3c, ts.max_logical_reads as c55d, ts.total_elapsed_time as cc5d, ts.last_elapsed_time as c750, ts.min_elapsed_time as cac9, ts.max_elapsed_time as c8ce from sys.dm_exec_trigger_stats ts where ts.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c union select distinct c.c153 from #4dc c) or ts.plan_handle in (select distinct r.plan_handle from #091 r) end else insert into #cd9 select ts.database_id as cd24, ts.object_id as c20d, ts.type as c55f, ts.type_desc as c20b, ts.sql_handle as c153, ts.plan_handle as ce84, ts.cached_time as c418, ts.last_execution_time as c2f9, ts.execution_count as c521, ts.total_worker_time as cb4f, ts.last_worker_time as c3a8, ts.min_worker_time as cc50, ts.max_worker_time as caa0, ts.total_physical_reads as cfbf, ts.last_physical_reads as c2f7, ts.min_physical_reads as c9ff, ts.max_physical_reads as c6f9, ts.total_logical_writes as cb96, ts.last_logical_writes as c5f3, ts.min_logical_writes as c5bf, ts.max_logical_writes as c878, ts.total_logical_reads as cf41, ts.last_logical_reads as c9cf, ts.min_logical_reads as ce3c, ts.max_logical_reads as c55d, ts.total_elapsed_time as cc5d, ts.last_elapsed_time as c750, ts.min_elapsed_time as cac9, ts.max_elapsed_time as c8ce from sys.dm_exec_trigger_stats ts where ts.sql_handle in (select distinct r.sql_handle from #091 r union select distinct c.most_recent_sql_handle from #dd0 c) or ts.plan_handle in (select distinct r.plan_handle from #091 r) end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_trigger_stats ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_cached_plans_info')) begin if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) insert into #2d4 select cp.bucketid as c128, cp.refcounts as c8ba, cp.usecounts as c310, cp.size_in_bytes as c45d, cp.memory_object_address as ce96, cp.cacheobjtype as c546, cp.objtype as cb4b, cp.plan_handle as ce84, cp.pool_id as c5e8, cp.parent_plan_handle as ce9e from sys.dm_exec_cached_plans cp where cp.plan_handle in (select distinct r.plan_handle from #091 r union select distinct qmg.ce84 from #525 qmg) else insert into #2d4 select cp.bucketid as c128, cp.refcounts as c8ba, cp.usecounts as c310, cp.size_in_bytes as c45d, cp.memory_object_address as ce96, cp.cacheobjtype as c546, cp.objtype as cb4b, cp.plan_handle as ce84, cp.pool_id as c5e8, cp.parent_plan_handle as ce9e from sys.dm_exec_cached_plans cp where cp.plan_handle in (select distinct r.plan_handle from #091 r) end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_cached_plans ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_session_tempdb_usage_kb', 'c99_session_max_tempdb_usage_kb', 'c99_session_tempdb_usage_info')) insert into #406 select spu.session_id as cd43, spu.database_id as cd24, spu.user_objects_alloc_page_count as c52c, spu.user_objects_dealloc_page_count as cdea, spu.internal_objects_alloc_page_count as c248, spu.internal_objects_dealloc_page_count as c84f, spu.user_objects_deferred_dealloc_page_count as ca58, (select login_time from sys.dm_exec_sessions where session_id = s.session_id) as c4d8 from sys.dm_db_session_space_usage spu inner join #9de s on (spu.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_db_session_space_usage ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_task_tempdb_usage_kb', 'c7a_task_max_tempdb_usage_kb', 'c7a_task_tempdb_usage_info')) insert into #e70 select tsu.task_address as cd18, tsu.is_remote_task as c157, tsu.session_id as cd43, tsu.request_id as c9d7, tsu.exec_context_id as ca87, tsu.database_id as cd24, tsu.user_objects_alloc_page_count as c52c, tsu.user_objects_dealloc_page_count as cdea, tsu.internal_objects_alloc_page_count as c248, tsu.internal_objects_dealloc_page_count as c84f, (select start_time from sys.dm_exec_requests where session_id = r.session_id and request_id = r.request_id) as cc53 from sys.dm_db_task_space_usage tsu inner join #091 r on (tsu.session_id = r.session_id and tsu.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_db_task_space_usage ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_cursor_count', 'c99_max_cursor_dormant_duration', 'c99_cursors_info')) insert into #4dc select c.session_id as cd43, c.cursor_id as cad9, c.name as c60f, c.properties as cee1, c.sql_handle as c153, c.statement_start_offset as c294, c.statement_end_offset as c82a, c.plan_generation_num as c99e, c.creation_time as c87f, c.is_open as cae1, c.is_async_population as c34b, c.is_close_on_commit as c246, c.fetch_status as cceb, c.fetch_buffer_size as c66b, c.fetch_buffer_start as cf49, c.ansi_position as c879, c.worker_time as c1c7, c.reads as c60b, c.writes as ca14, c.dormant_duration as cee4, c.statement_sql_handle as c0c4, c.statement_context_id as c69a, (select login_time from sys.dm_exec_sessions where session_id = s.session_id) as c4d8 from #9de s cross apply sys.dm_exec_cursors(session_id) c select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_exec_cursors ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_service_broker_info')) insert into #588 select bat.spid as c96f, bat.database_id as cd24, bat.queue_id as cd0c, bat.procedure_name as c891, bat.execute_as as c0b0, (select login_time from sys.dm_exec_sessions where session_id = s.session_id) as c4d8 from sys.dm_broker_activated_tasks bat inner join #9de s on (bat.spid = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_broker_activated_tasks ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_workers_info')) if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) insert into #016 select w.worker_address as c7de, w.status as c2db, w.is_preemptive as c425, w.is_fiber as cd5d, w.is_sick as c9d4, w.is_in_cc_exception as c69f, w.is_fatal_exception as cd1c, w.is_inside_catch as c340, w.is_in_polling_io_completion_routine as c1f6, w.context_switch_count as c5ec, w.pending_io_count as c580, w.pending_io_byte_count as c0d4, w.pending_io_byte_average as cbdb, w.wait_started_ms_ticks as c6dd, w.wait_resumed_ms_ticks as c384, w.task_bound_ms_ticks as c264, w.worker_created_ms_ticks as c502, w.exception_num as cb30, w.exception_severity as c1fc, w.exception_address as cdc6, w.affinity as cfa6, w.state as c7d3, w.start_quantum as c49d, w.end_quantum as c4e5, w.last_wait_type as c600, w.return_code as ce70, w.quantum_used as c369, w.max_quantum as cb0e, w.boost_count as cf85, w.tasks_processed_count as ce19, w.fiber_address as c31f, w.task_address as cd18, w.memory_object_address as ce96, w.thread_address as c50f, w.signal_worker_address as c678, w.scheduler_address as cd62, w.processor_group as c9dd, (select start_time from sys.dm_exec_requests where session_id = r.session_id and request_id = r.request_id) as cc53 from sys.dm_os_workers w inner join #f5c t on (w.task_address = t.cd18) join #091 r on (t.cd43 = r.session_id and t.c9d7 = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_os_workers ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_threads_info')) if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) insert into #d98 select th.thread_address as c50f, th.started_by_sqlservr as cc40, th.os_thread_id as c626, th.status as c2db, th.instruction_address as cef9, th.creation_time as c87f, th.kernel_time as c64e, th.usermode_time as cdd1, th.stack_base_address as c0b2, th.stack_end_address as c3fe, th.stack_bytes_committed as c272, th.stack_bytes_used as c8fe, th.affinity as cfa6, th.priority as c569, th.locale as c2a7, th.token as ca98, th.is_impersonating as ca02, th.is_waiting_on_loader_lock as c952, th.fiber_data as ca8e, th.thread_handle as c59c, th.event_handle as c369, th.scheduler_address as cd62, th.worker_address as c7de, th.fiber_context_address as cdce, th.self_address as c3ce, th.processor_group as c9dd, (select start_time from sys.dm_exec_requests where session_id = r.session_id and request_id = r.request_id) as cc53 from sys.dm_os_threads th inner join #016 w on (th.worker_address = w.c7de) inner join #f5c t on (w.cd18 = t.cd18) inner join #091 r on (t.cd43 = r.session_id and t.c9d7 = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'insert into select ... from sys.dm_os_threads ... took ' + cast(@a09 as nvarchar(256)) + ' ms' if exists (select c35f from #2ff where c35f in ('c99_locks_info', 'c7a_locks_info', 'c99_waiting_tasks_info', 'c7a_wait_resource_info')) begin create table #3fd (cf24 nvarchar(60), c769 int, c1a4 bigint, c20d int, cf80 int, cec5 int, cdff bigint, c84d bigint, c72f nvarchar(256), c483 nvarchar(256), c765 nvarchar(256), c20b nvarchar(60), c99a int, primary key (cf24, c769, c1a4)) if exists (select c35f from #2ff where c35f in ('c99_locks_info', 'c7a_locks_info')) insert into #3fd (cf24, c769, c1a4) select distinct cf24, c769, c1a4 from #e8f where cf24 in ('ALLOCATION_UNIT', 'OBJECT', 'HOBT', 'PAGE', 'KEY', 'RID') if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_info')) begin update #476 set ca43 = (select replace(value, 'dbid=', '') from (select c.value('.', 'nvarchar(max)') as value from (select cast(N'<r>' + replace(c1f6, ' ', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where value like 'dbid=%') from #476 wt where wt.c1f6 like 'databaselock %' or wt.c1f6 like 'objectlock %' or wt.c1f6 like 'pagelock %' or wt.c1f6 like 'keylock %' or wt.c1f6 like 'ridlock %' or wt.c1f6 like 'hobtlock %' update #476 set c285 = (select replace(value, 'objid=', '') from (select c.value('.', 'nvarchar(max)') as value from (select cast(N'<r>' + replace(c1f6, ' ', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where value like 'objid=%') from #476 wt where wt.c1f6 like 'objectlock %' update #476 set c73a = (select replace(value, 'associatedObjectId=', '') from (select c.value('.', 'nvarchar(max)') as value from (select cast(N'<r>' + replace(c1f6, ' ', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where value like 'associatedObjectId=%') from #476 wt where wt.c1f6 like 'pagelock %' or wt.c1f6 like 'keylock %' or wt.c1f6 like 'ridlock %' or wt.c1f6 like 'hobtlock %' insert into #3fd (cf24, c769, c1a4) select distinct 'OBJECT', ca43, c285 from #476 wt where wt.c1f6 like 'objectlock %' and not exists (select cf24 from #3fd rdaeid where rdaeid.cf24 = 'OBJECT' and rdaeid.c769 = wt.ca43 and rdaeid.c1a4 = wt.c285) insert into #3fd (cf24, c769, c1a4) select distinct 'KEY', ca43, c73a from #476 wt where wt.c1f6 like 'keylock %' and not exists (select cf24 from #3fd rdaeid where rdaeid.cf24 = 'KEY' and rdaeid.c769 = wt.ca43 and rdaeid.c1a4 = wt.c73a) insert into #3fd (cf24, c769, c1a4) select distinct 'RID', ca43, c73a from #476 wt where wt.c1f6 like 'ridlock %' and not exists (select cf24 from #3fd rdaeid where rdaeid.cf24 = 'RID' and rdaeid.c769 = wt.ca43 and rdaeid.c1a4 = wt.c73a) insert into #3fd (cf24, c769, c1a4) select distinct 'PAGE', ca43, c73a from #476 wt where wt.c1f6 like 'pagelock %' and not exists (select cf24 from #3fd rdaeid where rdaeid.cf24 = 'PAGE' and rdaeid.c769 = wt.ca43 and rdaeid.c1a4 = wt.c73a) insert into #3fd (cf24, c769, c1a4) select distinct 'HOBT', ca43, c73a from #476 wt where wt.c1f6 like 'hobtlock %' and not exists (select cf24 from #3fd rdaeid where rdaeid.cf24 = 'HOBT' and rdaeid.c769 = wt.ca43 and rdaeid.c1a4 = wt.c73a) end if exists (select c35f from #2ff where c35f in ('c7a_wait_resource_info')) begin insert into #3fd (cf24, c769, c1a4) select distinct 'OBJECT', (select wait_resource_database_id from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) as wait_resource_database_id) as xy), (select wait_resource_object_id from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 3) as wait_resource_object_id) as xy) from #091 r where r.wait_type like 'LCK_%' and r.wait_resource like 'OBJECT%' and not exists (select cf24 from #3fd rdaeid where rdaeid.cf24 = 'OBJECT' and rdaeid.c769 = (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) and rdaeid.c1a4 = (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 3)) insert into #3fd (cf24, c769, c1a4) select distinct 'KEY', (select wait_resource_database_id from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) as wait_resource_database_id) as xy), (select wait_resource_object_id from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(replace(replace(wait_resource, '(', ':'), ')', ':'), ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 3) as wait_resource_object_id) as xy) from #091 r where r.wait_type like 'LCK_%' and r.wait_resource like 'KEY%' and not exists (select cf24 from #3fd rdaeid where rdaeid.cf24 = 'KEY' and rdaeid.c769 = (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) and rdaeid.c1a4 = (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(replace(replace(wait_resource, '(', ':'), ')', ':'), ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 3)) insert into #3fd (cf24, c769, c1a4) select distinct 'HOBT', (select wait_resource_database_id from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) as wait_resource_database_id) as xy), (select wait_resource_object_id from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 3) as wait_resource_object_id) as xy) from #091 r where r.wait_type like 'LCK_%' and r.wait_resource like 'HOBT%' and not exists (select cf24 from #3fd rdaeid where rdaeid.cf24 = 'HOBT' and rdaeid.c769 = (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) and rdaeid.c1a4 = (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 3)) end declare c7a7 cursor for select distinct c769 from #3fd open c7a7 fetch next from c7a7 into @deb while (@@fetch_status = 0) begin set @697 = 'use [' + db_name(@deb) + '] update #3fd set c20d = o.object_id, cf80 = s.schema_id, c72f = o.name, c483 = s.name from #3fd rdaeid inner join sys.objects o with (nolock) on (rdaeid.c1a4 = o.object_id) inner join sys.schemas s with (nolock) on (o.schema_id = s.schema_id) where rdaeid.c769 = db_id() and rdaeid.cf24 in (''OBJECT'')' select @254 = getdate() exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = '''Failed: sp_executesql N''' + @697 + '''''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7a7 deallocate c7a7 return 1 end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'use [' + db_name(@deb) + '] update #3fd set object_id ... (''OBJECT'') ... took ' + cast(@a09 as nvarchar(256)) + ' ms' set @697 = 'use [' + db_name(@deb) + '] update #3fd set c20d = o.object_id, cf80 = s.schema_id, cec5 = i.index_id, cdff = p.partition_id, c72f = o.name, c483 = s.name, c765 = i.name, c20b = i.type_desc, c99a = p.partition_number from #3fd rdaeid inner join sys.partitions p with (nolock) on (rdaeid.c1a4 = p.partition_id) inner join sys.indexes i with (nolock) on (p.object_id = i.object_id and p.index_id = i.index_id) inner join sys.objects o with (nolock) on (i.object_id = o.object_id) inner join sys.schemas s with (nolock) on (o.schema_id = s.schema_id) where rdaeid.c769 = db_id() and rdaeid.cf24 in (''HOBT'', ''PAGE'', ''KEY'', ''RID'')' select @254 = getdate() exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = '''Failed: sp_executesql N''' + @697 + '''''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7a7 deallocate c7a7 return 1 end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'use [' + db_name(@deb) + '] update #3fd object_id ... (''HOBT'', ''PAGE'', ''KEY'', ''RID'') ... took ' + cast(@a09 as nvarchar(256)) + ' ms' set @697 = 'use [' + db_name(@deb) + '] update #3fd set c20d = o.object_id, cf80 = s.schema_id, cec5 = i.index_id, cdff = p.partition_id, c84d = au.allocation_unit_id, c72f = o.name, c483 = s.name, c765 = i.name, c20b = i.type_desc, c99a = p.partition_number from #3fd rdaeid inner join sys.allocation_units au with (nolock) on (rdaeid.c1a4 = au.allocation_unit_id) inner join sys.partitions p with (nolock) on (au.container_id = p.hobt_id) inner join sys.indexes i with (nolock) on (p.object_id = i.object_id and p.index_id = i.index_id) inner join sys.objects o with (nolock) on (i.object_id = o.object_id) inner join sys.schemas s with (nolock) on (o.schema_id = s.schema_id) where rdaeid.c769 = db_id() and rdaeid.cf24 in (''ALLOCATION_UNIT'')' select @254 = getdate() exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = '''Failed: sp_executesql N''' + @697 + '''''' raiserror (@ea1, 17, 1) set @datetime = NULL close c7a7 deallocate c7a7 return 1 end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'use [' + db_name(@deb) + '] update #3fd object_id ... (''ALLOCATION_UNIT'') ... took ' + cast(@a09 as nvarchar(256)) + ' ms' fetch next from c7a7 into @deb end close c7a7 deallocate c7a7 end
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_wait_resource_info')) update #0ed set wait_resource_info = 'HOBT = ' + (select case wait_resource_database_id when 32767 then '[Resource Database]' else db_name(wait_resource_database_id) end + '.' + (select c483 from #3fd rdaeid where rdaeid.cf24 = 'HOBT' and wait_resource_database_id = rdaeid.c769 and wait_resource_object_id = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where rdaeid.cf24 = 'HOBT' and wait_resource_database_id = rdaeid.c769 and wait_resource_object_id = rdaeid.c1a4) from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) as wait_resource_database_id, (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 3) as wait_resource_object_id) as xy) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) where r.wait_type like 'LCK_%' and r.wait_resource like 'HOBT%' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set wait_resource_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('cb2_trigger_stats_info')) update #b39 set trigger_stats_info = (select trigger_stats_info.trigger_stats_info, c521 as executioncount, (cast(case c521 when 1 then NULL else c521 end as float) / case datediff(s, c418, c2f9) when 0 then NULL else datediff(s, c418, c2f9) end) as ExecutionsPerSec, cb4f as TotalCPUTimeMS, (case cb4f when 0 then NULL else cb4f end) / c521 / 1000 as AverageCPUTimeMS, cc5d / 1000 as TotalDurationMS, (case cc5d when 0 then NULL else cc5d end) / c521 / 1000 as AverageDurationMS, cf41 as TotalLogicalReads, (case cf41 when 0 then NULL else cf41 end) / c521 as AverageLogicalReads, cfbf as TotalPhysicalReads, (case cfbf when 0 then NULL else cfbf end) / c521 as AveragePhysicalReads, cb96 as TotalLogicalWrites, (case cb96 when 0 then NULL else cb96 end) / c521 as AverageLogicalWrites, trigger_stats.cd24 as database_id, trigger_stats.c20d as object_id, trigger_stats.c55f as type, trigger_stats.c20b as type_desc, sys.fn_varbintohexstr(trigger_stats.c153) as sql_handle, sys.fn_varbintohexstr(trigger_stats.ce84) as plan_handle, trigger_stats.c418 as cached_time, trigger_stats.c2f9 as last_execution_time, trigger_stats.cb4f as total_worker_time, trigger_stats.c3a8 as last_worker_time, trigger_stats.cc50 as min_worker_time, trigger_stats.caa0 as max_worker_time, trigger_stats.cfbf as total_physical_reads, trigger_stats.c2f7 as last_physical_reads, trigger_stats.c9ff as min_physical_reads, trigger_stats.c6f9 as max_physical_reads, trigger_stats.cb96 as total_logical_writes, trigger_stats.c5f3 as last_logical_writes, trigger_stats.c5bf as min_logical_writes, trigger_stats.c878 as max_logical_writes, trigger_stats.cf41 as total_logical_reads, trigger_stats.c9cf as last_logical_reads, trigger_stats.ce3c as min_logical_reads, trigger_stats.c55d as max_logical_reads, trigger_stats.cc5d as total_elapsed_time, trigger_stats.c750 as last_elapsed_time, trigger_stats.cac9 as min_elapsed_time, trigger_stats.c8ce as max_elapsed_time from (select null as trigger_stats_info) as trigger_stats_info cross join #cd9 trigger_stats where trigger_stats.c153 = c.most_recent_sql_handle for xml auto) from #b39 ci inner join #dd0 c on (ci.session_id = c.session_id and ci.connection_id = c.connection_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_connections set trigger_stats_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_trigger_stats_info')) update #0ed set trigger_stats_info = (select trigger_stats_info.trigger_stats_info, c521 as executioncount, (cast(case c521 when 1 then NULL else c521 end as float) / case datediff(s, c418, c2f9) when 0 then NULL else datediff(s, c418, c2f9) end) as ExecutionsPerSec, cb4f as TotalCPUTimeMS, (case cb4f when 0 then NULL else cb4f end) / c521 / 1000 as AverageCPUTimeMS, cc5d / 1000 as TotalDurationMS, (case cc5d when 0 then NULL else cc5d end) / c521 / 1000 as AverageDurationMS, cf41 as TotalLogicalReads, (case cf41 when 0 then NULL else cf41 end) / c521 as AverageLogicalReads, cfbf as TotalPhysicalReads, (case cfbf when 0 then NULL else cfbf end) / c521 as AveragePhysicalReads, cb96 as TotalLogicalWrites, (case cb96 when 0 then NULL else cb96 end) / c521 as AverageLogicalWrites, trigger_stats.cd24 as database_id, trigger_stats.c20d as object_id, trigger_stats.c55f as type, trigger_stats.c20b as type_desc, sys.fn_varbintohexstr(trigger_stats.c153) as sql_handle, sys.fn_varbintohexstr(trigger_stats.ce84) as plan_handle, trigger_stats.c418 as cached_time, trigger_stats.c2f9 as last_execution_time, trigger_stats.cb4f as total_worker_time, trigger_stats.c3a8 as last_worker_time, trigger_stats.cc50 as min_worker_time, trigger_stats.caa0 as max_worker_time, trigger_stats.cfbf as total_physical_reads, trigger_stats.c2f7 as last_physical_reads, trigger_stats.c9ff as min_physical_reads, trigger_stats.c6f9 as max_physical_reads, trigger_stats.cb96 as total_logical_writes, trigger_stats.c5f3 as last_logical_writes, trigger_stats.c5bf as min_logical_writes, trigger_stats.c878 as max_logical_writes, trigger_stats.cf41 as total_logical_reads, trigger_stats.c9cf as last_logical_reads, trigger_stats.ce3c as min_logical_reads, trigger_stats.c55d as max_logical_reads, trigger_stats.cc5d as total_elapsed_time, trigger_stats.c750 as last_elapsed_time, trigger_stats.cac9 as min_elapsed_time, trigger_stats.c8ce as max_elapsed_time from (select null as trigger_stats_info) as trigger_stats_info cross join #cd9 trigger_stats where trigger_stats.ce84 = r.plan_handle for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set trigger_stats_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_tasks_context_switches')) update #0ed set tasks_context_switches = (select sum(tasks.ce18) as tasks_context_switches from #f5c tasks where tasks.cd43 = ri.session_id and tasks.c9d7 = ri.request_id and tasks.ce18 > 0 and tasks.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set tasks_context_switches ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_job_info')) update #c05 set job_info = (select job_info.job_info, job.name, job_step.step_name, job_step.subsystem, job_step.command, job_step.last_run_duration, job_step.last_run_retries, job_step.last_run_date, job_step.last_run_time, job.job_id, job_step.step_id from (select null as job_info) as job_info cross apply msdb..sysjobs job inner join msdb..sysjobsteps job_step on (job.job_id = job_step.job_id) where job.job_id = (select cast(cast('' as xml).value('xs:hexBinary(sql:column("program_name"))', 'varbinary(max)') as uniqueidentifier) from (select substring(program_name, charindex(' (Job 0x', program_name, 0) + 8, 32) as program_name) as x) and job_step.step_id = substring(program_name, charindex(' : Step ', program_name, 0) + 8, len(program_name) - charindex(' : Step ', program_name, 0) - 8) for xml auto) from #c05 si inner join #9de s on (si.session_id = s.session_id) where s.program_name like '% (Job 0x%' and s.program_name like '% : Step %' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set job_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_wait_resource_info')) update #0ed set wait_resource_info = 'DATABASE = ' + (select case wait_resource_database_id when 32767 then '[Resource Database]' else db_name(wait_resource_database_id) end from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) as wait_resource_database_id) as xy) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) where r.wait_type like 'LCK_%' and r.wait_resource like 'DATABASE%' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set wait_resource_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_transaction_log_record_count')) update #c05 set transaction_log_record_count = (select sum(tdt.ce7e) as transaction_log_record_count from #f3c tst inner join #088 tat on (tst.cc02 = tat.cc02) inner join #318 tdt on (tst.cc02 = tdt.cc02) where tst.cd43 = si.session_id group by tst.cd43, tst.cc02, tat.c6bb) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set transaction_log_record_count ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_tasks_ios_per_second')) update #0ed set tasks_ios_per_second = (select case sum(tasks.c580) when 0 then NULL else case when datediff(second, r.start_time, max(tasks.ctime)) > 0 then sum(tasks.c580) / datediff(second, r.start_time, max(tasks.ctime)) else NULL end end as tasks_ios_per_second from #f5c tasks where tasks.cd43 = ri.session_id and tasks.c9d7 = ri.request_id and tasks.c580 > 0 and tasks.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set tasks_ios_per_second ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_read_bytes_per_second')) update #0ed set read_bytes_per_second = (select case r.reads when 0 then NULL else case when datediff(second, r.start_time, r.ctime) > 0 then r.reads / datediff(second, r.start_time, r.ctime) else NULL end end as read_bytes_per_second) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set read_bytes_per_second ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_used_memory_kb')) update #0ed set query_memory_grants_used_memory_kb = (select query_memory_grants.c5be as query_memory_grants_used_memory_kb from #525 query_memory_grants where query_memory_grants.cd43 = ri.session_id and query_memory_grants.c9d7 = ri.request_id and query_memory_grants.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_memory_grants_used_memory_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('cb2_procedure_stats_info')) update #b39 set procedure_stats_info = (select procedure_stats_info.procedure_stats_info, c521 as executioncount, (cast(case c521 when 1 then NULL else c521 end as float) / case datediff(s, c418, c2f9) when 0 then NULL else datediff(s, c418,c2f9 ) end) as ExecutionsPerSec, cb4f as TotalCPUTimeMS, (case cb4f when 0 then NULL else cb4f end) / c521 / 1000 as AverageCPUTimeMS, cc5d / 1000 as TotalDurationMS, (case cc5d when 0 then NULL else cc5d end) / c521 / 1000 as AverageDurationMS, cf41 as TotalLogicalReads, (case cf41 when 0 then NULL else cf41 end) / c521 as AverageLogicalReads, cfbf as TotalPhysicalReads, (case cfbf when 0 then NULL else cfbf end) / c521 as AveragePhysicalReads, cb96 as TotalLogicalWrites, (case cb96 when 0 then NULL else cb96 end) / c521 as AverageLogicalWrites, procedure_stats.cd24 as database_id, procedure_stats.c20d as object_id, procedure_stats.c55f as type, procedure_stats.c20b as type_desc, sys.fn_varbintohexstr(procedure_stats.c153) as sql_handle, sys.fn_varbintohexstr(procedure_stats.ce84) as plan_handle, procedure_stats.c418 as cached_time, procedure_stats.c2f9 as last_execution_time, procedure_stats.cb4f as total_worker_time, procedure_stats.c3a8 as last_worker_time, procedure_stats.cc50 as min_worker_time, procedure_stats.caa0 as max_worker_time, procedure_stats.cfbf as total_physical_reads, procedure_stats.c2f7 as last_physical_reads, procedure_stats.c9ff as min_physical_reads, procedure_stats.c6f9 as max_physical_reads, procedure_stats.cb96 as total_logical_writes, procedure_stats.c5f3 as last_logical_writes, procedure_stats.c5bf as min_logical_writes, procedure_stats.c878 as max_logical_writes, procedure_stats.cf41 as total_logical_reads, procedure_stats.c9cf as last_logical_reads, procedure_stats.ce3c as min_logical_reads, procedure_stats.c55d as max_logical_reads, procedure_stats.cc5d as total_elapsed_time, procedure_stats.c750 as last_elapsed_time, procedure_stats.cac9 as min_elapsed_time, procedure_stats.c8ce as max_elapsed_time from (select null as procedure_stats_info) as procedure_stats_info cross join #066 procedure_stats where procedure_stats.c153 = c.most_recent_sql_handle for xml auto) from #b39 ci inner join #dd0 c on (ci.session_id = c.session_id and ci.connection_id = c.connection_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_connections set procedure_stats_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_procedure_stats_info')) update #0ed set procedure_stats_info = (select procedure_stats_info.procedure_stats_info, c521 as executioncount, (cast(case c521 when 1 then NULL else c521 end as float) / case datediff(s, c418, c2f9) when 0 then NULL else datediff(s, c418, c2f9) end) as ExecutionsPerSec, cb4f as TotalCPUTimeMS, (case cb4f when 0 then NULL else cb4f end) / c521 / 1000 as AverageCPUTimeMS, cc5d / 1000 as TotalDurationMS, (case cc5d when 0 then NULL else cc5d end) / c521 / 1000 as AverageDurationMS, cf41 as TotalLogicalReads, (case cf41 when 0 then NULL else cf41 end) / c521 as AverageLogicalReads, cfbf as TotalPhysicalReads, (case cfbf when 0 then NULL else cfbf end) / c521 as AveragePhysicalReads, cb96 as TotalLogicalWrites, (case cb96 when 0 then NULL else cb96 end) / c521 as AverageLogicalWrites, procedure_stats.cd24 as database_id, procedure_stats.c20d as object_id, procedure_stats.c55f as type, procedure_stats.c20b as type_desc, sys.fn_varbintohexstr(procedure_stats.c153) as sql_handle, sys.fn_varbintohexstr(procedure_stats.ce84) as plan_handle, procedure_stats.c418 as cached_time, procedure_stats.c2f9 as last_execution_time, procedure_stats.cb4f as total_worker_time, procedure_stats.c3a8 as last_worker_time, procedure_stats.cc50 as min_worker_time, procedure_stats.caa0 as max_worker_time, procedure_stats.cfbf as total_physical_reads, procedure_stats.c2f7 as last_physical_reads, procedure_stats.c9ff as min_physical_reads, procedure_stats.c6f9 as max_physical_reads, procedure_stats.cb96 as total_logical_writes, procedure_stats.c5f3 as last_logical_writes, procedure_stats.c5bf as min_logical_writes, procedure_stats.c878 as max_logical_writes, procedure_stats.cf41 as total_logical_reads, procedure_stats.c9cf as last_logical_reads, procedure_stats.ce3c as min_logical_reads, procedure_stats.c55d as max_logical_reads, procedure_stats.cc5d as total_elapsed_time, procedure_stats.c750 as last_elapsed_time, procedure_stats.cac9 as min_elapsed_time, procedure_stats.c8ce as max_elapsed_time from (select null as procedure_stats_info) as procedure_stats_info cross join #066 procedure_stats where procedure_stats.ce84 = r.plan_handle for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set procedure_stats_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_tasks_info')) update #0ed set tasks_info = (select tasks_info.tasks_info, tasks.c005 as task_state, tasks.ce18 as context_switches_count, tasks.c580 as pending_io_count, tasks.c0d4 as pending_io_byte_count, tasks.cbdb as pending_io_byte_average, tasks.c461 as scheduler_id, tasks.cd43 as session_id, tasks.ca87 as exec_context_id, tasks.c9d7 as request_id, cc53 as request_start_time, ctime from (select null as tasks_info) as tasks_info cross join #f5c tasks where tasks.cd43 = ri.session_id and tasks.c9d7 = ri.request_id and tasks.cc53 = r.start_time order by tasks.c9d7, tasks.ca87 for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set tasks ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_task_max_tempdb_usage_kb')) update #0ed set task_max_tempdb_usage_kb = (select sum(task_space_usage.c52c + task_space_usage.c248) * 8 as task_tempdb_usage from #e70 task_space_usage where task_space_usage.cd43 = ri.session_id and task_space_usage.c9d7 = ri.request_id and (task_space_usage.c52c + task_space_usage.c248) > 0 and task_space_usage.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set task_max_tempdb_usage_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_session_max_tempdb_usage_kb')) update #c05 set session_max_tempdb_usage_kb = (select (session_space_usage.c52c + session_space_usage.c248) * 8 as session_tempdb_usage from #406 session_space_usage where session_space_usage.cd43 = si.session_id and ((session_space_usage.c52c + session_space_usage.c248) > 0) and session_space_usage.c4d8 = s.login_time) from #c05 si inner join #9de s on (si.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set session_max_tempdb_usage_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_max_used_memory_kb')) update #0ed set query_memory_grants_max_used_memory_kb = (select query_memory_grants.c54c as query_memory_grants_max_used_memory_kb from #525 query_memory_grants where query_memory_grants.cd43 = ri.session_id and query_memory_grants.c9d7 = ri.request_id and query_memory_grants.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_memory_grants_max_used_memory_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_tasks_count')) update #0ed set tasks_count = (select case count(tasks.ca87) when NULL then NULL else count(tasks.ca87) end as tasks_count from #f5c tasks where tasks.cd43 = ri.session_id and tasks.c9d7 = ri.request_id and tasks.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set tasks_count ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_profiles_read_ahead_count')) update #0ed set query_profiles_read_ahead_count = (select sum(query_profiles.c2e7) as query_profiles_read_ahead_count from #aa7 query_profiles where query_profiles.cd43 = ri.session_id and query_profiles.c9d7 = ri.request_id and query_profiles.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_profiles_read_ahead_count ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_blocking_session_ids')) update #c05 set waiting_tasks_blocking_session_ids = (select cast(waiting_tasks.c114 as nvarchar(256)) + case when count(*) > 1 then '(' + cast(count(*) as nvarchar(256)) + ')' else '' end + case row_number() over (order by count(*) desc) when count(*) over () then '' else ', ' end from #476 waiting_tasks where waiting_tasks.cd43 = si.session_id and waiting_tasks.c114 is not NULL group by waiting_tasks.c114 order by count(*) desc for xml path('')) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set waiting_tasks_blocking_session_ids ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_valid_flag')) if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) update #c05 set waiting_tasks_valid_flag = (select case when max(waiting_tasks.c4d8) is NULL then NULL when max(waiting_tasks.c4d8) = s.login_time then 1 else 0 end from #476 waiting_tasks where waiting_tasks.cd43 = si.session_id) from #c05 si inner join #9de s on (si.session_id = s.session_id) else update #c05 set waiting_tasks_valid_flag = (select case when max(waiting_tasks.c4d8) is NULL then NULL when max(waiting_tasks.c4d8) = s.login_time then 1 else 0 end from #476 waiting_tasks where waiting_tasks.cd43 = si.session_id) from #c05 si inner join #9de s on (si.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set waiting_tasks_valid_flag ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_granted_memory_kb')) update #0ed set query_memory_grants_granted_memory_kb = (select query_memory_grants.c28c as query_memory_grants_granted_memory_kb from #525 query_memory_grants where query_memory_grants.cd43 = ri.session_id and query_memory_grants.c9d7 = ri.request_id and query_memory_grants.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_memory_grants_granted_memory_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_task_tempdb_usage_info')) update #0ed set task_tempdb_usage_info = (select task_tempdb_usage_info.task_tempdb_usage_info, task_space_usage.cd43 as session_id, task_space_usage.c9d7 as request_id, task_space_usage.ca87 as exec_context_id, task_space_usage.cd24 as database_id, task_space_usage.c52c as user_objects_alloc_page_count, task_space_usage.cdea as user_objects_dealloc_page_count, task_space_usage.c248 as internal_objects_alloc_page_count, task_space_usage.c84f as internal_objects_dealloc_page_count, cc53 as request_start_time from (select null as task_tempdb_usage_info) as task_tempdb_usage_info cross join #e70 task_space_usage where task_space_usage.cd43 = ri.session_id and task_space_usage.c9d7 = ri.request_id and task_space_usage.cc53 = r.start_time order by task_space_usage.cd43, task_space_usage.c9d7, task_space_usage.ca87 for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set task_tempdb_usage_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_wait_resource_info')) update #0ed set wait_resource_info = 'OBJECT = ' + (select case wait_resource_database_id when 32767 then '[Resource Database]' else db_name(wait_resource_database_id) end + '.' + (select c483 from #3fd rdaeid where rdaeid.cf24 = 'OBJECT' and wait_resource_database_id = rdaeid.c769 and wait_resource_object_id = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where rdaeid.cf24 = 'OBJECT' and wait_resource_database_id = rdaeid.c769 and wait_resource_object_id = rdaeid.c1a4) from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) as wait_resource_database_id, (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(wait_resource, ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 3) as wait_resource_object_id) as xy) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) where r.wait_type like 'LCK_%' and r.wait_resource like 'OBJECT%' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set wait_resource_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_tasks_pending_io')) update #0ed set tasks_pending_io = (select sum(tasks.c580) as tasks_pending_io from #f5c tasks where tasks.cd43 = ri.session_id and tasks.c9d7 = ri.request_id and tasks.c580 > 0 and tasks.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set tasks_pending_io ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_max_cursor_dormant_duration')) update #c05 set max_cursor_dormant_duration = (select max(cursors.cee4) as dormant_duration from #4dc cursors where cursors.cd43 = si.session_id and cursors.c4d8 = s.login_time) from #c05 si inner join #9de s on (si.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set max_cursor_dormant_duration ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_profiles_logical_read_count')) update #0ed set query_profiles_logical_read_count = (select sum(query_profiles.c031) as query_profiles_logical_read_count from #aa7 query_profiles where query_profiles.cd43 = ri.session_id and query_profiles.c9d7 = ri.request_id and query_profiles.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_profiles_logical_read_count ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_workers_info')) if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) update #0ed set workers_info = (select workers_info.workers_info, workers.c2db as status, workers.c425 as is_preemptive, workers.cd5d as is_fiber, workers.c9d4 as is_sick, workers.c69f as is_in_cc_exception, workers.cd1c as is_fatal_exception, workers.c340 as is_inside_catch, workers.c1f6 as is_in_polling_io_completion_routine, workers.c5ec as context_switch_count, workers.c580 as pending_io_count, workers.c0d4 as pending_io_byte_count, workers.cbdb as pending_io_byte_average, workers.c6dd as wait_started_ms_ticks, workers.c384 as wait_resumed_ms_ticks, workers.c264 as task_bound_ms_ticks, workers.c502 as worker_created_ms_ticks, workers.cb30 as exception_num, workers.c1fc as exception_severity, workers.cfa6 as affinity, workers.c7d3 as state, workers.c49d as start_quantum, workers.c4e5 as end_quantum, workers.c600 as last_wait_type, workers.ce70 as return_code, workers.c369 as quantum_used, workers.cb0e as max_quantum, workers.cf85 as boost_count, workers.ce19 as tasks_processed_count, workers.c9dd as processor_group, cc53 as request_start_time from (select null as workers_info) as workers_info cross join #016 workers where workers.cd18 = t.cd18 and workers.cc53 = t.cc53 for xml auto) from #0ed ri inner join #f5c t on (ri.session_id = t.cd43 and ri.request_id = t.c9d7) inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) where t.cc53 = r.start_time select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set workers ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_profiles_info')) update #0ed set query_profiles_info = (select query_profiles_info.query_profiles_info, query_profiles.cd43 as session_id, query_profiles.c9d7 as request_id, sys.fn_varbintohexstr(query_profiles.c153) as sql_handle, sys.fn_varbintohexstr(query_profiles.ce84) as plan_handle, query_profiles.c3a4 as physical_operator_name, query_profiles.ca4e as node_id, query_profiles.c439 as thread_id, sys.fn_varbintohexstr(query_profiles.cd18) as task_address, query_profiles.cb1a as row_count, query_profiles.cc3b as rewind_count, query_profiles.cf45 as rebind_count, query_profiles.ca0d as end_of_scan_count, query_profiles.c8bf as estimate_row_count, query_profiles.c58b as first_active_time, query_profiles.c9be as last_active_time, query_profiles.cd00 as open_time, query_profiles.c109 as first_row_time, query_profiles.c1cc as last_row_time, query_profiles.c91b as close_time, query_profiles.c2c9 as elapsed_time_ms, query_profiles.ce90 as cpu_time_ms, query_profiles.cd24 as database_id, query_profiles.c20d as object_id, query_profiles.cec5 as index_id, query_profiles.c816 as scan_count, query_profiles.c031 as logical_read_count, query_profiles.c63b as physical_read_count, query_profiles.c2e7 as read_ahead_count, query_profiles.c452 as write_page_count, query_profiles.c8c0 as lob_logical_read_count, query_profiles.c7b9 as lob_physical_read_count, query_profiles.cbf1 as lob_read_ahead_count, query_profiles.c906 as segment_read_count, query_profiles.c298 as segment_skip_count, cc53 as request_start_time from (select null as query_profiles_info) as query_profiles_info cross join #aa7 query_profiles where query_profiles.cd43 = ri.session_id and query_profiles.c9d7 = ri.request_id and query_profiles.cc53 = r.start_time for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_profiles_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_info')) update #476 set c297 = (select case when page_id = 0 then NULL when page_id = 1 or page_id % 8080 = 0 then 'PFS' when page_id = 2 or page_id % 511232 = 0 then 'GAM' when page_id = 3 or page_id % 511233 = 0 then 'SGAM' end from (select substring(c1f6, len(c1f6) - charindex(':', reverse(c1f6)) + 2, charindex(':', reverse(c1f6))) as page_id) as rd) from #476 wt where wt.c896 like 'PAGELATCH_%' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_os_waiting_tasks set resource_description_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_threads_info')) if exists (select c35f from #2ff where c35f in ('c7a_tasks_count', 'c7a_tasks_context_switches', 'c7a_tasks_pending_io', 'c7a_tasks_io_size_kb', 'c7a_tasks_ios_per_second', 'c7a_tasks_info')) update #0ed set threads_info = (select threads_info.threads_info, threads.cc40 as started_by_sqlservr, threads.c626 as os_thread_id, threads.c2db as status, threads.c87f as creation_time, threads.c64e as kernel_time, threads.cdd1 as usermode_time, threads.c272 as stack_bytes_committed, threads.c8fe as stack_bytes_used, threads.cfa6 as affinity, threads.c569 as priority, threads.c2a7 as locale, threads.ca02 as is_impersonating, threads.c952 as is_waiting_on_loader_lock, threads.c9dd as processor_group, cc53 as request_start_time from (select null as threads_info) as threads_info cross join #d98 threads where threads.c7de = t.c7de and threads.cc53 = t.cc53 for xml auto) from #0ed ri inner join #f5c t on (ri.session_id = t.cd43 and ri.request_id = t.c9d7) inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) where t.cc53 = r.start_time select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set threads ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_input_buffer_checksum')) update #0ed set input_buffer_checksum = (select cd88 from #c4f ib where ib.cd43 = ri.session_id and ib.c9d7 = ri.request_id) from #0ed ri select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set input_buffer ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_input_buffer_checksum')) update #c05 set input_buffer_checksum = (select cd88 from #c4f ib where ib.cd43 = si.session_id and ib.c9d7 is NULL) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set input_buffer ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_input_buffer_valid_flag')) update #0ed set input_buffer_valid_flag = (select case ib.cc53 when r.start_time then 1 else 0 end from #c4f ib where ib.cd43 = ri.session_id and ib.c9d7 = ri.request_id and ib.cd88 is not NULL) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set input_buffer_valid_flag ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_input_buffer_valid_flag')) update #c05 set input_buffer_valid_flag = (select case ib.ca6d when s.last_request_start_time then 1 else 0 end from #c4f ib where ib.cd43 = si.session_id and ib.cd88 is not NULL) from #c05 si inner join #9de s on (si.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set input_buffer_valid_flag ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_info')) update #476 set c297 = 'databaselock = ' + case ca43 when 32767 then '[Resource Database]' else db_name(ca43) end from #476 wt where wt.c1f6 like 'databaselock %' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_os_waiting_tasks set resource_description_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_transaction_log_bytes_used')) update #c05 set transaction_log_bytes_used = (select sum(tdt.c5a7) as transaction_log_bytes_used from #f3c tst inner join #088 tat on (tst.cc02 = tat.cc02) inner join #318 tdt on (tst.cc02 = tdt.cc02) where tst.cd43 = si.session_id group by tst.cd43, tst.cc02, tat.c6bb) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set transaction_log_bytes_used ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_info')) update #0ed set query_memory_grants_info = (select query_memory_grants_info.query_memory_grants_info, query_memory_grants.cd43 as session_id, query_memory_grants.c9d7 as request_id, query_memory_grants.c461 as scheduler_id, query_memory_grants.c59e as dop, query_memory_grants.c3d2 as request_time, query_memory_grants.ccb7 as grant_time, query_memory_grants.c1e1 as requested_memory_kb, query_memory_grants.c28c as granted_memory_kb, query_memory_grants.c4fe as required_memory_kb, query_memory_grants.c5be as used_memory_kb, query_memory_grants.c54c as max_used_memory_kb, query_memory_grants.cc47 as query_cost, query_memory_grants.c388 as timeout_sec, query_memory_grants.cdf3 as resource_semaphore_id, query_memory_grants.cd0c as queue_id, query_memory_grants.cb7b as wait_order, query_memory_grants.cd36 as is_next_candidate, query_memory_grants.c4e0 as wait_time_ms, sys.fn_varbintohexstr(query_memory_grants.ce84) as plan_handle, sys.fn_varbintohexstr(query_memory_grants.c153) as sql_handle, query_memory_grants.c52d as group_id, query_memory_grants.c5e8 as pool_id, query_memory_grants.cb4d as is_small, query_memory_grants.c62f as ideal_memory_kb, cc53 as request_start_time from (select null as query_memory_grants_info) as query_memory_grants_info cross join #525 query_memory_grants where query_memory_grants.cd43 = ri.session_id and query_memory_grants.c9d7 = ri.request_id and query_memory_grants.cc53 = r.start_time for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_memory_grants_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_lock_count')) update #0ed set lock_count = (select sum(tran_locks.c6ef) as lock_count from #e8f tran_locks where tran_locks.c3ec = ri.session_id and tran_locks.c335 = ri.request_id) from #0ed ri select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set lock_count ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_lock_count')) update #c05 set lock_count = (select sum(tran_locks.c6ef) as lock_count from #e8f tran_locks where tran_locks.c3ec = si.session_id) from #c05 si where si.session_id not in (select ri.session_id from #0ed ri) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set lock_count ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_transaction_info')) update #c05 set transaction_info = (select transaction_info.transaction_info, session_transactions.cd43 as session_id, active_transactions.cc02 as transaction_id, active_transactions.c60f as name, active_transactions.c6bb as transaction_begin_time, active_transactions.c710 as transaction_type, database_transactions.cd24 as database_id, database_transactions.ca79 as database_transaction_begin_time, database_transactions.c8b6 as database_transaction_type, database_transactions.c711 as database_transaction_state, database_transactions.ce7e as database_transaction_log_record_count, database_transactions.c5a7 as database_transaction_log_bytes_used from (select null as transaction_info) as transaction_info cross join #f3c session_transactions inner join #088 active_transactions on (session_transactions.cc02 = active_transactions.cc02) inner join #318 database_transactions on (session_transactions.cc02 = database_transactions.cc02) where session_transactions.cd43 = si.session_id order by session_transactions.cd43, session_transactions.cc02, database_transactions.cd24 for xml auto) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set transaction_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_transaction_info')) if exists (select c35f from #2ff where c35f in ('c99_lock_count', 'c7a_lock_count', 'c99_lock_owner_id', 'c7a_lock_owner_id', 'c99_locks_info', 'c7a_locks_info')) update #0ed set transaction_info = (select transaction_info.transaction_info, session_transactions.cd43 as session_id, active_transactions.cc02 as transaction_id, active_transactions.c60f as name, active_transactions.c6bb as transaction_begin_time, active_transactions.c710 as transaction_type, database_transactions.cd24 as database_id, database_transactions.ca79 as database_transaction_begin_time, database_transactions.c8b6 as database_transaction_type, database_transactions.c711 as database_transaction_state, database_transactions.ce7e as database_transaction_log_record_count, database_transactions.c5a7 as database_transaction_log_bytes_used from (select null as transaction_info) as transaction_info cross join #f3c session_transactions right join #088 active_transactions on (session_transactions.cc02 = active_transactions.cc02) inner join #318 database_transactions on (active_transactions.cc02 = database_transactions.cc02) where active_transactions.cc02 = (select max(tl.c78a) from #e8f tl where tl.c3ec = ri.session_id and tl.c335 = ri.request_id) order by active_transactions.cc02, database_transactions.cd24 for xml auto) from #0ed ri select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set transaction_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_wait_time_ms')) update #0ed set query_memory_grants_wait_time_ms = (select query_memory_grants.c4e0 as query_memory_grants_wait_time_ms from #525 query_memory_grants where query_memory_grants.cd43 = ri.session_id and query_memory_grants.c9d7 = ri.request_id and query_memory_grants.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_memory_grants_wait_time_ms ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_transaction_begin_time')) update #c05 set transaction_begin_time = (select tat.c6bb as transaction_begin_time from #f3c tst inner join #088 tat on (tst.cc02 = tat.cc02) where tst.cd43 = si.session_id) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set transaction_begin_time ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_transaction_begin_time')) if exists (select c35f from #2ff where c35f in ('c99_lock_count', 'c7a_lock_count', 'c99_lock_owner_id', 'c7a_lock_owner_id', 'c99_locks_info', 'c7a_locks_info')) update #0ed set transaction_begin_time = (select tat.c6bb as transaction_begin_time from #088 tat where tat.cc02 = (select max(tl.c78a) from #e8f tl where tl.c3ec = ri.session_id and tl.c335 = ri.request_id)) from #0ed ri select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set transaction_begin_time ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_info')) update #476 set c297 = 'keylock = ' + case ca43 when 32767 then '[Resource Database]' else db_name(ca43) end + '.' + (select c483 from #3fd rdaeid where rdaeid.cf24 = 'KEY' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where rdaeid.cf24 = 'KEY' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + ' (index_name = ' + (select isnull(c765, 'NULL') + '(' + c20b + ')' from #3fd rdaeid where rdaeid.cf24 = 'KEY' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + ', partition_number = ' + cast((select c99a from #3fd rdaeid where rdaeid.cf24 = 'KEY' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) as nvarchar(256)) + ')' from #476 wt where wt.c1f6 like 'keylock %' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_os_waiting_tasks set resource_description_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_locks_info')) update #0ed set locks_info = (select locks_info.locks_info, tran_locks.c3ec as session_id, case tran_locks.c769 when 32767 then 'Resource Database' else db_name(tran_locks.c769) end as database_name, tran_locks.cf24 + case when len(tran_locks.c590) > 0 then '(' + tran_locks.c590 + ')' else '' end as type, tran_locks.cd24 as mode, tran_locks.c7e4 as status, cast(sum(tran_locks.c6ef) as nvarchar(256)) as lock_count, case when tran_locks.cf24 in ('FILE', 'EXTENT', 'APPLICATION', 'METADATA') then NULL when tran_locks.cf24 in ('DATABASE') then case tran_locks.c769 when 32767 then '[Resource Database]' else db_name(tran_locks.c769) end when tran_locks.cf24 in ('OBJECT') then case tran_locks.c769 when 32767 then '[Resource Database]' else db_name(tran_locks.c769) end + '.' + (select c483 from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) when tran_locks.cf24 in ('ALLOCATION_UNIT', 'HOBT', 'PAGE', 'KEY', 'RID') then case tran_locks.c769 when 32767 then '[Resource Database]' else db_name(tran_locks.c769) end + '.' + (select c483 from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) + ' (index_name = ' + (select isnull(c765, 'NULL') + '(' + c20b + ')' from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) + ', partition_number = ' + cast((select c99a from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) as nvarchar(256)) + ')' else NULL end as resource_info, tran_locks.c335 as request_id, tran_locks.c78a as owner_id from (select null as locks_info) as locks_info cross join #e8f tran_locks where tran_locks.c3ec = ri.session_id and tran_locks.c335 = ri.request_id group by locks_info.locks_info, tran_locks.c3ec, tran_locks.c335, tran_locks.c78a, tran_locks.c769, tran_locks.c1a4, tran_locks.cf24, tran_locks.c590, tran_locks.cd24, tran_locks.c7e4 order by tran_locks.c3ec, tran_locks.c335, tran_locks.c78a, tran_locks.c769, tran_locks.c1a4, tran_locks.cf24, tran_locks.c590, tran_locks.cd24, tran_locks.c7e4 for xml auto) from #0ed ri select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set locks ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_ideal_memory_kb')) update #0ed set query_memory_grants_ideal_memory_kb = (select query_memory_grants.c62f as query_memory_grants_ideal_memory_kb from #525 query_memory_grants where query_memory_grants.cd43 = ri.session_id and query_memory_grants.c9d7 = ri.request_id and query_memory_grants.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_memory_grants_ideal_memory_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_service_broker_info')) update #c05 set service_broker_info = (select service_broker_info.service_broker_info, service_broker.c96f as spid, service_broker.cd24 as database_id, service_broker.cd0c as queue_id, service_broker.c891 as procedure_name, service_broker.c0b0 as execute_as, c4d8 as login_time from (select null as service_broker_info) as service_broker_info cross join #588 service_broker where service_broker.c96f = si.session_id and service_broker.c4d8 = s.login_time for xml auto) from #c05 si inner join #9de s on (si.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set c99_service_broker_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_lock_owner_id')) update #0ed set lock_owner_id = (select max(tran_locks.c78a) as lock_owner_id from #e8f tran_locks where tran_locks.c3ec = ri.session_id and tran_locks.c335 = ri.request_id) from #0ed ri select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set lock_owner_id ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_lock_owner_id')) update #c05 set lock_owner_id = (select max(tran_locks.c78a) as lock_owner_id from #e8f tran_locks where tran_locks.c3ec = si.session_id) from #c05 si where si.session_id not in (select ri.session_id from #0ed ri) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set lock_owner_id ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_locks_info')) update #c05 set locks_info = (select locks_info.locks_info, tran_locks.c3ec as session_id, case tran_locks.c769 when 32767 then 'Resource Database' else db_name(tran_locks.c769) end as database_name, tran_locks.cf24 + case when len(tran_locks.c590) > 0 then '(' + tran_locks.c590 + ')' else '' end as type, tran_locks.cd24 as mode, tran_locks.c7e4 as status, cast(sum(tran_locks.c6ef) as nvarchar(256)) as lock_count, case when tran_locks.cf24 in ('FILE', 'EXTENT', 'APPLICATION', 'METADATA') then NULL when tran_locks.cf24 in ('DATABASE') then case tran_locks.c769 when 32767 then '[Resource Database]' else db_name(tran_locks.c769) end when tran_locks.cf24 in ('OBJECT') then case tran_locks.c769 when 32767 then '[Resource Database]' else db_name(tran_locks.c769) end + '.' + (select c483 from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) when tran_locks.cf24 in ('ALLOCATION_UNIT', 'HOBT', 'PAGE', 'KEY', 'RID') then case tran_locks.c769 when 32767 then '[Resource Database]' else db_name(tran_locks.c769) end + '.' + (select c483 from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) + ' (index_name = ' + (select isnull(c765, 'NULL') + '(' + c20b + ')' from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) + ', partition_number = ' + cast((select c99a from #3fd rdaeid where tran_locks.cf24 = rdaeid.cf24 and tran_locks.c769 = rdaeid.c769 and tran_locks.c1a4 = rdaeid.c1a4) as nvarchar(256)) + ')' else NULL end as resource_info, tran_locks.c335 as request_id, tran_locks.c78a as owner_id from (select null as locks_info) as locks_info cross join #e8f tran_locks where tran_locks.c3ec = si.session_id group by locks_info.locks_info, tran_locks.c3ec, tran_locks.c335, tran_locks.c78a, tran_locks.c769, tran_locks.c1a4, tran_locks.cf24, tran_locks.c590, tran_locks.cd24, tran_locks.c7e4 order by tran_locks.c3ec, tran_locks.c335, tran_locks.c78a, tran_locks.c769, tran_locks.c1a4, tran_locks.cf24, tran_locks.c590, tran_locks.cd24, tran_locks.c7e4 for xml auto) from #c05 si where si.session_id not in (select ri.session_id from #0ed ri) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set locks ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_profiles_physical_read_count')) update #0ed set query_profiles_physical_read_count = (select sum(query_profiles.c63b) as query_profiles_physical_read_count from #aa7 query_profiles where query_profiles.cd43 = ri.session_id and query_profiles.c9d7 = ri.request_id and query_profiles.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_profiles_physical_read_count ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_cursor_count')) update #c05 set cursor_count = (select case count(*) when 0 then NULL else count(*) end from #4dc cursors where cursors.cd43 = si.session_id and cursors.c4d8 = s.login_time) from #c05 si inner join #9de s on (si.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set cursor_count ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_profiles_write_page_count')) update #0ed set query_profiles_write_page_count = (select sum(query_profiles.c452) as query_profiles_write_page_count from #aa7 query_profiles where query_profiles.cd43 = ri.session_id and query_profiles.c9d7 = ri.request_id and query_profiles.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_profiles_write_page_count ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_info')) update #476 set c297 = 'ridlock = ' + case ca43 when 32767 then '[Resource Database]' else db_name(ca43) end + '.' + (select c483 from #3fd rdaeid where rdaeid.cf24 = 'RID' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where rdaeid.cf24 = 'RID' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + ' (index_name = ' + (select isnull(c765, 'NULL') + '(' + c20b + ')' from #3fd rdaeid where rdaeid.cf24 = 'RID' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + ', partition_number = ' + cast((select c99a from #3fd rdaeid where rdaeid.cf24 = 'RID' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) as nvarchar(256)) + ')' from #476 wt where wt.c1f6 like 'ridlock %' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_os_waiting_tasks set resource_description_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_info')) update #476 set c297 = 'pagelock = ' + case ca43 when 32767 then '[Resource Database]' else db_name(ca43) end + '.' + (select c483 from #3fd rdaeid where rdaeid.cf24 = 'PAGE' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where rdaeid.cf24 = 'PAGE' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + ' (index_name = ' + (select isnull(c765, 'NULL') + '(' + c20b + ')' from #3fd rdaeid where rdaeid.cf24 = 'PAGE' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + ', partition_number = ' + cast((select c99a from #3fd rdaeid where rdaeid.cf24 = 'PAGE' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) as nvarchar(256)) + ')' from #476 wt where wt.c1f6 like 'pagelock %' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_os_waiting_tasks set resource_description_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_info')) update #476 set c297 = 'hobtlock = ' + case ca43 when 32767 then '[Resource Database]' else db_name(ca43) end + '.' + (select c483 from #3fd rdaeid where rdaeid.cf24 = 'HOBT' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where rdaeid.cf24 = 'HOBT' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + ' (index_name = ' + (select isnull(c765, 'NULL') + '(' + c20b + ')' from #3fd rdaeid where rdaeid.cf24 = 'HOBT' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) + ', partition_number = ' + cast((select c99a from #3fd rdaeid where rdaeid.cf24 = 'HOBT' and wt.ca43 = rdaeid.c769 and wt.c73a = rdaeid.c1a4) as nvarchar(256)) + ')' from #476 wt where wt.c1f6 like 'hobtlock %' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_os_waiting_tasks set resource_description_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_profiles_cpu_time_ms')) update #0ed set query_profiles_cpu_time_ms = (select sum(query_profiles.ce90) as query_profiles_cpu_time_ms from #aa7 query_profiles where query_profiles.cd43 = ri.session_id and query_profiles.c9d7 = ri.request_id and query_profiles.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_profiles_cpu_time_ms ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_wait_resource_info')) update #0ed set wait_resource_info = 'KEY = ' + (select case wait_resource_database_id when 32767 then '[Resource Database]' else db_name(wait_resource_database_id) end + '.' + (select c483 from #3fd rdaeid where rdaeid.cf24 in ('KEY') and wait_resource_database_id = rdaeid.c769 and wait_resource_associated_object_id = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where rdaeid.cf24 in ('KEY') and wait_resource_database_id = rdaeid.c769 and wait_resource_associated_object_id = rdaeid.c1a4) + ' (index_name = ' + (select isnull(c765, 'NULL') + '(' + c20b + ')' from #3fd rdaeid where rdaeid.cf24 in ('KEY') and wait_resource_database_id = rdaeid.c769 and wait_resource_associated_object_id = rdaeid.c1a4) + ', partition_number = ' + cast((select c99a from #3fd rdaeid where rdaeid.cf24 in ('KEY') and wait_resource_database_id = rdaeid.c769 and wait_resource_associated_object_id = rdaeid.c1a4) as nvarchar(256)) + ')' from (select (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(replace(replace(wait_resource, '(', ':'), ')', ':'), ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 2) as wait_resource_database_id, (select value from (select c.value('.', 'nvarchar(max)') as value, row_number() over (order by (select 1)) as rn from (select cast(N'<r>' + replace(replace(replace(wait_resource, '(', ':'), ')', ':'), ':', '</r><r>') + '</r>' as xml)) as x(y) cross apply x.y.nodes('r') t(c)) as z where rn = 3) as wait_resource_associated_object_id) as xy) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) where r.wait_type like 'LCK_%' and r.wait_resource like 'KEY%' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set wait_resource_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_cached_plans_info')) update #0ed set cached_plans_info = (select cached_plans_info.cached_plans_info, cached_plans.c128 as bucketid, cached_plans.c8ba as refcounts, cached_plans.c310 as usecounts, cached_plans.c45d as size_in_bytes, sys.fn_varbintohexstr(cached_plans.ce96) as memory_object_address, cached_plans.c546 as cacheobjtype, cached_plans.cb4b as objtype, sys.fn_varbintohexstr(cached_plans.ce84) as plan_handle, cached_plans.c5e8 as pool_id, sys.fn_varbintohexstr(cached_plans.ce9e) as parent_plan_handle from (select null as cached_plans_info) as cached_plans_info cross join #2d4 cached_plans where cached_plans.ce84 = r.plan_handle for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set cached_plans_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_plan_text_checksum')) update #0ed set query_plan_text_checksum = (select checksum from #eef qpc where qpc.plan_handle = r.plan_handle) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_plan_text_checksum ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_wait_types')) update #c05 set waiting_tasks_wait_types = (select waiting_tasks.c896 + case when count(*) > 1 then '(' + cast(count(*) as nvarchar(256)) + ')' else '' end + case row_number() over (order by count(*) desc) when count(*) over () then '' else ', ' end from #476 waiting_tasks where waiting_tasks.cd43 = si.session_id group by waiting_tasks.c896 order by count(*) desc for xml path('')) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set waiting_tasks_wait_types ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_max_wait_duration_ms')) update #c05 set waiting_tasks_max_wait_duration_ms = (select max(waiting_tasks.c693) from #476 waiting_tasks where waiting_tasks.cd43 = si.session_id) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set waiting_tasks_max_wait_duration_ms ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_task_tempdb_usage_kb')) update #0ed set task_tempdb_usage_kb = (select sum((task_space_usage.c52c - task_space_usage.cdea) + (task_space_usage.c248 - task_space_usage.c84f)) * 8 as task_space_usage_kb from #e70 task_space_usage where task_space_usage.cd43 = ri.session_id and task_space_usage.c9d7 = ri.request_id and (task_space_usage.c52c + task_space_usage.cdea + task_space_usage.c248 + task_space_usage.c84f) > 0 and task_space_usage.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set task_tempdb_usage_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_session_tempdb_usage_kb')) update #c05 set session_tempdb_usage_kb = (select (session_space_usage.c52c - session_space_usage.cdea - session_space_usage.ca58) + (session_space_usage.c248 - session_space_usage.c84f) * 8 as session_space_usage_kb from #406 session_space_usage where session_space_usage.cd43 = si.session_id and (((session_space_usage.c52c - session_space_usage.cdea - session_space_usage.ca58) + (session_space_usage.c248 - session_space_usage.c84f)) > 0) and session_space_usage.c4d8 = s.login_time) from #c05 si inner join #9de s on (si.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set session_tempdb_usage_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_memory_grants_requested_memory_kb')) update #0ed set query_memory_grants_requested_memory_kb = (select query_memory_grants.c1e1 as query_memory_grants_requested_memory_kb from #525 query_memory_grants where query_memory_grants.cd43 = ri.session_id and query_memory_grants.c9d7 = ri.request_id and query_memory_grants.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_memory_grants_requested_memory_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_session_tempdb_usage_info')) update #c05 set session_tempdb_usage_info = (select session_tempdb_usage_info.session_tempdb_usage_info, session_space_usage.cd43 as session_id, session_space_usage.cd24 as database_id, session_space_usage.c52c as user_objects_alloc_page_count, session_space_usage.cdea as user_objects_dealloc_page_count, session_space_usage.c248 as internal_objects_alloc_page_count, session_space_usage.c84f as internal_objects_dealloc_page_count, session_space_usage.ca58 as user_objects_deferred_dealloc_page_count, c4d8 as login_time from (select null as session_tempdb_usage_info) as session_tempdb_usage_info cross join #406 session_space_usage where session_space_usage.cd43 = si.session_id and (session_space_usage.c52c + session_space_usage.cdea + session_space_usage.c248 + session_space_usage.c84f) > 0 and session_space_usage.c4d8 = s.login_time for xml auto) from #c05 si inner join #9de s on (si.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set session_tempdb_usage_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_cursors_info')) update #c05 set cursors_info = (select cursors_info.cursors_info, cursors.cd43 as session_id, cursors.cad9 as cursor_id, cursors.c60f as name, cursors.cee1 as properties, sys.fn_varbintohexstr(cursors.c153) as sql_handle, cursors.c294 as statement_start_offset, cursors.c82a as statement_end_offset, cursors.c99e as plan_generation_num, cursors.c87f as creation_time, cursors.cae1 as is_open, cursors.c34b as is_async_population, cursors.c246 as is_close_on_commit, cursors.cceb as fetch_status, cursors.c66b as fetch_buffer_size, cursors.cf49 as fetch_buffer_start, cursors.c879 as ansi_position, cursors.c1c7 as worker_time, cursors.c60b as reads, cursors.ca14 as writes, cursors.cee4 as dormant_duration, sys.fn_varbintohexstr(cursors.c0c4) as statement_sql_handle, cursors.c69a as statement_context_id, c4d8 as login_time from (select null as cursors_info) as cursors_info cross join #4dc cursors where cursors.cd43 = si.session_id and cursors.c4d8 = s.login_time for xml auto) from #c05 si inner join #9de s on (si.session_id = s.session_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set cursors_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_info')) update #476 set c297 = 'objectlock = ' + case ca43 when 32767 then '[Resource Database]' else db_name(ca43) end + '.' + (select c483 from #3fd rdaeid where rdaeid.cf24 = 'OBJECT' and wt.ca43 = rdaeid.c769 and wt.c285 = rdaeid.c1a4) + '.' + (select c72f from #3fd rdaeid where rdaeid.cf24 = 'OBJECT' and wt.ca43 = rdaeid.c769 and wt.c285 = rdaeid.c1a4) from #476 wt where wt.c1f6 like 'objectlock %' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_os_waiting_tasks set resource_description_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_tasks_io_size_kb')) update #0ed set tasks_io_size_kb = (select case sum(tasks.c580) when 0 then NULL else (r.reads * 8) / sum(tasks.c580) end as tasks_io_size_kb from #f5c tasks where tasks.cd43 = ri.session_id and tasks.c9d7 = ri.request_id and tasks.c580 > 0 and tasks.cc53 = r.start_time) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set tasks_io_size_kb ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_wait_resource_info')) update #0ed set wait_resource_info = (select case when page_id = 0 then NULL when page_id = 1 or page_id % 8080 = 0 then 'PFS' when page_id = 2 or page_id % 511232 = 0 then 'GAM' when page_id = 3 or page_id % 511233 = 0 then 'SGAM' end from (select substring(wait_resource, len(wait_resource) - charindex(':', reverse(wait_resource)) + 2, charindex(':', reverse(wait_resource))) as page_id) as wr) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) where r.wait_type like 'PAGELATCH_%' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set wait_resource_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_waiting_tasks_info')) update #c05 set waiting_tasks_info = (select waiting_tasks_info.waiting_tasks_info, waiting_tasks.cd43 as session_id, waiting_tasks.ca87 as exec_context_id, waiting_tasks.c693 as wait_duration_ms, waiting_tasks.c896 as wait_type, waiting_tasks.c114 as blocking_session_id, waiting_tasks.cedf as blocking_exec_context_id, waiting_tasks.c1f6 as resource_description, c297 as resource_description_info, c4d8 as login_time from (select null as waiting_tasks_info) as waiting_tasks_info cross join #476 waiting_tasks where waiting_tasks.cd43 = si.session_id order by waiting_tasks.cd43, waiting_tasks.ca87, waiting_tasks.c693, waiting_tasks.c896, waiting_tasks.c114, waiting_tasks.cedf for xml auto) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set waiting_tasks_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_is_blocker')) update #c05 set is_blocker = (select case when exists (select c114 from #476 where si.session_id = c114 and cd43 <> c114) then 1 else 0 end) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set is_blocker ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_is_blocked')) update #0ed set is_blocked = (select case when exists (select cd43 from #476 where ri.session_id = cd43 and cd43 <> c114 and c4d8 = (select login_time from #9de where ri.session_id = session_id)) then 1 else 0 end) from #0ed ri select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set is_blocked ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_blocked_session_ids')) begin declare @007 nvarchar(max) declare c78b cursor for select si.session_id from #c05 si where is_blocker = 1 open c78b fetch next from c78b into @9c0 while (@@fetch_status = 0) begin with c6bf as (select cd43 from #476 where c114 = @9c0 and cd43 <> c114 union all select wt.cd43 from #476 wt inner join c6bf s on s.cd43 = wt.c114 where wt.cd43 <> wt.c114 and wt.cd43 <> @9c0 and wt.c4d8 = (select login_time from #c05 si inner join #9de s on (si.session_id = s.session_id) where si.session_id = wt.cd43)) select @007 = (select cast(cd43 as nvarchar(256)) + case row_number() over (order by cd43) when count(*) over () then '' else ', ' end from c6bf group by cd43 order by cd43 for xml path('')) update #c05 set blocked_session_ids = @007 where session_id = @9c0 fetch next from c78b into @9c0 end close c78b deallocate c78b end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set blocked_session_ids ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_is_dead_locked')) begin declare @80b bit declare c66d cursor for select si.session_id from #0ed si where is_blocked = 1 open c66d fetch next from c66d into @9c0 while (@@fetch_status = 0) begin with cf55 as (select c114, 0 as deadlocked, '<' + rtrim(ltrim(cast(c114 as nvarchar(max)))) + '>' as c2dc from #476 where cd43 = @9c0 and cd43 <> c114 and c4d8 = (select login_time from #c05 si inner join #9de s on (si.session_id = s.session_id) where si.session_id = @9c0) union all select wt.c114, case wt.c114 when @9c0 then 1 else 0 end as deadlocked, s.c2dc + '<' + rtrim(ltrim(cast(wt.c114 as nvarchar(max)))) + '>' as c2dc from #476 wt inner join cf55 s on s.c114 = wt.cd43 where wt.cd43 <> wt.c114 and s.deadlocked <> 1 and s.c2dc not like '%<' + rtrim(ltrim(cast(wt.c114 as nvarchar(max)))) + '>%' and wt.c4d8 = (select login_time from #c05 si inner join #9de s on (si.session_id = s.session_id) where si.session_id = wt.cd43)) select @80b = deadlocked from cf55 if (@80b = 1) update #0ed set is_dead_locked = @80b where session_id = @9c0 fetch next from c66d into @9c0 end close c66d deallocate c66d end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set is_dead_locked ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_is_head_blocker')) update #c05 set is_head_blocker = (select case when exists (select c114 from #476 where (si.session_id = c114 and cd43 <> c114 and si.session_id not in (select cd43 from #476 where cd43 <> c114)) or (si.session_id = c114 and cd43 <> c114 and si.session_id in (select session_id from #0ed where is_dead_locked = 1))) then 1 else 0 end) from #c05 si select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set is_head_blocker ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_blocker_session_ids')) begin declare @c4c nvarchar(max) declare cbfe cursor for select si.session_id from #0ed si where is_blocked = 1 open cbfe fetch next from cbfe into @9c0 while (@@fetch_status = 0) begin with cf55 as (select c114, '<' + rtrim(ltrim(cast(c114 as nvarchar(max)))) + '>' as c2dc from #476 where cd43 = @9c0 and cd43 <> c114 and c4d8 = (select login_time from #c05 si inner join #9de s on (si.session_id = s.session_id) where si.session_id = @9c0) union all select wt.c114, s.c2dc + '<' + rtrim(ltrim(cast(wt.c114 as nvarchar(max)))) + '>' as c2dc from #476 wt inner join cf55 s on s.c114 = wt.cd43 where wt.cd43 <> wt.c114 and wt.c114 <> @9c0 and s.c2dc not like '%<' + rtrim(ltrim(cast(wt.c114 as nvarchar(max)))) + '>%' and wt.c4d8 = (select login_time from #c05 si inner join #9de s on (si.session_id = s.session_id) where si.session_id = wt.cd43)) select @c4c = (select cast(c114 as nvarchar(256)) + case row_number() over (order by c114) when count(*) over () then '' else ', ' end from cf55 group by c114 order by c114 for xml path('')) update #0ed set blocker_session_ids = @c4c where session_id = @9c0 fetch next from cbfe into @9c0 end close cbfe deallocate cbfe end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set blocker_session_ids ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_head_blocker_session_ids')) begin declare @613 nvarchar(max) declare c565 cursor for select si.session_id from #0ed si where is_blocked = 1 open c565 fetch next from c565 into @9c0 while (@@fetch_status = 0) begin with cf55 as (select c114, '<' + rtrim(ltrim(cast(c114 as nvarchar(max)))) + '>' as c2dc from #476 where cd43 = @9c0 and cd43 <> c114 and c4d8 = (select login_time from #c05 si inner join #9de s on (si.session_id = s.session_id) where si.session_id = @9c0) union all select wt.c114, s.c2dc + '<' + rtrim(ltrim(cast(wt.c114 as nvarchar(max)))) + '>' as c2dc from #476 wt inner join cf55 s on s.c114 = wt.cd43 where wt.cd43 <> wt.c114 and wt.c114 <> @9c0 and s.c2dc not like '%<' + rtrim(ltrim(cast(wt.c114 as nvarchar(max)))) + '>%' and wt.c4d8 = (select login_time from #c05 si inner join #9de s on (si.session_id = s.session_id) where si.session_id = wt.cd43)) select @613 = (select cast(bs.c114 as nvarchar(256)) + case row_number() over (order by bs.c114) when count(*) over () then '' else ', ' end from cf55 bs where bs.c114 in (select session_id from #c05 where is_head_blocker = 1) group by bs.c114 order by bs.c114 for xml path('')) update #0ed set head_blocker_session_ids = @613 where session_id = @9c0 fetch next from c565 into @9c0 end close c565 deallocate c565 end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set head_blocker_session_ids ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if exists (select c35f from #2ff where c35f in ('cb2_query_stats_info')) update #b39 set query_stats_info = (select query_stats_info.query_stats_info, c521 as executioncount, (cast(case c521 when 1 then NULL else c521 end as float) / case datediff(s, c87f, c2f9) when 0 then NULL else datediff(s, c87f, c2f9) end) as ExecutionsPerSec, cc5d / 1000 / case cfc3 when 0 then NULL else cfc3 end as RowLatencyMS, cb4f / 1000 as TotalCPUTimeMS, (case cb4f when 0 then NULL else cb4f end) / c521 / 1000 as AverageCPUTimeMS, cc5d / 1000 as TotalDurationMS, (case cc5d when 0 then NULL else cc5d end) / c521 / 1000 as AverageDurationMS, cfc3 as TotalRows, (case cfc3 when 0 then NULL else cfc3 end) / c521 as AverageRows, cf41 as TotalLogicalReads, (case cf41 when 0 then NULL else cf41 end) / c521 as AverageLogicalReads, cfbf as TotalPhysicalReads, (case cfbf when 0 then NULL else cfbf end) / c521 as AveragePhysicalReads, cb96 as TotalLogicalWrites, (case cb96 when 0 then NULL else cb96 end) / c521 as AverageLogicalWrites, ccd1 / 1000 as TotalCLRTimeMS, (case ccd1 when 0 then NULL else ccd1 end) / c521 / 1000 as AverageCLRTimeMS, sys.fn_varbintohexstr(query_stats.c153) as sql_handle, query_stats.c294 as statement_start_offset, query_stats.c82a as statement_end_offset, query_stats.c99e as plan_generation_num, sys.fn_varbintohexstr(query_stats.ce84) as plan_handle, query_stats.c87f as creation_time, query_stats.c2f9 as last_execution_time, query_stats.cb4f as total_worker_time, query_stats.c3a8 as last_worker_time, query_stats.cc50 as min_worker_time, query_stats.caa0 as max_worker_time, query_stats.cfbf as total_physical_reads, query_stats.c2f7 as last_physical_reads, query_stats.c9ff as min_physical_reads, query_stats.c6f9 as max_physical_reads, query_stats.cb96 as total_logical_writes, query_stats.c5f3 as last_logical_writes, query_stats.c5bf as min_logical_writes, query_stats.c878 as max_logical_writes, query_stats.cf41 as total_logical_reads, query_stats.c9cf as last_logical_reads, query_stats.ce3c as min_logical_reads, query_stats.c55d as max_logical_reads, query_stats.ccd1 as total_clr_time, query_stats.c922 as last_clr_time, query_stats.cb90 as min_clr_time, query_stats.c22f as max_clr_time, query_stats.cc5d as total_elapsed_time, query_stats.c750 as last_elapsed_time, query_stats.cac9 as min_elapsed_time, query_stats.c8ce as max_elapsed_time, sys.fn_varbintohexstr(query_stats.cad9) as query_hash, sys.fn_varbintohexstr(query_stats.c2cb) as query_plan_hash, query_stats.cfc3 as total_rows, query_stats.c20a as last_rows, query_stats.c5ae as min_rows, query_stats.c269 as max_rows, sys.fn_varbintohexstr(query_stats.c0c4) as statement_sql_handle, query_stats.c69a as statement_context_id from (select null as query_stats_info) as query_stats_info cross join #d1b query_stats where query_stats.c153 = c.most_recent_sql_handle for xml auto) from #b39 ci inner join #dd0 c on (ci.session_id = c.session_id and ci.connection_id = c.connection_id) select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_connections set query_stats_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c7a_query_stats_info')) begin update #0ed set query_stats_info = (select query_stats_info.query_stats_info, c521 as executioncount, (cast(case c521 when 1 then NULL else c521 end as float) / case datediff(s, c87f, c2f9) when 0 then NULL else datediff(s, c87f, c2f9) end) as ExecutionsPerSec, cc5d / 1000 / case cfc3 when 0 then NULL else cfc3 end as RowLatencyMS, cb4f / 1000 as TotalCPUTimeMS, (case cb4f when 0 then NULL else cb4f end) / c521 / 1000 as AverageCPUTimeMS, cc5d / 1000 as TotalDurationMS, (case cc5d when 0 then NULL else cc5d end) / c521 / 1000 as AverageDurationMS, cfc3 as TotalRows, (case cfc3 when 0 then NULL else cfc3 end) / c521 as AverageRows, cf41 as TotalLogicalReads, (case cf41 when 0 then NULL else cf41 end) / c521 as AverageLogicalReads, cfbf as TotalPhysicalReads, (case cfbf when 0 then NULL else cfbf end) / c521 as AveragePhysicalReads, cb96 as TotalLogicalWrites, (case cb96 when 0 then NULL else cb96 end) / c521 as AverageLogicalWrites, ccd1 / 1000 as TotalCLRTimeMS, (case ccd1 when 0 then NULL else ccd1 end) / c521 / 1000 as AverageCLRTimeMS, sys.fn_varbintohexstr(query_stats.c153) as sql_handle, query_stats.c294 as statement_start_offset, query_stats.c82a as statement_end_offset, query_stats.c99e as plan_generation_num, sys.fn_varbintohexstr(query_stats.ce84) as plan_handle, query_stats.c87f as creation_time, query_stats.c2f9 as last_execution_time, query_stats.cb4f as total_worker_time, query_stats.c3a8 as last_worker_time, query_stats.cc50 as min_worker_time, query_stats.caa0 as max_worker_time, query_stats.cfbf as total_physical_reads, query_stats.c2f7 as last_physical_reads, query_stats.c9ff as min_physical_reads, query_stats.c6f9 as max_physical_reads, query_stats.cb96 as total_logical_writes, query_stats.c5f3 as last_logical_writes, query_stats.c5bf as min_logical_writes, query_stats.c878 as max_logical_writes, query_stats.cf41 as total_logical_reads, query_stats.c9cf as last_logical_reads, query_stats.ce3c as min_logical_reads, query_stats.c55d as max_logical_reads, query_stats.ccd1 as total_clr_time, query_stats.c922 as last_clr_time, query_stats.cb90 as min_clr_time, query_stats.c22f as max_clr_time, query_stats.cc5d as total_elapsed_time, query_stats.c750 as last_elapsed_time, query_stats.cac9 as min_elapsed_time, query_stats.c8ce as max_elapsed_time, sys.fn_varbintohexstr(query_stats.cad9) as query_hash, sys.fn_varbintohexstr(query_stats.c2cb) as query_plan_hash, query_stats.cfc3 as total_rows, query_stats.c20a as last_rows, query_stats.c5ae as min_rows, query_stats.c269 as max_rows, sys.fn_varbintohexstr(query_stats.c0c4) as statement_sql_handle, query_stats.c69a as statement_context_id from (select null as query_stats_info) as query_stats_info cross join #d1b query_stats where query_stats.ce84 = r.plan_handle and query_stats.c294 = r.statement_start_offset and query_stats.c82a = r.statement_end_offset for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) update #0ed set query_stats_info = (select query_stats_info.query_stats_info, c521 as executioncount, (cast(case c521 when 1 then NULL else c521 end as float) / case datediff(s, c87f, c2f9) when 0 then NULL else datediff(s, c87f, c2f9) end) as ExecutionsPerSec, cc5d / 1000 / case cfc3 when 0 then NULL else cfc3 end as RowLatencyMS, cb4f / 1000 as TotalCPUTimeMS, (case cb4f when 0 then NULL else cb4f end) / c521 / 1000 as AverageCPUTimeMS, cc5d / 1000 as TotalDurationMS, (case cc5d when 0 then NULL else cc5d end) / c521 / 1000 as AverageDurationMS, cfc3 as TotalRows, (case cfc3 when 0 then NULL else cfc3 end) / c521 as AverageRows, cf41 as TotalLogicalReads, (case cf41 when 0 then NULL else cf41 end) / c521 as AverageLogicalReads, cfbf as TotalPhysicalReads, (case cfbf when 0 then NULL else cfbf end) / c521 as AveragePhysicalReads, cb96 as TotalLogicalWrites, (case cb96 when 0 then NULL else cb96 end) / c521 as AverageLogicalWrites, ccd1 / 1000 as TotalCLRTimeMS, (case ccd1 when 0 then NULL else ccd1 end) / c521 / 1000 as AverageCLRTimeMS, sys.fn_varbintohexstr(query_stats.c153) as sql_handle, query_stats.c294 as statement_start_offset, query_stats.c82a as statement_end_offset, query_stats.c99e as plan_generation_num, sys.fn_varbintohexstr(query_stats.ce84) as plan_handle, query_stats.c87f as creation_time, query_stats.c2f9 as last_execution_time, query_stats.cb4f as total_worker_time, query_stats.c3a8 as last_worker_time, query_stats.cc50 as min_worker_time, query_stats.caa0 as max_worker_time, query_stats.cfbf as total_physical_reads, query_stats.c2f7 as last_physical_reads, query_stats.c9ff as min_physical_reads, query_stats.c6f9 as max_physical_reads, query_stats.cb96 as total_logical_writes, query_stats.c5f3 as last_logical_writes, query_stats.c5bf as min_logical_writes, query_stats.c878 as max_logical_writes, query_stats.cf41 as total_logical_reads, query_stats.c9cf as last_logical_reads, query_stats.ce3c as min_logical_reads, query_stats.c55d as max_logical_reads, query_stats.ccd1 as total_clr_time, query_stats.c922 as last_clr_time, query_stats.cb90 as min_clr_time, query_stats.c22f as max_clr_time, query_stats.cc5d as total_elapsed_time, query_stats.c750 as last_elapsed_time, query_stats.cac9 as min_elapsed_time, query_stats.c8ce as max_elapsed_time, sys.fn_varbintohexstr(query_stats.cad9) as query_hash, sys.fn_varbintohexstr(query_stats.c2cb) as query_plan_hash, query_stats.cfc3 as total_rows, query_stats.c20a as last_rows, query_stats.c5ae as min_rows, query_stats.c269 as max_rows, sys.fn_varbintohexstr(query_stats.c0c4) as statement_sql_handle, query_stats.c69a as statement_context_id from (select null as query_stats_info) as query_stats_info cross join #d1b query_stats where query_stats.c153 = r.sql_handle and query_stats.c294 = r.statement_start_offset and query_stats.c82a = r.statement_end_offset for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) where query_stats_info is NULL update #0ed set query_stats_info = (select query_stats_info.query_stats_info, c521 as executioncount, (cast(case c521 when 1 then NULL else c521 end as float) / case datediff(s, c87f, c2f9) when 0 then NULL else datediff(s, c87f, c2f9) end) as ExecutionsPerSec, cc5d / 1000 / case cfc3 when 0 then NULL else cfc3 end as RowLatencyMS, cb4f / 1000 as TotalCPUTimeMS, (case cb4f when 0 then NULL else cb4f end) / c521 / 1000 as AverageCPUTimeMS, cc5d / 1000 as TotalDurationMS, (case cc5d when 0 then NULL else cc5d end) / c521 / 1000 as AverageDurationMS, cfc3 as TotalRows, (case cfc3 when 0 then NULL else cfc3 end) / c521 as AverageRows, cf41 as TotalLogicalReads, (case cf41 when 0 then NULL else cf41 end) / c521 as AverageLogicalReads, cfbf as TotalPhysicalReads, (case cfbf when 0 then NULL else cfbf end) / c521 as AveragePhysicalReads, cb96 as TotalLogicalWrites, (case cb96 when 0 then NULL else cb96 end) / c521 as AverageLogicalWrites, ccd1 / 1000 as TotalCLRTimeMS, (case ccd1 when 0 then NULL else ccd1 end) / c521 / 1000 as AverageCLRTimeMS, sys.fn_varbintohexstr(query_stats.c153) as sql_handle, query_stats.c294 as statement_start_offset, query_stats.c82a as statement_end_offset, query_stats.c99e as plan_generation_num, sys.fn_varbintohexstr(query_stats.ce84) as plan_handle, query_stats.c87f as creation_time, query_stats.c2f9 as last_execution_time, query_stats.cb4f as total_worker_time, query_stats.c3a8 as last_worker_time, query_stats.cc50 as min_worker_time, query_stats.caa0 as max_worker_time, query_stats.cfbf as total_physical_reads, query_stats.c2f7 as last_physical_reads, query_stats.c9ff as min_physical_reads, query_stats.c6f9 as max_physical_reads, query_stats.cb96 as total_logical_writes, query_stats.c5f3 as last_logical_writes, query_stats.c5bf as min_logical_writes, query_stats.c878 as max_logical_writes, query_stats.cf41 as total_logical_reads, query_stats.c9cf as last_logical_reads, query_stats.ce3c as min_logical_reads, query_stats.c55d as max_logical_reads, query_stats.ccd1 as total_clr_time, query_stats.c922 as last_clr_time, query_stats.cb90 as min_clr_time, query_stats.c22f as max_clr_time, query_stats.cc5d as total_elapsed_time, query_stats.c750 as last_elapsed_time, query_stats.cac9 as min_elapsed_time, query_stats.c8ce as max_elapsed_time, sys.fn_varbintohexstr(query_stats.cad9) as query_hash, sys.fn_varbintohexstr(query_stats.c2cb) as query_plan_hash, query_stats.cfc3 as total_rows, query_stats.c20a as last_rows, query_stats.c5ae as min_rows, query_stats.c269 as max_rows, sys.fn_varbintohexstr(query_stats.c0c4) as statement_sql_handle, query_stats.c69a as statement_context_id from (select null as query_stats_info) as query_stats_info cross join #d1b query_stats where query_stats.c153 = r.sql_handle for xml auto) from #0ed ri inner join #091 r on (ri.session_id = r.session_id and ri.request_id = r.request_id) where query_stats_info is NULL end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_requests set query_stats_info ... took ' + cast(@a09 as nvarchar(256)) + ' ms' select @254 = getdate() if exists (select c35f from #2ff where c35f in ('c99_sp_whopro_inputparameters')) update #c05 set sp_whopro_inputparameters = case when @sessions is NULL then '@sessions = NULL' else '@sessions = ''' + replace(@sessions, '''', '''''') + '''' end + ', ' + case when @columns is NULL then '@columns = NULL' else '@columns = ''' + replace(@columns, '''', '''''') + '''' end + ', ' + case when @order_by is NULL then '@order_by = NULL' else '@order_by = ''' + replace(@order_by, '''', '''''') + '''' end + ', ' + case when @save_to_database is NULL then '@save_to_database = NULL' else '@save_to_database = ''' + @save_to_database + '''' end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'update sqlws_dm_exec_sessions set sp_whopro_inputparameters ... took ' + cast(@a09 as nvarchar(256)) + ' ms'
	select @254 = getdate() if (@5d0 = 1 and @b16 = 0) begin set @697 = 'use [' + db_name(@09e) + '] if not exists (select name from sys.objects where schema_id = ' + cast (@bcc as nvarchar(256)) + ' and name = ''sqlws_dm_exec_sessions'') create table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions (servername nvarchar(256), ctime datetime, session_id smallint, primary key (servername, ctime, session_id))' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] create table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] if not exists (select name from sys.objects where schema_id = ' + cast (@bcc as nvarchar(256)) + ' and name = ''sqlws_dm_exec_connections'') create table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections (servername nvarchar(256), ctime datetime, session_id smallint, connection_id uniqueidentifier, primary key (servername, ctime, session_id, connection_id))' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] create table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] if not exists (select name from sys.objects where schema_id = ' + cast (@bcc as nvarchar(256)) + ' and name = ''sqlws_dm_exec_requests'') create table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests (servername nvarchar(256), ctime datetime, session_id smallint, request_id int, connection_id uniqueidentifier, primary key (servername, ctime, session_id, request_id))' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] create table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end end declare @ec7 nvarchar(max) set @ec7 = '' declare @bc5 nvarchar(max) set @bc5 = '' declare @c61 nvarchar(max) set @c61 = '' declare @0ea nvarchar(max), @bfb bit create table #fb4 (cc6e int identity, ccd9 nvarchar(max)) create table #0d7 (c1cf nvarchar(max)) create table #ed4 (cc6e int identity, ccd9 nvarchar(max)) create table #018 (cc6e int identity, ccd9 nvarchar(max), c08c bit) create table #792 (cfbe int, c8ef int default 0, ccd9 nvarchar(max), ce65 nvarchar(max), c57c nvarchar(max), c06a nvarchar(max), primary key (cfbe, c8ef)) if (@355 = 1 and @columns is NULL) begin delete #2ff set @697 = 'use [' + db_name(@09e) + '] insert into #ed4 select name from (select ''c7e_'' + c.name as name, 100 + c.column_id as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_sessions'' and c.name in (select c.name from sys.all_objects o inner join sys.all_columns c on (o.object_id = c.object_id) where o.name = ''dm_exec_sessions'') and c.name not in (''session_id'', ''ctime'', ''servername'')' set @697 = @697 + ' union select ''c99_'' + c.name as name, 200 + c.column_id as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_sessions'' and c.name not in (select c.name from sys.all_objects o inner join sys.all_columns c on (o.object_id = c.object_id) where o.name = ''dm_exec_sessions'') and c.name not in (''session_id'', ''ctime'', ''servername'')' set @697 = @697 + ' union select ''c2e_'' + c.name as name, 500 + c.column_id as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_connections'' and c.name in (select c.name from sys.all_objects o inner join sys.all_columns c on (o.object_id = c.object_id) where o.name = ''dm_exec_connections'') and c.name not in (''session_id'', ''connection_id'', ''ctime'', ''servername'')' set @697 = @697 + ' union select ''cb2_'' + c.name as name, 600 + c.column_id as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_connections'' and c.name not in (select c.name from sys.all_objects o inner join sys.all_columns c on (o.object_id = c.object_id) where o.name = ''dm_exec_connections'') and c.name not in (''session_id'', ''connection_id'', ''ctime'', ''servername'')' set @697 = @697 + ' union select ''cec_'' + c.name as name, 300 + c.column_id as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests'' and c.name in (select c.name from sys.all_objects o inner join sys.all_columns c on (o.object_id = c.object_id) where o.name = ''dm_exec_requests'') and c.name not in (''session_id'', ''request_id'', ''connection_id'', ''ctime'', ''servername'')' set @697 = @697 + ' union select ''c7a_'' + c.name as name, 400 + c.column_id as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests'' and c.name not in (select c.name from sys.all_objects o inner join sys.all_columns c on (o.object_id = c.object_id) where o.name = ''dm_exec_requests'') and c.name not in (''session_id'', ''request_id'', ''connection_id'', ''ctime'', ''servername'')' set @697 = @697 + ' union select ''text_object_name'' as name, 700 as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests'' and c.name in (''sql_handle'') and exists (select c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_connections'' and c.name in (''most_recent_sql_handle'')) and exists (select o.name from sys.objects o where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_sql_text'')' set @697 = @697 + ' union select ''text'' as name, 710 as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests'' and c.name in (''sql_handle'') and exists (select c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_connections'' and c.name in (''most_recent_sql_handle'')) and exists (select o.name from sys.objects o where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_sql_text'')' set @697 = @697 + ' union select ''statement'' as name, 720 as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests'' and c.name in (''sql_handle'') and c.name in (''statement_start_offset'') and c.name in (''statement_start_offset'') and exists (select o.name from sys.objects o where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_sql_text'')' set @697 = @697 + ' union select ''query_plan'' as name, 730 as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests'' and c.name in (''plan_handle'') and exists (select o.name from sys.objects o where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_query_plan'')' set @697 = @697 + ' union select ''text_query_plan'' as name, 740 as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests'' and c.name in (''plan_handle'') and c.name in (''statement_start_offset'') and c.name in (''statement_start_offset'') and exists (select o.name from sys.objects o where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_text_query_plan'')' set @697 = @697 + ' union select ''plan_attributes_info'' as name, 750 as column_order from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests'' and c.name in (''plan_handle'') and exists (select o.name from sys.objects o where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_plan_attributes'')) as sqlws order by column_order' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into #ed4 failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end insert into #2ff (c35f) select ccd9 from #ed4 order by cc6e end insert into #018 select name, c08c from (select c35f as name, c08c, min(cc6e) as cc6e from #2ff where c08c = 0 group by c35f, c08c union all select c35f, c08c, cc6e from #2ff where c08c = 1) as columns order by cc6e insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 1 and ccd9 not in ('full_text_query_plan', 'query_plan', 'query_plan_checksum', 'cec_text_object_name', 'plan_attributes_info', 'input_buffer', 'cec_statement_object_name', 'cec_text', 'text_object_name', 'text_query_plan', 'c2e_text', 'cec_query_plan', 'cec_database_id', 'cec_full_text_query_plan', 'text', 'c2e_text_object_name', 'c7e_input_buffer', 'cec_statement', 'statement_object_name', 'cec_text_query_plan', 'statement', 'cec_plan_attributes_info', 'cec_query_plan_checksum', 'c7e_database_id', 'cec_input_buffer') if (exists (select ccd9 from #018 where ccd9 in ('c2e_endpoint_id') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_endpoint_id') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c2e_endpoint_id, c7e_endpoint_id)', 'c0c4_endpoint_id', ccd9 from #018 where c08c = 0 and ccd9 = 'c2e_endpoint_id' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c2e_endpoint_id', 'c7e_endpoint_id') end declare @baf nvarchar(max) if (@736 = 1) begin insert into #792 select cc6e, 0, 'ibsr.EventInfo', 'c02e_' + ccd9, ccd9, 'ibsr.EventInfo' from #018 where ccd9 = 'input_buffer' insert into #792 select cc6e, 0, 'ibs.EventInfo', ccd9, ccd9, 'ibs.EventInfo' from #018 where ccd9 = 'c7e_input_buffer' insert into #792 select cc6e, 0, 'ibr.EventInfo', ccd9, ccd9, 'ibr.EventInfo' from #018 where ccd9 = 'cec_input_buffer' end else begin set @baf = '(select ''='' + char(13) + char(10) + case when ibsr.EventInfo like ''%['' + char(0) + '']%'' collate sql_latin1_general_cp850_bin2 or ibsr.EventInfo like ''%['' + char(1) + ''-'' + char(8) + '']%'' or ibsr.EventInfo like ''%['' + char(11) + '']%'' or ibsr.EventInfo like ''%['' + char(12) + '']%'' or ibsr.EventInfo like ''%['' + char(14) + ''-'' + char(31) + '']%'' then replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(ibsr.EventInfo, nchar(0), ''[nchar(0)]'' collate sql_latin1_general_cp850_bin2), nchar(1), ''[nchar(1)]''), nchar(2), ''[nchar(2)]''), nchar(3), ''[nchar(3)]''), nchar(4), ''[nchar(4)]''), nchar(5), ''[nchar(5)]''), nchar(6), ''[nchar(6)]''), nchar(7), ''[nchar(7)]''), nchar(8), ''[nchar(8)]''), nchar(11), ''[nchar(11)]''), nchar(12), ''[nchar(12)]''), nchar(14), ''[nchar(14)]''), nchar(15), ''[nchar(15)]''), nchar(16), ''[nchar(16)]''), nchar(17), ''[nchar(17)]''), nchar(18), ''[nchar(18)]''), nchar(19), ''[nchar(19)]''), nchar(20), ''[nchar(20)]''), nchar(21), ''[nchar(21)]''), nchar(22), ''[nchar(22)]''), nchar(23), ''[nchar(23)]''), nchar(24), ''[nchar(24)]''), nchar(25), ''[nchar(25)]''), nchar(26), ''[nchar(26)]''), nchar(27), ''[nchar(27)]''), nchar(28), ''[nchar(28)]''), nchar(29), ''[nchar(29)]''), nchar(30), ''[nchar(30)]''), nchar(31), ''[nchar(31)]'') else ibsr.EventInfo end + char(13) + char(10) as [processing-instruction(ib)] for xml path(''''), type)' insert into #792 select cc6e, 0, @baf, 'c02e_' + ccd9, ccd9, 'cast(' + @baf + ' as nvarchar(max))' from #018 where ccd9 = 'input_buffer' insert into #792 select cc6e, 0, replace(@baf, 'ibsr', 'ibs'), ccd9, ccd9, 'cast(' + replace(@baf, 'ibsr', 'ibs') + ' as nvarchar(max))' from #018 where ccd9 = 'c7e_input_buffer' insert into #792 select cc6e, 0, replace(@baf, 'ibsr', 'ibr'), ccd9, ccd9, 'cast(' + replace(@baf, 'ibsr', 'ibr') + ' as nvarchar(max))' from #018 where ccd9 = 'cec_input_buffer' end if (exists (select ccd9 from #018 where ccd9 in ('cec_ansi_padding') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_ansi_padding') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_ansi_padding, c7e_ansi_padding)', 'c17a_ansi_padding', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_ansi_padding' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_ansi_padding', 'c7e_ansi_padding') end if (exists (select ccd9 from #018 where ccd9 in ('cec_date_format') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_date_format') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_date_format, c7e_date_format)', 'c17a_date_format', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_date_format' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_date_format', 'c7e_date_format') end if (exists (select ccd9 from #018 where ccd9 in ('cec_group_id') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_group_id') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_group_id, c7e_group_id)', 'c17a_group_id', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_group_id' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_group_id', 'c7e_group_id') end if (exists (select ccd9 from #018 where ccd9 in ('cec_concat_null_yields_null') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_concat_null_yields_null') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_concat_null_yields_null, c7e_concat_null_yields_null)', 'c17a_concat_null_yields_null', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_concat_null_yields_null' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_concat_null_yields_null', 'c7e_concat_null_yields_null') end if (exists (select ccd9 from #018 where ccd9 in ('cec_quoted_identifier') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_quoted_identifier') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_quoted_identifier, c7e_quoted_identifier)', 'c17a_quoted_identifier', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_quoted_identifier' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_quoted_identifier', 'c7e_quoted_identifier') end if (exists (select ccd9 from #018 where ccd9 in ('cec_open_transaction_count') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_open_transaction_count') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_open_transaction_count, c7e_open_transaction_count)', 'c17a_open_transaction_count', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_open_transaction_count' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_open_transaction_count', 'c7e_open_transaction_count') end if (exists (select ccd9 from #018 where ccd9 in ('cec_transaction_isolation_level') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_transaction_isolation_level') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_transaction_isolation_level, c7e_transaction_isolation_level)', 'c17a_transaction_isolation_level', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_transaction_isolation_level' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_transaction_isolation_level', 'c7e_transaction_isolation_level') end if (exists (select ccd9 from #018 where ccd9 in ('cec_date_first') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_date_first') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_date_first, c7e_date_first)', 'c17a_date_first', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_date_first' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_date_first', 'c7e_date_first') end if (exists (select ccd9 from #018 where ccd9 in ('cec_language') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_language') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_language, c7e_language)', 'c17a_language', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_language' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_language', 'c7e_language') end if (exists (select ccd9 from #018 where ccd9 in ('cec_ansi_null_dflt_on') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_ansi_null_dflt_on') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_ansi_null_dflt_on, c7e_ansi_null_dflt_on)', 'c17a_ansi_null_dflt_on', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_ansi_null_dflt_on' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_ansi_null_dflt_on', 'c7e_ansi_null_dflt_on') end if (exists (select ccd9 from #018 where ccd9 in ('cec_deadlock_priority') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_deadlock_priority') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_deadlock_priority, c7e_deadlock_priority)', 'c17a_deadlock_priority', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_deadlock_priority' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_deadlock_priority', 'c7e_deadlock_priority') end if (exists (select ccd9 from #018 where ccd9 in ('cec_ansi_nulls') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_ansi_nulls') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_ansi_nulls, c7e_ansi_nulls)', 'c17a_ansi_nulls', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_ansi_nulls' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_ansi_nulls', 'c7e_ansi_nulls') end if (exists (select ccd9 from #018 where ccd9 in ('cec_arithabort') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_arithabort') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_arithabort, c7e_arithabort)', 'c17a_arithabort', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_arithabort' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_arithabort', 'c7e_arithabort') end if (exists (select ccd9 from #018 where ccd9 in ('cec_ansi_warnings') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_ansi_warnings') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_ansi_warnings, c7e_ansi_warnings)', 'c17a_ansi_warnings', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_ansi_warnings' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_ansi_warnings', 'c7e_ansi_warnings') end if (exists (select ccd9 from #018 where ccd9 in ('cec_ansi_defaults') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_ansi_defaults') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_ansi_defaults, c7e_ansi_defaults)', 'c17a_ansi_defaults', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_ansi_defaults' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_ansi_defaults', 'c7e_ansi_defaults') end if (exists (select ccd9 from #018 where ccd9 in ('cec_prev_error') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_prev_error') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_prev_error, c7e_prev_error)', 'c17a_prev_error', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_prev_error' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_prev_error', 'c7e_prev_error') end if (exists (select ccd9 from #018 where ccd9 in ('cec_lock_timeout') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_lock_timeout') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_lock_timeout, c7e_lock_timeout)', 'c17a_lock_timeout', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_lock_timeout' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_lock_timeout', 'c7e_lock_timeout') end if (exists (select ccd9 from #018 where ccd9 in ('cec_text_size') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_text_size') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_text_size, c7e_text_size)', 'c17a_text_size', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_text_size' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_text_size', 'c7e_text_size') end if (exists (select ccd9 from #018 where ccd9 in ('cec_context_info') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7e_context_info') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(cec_context_info, c7e_context_info)', 'c17a_context_info', ccd9 from #018 where c08c = 0 and ccd9 = 'cec_context_info' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('cec_context_info', 'c7e_context_info') end insert into #792 select cc6e, 0, 'object_name(isnull(rst.objectid, cst.objectid), isnull(rst.dbid, cst.dbid))', 'c5cd_text_object_name', ccd9, 'object_name(isnull(rst.objectid, cst.objectid), isnull(rst.dbid, cst.dbid))' from #018 where ccd9 = 'text_object_name' insert into #792 select cc6e, 0, 'object_name(cst.objectid, cst.dbid)', 'c2e_text_object_name', ccd9, 'object_name(cst.objectid, cst.dbid)' from #018 where ccd9 = 'c2e_text_object_name' insert into #792 select cc6e, 0, 'object_name(rst.objectid, rst.dbid)', 'cec_text_object_name', ccd9, 'object_name(rst.objectid, rst.dbid)' from #018 where ccd9 = 'cec_text_object_name' if (@736 = 1) begin insert into #792 select cc6e, 1, 'isnull(rst.text, cst.text)', 'c5cd_' + ccd9, ccd9, 'isnull(rst.text, cst.text)' from #018 where ccd9 = 'text' insert into #792 select cc6e, 1, 'cst.text', ccd9, ccd9, 'cst.text' from #018 where ccd9 = 'c2e_text' insert into #792 select cc6e, 1, 'rst.text', ccd9, ccd9, 'rst.text' from #018 where ccd9 = 'cec_text' end else begin set @baf = '(select ''='' + char(13) + char(10) + case when isnull(rst.text, cst.text) like ''%['' + char(0) + '']%'' collate sql_latin1_general_cp850_bin2 or isnull(rst.text, cst.text) like ''%['' + char(1) + ''-'' + char(8) + '']%'' or isnull(rst.text, cst.text) like ''%['' + char(11) + '']%'' or isnull(rst.text, cst.text) like ''%['' + char(12) + '']%'' or isnull(rst.text, cst.text) like ''%['' + char(14) + ''-'' + char(31) + '']%'' then replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(isnull(rst.text, cst.text), nchar(0), ''[nchar(0)]'' collate sql_latin1_general_cp850_bin2), nchar(1), ''[nchar(1)]''), nchar(2), ''[nchar(2)]''), nchar(3), ''[nchar(3)]''), nchar(4), ''[nchar(4)]''), nchar(5), ''[nchar(5)]''), nchar(6), ''[nchar(6)]''), nchar(7), ''[nchar(7)]''), nchar(8), ''[nchar(8)]''), nchar(11), ''[nchar(11)]''), nchar(12), ''[nchar(12)]''), nchar(14), ''[nchar(14)]''), nchar(15), ''[nchar(15)]''), nchar(16), ''[nchar(16)]''), nchar(17), ''[nchar(17)]''), nchar(18), ''[nchar(18)]''), nchar(19), ''[nchar(19)]''), nchar(20), ''[nchar(20)]''), nchar(21), ''[nchar(21)]''), nchar(22), ''[nchar(22)]''), nchar(23), ''[nchar(23)]''), nchar(24), ''[nchar(24)]''), nchar(25), ''[nchar(25)]''), nchar(26), ''[nchar(26)]''), nchar(27), ''[nchar(27)]''), nchar(28), ''[nchar(28)]''), nchar(29), ''[nchar(29)]''), nchar(30), ''[nchar(30)]''), nchar(31), ''[nchar(31)]'') else isnull(rst.text, cst.text) end + char(13) + char(10) as [processing-instruction(t)] for xml path(''''), type)' insert into #792 select cc6e, 1, @baf, 'c5cd_' + ccd9, ccd9, 'cast(' + @baf + ' as nvarchar(max))' from #018 where ccd9 = 'text' insert into #792 select cc6e, 1, replace(@baf, 'isnull(rst.text, cst.text)', 'cst.text'), ccd9, ccd9, 'cast(' + replace(@baf, 'isnull(rst.text, cst.text)', 'cst.text') + ' as nvarchar(max))' from #018 where ccd9 = 'c2e_text' insert into #792 select cc6e, 1, replace(@baf, 'isnull(rst.text, cst.text)', 'rst.text'), ccd9, ccd9, 'cast(' + replace(@baf, 'isnull(rst.text, cst.text)', 'rst.text') + ' as nvarchar(max))' from #018 where ccd9 = 'cec_text' end insert into #792 select cc6e, 0, 'object_name(rst.objectid, rst.dbid)', 'cec_statement_object_name', ccd9, 'object_name(rst.objectid, rst.dbid)' from #018 where ccd9 = 'statement_object_name' insert into #792 select cc6e, 0, 'object_name(rst.objectid, rst.dbid)', 'cec_statement_object_name', ccd9, 'object_name(rst.objectid, rst.dbid)' from #018 where ccd9 = 'cec_statement_object_name' if (@736 = 1) begin set @baf = '(select substring(rst.text, ((case when (datalength(rst.text) - r.statement_start_offset) != abs(datalength(rst.text) - r.statement_start_offset) or (datalength(rst.text) - r.statement_end_offset) != abs(datalength(rst.text) - r.statement_end_offset) then 0 else r.statement_start_offset end) / 2) + 1, (((case when r.statement_end_offset = -1 then datalength(rst.text) when (datalength(rst.text) - r.statement_start_offset) != abs(datalength(rst.text) - r.statement_start_offset) or (datalength(rst.text) - r.statement_end_offset) != abs(datalength(rst.text) - r.statement_end_offset) then datalength(rst.text) else r.statement_end_offset end) - (case when (datalength(rst.text) - r.statement_start_offset) != abs(datalength(rst.text) - r.statement_start_offset) or (datalength(rst.text) - r.statement_end_offset) != abs(datalength(rst.text) - r.statement_end_offset) then 0 else r.statement_start_offset end)) / 2) + 1))' insert into #792 select cc6e, 1, @baf, 'cec_' + ccd9, ccd9, @baf from #018 where ccd9 = 'statement' insert into #792 select cc6e, 1, @baf, ccd9, ccd9, @baf from #018 where ccd9 = 'cec_statement' end else begin set @baf = '(select ''='' + char(13) + char(10) + case when rst.text like ''%['' + char(0) + '']%'' collate sql_latin1_general_cp850_bin2 or rst.text like ''%['' + char(1) + ''-'' + char(8) + '']%'' or rst.text like ''%['' + char(11) + '']%'' or rst.text like ''%['' + char(12) + '']%'' or rst.text like ''%['' + char(14) + ''-'' + char(31) + '']%'' then replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace((select substring(rst.text, ((case when (datalength(rst.text) - r.statement_start_offset) != abs(datalength(rst.text) - r.statement_start_offset) or (datalength(rst.text) - r.statement_end_offset) != abs(datalength(rst.text) - r.statement_end_offset) then 0 else r.statement_start_offset end) / 2) + 1, (((case when r.statement_end_offset = -1 then datalength(rst.text) when (datalength(rst.text) - r.statement_start_offset) != abs(datalength(rst.text) - r.statement_start_offset) or (datalength(rst.text) - r.statement_end_offset) != abs(datalength(rst.text) - r.statement_end_offset) then datalength(rst.text) else r.statement_end_offset end) - (case when (datalength(rst.text) - r.statement_start_offset) != abs(datalength(rst.text) - r.statement_start_offset) or (datalength(rst.text) - r.statement_end_offset) != abs(datalength(rst.text) - r.statement_end_offset) then 0 else r.statement_start_offset end)) / 2) + 1)), nchar(0), ''[nchar(0)]'' collate sql_latin1_general_cp850_bin2), nchar(1), ''[nchar(1)]''), nchar(2), ''[nchar(2)]''), nchar(3), ''[nchar(3)]''), nchar(4), ''[nchar(4)]''), nchar(5), ''[nchar(5)]''), nchar(6), ''[nchar(6)]''), nchar(7), ''[nchar(7)]''), nchar(8), ''[nchar(8)]''), nchar(11), ''[nchar(11)]''), nchar(12), ''[nchar(12)]''), nchar(14), ''[nchar(14)]''), nchar(15), ''[nchar(15)]''), nchar(16), ''[nchar(16)]''), nchar(17), ''[nchar(17)]''), nchar(18), ''[nchar(18)]''), nchar(19), ''[nchar(19)]''), nchar(20), ''[nchar(20)]''), nchar(21), ''[nchar(21)]''), nchar(22), ''[nchar(22)]''), nchar(23), ''[nchar(23)]''), nchar(24), ''[nchar(24)]''), nchar(25), ''[nchar(25)]''), nchar(26), ''[nchar(26)]''), nchar(27), ''[nchar(27)]''), nchar(28), ''[nchar(28)]''), nchar(29), ''[nchar(29)]''), nchar(30), ''[nchar(30)]''), nchar(31), ''[nchar(31)]'') else (select substring(rst.text, ((case when (datalength(rst.text) - r.statement_start_offset) != abs(datalength(rst.text) - r.statement_start_offset) or (datalength(rst.text) - r.statement_end_offset) != abs(datalength(rst.text) - r.statement_end_offset) then 0 else r.statement_start_offset end) / 2) + 1, (((case when r.statement_end_offset = -1 then datalength(rst.text) when (datalength(rst.text) - r.statement_start_offset) != abs(datalength(rst.text) - r.statement_start_offset) or (datalength(rst.text) - r.statement_end_offset) != abs(datalength(rst.text) - r.statement_end_offset) then datalength(rst.text) else r.statement_end_offset end) - (case when (datalength(rst.text) - r.statement_start_offset) != abs(datalength(rst.text) - r.statement_start_offset) or (datalength(rst.text) - r.statement_end_offset) != abs(datalength(rst.text) - r.statement_end_offset) then 0 else r.statement_start_offset end)) / 2) + 1)) end + char(13) + char(10) as [processing-instruction(s)] for xml path(''''), type)' insert into #792 select cc6e, 1, @baf, 'cec_' + ccd9, ccd9, 'cast(' + @baf + ' as nvarchar(max))' from #018 where ccd9 = 'statement' insert into #792 select cc6e, 1, @baf, ccd9, ccd9, 'cast(' + @baf + ' as nvarchar(max))' from #018 where ccd9 = 'cec_statement' end insert into #792 select cc6e, 0, case @ce7 when 0 then 'cast(tqp.query_plan as xml)' else 'tqp.query_plan' end, 'cec_' + ccd9, ccd9, case @ce7 when 0 then 'cast(tqp.query_plan as nvarchar(max))' else 'tqp.query_plan' end from #018 where ccd9 = 'text_query_plan' insert into #792 select cc6e, 0, case @ce7 when 0 then 'cast(tqp.query_plan as xml)' else 'tqp.query_plan' end, ccd9, ccd9, case @ce7 when 0 then 'cast(tqp.query_plan as nvarchar(max))' else 'tqp.query_plan' end from #018 where ccd9 = 'cec_text_query_plan' insert into #792 select cc6e, 0, case @ce7 when 0 then 'cast(ftqp.query_plan as xml)' else 'ftqp.query_plan' end, 'cec_' + ccd9, ccd9, case @ce7 when 0 then 'cast(ftqp.query_plan as nvarchar(max))' else 'ftqp.query_plan' end from #018 where ccd9 = 'full_text_query_plan' insert into #792 select cc6e, 0, case @ce7 when 0 then 'cast(ftqp.query_plan as xml)' else 'ftqp.query_plan' end, ccd9, ccd9, case @ce7 when 0 then 'cast(ftqp.query_plan as nvarchar(max))' else 'ftqp.query_plan' end from #018 where ccd9 = 'cec_full_text_query_plan' insert into #792 select cc6e, 0, 'pa.plan_attributes_info', 'cec_' + ccd9, ccd9, 'cast(pa.plan_attributes_info as nvarchar(max))' from #018 where ccd9 = 'plan_attributes_info' insert into #792 select cc6e, 0, 'pa.plan_attributes_info', ccd9, ccd9, 'cast(pa.plan_attributes_info as nvarchar(max))' from #018 where ccd9 = 'cec_plan_attributes_info' insert into #792 select cc6e, 0, 'qp.query_plan', 'cec_' + ccd9, ccd9, 'cast(qp.query_plan as nvarchar(max))' from #018 where ccd9 = 'query_plan' insert into #792 select cc6e, 0, 'qp.query_plan', ccd9, ccd9, 'cast(qp.query_plan as nvarchar(max))' from #018 where ccd9 = 'cec_query_plan' insert into #792 select cc6e, 0, 'qpc.query_plan', 'cec_' + ccd9, ccd9, 'cast(qpc.query_plan as nvarchar(max))' from #018 where ccd9 = 'query_plan_checksum' insert into #792 select cc6e, 0, 'qpc.query_plan', ccd9, ccd9, 'cast(qpc.query_plan as nvarchar(max))' from #018 where ccd9 = 'cec_query_plan_checksum' if (exists (select ccd9 from #018 where ccd9 in ('c7a_custom_info') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c99_custom_info') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_custom_info, c99_custom_info)', 'c62c_custom_info', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_custom_info' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_custom_info', 'c99_custom_info') end if (exists (select ccd9 from #018 where ccd9 in ('c7a_lock_owner_id') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c99_lock_owner_id') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_lock_owner_id, c99_lock_owner_id)', 'c62c_lock_owner_id', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_lock_owner_id' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_lock_owner_id', 'c99_lock_owner_id') end if (exists (select ccd9 from #018 where ccd9 in ('c7a_input_buffer_valid_flag') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c99_input_buffer_valid_flag') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_input_buffer_valid_flag, c99_input_buffer_valid_flag)', 'c62c_input_buffer_valid_flag', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_input_buffer_valid_flag' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_input_buffer_valid_flag', 'c99_input_buffer_valid_flag') end if (exists (select ccd9 from #018 where ccd9 in ('c7a_lock_count') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c99_lock_count') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_lock_count, c99_lock_count)', 'c62c_lock_count', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_lock_count' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_lock_count', 'c99_lock_count') end if (exists (select ccd9 from #018 where ccd9 in ('c7a_transaction_info') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c99_transaction_info') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_transaction_info, c99_transaction_info)', 'c62c_transaction_info', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_transaction_info' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_transaction_info', 'c99_transaction_info') end if (exists (select ccd9 from #018 where ccd9 in ('c7a_transaction_begin_time') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c99_transaction_begin_time') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_transaction_begin_time, c99_transaction_begin_time)', 'c62c_transaction_begin_time', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_transaction_begin_time' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_transaction_begin_time', 'c99_transaction_begin_time') end if (exists (select ccd9 from #018 where ccd9 in ('c7a_locks_info') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c99_locks_info') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_locks_info, c99_locks_info)', 'c62c_locks_info', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_locks_info' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_locks_info', 'c99_locks_info') end insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'case c7e_database_id when 0 then NULL else db_name(c7e_database_id) end', 'c7e_database_name', ccd9 from #018 where ccd9 = 'c7e_database_id' and c08c = 1 insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'case cec_database_id when 0 then NULL else db_name(cec_database_id) end', 'cec_database_name', ccd9 from #018 where ccd9 = 'cec_database_id' and c08c = 1 insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 1, ccd9, ccd9, ccd9 from #018 where ccd9 in ('cec_database_id', 'c7e_database_id') and c08c = 1 if (exists (select ccd9 from #018 where ccd9 in ('c7e_database_id') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('cec_database_id') and c08c = 0)) begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'case isnull(cec_database_id, c7e_database_id) when 0 then NULL else db_name(isnull(cec_database_id, c7e_database_id)) end', 'c17a_database_name', ccd9 from #018 where ccd9 = 'c7e_database_id' and c08c = 0 insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 1, 'isnull(cec_database_id, c7e_database_id)', 'c17a_database_id', ccd9 from #018 where ccd9 = 'c7e_database_id' and c08c = 0 end else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'case c7e_database_id when 0 then NULL else db_name(c7e_database_id) end', 'c7e_database_name', ccd9 from #018 where ccd9 = 'c7e_database_id' and c08c = 0 insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'case cec_database_id when 0 then NULL else db_name(cec_database_id) end', 'cec_database_name', ccd9 from #018 where ccd9 = 'cec_database_id' and c08c = 0 insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 1, ccd9, ccd9, ccd9 from #018 where ccd9 in ('cec_database_id', 'c7e_database_id') and c08c = 0 end if exists (select cc9a from #253 where upper(cc9a) in ('ALL')) begin if (exists (select ccd9 from #018 where ccd9 in ('c99_input_buffer_checksum') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('c7a_input_buffer_checksum') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c99_input_buffer_checksum, c7a_input_buffer_checksum)', 'c02e_input_buffer_checksum', ccd9 from #018 where ccd9 = 'c99_input_buffer_checksum' and c08c = 0 else if (exists (select ccd9 from #018 where ccd9 in ('c99_input_buffer_checksum') and c08c = 0) or exists (select ccd9 from #018 where ccd9 in ('c7a_input_buffer_checksum') and c08c = 0)) begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where ccd9 = 'c99_input_buffer_checksum' and c08c = 0 insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where ccd9 = 'c7a_input_buffer_checksum' and c08c = 0 end insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where ccd9 = 'c7a_query_plan_text_checksum' and c08c = 0 end if (exists (select ccd9 from #018 where ccd9 in ('c7a_query_stats_info') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('cb2_query_stats_info') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_query_stats_info, cb2_query_stats_info)', 'ce02_query_stats_info', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_query_stats_info' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_query_stats_info', 'cb2_query_stats_info') end if (exists (select ccd9 from #018 where ccd9 in ('c7a_trigger_stats_info') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('cb2_trigger_stats_info') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_trigger_stats_info, cb2_trigger_stats_info)', 'ce02_trigger_stats_info', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_trigger_stats_info' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_trigger_stats_info', 'cb2_trigger_stats_info') end if (exists (select ccd9 from #018 where ccd9 in ('c7a_procedure_stats_info') and c08c = 0) and exists (select ccd9 from #018 where ccd9 in ('cb2_procedure_stats_info') and c08c = 0)) insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, 'isnull(c7a_procedure_stats_info, cb2_procedure_stats_info)', 'ce02_procedure_stats_info', ccd9 from #018 where c08c = 0 and ccd9 = 'c7a_procedure_stats_info' else begin insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where c08c = 0 and ccd9 in ('c7a_procedure_stats_info', 'cb2_procedure_stats_info') end insert into #792 (cfbe, c8ef, ccd9, ce65, c57c) select cc6e, 0, ccd9, ccd9, ccd9 from #018 where ccd9 not in ('cec_database_id', 'c7e_transaction_isolation_level', 'c7a_query_plan_text_checksum', 'cec_language', 'cec_deadlock_priority', 'c7a_locks_info', 'c7a_transaction_info', 'cec_context_info', 'c7a_lock_owner_id', 'c7e_context_info', 'c7e_group_id', 'c7e_prev_error', 'c7e_database_id', 'cec_ansi_null_dflt_on', 'c7e_ansi_padding', 'cb2_query_stats_info', 'c7e_deadlock_priority', 'c99_input_buffer_checksum', 'c7a_lock_count', 'cec_ansi_warnings', 'c99_lock_count', 'c7e_arithabort', 'cec_date_first', 'cec_ansi_nulls', 'c7e_quoted_identifier', 'c99_custom_info', 'c2e_endpoint_id', 'c99_input_buffer_valid_flag', 'cec_group_id', 'cec_quoted_identifier', 'cec_concat_null_yields_null', 'c7a_procedure_stats_info', 'cec_ansi_defaults', 'c7e_language', 'c7e_date_first', 'c7a_custom_info', 'c99_locks_info', 'c7e_text_size', 'c7a_input_buffer_checksum', 'c7a_transaction_begin_time', 'cb2_trigger_stats_info', 'cec_transaction_isolation_level', 'cb2_procedure_stats_info', 'c7a_input_buffer_valid_flag', 'c99_transaction_begin_time', 'c7e_ansi_nulls', 'cec_prev_error', 'c7a_query_stats_info', 'c7e_ansi_defaults', 'c7e_ansi_null_dflt_on', 'c99_lock_owner_id', 'c7e_concat_null_yields_null', 'c7e_lock_timeout', 'c7a_trigger_stats_info', 'cec_text_size', 'cec_arithabort', 'cec_date_format', 'c7e_endpoint_id', 'cec_ansi_padding', 'cec_lock_timeout', 'c99_transaction_info', 'c7e_date_format', 'c7e_ansi_warnings', 'c7e_open_transaction_count', 'cec_open_transaction_count') and ccd9 not in (select c57c from #792) insert into #fb4 select ccd9 from (select ccd9, min(cc6e) as cc6e from #018 where ccd9 not in ('cb2_session_id', 'c7e_session_id', 'cec_full_text_query_plan', 'cec_servername', 'c2e_connection_id', 'cec_input_buffer', 'c7a_session_id', 'c2e_session_id', 'statement_object_name', 'query_plan', 'c7a_request_id', 'c2e_text', 'text', 'query_plan_checksum', 'c99_session_id', 'text_object_name', 'cec_query_plan_checksum', 'c2e_servername', 'statement', 'cec_session_id', 'cec_text_object_name', 'c7e_input_buffer', 'cec_statement_object_name', 'text_query_plan', 'cec_plan_attributes_info', 'c2e_text_object_name', 'c7e_ctime', 'full_text_query_plan', 'input_buffer', 'cec_ctime', 'cec_query_plan', 'cec_text_query_plan', 'cec_text', 'cec_request_id', 'cb2_connection_id', 'c2e_ctime', 'c7e_servername', 'cec_statement', 'cec_connection_id', 'c7a_connection_id', 'plan_attributes_info') group by ccd9) as ccd9 order by cc6e set @ec7 = '' + (select ccd9 + ', ' from #fb4 where ccd9 like 'c7e_%' or ccd9 like 'c99_%' order by cc6e for xml path('')) + '' set @bc5 = '' + (select ccd9 + ', ' from #fb4 where ccd9 like 'c2e_%' or ccd9 like 'cb2_%' order by cc6e for xml path('')) + '' set @c61 = '' + (select ccd9 + ', ' from #fb4 where ccd9 like 'cec_%' or ccd9 like 'c7a_%' order by cc6e for xml path('')) + '' if (@ec7 is NULL) set @ec7 = '' if (@bc5 is NULL) set @bc5 = '' if (@c61 is NULL) set @c61 = '' select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'Post processing took ' + cast(@a09 as nvarchar(256)) + ' ms' if (@5d0 = 1 and @355 = 0) begin select @254 = getdate() set @697 = 'use [' + db_name(@09e) + '] insert into #0d7 select ''c7e_'' + c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_sessions'' union all select ''c2e_'' + c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_connections'' union all select ''cec_'' + c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests'' union all select ''c99_'' + c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_sessions'' union all select ''cb2_'' + c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_connections'' union all select ''c7a_'' + c.name from sys.objects o inner join sys.columns c on (o.object_id = c.object_id) where o.schema_id = ' + cast (@bcc as nvarchar(256)) + ' and o.name = ''sqlws_dm_exec_requests''' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into #0d7 failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end if exists (select ccd9 from #fb4 where ccd9 not in (select c1cf from #0d7)) begin create table #12b (ccd9 nvarchar(max)) insert into #12b select ccd9 from #fb4 where ccd9 not in (select c1cf from #0d7) if (@5d0 = 1 and @b16 = 0) begin set @697 = 'use [' + db_name(@09e) + '] if exists (select ccd9 from #12b where ccd9 = ''c7e_login_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add login_time datetime if exists (select ccd9 from #12b where ccd9 = ''c7e_host_name'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add host_name nvarchar(128) if exists (select ccd9 from #12b where ccd9 = ''c7e_program_name'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add program_name nvarchar(128) if exists (select ccd9 from #12b where ccd9 = ''c7e_host_process_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add host_process_id int if exists (select ccd9 from #12b where ccd9 = ''c7e_client_version'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add client_version int if exists (select ccd9 from #12b where ccd9 = ''c7e_client_interface_name'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add client_interface_name nvarchar(32) if exists (select ccd9 from #12b where ccd9 = ''c7e_security_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add security_id varbinary(85) if exists (select ccd9 from #12b where ccd9 = ''c7e_login_name'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add login_name nvarchar(128) if exists (select ccd9 from #12b where ccd9 = ''c7e_nt_domain'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add nt_domain nvarchar(128) if exists (select ccd9 from #12b where ccd9 = ''c7e_nt_user_name'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add nt_user_name nvarchar(128) if exists (select ccd9 from #12b where ccd9 = ''c7e_status'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add status nvarchar(30) if exists (select ccd9 from #12b where ccd9 = ''c7e_context_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add context_info varbinary(128) if exists (select ccd9 from #12b where ccd9 = ''c7e_cpu_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add cpu_time int if exists (select ccd9 from #12b where ccd9 = ''c7e_memory_usage'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add memory_usage int if exists (select ccd9 from #12b where ccd9 = ''c7e_total_scheduled_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add total_scheduled_time int if exists (select ccd9 from #12b where ccd9 = ''c7e_total_elapsed_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add total_elapsed_time int if exists (select ccd9 from #12b where ccd9 = ''c7e_endpoint_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add endpoint_id int if exists (select ccd9 from #12b where ccd9 = ''c7e_last_request_start_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add last_request_start_time datetime if exists (select ccd9 from #12b where ccd9 = ''c7e_last_request_end_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add last_request_end_time datetime if exists (select ccd9 from #12b where ccd9 = ''c7e_reads'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add reads bigint if exists (select ccd9 from #12b where ccd9 = ''c7e_writes'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add writes bigint if exists (select ccd9 from #12b where ccd9 = ''c7e_logical_reads'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add logical_reads bigint if exists (select ccd9 from #12b where ccd9 = ''c7e_is_user_process'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add is_user_process bit if exists (select ccd9 from #12b where ccd9 = ''c7e_text_size'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add text_size int if exists (select ccd9 from #12b where ccd9 = ''c7e_language'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add language nvarchar(128) if exists (select ccd9 from #12b where ccd9 = ''c7e_date_format'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add date_format nvarchar(3) if exists (select ccd9 from #12b where ccd9 = ''c7e_date_first'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add date_first smallint if exists (select ccd9 from #12b where ccd9 = ''c7e_quoted_identifier'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add quoted_identifier bit if exists (select ccd9 from #12b where ccd9 = ''c7e_arithabort'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add arithabort bit if exists (select ccd9 from #12b where ccd9 = ''c7e_ansi_null_dflt_on'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add ansi_null_dflt_on bit if exists (select ccd9 from #12b where ccd9 = ''c7e_ansi_defaults'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add ansi_defaults bit if exists (select ccd9 from #12b where ccd9 = ''c7e_ansi_warnings'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add ansi_warnings bit if exists (select ccd9 from #12b where ccd9 = ''c7e_ansi_padding'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add ansi_padding bit if exists (select ccd9 from #12b where ccd9 = ''c7e_ansi_nulls'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add ansi_nulls bit if exists (select ccd9 from #12b where ccd9 = ''c7e_concat_null_yields_null'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add concat_null_yields_null bit if exists (select ccd9 from #12b where ccd9 = ''c7e_transaction_isolation_level'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add transaction_isolation_level smallint if exists (select ccd9 from #12b where ccd9 = ''c7e_lock_timeout'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add lock_timeout int if exists (select ccd9 from #12b where ccd9 = ''c7e_deadlock_priority'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add deadlock_priority int if exists (select ccd9 from #12b where ccd9 = ''c7e_row_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add row_count bigint if exists (select ccd9 from #12b where ccd9 = ''c7e_prev_error'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add prev_error int if exists (select ccd9 from #12b where ccd9 = ''c7e_original_security_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add original_security_id varbinary(85) if exists (select ccd9 from #12b where ccd9 = ''c7e_original_login_name'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add original_login_name nvarchar(128) if exists (select ccd9 from #12b where ccd9 = ''c7e_last_successful_logon'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add last_successful_logon datetime if exists (select ccd9 from #12b where ccd9 = ''c7e_last_unsuccessful_logon'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add last_unsuccessful_logon datetime if exists (select ccd9 from #12b where ccd9 = ''c7e_unsuccessful_logons'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add unsuccessful_logons bigint if exists (select ccd9 from #12b where ccd9 = ''c7e_group_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add group_id int if exists (select ccd9 from #12b where ccd9 = ''c7e_database_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add database_id smallint if exists (select ccd9 from #12b where ccd9 = ''c7e_authenticating_database_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add authenticating_database_id int if exists (select ccd9 from #12b where ccd9 = ''c7e_open_transaction_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add open_transaction_count int' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] if exists (select ccd9 from #12b where ccd9 = ''c2e_most_recent_session_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add most_recent_session_id int if exists (select ccd9 from #12b where ccd9 = ''c2e_connect_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add connect_time datetime if exists (select ccd9 from #12b where ccd9 = ''c2e_net_transport'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add net_transport nvarchar(40) if exists (select ccd9 from #12b where ccd9 = ''c2e_protocol_type'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add protocol_type nvarchar(40) if exists (select ccd9 from #12b where ccd9 = ''c2e_protocol_version'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add protocol_version int if exists (select ccd9 from #12b where ccd9 = ''c2e_endpoint_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add endpoint_id int if exists (select ccd9 from #12b where ccd9 = ''c2e_encrypt_option'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add encrypt_option nvarchar(40) if exists (select ccd9 from #12b where ccd9 = ''c2e_auth_scheme'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add auth_scheme nvarchar(40) if exists (select ccd9 from #12b where ccd9 = ''c2e_node_affinity'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add node_affinity smallint if exists (select ccd9 from #12b where ccd9 = ''c2e_num_reads'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add num_reads int if exists (select ccd9 from #12b where ccd9 = ''c2e_num_writes'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add num_writes int if exists (select ccd9 from #12b where ccd9 = ''c2e_last_read'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add last_read datetime if exists (select ccd9 from #12b where ccd9 = ''c2e_last_write'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add last_write datetime if exists (select ccd9 from #12b where ccd9 = ''c2e_net_packet_size'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add net_packet_size int if exists (select ccd9 from #12b where ccd9 = ''c2e_client_net_address'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add client_net_address varchar(48) if exists (select ccd9 from #12b where ccd9 = ''c2e_client_tcp_port'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add client_tcp_port int if exists (select ccd9 from #12b where ccd9 = ''c2e_local_net_address'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add local_net_address varchar(48) if exists (select ccd9 from #12b where ccd9 = ''c2e_local_tcp_port'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add local_tcp_port int if exists (select ccd9 from #12b where ccd9 = ''c2e_parent_connection_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add parent_connection_id uniqueidentifier if exists (select ccd9 from #12b where ccd9 = ''c2e_most_recent_sql_handle'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add most_recent_sql_handle varbinary(64)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] if exists (select ccd9 from #12b where ccd9 = ''cec_start_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add start_time datetime if exists (select ccd9 from #12b where ccd9 = ''cec_status'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add status nvarchar(30) if exists (select ccd9 from #12b where ccd9 = ''cec_command'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add command nvarchar(32) if exists (select ccd9 from #12b where ccd9 = ''cec_sql_handle'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add sql_handle varbinary(64) if exists (select ccd9 from #12b where ccd9 = ''cec_statement_start_offset'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add statement_start_offset int if exists (select ccd9 from #12b where ccd9 = ''cec_statement_end_offset'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add statement_end_offset int if exists (select ccd9 from #12b where ccd9 = ''cec_plan_handle'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add plan_handle varbinary(64) if exists (select ccd9 from #12b where ccd9 = ''cec_database_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add database_id smallint if exists (select ccd9 from #12b where ccd9 = ''cec_user_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add user_id int if exists (select ccd9 from #12b where ccd9 = ''cec_blocking_session_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add blocking_session_id smallint if exists (select ccd9 from #12b where ccd9 = ''cec_wait_type'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add wait_type nvarchar(60) if exists (select ccd9 from #12b where ccd9 = ''cec_wait_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add wait_time int if exists (select ccd9 from #12b where ccd9 = ''cec_last_wait_type'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add last_wait_type nvarchar(60) if exists (select ccd9 from #12b where ccd9 = ''cec_wait_resource'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add wait_resource nvarchar(256) if exists (select ccd9 from #12b where ccd9 = ''cec_open_transaction_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add open_transaction_count int if exists (select ccd9 from #12b where ccd9 = ''cec_open_resultset_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add open_resultset_count int if exists (select ccd9 from #12b where ccd9 = ''cec_transaction_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add transaction_id bigint if exists (select ccd9 from #12b where ccd9 = ''cec_context_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add context_info varbinary(128) if exists (select ccd9 from #12b where ccd9 = ''cec_percent_complete'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add percent_complete real if exists (select ccd9 from #12b where ccd9 = ''cec_estimated_completion_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add estimated_completion_time bigint if exists (select ccd9 from #12b where ccd9 = ''cec_cpu_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add cpu_time int if exists (select ccd9 from #12b where ccd9 = ''cec_total_elapsed_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add total_elapsed_time int if exists (select ccd9 from #12b where ccd9 = ''cec_scheduler_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add scheduler_id int if exists (select ccd9 from #12b where ccd9 = ''cec_task_address'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add task_address varbinary(8) if exists (select ccd9 from #12b where ccd9 = ''cec_reads'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add reads bigint if exists (select ccd9 from #12b where ccd9 = ''cec_writes'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add writes bigint if exists (select ccd9 from #12b where ccd9 = ''cec_logical_reads'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add logical_reads bigint if exists (select ccd9 from #12b where ccd9 = ''cec_text_size'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add text_size int if exists (select ccd9 from #12b where ccd9 = ''cec_language'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add language nvarchar(128) if exists (select ccd9 from #12b where ccd9 = ''cec_date_format'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add date_format nvarchar(3) if exists (select ccd9 from #12b where ccd9 = ''cec_date_first'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add date_first smallint if exists (select ccd9 from #12b where ccd9 = ''cec_quoted_identifier'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add quoted_identifier bit if exists (select ccd9 from #12b where ccd9 = ''cec_arithabort'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add arithabort bit if exists (select ccd9 from #12b where ccd9 = ''cec_ansi_null_dflt_on'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add ansi_null_dflt_on bit if exists (select ccd9 from #12b where ccd9 = ''cec_ansi_defaults'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add ansi_defaults bit if exists (select ccd9 from #12b where ccd9 = ''cec_ansi_warnings'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add ansi_warnings bit if exists (select ccd9 from #12b where ccd9 = ''cec_ansi_padding'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add ansi_padding bit if exists (select ccd9 from #12b where ccd9 = ''cec_ansi_nulls'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add ansi_nulls bit if exists (select ccd9 from #12b where ccd9 = ''cec_concat_null_yields_null'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add concat_null_yields_null bit if exists (select ccd9 from #12b where ccd9 = ''cec_transaction_isolation_level'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add transaction_isolation_level smallint if exists (select ccd9 from #12b where ccd9 = ''cec_lock_timeout'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add lock_timeout int if exists (select ccd9 from #12b where ccd9 = ''cec_deadlock_priority'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add deadlock_priority int if exists (select ccd9 from #12b where ccd9 = ''cec_row_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add row_count bigint if exists (select ccd9 from #12b where ccd9 = ''cec_prev_error'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add prev_error int if exists (select ccd9 from #12b where ccd9 = ''cec_nest_level'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add nest_level int if exists (select ccd9 from #12b where ccd9 = ''cec_granted_query_memory'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add granted_query_memory int if exists (select ccd9 from #12b where ccd9 = ''cec_executing_managed_code'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add executing_managed_code bit if exists (select ccd9 from #12b where ccd9 = ''cec_group_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add group_id int if exists (select ccd9 from #12b where ccd9 = ''cec_query_hash'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_hash binary(8) if exists (select ccd9 from #12b where ccd9 = ''cec_query_plan_hash'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_plan_hash binary(8) if exists (select ccd9 from #12b where ccd9 = ''cec_statement_sql_handle'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add statement_sql_handle varbinary(64) if exists (select ccd9 from #12b where ccd9 = ''cec_statement_context_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add statement_context_id bigint' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] if exists (select ccd9 from #12b where ccd9 = ''c99_job_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add job_info xml if exists (select ccd9 from #12b where ccd9 = ''c99_is_blocker'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add is_blocker bit if exists (select ccd9 from #12b where ccd9 = ''c99_is_head_blocker'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add is_head_blocker bit if exists (select ccd9 from #12b where ccd9 = ''c99_blocked_session_ids'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add blocked_session_ids nvarchar(max) if exists (select ccd9 from #12b where ccd9 = ''c99_input_buffer_checksum'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add input_buffer_checksum int if exists (select ccd9 from #12b where ccd9 = ''c99_input_buffer_valid_flag'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add input_buffer_valid_flag bit if exists (select ccd9 from #12b where ccd9 = ''c99_lock_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add lock_count int if exists (select ccd9 from #12b where ccd9 = ''c99_lock_owner_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add lock_owner_id bigint if exists (select ccd9 from #12b where ccd9 = ''c99_locks_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add locks_info xml if exists (select ccd9 from #12b where ccd9 = ''c99_transaction_begin_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add transaction_begin_time datetime if exists (select ccd9 from #12b where ccd9 = ''c99_transaction_log_record_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add transaction_log_record_count int if exists (select ccd9 from #12b where ccd9 = ''c99_transaction_log_bytes_used'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add transaction_log_bytes_used bigint if exists (select ccd9 from #12b where ccd9 = ''c99_transaction_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add transaction_info xml if exists (select ccd9 from #12b where ccd9 = ''c99_session_tempdb_usage_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add session_tempdb_usage_kb int if exists (select ccd9 from #12b where ccd9 = ''c99_session_max_tempdb_usage_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add session_max_tempdb_usage_kb int if exists (select ccd9 from #12b where ccd9 = ''c99_session_tempdb_usage_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add session_tempdb_usage_info xml if exists (select ccd9 from #12b where ccd9 = ''c99_cursor_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add cursor_count int if exists (select ccd9 from #12b where ccd9 = ''c99_max_cursor_dormant_duration'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add max_cursor_dormant_duration bigint if exists (select ccd9 from #12b where ccd9 = ''c99_cursors_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add cursors_info xml if exists (select ccd9 from #12b where ccd9 = ''c99_waiting_tasks_wait_types'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add waiting_tasks_wait_types nvarchar(max) if exists (select ccd9 from #12b where ccd9 = ''c99_waiting_tasks_max_wait_duration_ms'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add waiting_tasks_max_wait_duration_ms bigint if exists (select ccd9 from #12b where ccd9 = ''c99_waiting_tasks_blocking_session_ids'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add waiting_tasks_blocking_session_ids nvarchar(max) if exists (select ccd9 from #12b where ccd9 = ''c99_waiting_tasks_valid_flag'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add waiting_tasks_valid_flag bit if exists (select ccd9 from #12b where ccd9 = ''c99_waiting_tasks_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add waiting_tasks_info xml if exists (select ccd9 from #12b where ccd9 = ''c99_service_broker_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add service_broker_info xml if exists (select ccd9 from #12b where ccd9 = ''c99_sp_whopro_inputparameters'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add sp_whopro_inputparameters nvarchar(max) if exists (select ccd9 from #12b where ccd9 = ''c99_custom_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions add custom_info nvarchar(max)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] if exists (select ccd9 from #12b where ccd9 = ''cb2_query_stats_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add query_stats_info xml if exists (select ccd9 from #12b where ccd9 = ''cb2_procedure_stats_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add procedure_stats_info xml if exists (select ccd9 from #12b where ccd9 = ''cb2_trigger_stats_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections add trigger_stats_info xml' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_connections failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @697 = 'use [' + db_name(@09e) + '] if exists (select ccd9 from #12b where ccd9 = ''c7a_is_blocked'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add is_blocked bit if exists (select ccd9 from #12b where ccd9 = ''c7a_is_dead_locked'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add is_dead_locked bit if exists (select ccd9 from #12b where ccd9 = ''c7a_blocker_session_ids'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add blocker_session_ids nvarchar(max) if exists (select ccd9 from #12b where ccd9 = ''c7a_head_blocker_session_ids'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add head_blocker_session_ids nvarchar(max) if exists (select ccd9 from #12b where ccd9 = ''c7a_input_buffer_checksum'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add input_buffer_checksum int if exists (select ccd9 from #12b where ccd9 = ''c7a_input_buffer_valid_flag'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add input_buffer_valid_flag bit if exists (select ccd9 from #12b where ccd9 = ''c7a_wait_resource_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add wait_resource_info nvarchar(max) if exists (select ccd9 from #12b where ccd9 = ''c7a_lock_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add lock_count int if exists (select ccd9 from #12b where ccd9 = ''c7a_lock_owner_id'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add lock_owner_id bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_locks_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add locks_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_transaction_begin_time'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add transaction_begin_time datetime if exists (select ccd9 from #12b where ccd9 = ''c7a_transaction_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add transaction_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_task_tempdb_usage_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add task_tempdb_usage_kb int if exists (select ccd9 from #12b where ccd9 = ''c7a_task_max_tempdb_usage_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add task_max_tempdb_usage_kb int if exists (select ccd9 from #12b where ccd9 = ''c7a_task_tempdb_usage_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add task_tempdb_usage_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_query_memory_grants_requested_memory_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_memory_grants_requested_memory_kb bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_memory_grants_granted_memory_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_memory_grants_granted_memory_kb bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_memory_grants_used_memory_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_memory_grants_used_memory_kb bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_memory_grants_max_used_memory_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_memory_grants_max_used_memory_kb bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_memory_grants_wait_time_ms'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_memory_grants_wait_time_ms bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_memory_grants_ideal_memory_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_memory_grants_ideal_memory_kb bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_memory_grants_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_memory_grants_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_query_profiles_cpu_time_ms'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_profiles_cpu_time_ms bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_profiles_logical_read_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_profiles_logical_read_count bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_profiles_physical_read_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_profiles_physical_read_count bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_profiles_read_ahead_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_profiles_read_ahead_count bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_profiles_write_page_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_profiles_write_page_count bigint if exists (select ccd9 from #12b where ccd9 = ''c7a_query_profiles_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_profiles_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_query_stats_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_stats_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_procedure_stats_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add procedure_stats_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_trigger_stats_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add trigger_stats_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_cached_plans_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add cached_plans_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_tasks_count'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add tasks_count int if exists (select ccd9 from #12b where ccd9 = ''c7a_tasks_context_switches'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add tasks_context_switches int if exists (select ccd9 from #12b where ccd9 = ''c7a_tasks_pending_io'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add tasks_pending_io int if exists (select ccd9 from #12b where ccd9 = ''c7a_tasks_io_size_kb'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add tasks_io_size_kb int if exists (select ccd9 from #12b where ccd9 = ''c7a_read_bytes_per_second'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add read_bytes_per_second int if exists (select ccd9 from #12b where ccd9 = ''c7a_tasks_ios_per_second'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add tasks_ios_per_second int if exists (select ccd9 from #12b where ccd9 = ''c7a_tasks_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add tasks_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_workers_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add workers_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_threads_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add threads_info xml if exists (select ccd9 from #12b where ccd9 = ''c7a_query_plan_text_checksum'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add query_plan_text_checksum int if exists (select ccd9 from #12b where ccd9 = ''c7a_custom_info'') ' set @697 = @697 + 'alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests add custom_info nvarchar(max)' exec @8e3 = sp_executesql @697 if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] alter table [' + schema_name(@bcc) + '].sqlws_dm_exec_requests failed: sp_executesql N''' + @697 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end end end set @ec7 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions (servername, session_id, ' + replace(replace(@ec7, 'c7e_', ''), 'c99_', '') + 'ctime' + ') select @@servername, s.session_id, ' + replace(replace(@ec7, 'c7e_', 's.'), 'c99_', 'si.') + '@datetime from #9de s inner join #c05 si on (s.session_id = si.session_id)' exec @8e3 = sp_executesql @ec7, N'@datetime datetime', @datetime if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions failed: sp_executesql N''' + @ec7 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @bc5 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_connections (servername, session_id, connection_id, ' + replace(replace(@bc5, 'c2e_', ''), 'cb2_', '') + 'ctime' + ') select @@servername, c.session_id, c.connection_id, ' + replace(replace(@bc5, 'c2e_', 'c.'), 'cb2_', 'ci.') + '@datetime from #dd0 c inner join #b39 ci on (c.session_id = ci.session_id and c.connection_id = ci.connection_id)' exec @8e3 = sp_executesql @bc5, N'@datetime datetime', @datetime if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_connections failed: sp_executesql N''' + @bc5 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @c61 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_requests (servername, session_id, request_id, connection_id, ' + replace(replace(@c61, 'cec_', ''), 'c7a_', '') + 'ctime' + ') select @@servername, r.session_id, r.request_id, r.connection_id, ' + replace(replace(@c61, 'cec_', 'r.'), 'c7a_', 'ri.') + '@datetime from #091 r inner join #0ed ri on (r.session_id = ri.session_id and r.request_id = ri.request_id)' exec @8e3 = sp_executesql @c61, N'@datetime datetime', @datetime if (@8e3 <> 0) begin set @ea1 = 'use [' + db_name(@09e) + '] insert into [' + schema_name(@bcc) + '].sqlws_dm_exec_requests failed: sp_executesql N''' + @c61 + '''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'Insert into sqlws_dm_exec_... tables took ' + cast(@a09 as nvarchar(256)) + ' ms' end insert into #792 values (0, 0, 'c7e_session_id', 's.session_id', 'c7e_session_id', 's.session_id') declare @7c9 int select @7c9 = max(cfbe) + 1 from #792 insert into #792 values (@7c9 + 1, 0, 'cec_request_id', 'r.request_id', 'cec_request_id', 'r.request_id') insert into #792 values (@7c9 + 2, 0, 'c2e_connection_id', 'c.connection_id', 'c2e_connection_id', 'c.connection_id') if (@5d0 = 1 or @355 = 1) insert into #792 values (@7c9 + 3, 0, 'c7e_ctime', 's.ctime', 'c7e_ctime', 's.ctime') update #792 set ccd9 = replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(ccd9, 'c02e_', 'sr.'), 'c0c4_', 'cs.'), 'c17a_', 'rs.'), 'c5cd_', 'rc.'), 'c6ae_', 'cs.'), 'c62c_', 'rs.'), 'ce02_', 'rc.'), 'c7e_', 's.'), 'c99_', 's.'), 'c2e_', 'c.'), 'cb2_', 'c.'), 'cec_', 'r.'), 'c7a_', 'r.'), ce65 = replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(ce65, 'c02e_', 'sr.'), 'c0c4_', 'cs.'), 'c17a_', 'rs.'), 'c5cd_', 'rc.'), 'c6ae_', 'cs.'), 'c62c_', 'rs.'), 'ce02_', 'rc.'), 'c7e_', 's.'), 'c99_', 's.'), 'c2e_', 'c.'), 'cb2_', 'c.'), 'cec_', 'r.'), 'c7a_', 'r.') set @697 = (select ccd9 + ' as ''' + ce65 + '''' + case row_number() over (order by cfbe, c8ef) when count(*) over () then '' else ', ' end from #792 order by cfbe, c8ef for xml path('')) update #792 set c06a = 'cast(' + ccd9 + ' as nvarchar(max))' where ccd9 like '%job_info%' or ccd9 like '%locks_info%' or ccd9 like '%transaction_info%' or ccd9 like '%session_tempdb_usage_info%' or ccd9 like '%cursors_info%' or ccd9 like '%waiting_tasks_info%' or ccd9 like '%service_broker_info%' or ccd9 like '%query_stats_info%' or ccd9 like '%procedure_stats_info%' or ccd9 like '%trigger_stats_info%' or ccd9 like '%locks_info%' or ccd9 like '%transaction_info%' or ccd9 like '%task_tempdb_usage_info%' or ccd9 like '%query_memory_grants_info%' or ccd9 like '%query_profiles_info%' or ccd9 like '%query_stats_info%' or ccd9 like '%procedure_stats_info%' or ccd9 like '%trigger_stats_info%' or ccd9 like '%cached_plans_info%' or ccd9 like '%tasks_info%' or ccd9 like '%workers_info%' or ccd9 like '%threads_info%' update #792 set c06a = ccd9 where c06a is NULL declare @734 nvarchar(max) declare @fc6 xml create table #149 (cc6e int identity, ccd9 nvarchar(max), ce65 nvarchar(max)) set @734 = replace(replace(replace(@order_by, char(13), ' '), char(10), ' '), '	', ' ') while (charindex('  ', @734) <> 0) set @734 = replace(@734, '  ', ' ') if (@734 = ' ') set @order_by = NULL if (@order_by is not NULL and ltrim(rtrim(upper(@order_by))) <> 'HELP') begin select @254 = getdate() set @order_by = replace(replace(replace(@order_by, char(13), ' '), char(10), ' '), '	', ' ') while (charindex('  ', @order_by) <> 0) set @order_by = replace(@order_by, '  ', ' ') set @fc6 = N'<r>' + replace(lower(@order_by), ',', '</r><r>') + '</r>' insert into #149 (ce65) select ltrim(rtrim(c.value('.', 'nvarchar(max)'))) from @fc6.nodes('r') as t(c) delete #149 where ce65 is NULL or ce65 = '' if exists (select ce65 from #149) begin if exists (select ce65 from #149 where ce65 not in (select ce65 from #792 union select ce65 + ' asc ' from #792 union select ce65 + ' desc ' from #792)) begin set @ea1 = 'Invalid column alias ''' + (select ce65 + case row_number() over (order by cc6e) when count(*) over () then '' else ', ' end from #149 where ce65 not in (select ce65 from #792 union select ce65 + ' asc ' from #792 union select ce65 + ' desc ' from #792) order by cc6e for xml path('')) + ''' for @order_by specified' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end update #149 set ccd9 = s.c06a from #149 o inner join #792 s on (o.ce65 = s.ce65) update #149 set ccd9 = s.c06a + ' asc' from #149 o inner join #792 s on (o.ce65 = s.ce65 + ' asc') update #149 set ccd9 = s.c06a + ' desc' from #149 o inner join #792 s on (o.ce65 = s.ce65 + ' desc') if exists (select ce65 from #149 where ccd9 is NULL) begin set @ea1 = 'Invalid column alias ''' + (select ce65 + case row_number() over (order by cc6e) when count(*) over () then '' else ', ' end from #149 where ccd9 is NULL order by cc6e for xml path('')) + ''' for @order_by specified' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end set @734 = (select ccd9 + case row_number() over (order by cc6e) when count(*) over () then '' else ', ' end from #149 order by cc6e for xml path('')) end else set @734 = NULL select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'Parsing parameter step 2 took ' + cast(@a09 as nvarchar(256)) + ' ms' end if (@5d0 = 1 or @355 = 1) begin set @697 = 'select ' + @697 + ' from [' + schema_name(@bcc) + '].sqlws_dm_exec_sessions s left join [' + schema_name(@bcc) + '].sqlws_dm_exec_connections c on ((s.servername = c.servername) and (s.session_id = c.session_id and s.ctime = c.ctime)) left join [' + schema_name(@bcc) + '].sqlws_dm_exec_requests r on ((s.servername = r.servername) and ((c.session_id = r.session_id and c.connection_id = r.connection_id and c.ctime = r.ctime) or (s.session_id = r.session_id and c.connection_id is NULL and s.ctime = r.ctime)))' if exists (select c35f from #2ff where c35f in ('input_buffer')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_input_buffer ibsr on ((s.servername = ibsr.servername) and ((s.input_buffer_checksum =ibsr.checksum) or (r.input_buffer_checksum =ibsr.checksum)))' if exists (select c35f from #2ff where c35f in ('c7e_input_buffer')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_input_buffer ibs on ((s.servername = ibs.servername) and (s.input_buffer_checksum = ibs.checksum))' if exists (select c35f from #2ff where c35f in ('cec_input_buffer')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_input_buffer ibr on ((s.servername = ibr.servername) and (r.input_buffer_checksum =ibr.checksum))' if exists (select c35f from #2ff where c35f in ('text_object_name', 'text', 'c2e_text_object_name', 'c2e_text', 'cec_text_object_name', 'cec_text')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text rst on ((s.servername = rst.servername) and (r.sql_handle = rst.sql_handle)) left join [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text cst on ((s.servername = rst.servername) and (c.most_recent_sql_handle = cst.sql_handle))' if exists (select c35f from #2ff where c35f in ('statement_object_name', 'statement', 'cec_statement_object_name', 'cec_statement')) if not exists (select c35f from #2ff where c35f in ('text_object_name', 'text', 'c2e_text_object_name', 'c2e_text', 'cec_text_object_name', 'cec_text')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_dm_exec_sql_text rst on ((s.servername = rst.servername) and (r.sql_handle = rst.sql_handle))' if exists (select c35f from #2ff where c35f in ('query_plan', 'cec_query_plan')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan qp on ((s.servername = qp.servername) and (r.plan_handle = qp.plan_handle))' if exists (select c35f from #2ff where c35f in ('query_plan_checksum', 'cec_query_plan_checksum')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_dm_exec_query_plan_checksum qpc on ((s.servername = qpc.servername) and (r.query_plan_text_checksum = qpc.checksum))' if exists (select c35f from #2ff where c35f in ('text_query_plan', 'cec_text_query_plan')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan tqp on ((s.servername = tqp.servername) and (r.plan_handle = tqp.plan_handle and r.statement_start_offset = tqp.statement_start_offset and r.statement_end_offset = tqp.statement_end_offset))' if exists (select c35f from #2ff where c35f in ('full_text_query_plan', 'cec_full_text_query_plan')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_dm_exec_text_query_plan ftqp on ((s.servername = ftqp.servername) and (r.plan_handle = ftqp.plan_handle and ftqp.statement_start_offset = 0 and ftqp.statement_end_offset = -1))' if exists (select c35f from #2ff where c35f in ('plan_attributes_info', 'cec_plan_attributes_info')) set @697 = @697 + ' left join [' + schema_name(@bcc) + '].sqlws_dm_exec_plan_attributes pa on ((s.servername = pa.servername) and (r.plan_handle = pa.plan_handle))' end else begin set @697 = 'select ' + @697 + ' from (select s.session_id, s.login_time, s.host_name, s.program_name, s.host_process_id, s.client_version, s.client_interface_name, s.security_id, s.login_name, s.nt_domain, s.nt_user_name, s.status, s.context_info, s.cpu_time, s.memory_usage, s.total_scheduled_time, s.total_elapsed_time, s.endpoint_id, s.last_request_start_time, s.last_request_end_time, s.reads, s.writes, s.logical_reads, s.is_user_process, s.text_size, s.language, s.date_format, s.date_first, s.quoted_identifier, s.arithabort, s.ansi_null_dflt_on, s.ansi_defaults, s.ansi_warnings, s.ansi_padding, s.ansi_nulls, s.concat_null_yields_null, s.transaction_isolation_level, s.lock_timeout, s.deadlock_priority, s.row_count, s.prev_error, s.original_security_id, s.original_login_name, s.last_successful_logon, s.last_unsuccessful_logon, s.unsuccessful_logons, s.group_id, s.database_id, s.authenticating_database_id, s.open_transaction_count, si.job_info, si.is_blocker, si.is_head_blocker, si.blocked_session_ids, si.input_buffer_checksum, si.input_buffer_valid_flag, si.lock_count, si.lock_owner_id, si.locks_info, si.transaction_begin_time, si.transaction_log_record_count, si.transaction_log_bytes_used, si.transaction_info, si.session_tempdb_usage_kb, si.session_max_tempdb_usage_kb, si.session_tempdb_usage_info, si.cursor_count, si.max_cursor_dormant_duration, si.cursors_info, si.waiting_tasks_wait_types, si.waiting_tasks_max_wait_duration_ms, si.waiting_tasks_blocking_session_ids, si.waiting_tasks_valid_flag, si.waiting_tasks_info, si.service_broker_info, si.sp_whopro_inputparameters, si.custom_info from #9de s inner join #c05 si on (s.session_id = si.session_id)) s ' set @697 = @697 + 'left join (select c.session_id, c.most_recent_session_id, c.connect_time, c.net_transport, c.protocol_type, c.protocol_version, c.endpoint_id, c.encrypt_option, c.auth_scheme, c.node_affinity, c.num_reads, c.num_writes, c.last_read, c.last_write, c.net_packet_size, c.client_net_address, c.client_tcp_port, c.local_net_address, c.local_tcp_port, c.connection_id, c.parent_connection_id, c.most_recent_sql_handle, ci.query_stats_info, ci.procedure_stats_info, ci.trigger_stats_info from #dd0 c inner join #b39 ci on (c.session_id = ci.session_id and c.connection_id = ci.connection_id)) c on (s.session_id = c.session_id) ' set @697 = @697 + 'left join (select r.session_id, r.request_id, r.start_time, r.status, r.command, r.sql_handle, r.statement_start_offset, r.statement_end_offset, r.plan_handle, r.database_id, r.user_id, r.connection_id, r.blocking_session_id, r.wait_type, r.wait_time, r.last_wait_type, r.wait_resource, r.open_transaction_count, r.open_resultset_count, r.transaction_id, r.context_info, r.percent_complete, r.estimated_completion_time, r.cpu_time, r.total_elapsed_time, r.scheduler_id, r.task_address, r.reads, r.writes, r.logical_reads, r.text_size, r.language, r.date_format, r.date_first, r.quoted_identifier, r.arithabort, r.ansi_null_dflt_on, r.ansi_defaults, r.ansi_warnings, r.ansi_padding, r.ansi_nulls, r.concat_null_yields_null, r.transaction_isolation_level, r.lock_timeout, r.deadlock_priority, r.row_count, r.prev_error, r.nest_level, r.granted_query_memory, r.executing_managed_code, r.group_id, r.query_hash, r.query_plan_hash, r.statement_sql_handle, r.statement_context_id, ri.is_blocked, ri.is_dead_locked, ri.blocker_session_ids, ri.head_blocker_session_ids, ri.input_buffer_checksum, ri.input_buffer_valid_flag, ri.wait_resource_info, ri.lock_count, ri.lock_owner_id, ri.locks_info, ri.transaction_begin_time, ri.transaction_info, ri.task_tempdb_usage_kb, ri.task_max_tempdb_usage_kb, ri.task_tempdb_usage_info, ri.query_memory_grants_requested_memory_kb, ri.query_memory_grants_granted_memory_kb, ri.query_memory_grants_used_memory_kb, ri.query_memory_grants_max_used_memory_kb, ri.query_memory_grants_wait_time_ms, ri.query_memory_grants_ideal_memory_kb, ri.query_memory_grants_info, ri.query_profiles_cpu_time_ms, ri.query_profiles_logical_read_count, ri.query_profiles_physical_read_count, ri.query_profiles_read_ahead_count, ri.query_profiles_write_page_count, ri.query_profiles_info, ri.query_stats_info, ri.procedure_stats_info, ri.trigger_stats_info, ri.cached_plans_info, ri.tasks_count, ri.tasks_context_switches, ri.tasks_pending_io, ri.tasks_io_size_kb, ri.read_bytes_per_second, ri.tasks_ios_per_second, ri.tasks_info, ri.workers_info, ri.threads_info, ri.query_plan_text_checksum, ri.custom_info from #091 r inner join #0ed ri on (r.session_id = ri.session_id and r.request_id = ri.request_id)) r on ((c.session_id = r.session_id and c.connection_id = r.connection_id) or (s.session_id = r.session_id and c.connection_id is NULL)) ' if exists (select c35f from #2ff where c35f in ('input_buffer')) set @697 = @697 + ' left join #384 ibsr on ((s.input_buffer_checksum = ibsr.checksum) or (r.input_buffer_checksum = ibsr.checksum))' if exists (select c35f from #2ff where c35f in ('c7e_input_buffer')) set @697 = @697 + ' left join #384 ibs on (s.input_buffer_checksum = ibs.checksum)' if exists (select c35f from #2ff where c35f in ('cec_input_buffer')) set @697 = @697 + ' left join #384 ibr on (r.input_buffer_checksum =ibr.checksum)' if exists (select c35f from #2ff where c35f in ('text_object_name', 'text', 'c2e_text_object_name', 'c2e_text', 'cec_text_object_name', 'cec_text')) set @697 = @697 + ' left join #fbf rst on (r.sql_handle = rst.sql_handle) left join #fbf cst on (c.most_recent_sql_handle = cst.sql_handle)' if exists (select c35f from #2ff where c35f in ('statement_object_name', 'statement', 'cec_statement_object_name', 'cec_statement')) if not exists (select c35f from #2ff where c35f in ('text_object_name', 'text', 'c2e_text_object_name', 'c2e_text', 'cec_text_object_name', 'cec_text')) set @697 = @697 + ' left join #fbf rst on (r.sql_handle = rst.sql_handle)' if exists (select c35f from #2ff where c35f in ('query_plan', 'cec_query_plan')) set @697 = @697 + ' left join #f20 qp on (r.plan_handle = qp.plan_handle)' if exists (select c35f from #2ff where c35f in ('query_plan_checksum', 'cec_query_plan_checksum')) set @697 = @697 + ' left join #eef qpc on (r.query_plan_text_checksum = qpc.checksum)' if exists (select c35f from #2ff where c35f in ('text_query_plan', 'cec_text_query_plan')) set @697 = @697 + ' left join #164 tqp on (r.plan_handle = tqp.plan_handle and r.statement_start_offset = tqp.statement_start_offset and r.statement_end_offset = tqp.statement_end_offset)' if exists (select c35f from #2ff where c35f in ('full_text_query_plan', 'cec_full_text_query_plan')) set @697 = @697 + ' left join #164 ftqp on (r.plan_handle = ftqp.plan_handle and ftqp.statement_start_offset = 0 and ftqp.statement_end_offset = -1)' if exists (select c35f from #2ff where c35f in ('plan_attributes_info', 'cec_plan_attributes_info')) set @697 = @697 + ' left join #ca5 pa on (r.plan_handle = pa.plan_handle)' end if (@20e = 1 and @355 = 1) begin select cmd from (select 'use [' + case @09e when 0 then db_name(db_id()) else db_name(@09e) end + ']' as cmd, 1 as id union all select @697, 2 union all select case when @datetime_to is NULL then '	where s.ctime = ''' + convert(sysname, @datetime, 21) + '''' else '	where s.ctime between ''' + convert(sysname, @datetime, 21) + ''' and ''' + convert(sysname, @datetime_to, 21) + '''' end, 3 union all select case when @734 is NULL then '	order by s.ctime, s.session_id' else '	order by ' + @734 end, 4 union all select 'go', 5 union all select '', 6) as t order by id end else begin set @8e3 = 0 select @254 = getdate() if (@5d0 = 0 and @355 = 0) begin if (ltrim(rtrim(upper(@order_by))) = 'HELP') select 'exec sp_executesql N''' + replace(@697, '''', '''''') + '''' as 'Help to choose column aliases for order by from select clause' else if (@734 is NULL) begin set @697 = @697 + ' order by s.session_id' exec @8e3 = sp_executesql @697 end else begin set @697 = @697 + ' order by ' + @734 exec @8e3 = sp_executesql @697 end end else if (@20e = 0) begin set @697 = 'use [' + db_name(@09e) + '] ' + @697 if (ltrim(rtrim(upper(@order_by))) = 'HELP') if (@datetime_to is NULL) select 'exec sp_executesql N''' + replace(@697, '''', '''''') + ' where s.ctime = @datetime'', N''@datetime datetime'', @datetime = ''' + convert(sysname, @datetime, 21) + '''' as 'Help to choose column aliases for order by from select clause' else select 'exec sp_executesql N''' + replace(@697, '''', '''''') + ' where s.ctime between @datetime and @datetime_to'', N''@datetime datetime, @datetime_to datetime'', @datetime = ''' + convert(sysname, @datetime, 21) + ''', @datetime_to = ''' + convert(sysname, @datetime_to, 21) + '''' as 'Help to choose column aliases for order by from select clause' else if (@734 is NULL) if (@datetime_to is NULL) begin set @697 = @697 + ' where s.ctime = @datetime order by s.ctime, s.session_id' exec @8e3 = sp_executesql @697, N'@datetime datetime', @datetime end else begin set @697 = @697 + ' where s.ctime between @datetime and @datetime_to order by s.ctime, s.session_id' exec @8e3 = sp_executesql @697, N'@datetime datetime, @datetime_to datetime', @datetime, @datetime_to end else if (@datetime_to is NULL) begin set @697 = @697 + ' where s.ctime = @datetime order by ' + @734 exec @8e3 = sp_executesql @697, N'@datetime datetime', @datetime end else begin set @697 = @697 + ' where s.ctime between @datetime and @datetime_to order by ' + @734 exec @8e3 = sp_executesql @697, N'@datetime datetime, @datetime_to datetime', @datetime, @datetime_to end end if (@8e3 <> 0) begin set @ea1 = '''Failed: sp_executesql N''' + replace(@697, '%', '%%') + '''''' raiserror (@ea1, 17, 1) set @datetime = NULL return 1 end select @a09 = datediff(ms, @254, getdate()) if (@a09 > @execution_time_report_threshold) print 'Final sp_whopro select statement took ' + cast(@a09 as nvarchar(256)) + ' ms' end return 0
end
go